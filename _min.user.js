// ==UserScript==
// @name           Castle Age Autoplayer
// @namespace      caap
// @description    Auto player for Castle Age
// @version        140.23.26
// @require        http://cloutman.com/jquery-latest.min.js
// @require        http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/jquery-ui-1.8.1/js/jquery-ui-1.8.1.custom.min.js
// @require        http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/farbtastic12/farbtastic/farbtastic.min.js
// @include        http*://apps.*facebook.com/castle_age/*
// @include        http://www.facebook.com/common/error.html
// @include        http://www.facebook.com/reqs.php#confirm_46755028429_0
// @include        http://www.facebook.com/home.php
// @include        http://www.facebook.com/*filter=app_46755028429*
// @exclude        *#iframe*
// @license        GPL version 3 or any later version; http://www.gnu.org/copyleft/gpl.html
// @compatability  Firefox 3.0+, Chrome 4+, Flock 2.0+
// ==/UserScript==

/*jslint white: true, browser: true, devel: true, undef: true, nomen: true, bitwise: true, plusplus: true, immed: true, regexp: true */
/*global window,unsafeWindow,$,GM_log,console,GM_getValue,GM_setValue,GM_xmlhttpRequest,GM_openInTab,GM_registerMenuCommand,XPathResult,GM_deleteValue,GM_listValues,GM_addStyle,CM_Listener,CE_message,ConvertGMtoJSON,localStorage */

var caapVersion = "140.23.26",
    global = {},
    gm = {},
    nHtml = {},
    caap = {};

///////////////////////////
//       CAAP Prototypes
///////////////////////////

String.prototype.ucFirst = function () {
    var firstLetter = this.substr(0, 1);
    return firstLetter.toUpperCase() + this.substr(1);
};

String.prototype.stripHTML = function (html) {
    return this.replace(new RegExp('<[^>]+>', 'g'), '').replace(/&nbsp;/g, '');
};

///////////////////////////
var b,caapVersion="140.23.26",global={},gm={},nHtml={},caap={};String.prototype.ucFirst=function(){return this.substr(0,1).toUpperCase()+this.substr(1)};String.prototype.stripHTML=function(){return this.replace(new RegExp("<[^>]+>","g"),"").replace(/&nbsp;/g,"")};
var revision="527",show_debug=true,VERSION="31.1",script_started=Date.now(),userID=0,imagepath="",isGreasemonkey=navigator.userAgent.toLowerCase().indexOf("chrome")===-1,log=function(){console.log("["+(new Date).toLocaleTimeString()+"] "+(WorkerStack&&WorkerStack.length?WorkerStack[WorkerStack.length-1].name+": ":"")+$.makeArray(arguments).join("\n"))},debug=show_debug?function(){console.log("["+(revision&&revision!=="$WCREV$"?"r"+revision:"v"+VERSION)+"] ["+(new Date).toLocaleTimeString()+"] "+(WorkerStack&&
WorkerStack.length?WorkerStack[WorkerStack.length-1].name+": ":"")+$.makeArray(arguments).join("\n"))}:function(){};if(typeof unsafeWindow==="undefined")var unsafeWindow=window;
if(window.location.hostname==="apps.facebook.com"||window.location.hostname==="apps.new.facebook.com"){var applications={"reqs.php":["","Gifts"],castle_age:["46755028429","Castle Age"]};for(var i in applications)if(window.location.pathname.indexOf(i)===1){var APP=i,APPID=applications[i][0],APPNAME=applications[i][1],PREFIX="golem"+APPID+"_";break}}
function do_css(){$("head").append("<style type=\"text/css\">.red { background: red !important; }.golem-tooltip { display: none; position: absolute; top: 10000px; left: 10000px; min-width: 250px; z-index: 5; margin: 0; padding: 0; }.golem-tooltip > p { background: white; border: 1px solid #aaaaaa; margin: 0; padding: 5px; }.golem-tooltip > img { float: right; background: url(\"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%0E%00%00%00%0E%08%03%00%00%00(%96%DD%E3%00%00%00%F9PLTE%B7HH%85HG%E1%9F%A9%B6HH%DEjJ%E1gt%D3%98%9E%D3eF%E1%83%8F%93F%40%85%40%3D%DAWc%D7Vb%8DA%3F%E1u%81%C0%5BG%A5DE%E3%A0%AB%B8NM%BCHK%A9%83%89%EC%BF%C4%ACEG%95BA%D7%81%87%E6%CE%D1%D1%95%A2%BCy%82%DFjK%E1%9F%AA%EE%C9%CF%CEx%83%E2%91%9C%DA%96%A0%E0XX%C2LL%CD%94%A0%D2fn%B4GI%E8%C2%C6%CEkv%D6fG%E2%9C%A6%C7t%7F%DEfs%C4RV%D2%87%91%CF%90%96%D1%60l%D6TT%A4%81%87%CESW%E0%97%9C%E8%BE%C5%9DCC%C0LX%BCmw%DD%BB%C0%DCr~%D6%7D%88%D7%97%A2%CFy%84%CF%92%9C%D7p%7B%E0%A2%AC%E1%A3%AD%D9q%7C%C4~%87%DD%C0%C4%D5oz%CE%84%8E%C2%86%8F%CC%8D%96%ED%CF%D4%C4r%7C%E2%C5%CA%F0%D2%D8%E4%A5%AF%D3KP%97HB%E6%AC%B5%FF%FF%FF%FF%FF%FF%CE0%0B%07%00%00%00StRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%00f%89~Y%00%00%00%B4IDATx%DA%3C%C5g%17%81%00%18%06%D0%D7(%19%89Bfe%93U!%7B%EF%11%9E%FE%FF%8F%E18%8E%FB%E5%92%9B%AD%3E~%AAY%97*%FD%81r%FFR%06%FD%0Au%D2%AF%BFt%87%24%AF%E38%9B%0B%D6%9F%BC%12%D5%E2%85!%E67%2C1%2C%C4k%94%D2%8B%C8%9C%F78eP%D4S%14%D3%BA%C8%1D'%D8%E5%D0%D5bds*Z%B3%EBx%D1%82%CA%D9%24G%1B%A8OW%87m%1D%8D%A8L%3Cc%B0H%B6%DBI%B0%06%C3S(%1C%19%F5%F0%D1%1BE%C2!%F2%88%25%B3%EC%23%F2%95%CD%92%E8!%2B(%E4%FD%CD%40%A0%E9%CF%0BA%8B%DC%C4%F3%2F%E1%BE%05%18%00%AD%D8%24%FF%02%BAqR%00%00%00%00IEND%AEB%60%82\") center center no-repeat; }.golem-tooltip > img:hover { background: url(\"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%0E%00%00%00%0E%08%03%00%00%00(%96%DD%E3%00%00%00%F0PLTE%D6%00%00%C0%00%00%E1%00%00%D5R%5C%E0%00%00%D9%00%00%9B%00%00%C6%00%00%CD%00%00%C5%0B%00%C1%0E%0F%C3%0A%00%E6%22%00%D407%EA%B3%BD%ED%23%00i%00%00L%0D%0E%D3%00%00C%00%00%5D%00%00b%02%00%C6FO%F1%0D%00%D1%0B%00%DEy~%82%00%00v%00%00%96hr%8Dirp%0D%0E%A7%07%00%E8%99%99%AA%0E%0F%D5lr%EE%99%99%E6%00%00%C1pz%C9%0B%0C%E0%9D%9D%C8pz%AF%00%00%E6%0C%00%CB%00%00%E4%22%00%B3%15%00%D0%0B%0CP%00%00%D207%8F%00%00%C4%00%00%B8%0C%0D%EF%24%00%BC%0A%0B%E8%A9%AF%B5%00%00%D4%00%00%D8%00%00%C8%00%00%D5U%60%D5%84%85%B3%09%0A%D6Va%BD%00%00%C8-4%CF%00%00%D7%80%80%DB%00%00%C2%2C2%B7%00%00%DC%95%98%E3%00%00%D5ff%EE%BF%CA%D9Wb%C1%00%00k%00%00%DD%7C%8D%FF%FF%FF%FF%FF%FF%2FY%B8%C8%00%00%00PtRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%00%13s%A6y%00%00%00%B2IDATx%DA%3C%C5U%12%82%00%00%05%C0%07%D8%8A%85%0D%B6%22vw'%88%FA%B8%FFmt%1C%C7%FDY8F%E0%F1%130%1C%D4%C7%95%F0%FD%2B%5C%19%D7QN%BD%FERex%24%DB%B6w3%AE%3FI%1E%0C%E5A%96%87%1B%2F%CC%0E%E4!r%3D%9D%8D%E9%86%DB%06%F5%5E%0Ej%7C%C4%A6p%E2%B5%C9Q%5CE%D4%ED%A5p%DC%CFW%02%BD%EE(%12.%1FKg%2C%96%25%FA%5C%09%F4k%B0X5%CD*-%D4%FAPD%B3m%F1%C3j%9B%A2%82X1%DD%CA%04%FD%FE%60%A6%95.%C6%90Ov%23%93P%A7%13%9AD%BA%C9%3C%1C%AD%F0%FC)h%CE%5B%80%01%00%B4%14%23%D5%5D%E5%26%DF%00%00%00%00IEND%AEB%60%82\") center center no-repeat; }.golem-tooltip > img:active { background: url(\"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%0E%00%00%00%0E%08%03%00%00%00(%96%DD%E3%00%00%00%EAPLTE%B2%00%00%B1%00%00%B6%00%00%B0%26%2B%BD%00%00%9A%0A%0BL%15%13%91%0E%0F%A3%0A%00%3B%00%00%93%1B%09%A5%00%00%A58%40F%00%00%AB%00%00%82r%7B%AA%00%00d%00%00%C1%1E%00%B8pzC%13%14n%00%00%C0%00%00%B9im%C5%1F%01%BE%1D%00%8C%0A%03Z%00%00%B2%5B%60%B1AI%C9%0D%00%5E%0D%0EP%00%00x%00%00%83%00%00%AE%06%07%A7%06%07%A3%0E%0F%93%00%00%C8%1F%00%B1%26%2B%BF%7D~%BB%00%00%C4%98%9F%C0%0C%00%C4%7D~%8Chr%B3pz%AE%0B%00%B8%7F%80%A6%00%00%A5%0B%00%97%00%00%BA%8A%8D%95%05%06%A7%24(%B6%7D~%B0DL%99%00%00%9B%05%06%B2DM%A8%00%00%A2%23'%B4%00%00%A0%00%00%C2%97%9B%B5%7F%80%AD%00%00%9C%00%00%BE%00%00%B0ST%B4EN%C7%A2%AAX%00%00%A1%00%00%B8dr%D1%D1%D2%FF%FF%FF%A1%5B%BF%DF%00%00%00NtRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%FF%00%ACM%FB%CE%00%00%00%B1IDATx%DA%3C%C5%E7%16%81%00%00%06%D0%AF%8C%08%D9%5Bde%CB%DE%9B%8A%7C%BD%FF%EBp%9C%8E%FB%E7%C2M%B7%1DO%3B%ED%C2%08T%06%CF%9FA%25%60%40%8A%BE%FF%A2%12%1A%AAm%DB%87%2B%B7%DF%D4%06%EA%5D_%9E%EB%25O%CC%FB%BAud%9B-N%F77%AE%A6l5%B3H%0A%11%EA%97%0Dw%3A%23B%12eqF%E7%FEX%1C%1D%CE%C42%B4%BE%C2%9E%08%E1%DC%A3%D2%D7%10%CB%C1%E2%C84G%B4%90%8B!%EC7%13%16%BF%AC%84%E9%0F%23S%AA%0E'%A1%F9%3C4%19VK%19%C4%83r%A1%93*%16S%9D%82%1C%8C%C3%1D%D7%5E%9E%DA%D8%FD%080%00g%F3%23%20i%8A%D0%D6%00%00%00%00IEND%AEB%60%82\") center center no-repeat; }.golem-config { float: none; margin-right: 0; }.golem-config > div { position: static; width: 196px; margin: 0; padding: 0; overflow: hidden; overflow-y: auto; }.golem-config #golem_fixed { float:right; margin:-2px; width:16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00.IDATx%DAb%60A%03%0Cd%0B03%81%18LH%02%10%80%2C%C0%84%24%00%96d%C2%A7%02%AB%19L%8C%A8%B6P%C3%E9%08%00%10%60%00%00z%03%C7%24%170%91%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-config-fixed { float: right; margin-right: 200px; }.golem-config-fixed > div { position: fixed; }.golem-config-fixed #golem_fixed { background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%005IDATx%DAb%60A%03%0C%C4%0901%83%00%13%92%0A%B0%00%0B)%02%8C%CCLLL%CC%0Cx%0CefF%E8%81%B9%83%19%DDa%84%05H%F0%1C%40%80%01%00%FE9%03%C7%D4%8CU%A3%00%00%00%00IEND%AEB%60%82') no-repeat; }#golem-dashboard { position: absolute; width: 600px; height: 185px; margin: 0; border-left: 1px solid black; border-right:1px solid black; overflow: hidden; background: white; z-index: 3; }#golem-dashboard thead th { cursor: pointer }#golem-dashboard thead th.golem-sort:after { content: '&darr;'; }#golem-dashboard thead th.golem-sort-reverse:after { content: '&uarr;'; }#golem-dashboard tbody tr:nth-child(odd) { background: #eeeeee; }#golem-dashboard tbody th { text-align: left; font-weight: normal; }#golem-dashboard td, #golem-dashboard th { margin: 2px; text-align: center; padding: 0 8px; }#golem-dashboard > div { height: 163px; overflow: hidden; overflow-y: scroll; border-top: 1px solid #d3d3d3; }#golem-dashboard > div > div { padding: 2px; }#golem-dashboard .golem-status { width: 100%; }#golem-dashboard .golem-status tbody th { text-align: right; padding: 2px; font-weight: bold; }#golem-dashboard .golem-status tbody td { text-align: left; }#golem-dashboard .overlay { position: absolute; left:10px; margin: 3px; color: white; text-shadow: black 0px 0px 2px; }table.golem-graph { height: 100px }table.golem-graph tbody th, table.golem-graph tbody td { border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }table.golem-graph tbody th { max-width: 75px; }table.golem-graph tbody th:first-child { text-align: right; border-left: 1px solid #dddddd; border-right: 1px solid #cccccc; }table.golem-graph tbody th:first-child div { line-height: 60px; height: 60px; }table.golem-graph tbody th:first-child div:first-child, table.golem-graph tbody th:first-child div:last-child { line-height: 20px; height: 20px; }table.golem-graph tbody th:last-child { text-align: left; border-right: 1px solid #dddddd; vertical-align: bottom; }table.golem-graph tbody th:last-child div { position: relative; height: 10px; margin: -10px 0 0; }table.golem-graph tbody th:last-child div:nth-last-child(1) { color: #ff0000; }table.golem-graph tbody th:last-child div:nth-last-child(2) { color: #0000ff; }table.golem-graph tbody th:last-child div:nth-last-child(3) { color: #00ffff; }table.golem-graph tbody th:last-child div:nth-last-child(4) { color: #aa00aa; }table.golem-graph tbody td { margin: 0; padding: 0 !important; vertical-align: bottom; width: 5px; border-right: 1px solid #dddddd; }table.golem-graph tbody td:nth-child(12n+1) { border-right: 1px solid #cccccc; }table.golem-graph tbody td div div { margin: 0; padding: 0; width: 5px; }table.golem-graph tbody td div.bars div:nth-last-child(1) { background: #00ff00; }table.golem-graph tbody td div.bars div:nth-last-child(2) { background: #00aa00; }table.golem-graph tbody td div.bars div:nth-last-child(3) { background: #ffff00; }table.golem-graph tbody td div.bars div:nth-last-child(4) { background: #ff00ff; }table.golem-graph tbody td div.goal div { position: relative; height: 1px; margin: -1px 0 0; }table.golem-graph tbody td div.goal div:nth-last-child(1) { background: #ff0000; }table.golem-graph tbody td div.goal div:nth-last-child(2) { background: #0000ff; }table.golem-graph tbody td div.goal div:nth-last-child(3) { background: #00ffff; }table.golem-graph tbody td div.goal div:nth-last-child(4) { background: #aa00aa; }.golem-button, .golem-button-active { border: 1px solid #d3d3d3; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; font-weight: normal; font-size: 13px; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-button:hover, .golem-button-active { border: 1px solid #aaaaaa; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }img.golem-button, img.golem-button-active { margin-bottom: -2px }.golem-tab-header { position: relative; top: 1px; border: 1px solid #d3d3d3; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 1px 2px; -moz-border-radius-topleft: 3px; -webkit-border-top-left-radius: 3px; border-top-left-radius: 3px; -moz-border-radius-topright: 3px; -webkit-border-top-right-radius: 3px; border-top-right-radius: 3px; }.golem-tab-header-active { border: 1px solid #aaaaaa; border-bottom: 0 !important; padding: 2px; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }.golem-title { padding: 4px; overflow: hidden; border-bottom: 1px solid #aaaaaa; background: #cccccc url(http://cloutman.com/css/base/images/ui-bg_highlight-soft_75_cccccc_1x100.png) 50% 50% repeat-x; color: #222222; font-weight: bold; }.golem-panel > .golem-panel-header, .golem-panel > * > .golem-panel-header { border: 1px solid #d3d3d3; cursor: pointer; margin-top: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-panel > .golem-panel-content, .golem-panel > * > .golem-panel-content { border: 1px solid #aaaaaa; border-top: 0 !important; padding: 2px 6px; background: #ffffff url(http://cloutman.com/css/base/images/ui-bg_glass_65_ffffff_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #212121; display: none; -moz-border-radius-bottomleft: 3px; -webkit-border-bottom-left-radius: 3px; border-bottom-left-radius: 3px; -moz-border-radius-bottomright: 3px; -webkit-border-bottom-right-radius: 3px; border-bottom-right-radius: 3px; }.golem-panel-show > .golem-panel-header, .golem-panel-show > * > .golem-panel-header { border: 1px solid #aaaaaa; border-bottom: 0 !important; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; -moz-border-radius-bottomleft: 0 !important; -webkit-border-bottom-left-radius: 0 !important; border-bottom-left-radius: 0 !important; -moz-border-radius-bottomright: 0 !important; -webkit-border-bottom-right-radius: 0 !important; border-bottom-right-radius: 0 !important; }.golem-panel-show > .golem-panel-content, .golem-panel-show > * > .golem-panel-content { display: block; }.golem-panel-sortable .golem-lock { display: none; }.golem-panel-content br:last-child { clear: both; }.golem-panel .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C%D4%13%60%C0%10%60%C0%10%60%C0%10%60%20%A4%82%90-%149%1D%20%C0%00%81%0E%00%F1%DE%25%95%BE%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-panel .golem-panel-header .golem-lock { float: right; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%001IDATx%DAb%60D%03%0CD%0B000%A0%0800%C0D%E0%02%8C(%02%0C%0Cp%25%B8%05%18%09%0A%A0j%C1%B4%96%1C%BF%C0%01%40%80%01%00n%11%00%CF%7D%2Bk%9B%00%00%00%00IEND%AEB%60%82') no-repeat;}.golem-panel-show .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C4%13%60%80%00%24%15%08%3EL%0B%9C%CF%88N%D3%D0a%C8%00%20%C0%00%7F%DE%00%F1%CCc%A6b%00%00%00%00IEND%AEB%60%82') no-repeat; }</style>")}
b=String.prototype;b.trim=function(){return this.replace(/^\s+|\s+$/g,"")};b.filepart=function(){var c=this.lastIndexOf("/");if(c>=0)return this.substr(c+1);return this};b.pathpart=function(){var c=this.lastIndexOf("/");if(c>=0)return this.substr(0,c+1);return this};b.regex=function(c){c=this.match(c);var d;if(c){c.shift();for(d=0;d<c.length;d++)if(c[d]&&c[d].search(/^[-+]?[0-9]*\.?[0-9]*$/)>=0)c[d]=parseFloat(c[d]);if(c.length===1)return c[0]}return c};b.toNumber=function(){return parseFloat(this)};
b.parseTimer=function(){var c=this.split(":"),d=0,e;for(e=0;e<c.length;e++)d=d*60+parseInt(c[e],10);if(isNaN(d))d=9999;return d};Number.prototype.round=function(c){return result=Math.round(this*Math.pow(10,c||0))/Math.pow(10,c||0)};Math.range=function(c,d,e){return Math.max(c,Math.min(d,e))};
var makeTimer=function(c){var d=Math.floor(c/3600),e=Math.floor(c/60)%60;c=Math.floor(c%60);return(d?d+":"+(e>9?e:"0"+e):e)+":"+(c>9?c:"0"+c)},WorkerByName=function(c){if(typeof c==="string"){c=c.toLowerCase();for(var d in Workers)if(d.toLowerCase()===c)return Workers[d]}return null},WorkerById=function(c){for(var d in Workers)if(Workers[d].id===c)return Workers[d];return null},Divisor=function(c){var d=c,e=1;if(d<20)return 1;for(;d>100;){d/=10;e*=10}if(c/e>40)e*=5;else if(c/e>20)e*=2.5;return e},
length=function(c){var d=0,e;if(typeof c==="object")for(e in c)d++;else if(typeof c==="array")d=c.length;return d},unique=function(c){var d={},e,f=c.length,g=[];for(e=0;e<f;e++)d[c[e]]=c[e];for(e in d)g.push(d[e]);return g},deleteElement=function(c,d){if(isArray(c))for(;d in c;)c.splice(c.indexOf(d),1)},sum=function(c){var d,e=0;if(isArray(c))for(d=0;d<c.length;d++)e+=sum(c[d]||0);else if(typeof c==="object")for(d in c)e+=sum(c[d]);else if(typeof c==="number")e=c;else if(typeof c==="string"&&c.search(/^[-+]?[0-9]*\.?[0-9]*$/)>=
0)e=parseFloat(c);return e},addCommas=function(c){c=c?c.toString():"0";for(var d=/(-?[0-9]+)([0-9]{3})/;d.test(c);)c=c.replace(d,"$1,$2");return c},findInArray=function(c,d){if(isArray(c))for(var e=0;e<c.length;e++)if(c[e]===d)return true;return false},findInObject=function(c,d){if(typeof c==="object")for(var e in c)if(c[e]==d)return e;return null},arrayIndexOf=function(c,d){if(isArray(c))for(var e=0;e<c.length;e++)if(c[e]===d)return e;return-1},arrayLastIndexOf=function(c,d){if(isArray(c))for(var e=
c.length-1;e>=0;e--)if(c[e]===d)return e;return-1},sortObject=function(c,d,e){var f=[],g={};if(typeof e==="undefined")e=false;for(i in c)f.push(i);f.sort(d);for(i=0;i<f.length;i++)g[f[i]]=e&&typeof c[f[i]]==="object"?sortObject(c[f[i]],d,e):c[f[i]];return g},getAttDefList=[],getAttDef=function(c,d,e,f,g){var h=[],k=0,l=0,m=e==="att"?"def":"att",p;if(d)for(p in c)d(h,p,c);else h=getAttDefList;h.sort(function(n,q){return c[q][e]+0.7*c[q][m]-(c[n][e]+0.7*c[n][m])});for(p=0;p<h.length;p++){d=typeof c[h[p]].own===
"number"?c[h[p]].own:1;if(g)if(Math.min(f,d)>0){if(!c[h[p]].use)c[h[p]].use={};c[h[p]].use[g+"_"+e]=Math.min(f,d)}else if(length(c[h[p]].use)){delete c[h[p]].use[g+"_"+e];length(c[h[p]].use)||delete c[h[p]].use}d=Math.min(f,d);k+=d*c[h[p]].att;l+=d*c[h[p]].def;f-=d}getAttDefList=h;return(e==="att"?k:0.7*k)+(e==="def"?l:0.7*l)},tr=function(c,d,e){c.push("<tr"+(e?" "+e:"")+">"+(d||"")+"</tr>")},th=function(c,d,e){c.push("<th"+(e?" "+e:"")+">"+(d||"")+"</th>")},td=function(c,d,e){c.push("<td"+(e?" "+
e:"")+">"+(d||"")+"</td>")},isArray=function(c){return c&&typeof c==="object"&&!c.propertyIsEnumerable("length")&&typeof c.length==="number"},isNumber=function(c){return typeof c==="number"},isWorker=function(c){return c&&typeof c==="object"&&typeof c.name==="string"&&typeof Workers[c.name]==="object"&&Workers[c.name]===c},plural=function(c){return c===1?"":"s"};Date.prototype.format=function(c){for(var d="",e=Date.replaceChars,f=0;f<c.length;f++){var g=c.charAt(f);d+=e[g]?e[g].call(this):g}return d};
Date.replaceChars={shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longMonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longDays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d:function(){return(this.getDate()<10?"0":"")+this.getDate()},D:function(){return Date.replaceChars.shortDays[this.getDay()]},j:function(){return this.getDate()},
l:function(){return Date.replaceChars.longDays[this.getDay()]},N:function(){return this.getDay()+1},S:function(){return this.getDate()%10==1&&this.getDate()!=11?"st":this.getDate()%10==2&&this.getDate()!=12?"nd":this.getDate()%10==3&&this.getDate()!=13?"rd":"th"},w:function(){return this.getDay()},z:function(){return"Not Yet Supported"},W:function(){return"Not Yet Supported"},F:function(){return Date.replaceChars.longMonths[this.getMonth()]},m:function(){return(this.getMonth()<9?"0":"")+(this.getMonth()+
1)},M:function(){return Date.replaceChars.shortMonths[this.getMonth()]},n:function(){return this.getMonth()+1},t:function(){return"Not Yet Supported"},L:function(){return this.getFullYear()%4==0&&this.getFullYear()%100!=0||this.getFullYear()%400==0?"1":"0"},o:function(){return"Not Supported"},Y:function(){return this.getFullYear()},y:function(){return(""+this.getFullYear()).substr(2)},a:function(){return this.getHours()<12?"am":"pm"},A:function(){return this.getHours()<12?"AM":"PM"},B:function(){return"Not Yet Supported"},
g:function(){return this.getHours()%12||12},G:function(){return this.getHours()},h:function(){return((this.getHours()%12||12)<10?"0":"")+(this.getHours()%12||12)},H:function(){return(this.getHours()<10?"0":"")+this.getHours()},i:function(){return(this.getMinutes()<10?"0":"")+this.getMinutes()},s:function(){return(this.getSeconds()<10?"0":"")+this.getSeconds()},e:function(){return"Not Yet Supported"},I:function(){return"Not Supported"},O:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/
60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+"00"},P:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+":"+(Math.abs(this.getTimezoneOffset()%60)<10?"0":"")+Math.abs(this.getTimezoneOffset()%60)},T:function(){var c=this.getMonth();this.setMonth(0);var d=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,"$1");this.setMonth(c);return d},Z:function(){return-this.getTimezoneOffset()*60},c:function(){return this.format("Y-m-d")+
"T"+this.format("H:i:sP")},r:function(){return this.toString()},U:function(){return this.getTime()/1E3}};var iscaap=function(){return typeof caap!="undefined"},Workers={},WorkerStack=[];if(isGreasemonkey)var setItem=function(c,d){GM_setValue(c,d)},getItem=function(c){return GM_getValue(c)};else{setItem=function(c,d){localStorage.setItem("golem."+APP+"."+c,d)};getItem=function(c){return localStorage.getItem("golem."+APP+"."+c)}}
function Worker(c,d,e){Workers[c]=this;this.id=null;this.name=c;this.pages=d;this.defaults={};this.settings=e||{};this.data={};this.option={};this.update=this.work=this.parse=this.init=this.display=this.runtime=null;this.get=function(f,g){return this._get(f,g)};this.set=function(f,g){return this._set(f,g)};this._rootpath=true;this._loaded=false;this._working={data:false,option:false,runtime:false,update:false};this._changed=Date.now();this._watching=[]}b=Worker.prototype;
b._flush=function(){WorkerStack.push(this);this._save();this.settings.keep||delete this.data;WorkerStack.pop()};
b._get=function(c,d){var e=typeof c==="string"?c.split("."):typeof c==="object"?c:[],f;if(!e.length||e[0]!=="data"&&e[0]!=="option"&&e[0]!=="runtime")e.unshift("data");if(e[0]==="data"){!this._loaded&&this._init();this._unflush()}f=this[e.shift()];try{return function(h,k){if(k.length){var l=k.shift();return arguments.callee(h[l],k)}else return h}(f,e)}catch(g){typeof d==="undefined"&&debug(g.name+" in "+this.name+".get("+c.toString()+"): "+g.message)}return typeof d!=="undefined"?d:null};
b._init=function(){if(!this._loaded){WorkerStack.push(this);this._loaded=true;try{this.init&&this.init()}catch(c){debug(c.name+" in "+this.name+".init(): "+c.message)}WorkerStack.pop()}};
b._load=function(c){if(c!=="data"&&c!=="option"&&c!=="runtime"){this._load("data");this._load("option");this._load("runtime")}else{WorkerStack.push(this);var d=getItem((this._rootpath?userID+".":"")+c+"."+this.name);if(d){try{d=JSON.parse(d)}catch(e){debug(this.name+"._load("+c+"): Not JSON data, should only appear once for each type...");d=eval(d)}this[c]=$.extend(true,{},this[c],d)}WorkerStack.pop()}};
b._parse=function(c){WorkerStack.push(this);var d=false;try{d=this.parse&&this.parse(c)}catch(e){debug(e.name+" in "+this.name+".parse("+c+"): "+e.message)}WorkerStack.pop();return d};b._remind=function(c){var d=this;window.setTimeout(function(){d._update("reminder",null)},c*1E3)};
b._save=function(c){if(c!=="data"&&c!=="option"&&c!=="runtime")return this._save("data")+this._save("option")+this._save("runtime");if(typeof this[c]==="undefined"||!this[c]||this._working[c])return false;var d=(this._rootpath?userID+".":"")+c+"."+this.name,e=JSON.stringify(this[c]);if(getItem(d)==="undefined"||getItem(d)!==e){WorkerStack.push(this);this._working[c]=true;this._changed=Date.now();this._update(c,null);setItem(d,e);this._working[c]=false;WorkerStack.pop();return true}return false};
b._set=function(c,d){var e=typeof c==="string"?c.split("."):typeof c==="object"?c:[],f;if(!e.length||e[0]!=="data"&&e[0]!=="option"&&e[0]!=="runtime")e.unshift("data");if(e[0]==="data"){!this._loaded&&this._init();this._unflush()}f=this[e.shift()];try{e.length&&function(h,k){var l=k.shift();if(k.length){if(typeof h[l]!=="object")h[l]={};arguments.callee(h[l],k)}else h[l]=d}(f,e)}catch(g){debug(g.name+" in "+this.name+".set("+c+", "+d+"): "+g.message)}return null};
b._setup=function(){WorkerStack.push(this);if((!this.settings.gm_only||isGreasemonkey)&&(this.settings.system||!length(this.defaults)||this.defaults[APP])){if(this.defaults[APP])for(var c in this.defaults[APP])this[c]=this.defaults[APP][c];this._load()}else delete Workers[this.name];WorkerStack.pop()};b._unflush=function(){WorkerStack.push(this);!this._loaded&&this._init();!this.settings.keep&&!this.data&&this._load("data");iscaap()&&typeof this.caap_load=="function"&&this.caap_load();WorkerStack.pop()};
b._unwatch=function(c){if(typeof c==="string")c=WorkerByName(c);isWorker(c)&&deleteElement(c._watching,this)};
b._update=function(c,d){if(this._loaded&&(this.update||this._watching.length)){WorkerStack.push(this);var e=false;this._working.update=true;if(typeof this.data==="undefined"){e=true;this._unflush()}try{this.update&&this.update(c,d)}catch(f){debug(f.name+" in "+this.name+".update("+(c?c:"null")+", "+(d?d.name:"null")+"): "+f.message)}if(!d)for(d=0;d<this._watching.length;d++)this._watching[d]._update(c,this);e&&this._flush();this._working.update=false;WorkerStack.pop()}};
b._watch=function(c){if(typeof c==="string")c=WorkerByName(c);isWorker(c)&&!findInArray(c._watching,this)&&c._watching.push(this)};b._work=function(c){WorkerStack.push(this);var d=false;try{d=this.work&&this.work(c)}catch(e){debug(e.name+" in "+this.name+".work("+c+"): "+e.message)}WorkerStack.pop();return d};var Army=new Worker("Army");Army.data={};Army.settings={system:true,advanced:true};Army.option={forget:14};Army.runtime={update:{},sort:0,rev:false,show:0,info:"uid"};
Army.display=[{id:"forget",label:"Forget after",select:[1,2,3,4,5,6,7,14,21,28],after:"days",help:"This will delete any userID that's not been seen for a length of time"}];Army.update=function(c,d){if(c==="data"&&!d){var e;for(e in this.runtime.update)if(this.runtime.update[e]){Workers[e]._update(c,this);this.runtime.update[e]=false}}};Army.init=function(){$("div.UIStandardFrame_Content").after('<div id="golem-army-tooltip" class="golem-tooltip"><a>&nbsp;x&nbsp;</a><p></p></div>');$("#golem-army-tooltip > a").click(function(){$("#golem-army-tooltip").hide()})};
Army.set=function(c,d){this._unflush();c=typeof c==="string"?c.split("."):typeof c==="object"?c:[];var e=null,f=null;if(c[0]==="option"||c[0]==="runtime")return this._set(c,d);c[0]==="data"&&c.shift();e=typeof c[0]==="string"&&c[0].regex(/[^0-9]/gi)?c.shift():isWorker(c[0])?c.shift().name:WorkerStack.length?WorkerStack[WorkerStack.length-1].name:null;if(c.length&&typeof c[0]==="string"&&!c[0].regex(/[^0-9]/gi))f=c.shift();if(e&&f){if(typeof Workers[e]!=="undefined")this.runtime.update[e]=true;this._set("data."+
f+"._last",Date.now());this._set("data."+f+"."+e+(c.length?"."+c.join("."):""),d)}};
Army.get=function(c,d){this._unflush();var e=typeof c==="string"?c.split("."):typeof c==="object"?c:[];var f=c=null,g;if(e[0]==="option"||e[0]==="runtime")return this._get(e,d);e[0]==="data"&&e.shift();if((c=typeof e[0]==="string"&&e[0].regex(/[^0-9]/gi)?e.shift():isWorker(e[0])?e.shift().name:WorkerStack.length?WorkerStack[WorkerStack.length-1].name:null)&&e.length===0){d=[];for(g in this.data)typeof this.data[g][c]!=="undefined"&&d.push(g);return d}if(e.length&&typeof e[0]==="string"&&!e[0].regex(/[^0-9]/gi))f=
e.shift();if(c&&f){this._set("data."+f+"._last",Date.now());return this._get("data."+f+"."+c+(e.length?"."+e.join("."):""),d)}};Army.name_callback=function(c,d,e){switch(c){default:return null;case "key":return"_info";case "name":return"Name";case "label":case "sort":return typeof d[e]._info.name!=="undefined"?d[e]._info.name:null}};
Army.info_callback=function(c,d,e){switch(c){default:return null;case "key":return"_info";case "name":return"Info ("+(findInObject(Army.infolist,Army.runtime.info)||"")+")";case "show":return"Info";case "label":case "sort":switch(Army.runtime.info){default:return typeof d[e]._info[Army.runtime.info]!=="undefined"?d[e]._info[Army.runtime.info]:null;case "uid":return e}case "has_tooltip":return true;case "tooltip":return"<b>Name:</b> "+(d[e]._info.name||"")}};
Army.infolist={UserID:"uid",Level:"level",Army:"army"};Army.sectionlist=[Army.name_callback,Army.info_callback];Army.section=function(c,d){this.sectionlist.push(d)};Army.order=[];
Army.dashboard=function(c,d){var e,f,g;f=this.runtime.show;var h=this.runtime.info,k=[],l=[],m=[],p=[];if($("#golem-army-show").length)f=parseInt($("#golem-army-show").attr("value"));if($("#golem-army-info").length)h=$("#golem-army-info").attr("value");if(typeof c==="undefined"||this.runtime.show!==f||this.runtime.info!==h){this.runtime.show=f;this.runtime.info=h;this.order=[];g=this.sectionlist[f]("key");for(e in this.data)try{typeof this.data[e][g]!=="undefined"&&this.sectionlist[f]("label",Army.data,
e)&&this.sectionlist[f]("label",Army.data,e)!==""&&this.order.push(e)}catch(n){log("add failed")}}for(e in this.sectionlist){th(l,this.sectionlist[e]("name"));if((g=this.sectionlist[e]("show"))&&g!=="")m.push('<option value="'+e+'"'+(e==f?" selected":"")+">"+g+"</option>")}for(e in this.infolist)p.push('<option value="'+(this.infolist[e]||"")+'"'+(this.infolist[e]==h?" selected":"")+">"+e+"</option>");k.push('Limit entries to <select id="golem-army-show">'+m.join("")+'</select> ... Info: <select id="golem-army-info">'+
p.join("")+"</select>");if(c!==this.runtime.sort||d!==this.runtime.rev){this.runtime.sort=c=typeof c!=="undefined"?c:this.runtime.sort||0;this.runtime.rev=d=typeof d!=="undefined"?d:this.runtime.rev||false;this.order.sort(function(o,r){var t=0,s=0;try{t=Army.sectionlist[c]("sort",Army.data,o)}catch(v){}try{s=Army.sectionlist[c]("sort",Army.data,r)}catch(u){}if(typeof t==="string"||typeof s==="string")return d?(s||"")>(t||""):(s||"")<(t||"");return d?(t||0)-(s||0):(s||0)-(t||0)})}k.push('<table cellspacing="0" style="width:100%"><thead><tr>'+
l.join("")+"</tr></thead><tbody>");for(f=0;f<this.order.length;f++){l=[];for(e in this.sectionlist)try{if(typeof this.data[this.order[f]][this.sectionlist[e]("key")]!=="undefined"){g=this.sectionlist[e]("label",this.data,this.order[f]);this.sectionlist[e]("has_tooltip")&&g&&g!==""?td(l,"<a>"+g+"</a>"):td(l,g||"")}else td(l,"")}catch(q){debug(q.name+" in Army.dashboard(): "+e+'("label"): '+q.message);td(l,"")}tr(k,l.join(""))}k.push("</tbody></table>");$("#golem-dashboard-Army").html(k.join(""));$("#golem-dashboard-Army td:first-child,#golem-dashboard-Army th:first-child").css("text-align",
"left");$("#golem-dashboard-Army select").change(function(){Army._unflush();Army.dashboard()});$("#golem-dashboard-Army thead th:eq("+c+")").attr("name",d?"reverse":"sort").append("&nbsp;"+(d?"&uarr;":"&darr;"));$("#golem-dashboard-Army td a").click(function(o){o.stopPropagation();var r;o=$(this.wrappedJSObject?this.wrappedJSObject:this);try{Army._unflush();if((r=Army.sectionlist[o.closest("td").index()]("tooltip",Army.data,Army.order[o.closest("tr").index()]))&&r!==""){$("#golem-army-tooltip > p").html(r);
$("#golem-army-tooltip").css({top:o.offset().top+o.height(),left:o.closest("td").offset().left}).show()}}catch(t){debug(t.name+" in Army.dashboard(): "+(Army.sectionlist?Army.sectionlist[o.index()]("name"):"unknown")+'("tooltip"): '+t.message)}return false})};var Config=new Worker("Config");Config.settings={system:true,keep:true};Config.option={display:"block",fixed:true,advanced:false,exploit:false};
Config.init=function(){$after=iscaap()?$("#caap_debug2_mess"):$("div.UIStandardFrame_Content");$("head").append('<link rel="stylesheet" href="http://cloutman.com/css/base/jquery-ui.css" type="text/css" />');var c,d,e,f;$after.after('<div class="golem-config'+(Config.option.fixed?" golem-config-fixed":"")+'"><div class="ui-widget-content"><div class="golem-title">Castle Age Golem '+(typeof revision!=="undefined"&&revision!=="$WCREV$"?"r"+revision:"v"+VERSION)+'<img id="golem_fixed"></div><div id="golem_buttons" style="margin:4px;"><img class="golem-button'+
(Config.option.display==="block"?"-active":"")+'" id="golem_options" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%E2%E2%E2%8A%8A%8A%AC%AC%AC%FF%FF%FFUUU%1C%CB%CE%D3%00%00%00%04tRNS%FF%FF%FF%00%40*%A9%F4%00%00%00%3DIDATx%DA%A4%8FA%0E%00%40%04%03%A9%FE%FF%CDK%D2%B0%BBW%BD%CD%94%08%8B%2F%B6%10N%BE%A2%18%97%00%09pDr%A5%85%B8W%8A%911%09%A8%EC%2B%8CaM%60%F5%CB%11%60%00%9C%F0%03%07%F6%BC%1D%2C%00%00%00%00IEND%AEB%60%82"></div><div style="display:'+
Config.option.display+';"><div id="golem_config" style="margin:0 4px;overflow:hidden;overflow-y:auto;"></div><div style="text-align:right;"><label>Advanced <input type="checkbox" id="golem-config-advanced"'+(Config.option.advanced?" checked":"")+"></label></div></div></div></div>");$("#golem_options").click(function(){$(this).toggleClass("golem-button golem-button-active");Config.option.display=Config.option.display==="block"?"none":"block";$("#golem_config").parent().toggle("blind");Config._save("option")});
$("#golem_fixed").click(function(){Config.option.fixed^=!iscaap();$(this).closest(".golem-config").toggleClass("golem-config-fixed");Config._save("option")});c=$("#golem_config");for(d in Workers)if(!iscaap()||caap.actionsList.indexOf(Workers[d].name)>=0&&typeof caap[Workers[d].name]!=="function")c.append(Config.makePanel(Workers[d]));c.sortable({axis:"y"});$(".golem-config .golem-panel > h3").click(function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show");
Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Config._save("option")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Config._save("option")}});c.children(".golem-panel-sortable").draggable({connectToSortable:"#golem_config",axis:"y",distance:5,scroll:false,handle:"h3",helper:"clone",opacity:0.75,
zIndex:100,refreshPositions:true,stop:function(){Config.updateOptions()}}).droppable({tolerance:"pointer",over:function(g,h){var k=Config.getOrder(),l=WorkerByName($(h.draggable).attr("name")),m=arrayIndexOf(k,$(this).attr("name"));if(arrayIndexOf(k,"Idle")>=m){if(l.settings.before)for(g=0;g<l.settings.before.length;g++)if(arrayIndexOf(k,l.settings.before[g])<=m)return;if(l.settings.after)for(g=0;g<l.settings.after.length;g++)if(arrayIndexOf(k,l.settings.after[g])>=m)return}m<arrayIndexOf(k,$(h.draggable).attr("name"))?
$(this).before(h.draggable):$(this).after(h.draggable)}});for(d in Workers){if(Workers[d].settings.before)for(e=0;e<Workers[d].settings.before.length;e++)if(f=WorkerByName(Workers[d].settings.before[e])){f.settings.after=f.settings.after||[];f.settings.after.push(Workers[d].name);f.settings.after=unique(f.settings.after)}if(Workers[d].settings.after)for(e=0;e<Workers[d].settings.after.length;e++)if(f=WorkerByName(Workers[d].settings.after[e])){f.settings.before=f.settings.before||[];f.settings.before.push(Workers[d].name);
f.settings.before=unique(f.settings.before)}}$.expr[":"].golem=function(g,h,k){h=k[3].toLowerCase().split(",");if($(g).attr("id")===PREFIX+h[0].trim().replace(/[^0-9a-z]/g,"-")+"_"+h[1].trim())return true;return false};$("input.golem_addselect").live("click",function(){var g,h,k=$(".golem_select",$(this).parent()).val().split(",");for(g=0;g<k.length;g++)(h=k[g].trim())&&$("select.golem_multiple",$(this).parent()).append("<option>"+h+"</option>");Config.updateOptions()});$("input.golem_delselect").live("click",
function(){$("select.golem_multiple option[selected=true]",$(this).parent()).each(function(g,h){$(h).remove()});Config.updateOptions()});$("input,textarea,select",c).change(function(){Config.updateOptions()});$("#golem-config-advanced").click(function(){Config.updateOptions();$(".golem-advanced").css("display",Config.option.advanced?"":"none")})};
Config.makePanel=function(c){var d,e,f,g,h,k=c.display,l=[],m=[],p=[],n={before:"",after:"",suffix:"",className:"",between:"to",size:7,min:0,max:100};if(!k)return false;c.id="golem_panel_"+c.name.toLowerCase().replace(/[^0-9a-z]/g,"-");e=findInArray(this.option.active,c.id);h=$('<div id="'+c.id+'" class="golem-panel'+(c.settings.unsortable?"":" golem-panel-sortable")+(e?" golem-panel-show":"")+(c.settings.advanced?" golem-advanced":"")+'"'+(c.settings.advanced&&!this.option.advanced||c.settings.exploit&&
!this.option.exploit?' style="display:none;"':"")+' name="'+c.name+'"><h3 class="golem-panel-header "><img class="golem-icon" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%00%00%00%00%00%00%A5g%B9%CF%00%00%00%01tRNS%00%40%E6%D8f%00%00%00%0FIDATx%DAb%60%18%05%C8%00%20%C0%00%01%10%00%01%3BBBK%00%00%00%00IEND%AEB%60%82">'+c.name+'<img class="golem-lock" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%00%00%00%00%00%00%A5g%B9%CF%00%00%00%01tRNS%00%40%E6%D8f%00%00%00%0FIDATx%DAb%60%18%05%C8%00%20%C0%00%01%10%00%01%3BBBK%00%00%00%00IEND%AEB%60%82"></h3></div>');
switch(typeof k){case "array":case "object":for(d in k){m=[];p=[];e=$.extend(true,{},n,k[d]);e.real_id=PREFIX+c.name.toLowerCase().replace(/[^0-9a-z]/g,"-")+"_"+e.id;e.value=c.get("option."+e.id)||null;e.alt=e.alt?' alt="'+e.alt+'"':"";e.hr&&m.push('<br><hr style="clear:both;margin:0;">');e.title&&m.push('<div style="text-align:center;font-size:larger;font-weight:bold;">'+e.title.replace(" ","&nbsp;")+"</div>");if(e.label){m.push('<span style="float:left;margin-top:2px;">'+e.label.replace(" ","&nbsp;")+
"</span>");if(e.text||e.checkbox||e.select)m.push('<span style="float:right;">');else e.multiple&&m.push("<br>")}e.before&&m.push(e.before+" ");if(e.info)e.id?m.push('<span style="float:right" id="'+e.real_id+'">'+(e.value||e.info)+"</span>"):m.push(e.info);else if(e.text)m.push('<input type="text" id="'+e.real_id+'" size="'+e.size+'" value="'+(e.value||"")+'">');else if(e.textarea)m.push('<textarea id="'+e.real_id+'" name="'+e.real_id+'" cols="23" rows="5">'+(e.value||"")+"</textarea>");else if(e.checkbox)m.push('<input type="checkbox" id="'+
e.real_id+'"'+(e.value?" checked":"")+">");else if(e.select){switch(typeof e.select){case "number":g=Divisor(e.select);for(f=0;f<=e.select;f+=g)p.push("<option"+(e.value==f?" selected":"")+">"+f+"</option>");break;case "string":e.className=' class="golem_'+e.select+'"';if(this.data&&this.data[e.select]&&(typeof this.data[e.select]==="array"||typeof this.data[e.select]==="object"))e.select=this.data[e.select];else break;case "array":case "object":if(isArray(e.select))for(f=0;f<e.select.length;f++)p.push('<option value="'+
e.select[f]+'"'+(e.value==e.select[f]?" selected":"")+">"+e.select[f]+(e.suffix?" "+e.suffix:"")+"</option>");else for(f in e.select)p.push('<option value="'+f+'"'+(e.value==f?" selected":"")+">"+e.select[f]+(e.suffix?" "+e.suffix:"")+"</option>");break}m.push('<select id="'+e.real_id+'"'+e.className+e.alt+">"+p.join("")+"</select>")}else if(e.multiple){if(typeof e.value==="array"||typeof e.value==="object")for(d in e.value)p.push('<option value="'+e.value[d]+'">'+e.value[d]+"</option>");m.push('<select style="width:100%;clear:both;" class="golem_multiple" multiple id="'+
e.real_id+'">'+p.join("")+"</select><br>");if(typeof e.multiple==="string")m.push('<input class="golem_select" type="text" size="'+e.size+'">');else{p=[];switch(typeof e.multiple){case "number":g=Divisor(e.select);for(f=0;f<=e.multiple;f+=g)p.push("<option>"+f+"</option>");break;case "array":case "object":if(isArray(e.multiple))for(f=0;f<e.multiple.length;f++)p.push('<option value="'+e.multiple[f]+'">'+e.multiple[f]+(e.suffix?" "+e.suffix:"")+"</option>");else for(f in e.multiple)p.push('<option value="'+
f+'">'+e.multiple[f]+(e.suffix?" "+e.suffix:"")+"</option>");break}m.push('<select class="golem_select">'+p.join("")+"</select>")}m.push('<input type="button" class="golem_addselect" value="Add" /><input type="button" class="golem_delselect" value="Del" />')}e.after&&m.push(" "+e.after);if(e.label&&(e.text||e.checkbox||e.select||e.multiple))m.push("</span>");l.push("<div"+(e.advanced?' class="golem-advanced"':"")+(e.advanced||e.exploit?' style="'+(e.advanced&&!this.option.advanced||e.exploit&&!this.option.exploit?
"display:none;":"")+(e.exploit?"border:1px solid red;background:#ffeeee;":"")+'"':"")+(e.help?' title="'+e.help+'"':"")+">"+m.join("")+"<br></div>")}h.append('<div class="golem-panel-content" style="font-size:smaller;">'+l.join("")+"</div>");return h;case "function":h.append('<div class="golem-panel-content" style="font-size:smaller;"></div>');try{$(".golem-panel-content",h).append(k())}catch(q){debug(q.name+" in Config.makePanel("+c.name+".display()): "+q.message)}return h;default:return null}};
Config.set=function(c,d){this._unflush();if(!this.data[c]||JSON.stringify(this.data[c])!==JSON.stringify(d)){this.data[c]=d;$("select.golem_"+c).each(function(e,f){var g=WorkerById($(f).closest("div.golem-panel").attr("id"));g=g?g.get(["option",$(f).attr("id").regex(/_([^_]*)$/i)]):null;var h=Config.data[c],k=[];if(isArray(h))for(e=0;e<h.length;e++)k.push('<option value="'+h[e]+'">'+h[e]+"</option>");else for(e in h)k.push('<option value="'+e+'">'+h[e]+"</option>");$(f).html(k.join("")).val(g)});
this._save();return true}return false};
Config.updateOptions=function(){Queue.option.queue=this.getOrder();this.option.advanced=$("#golem-config-advanced").attr("checked");$("#golem_config :input").each(function(c,d){if($(d).attr("id")){var e;if(c=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i)){if($(d).attr("type")==="checkbox")e=$(d).attr("checked");else if($(d).attr("multiple")){e=[];$("option",d).each(function(g,h){e.push($(h).text())})}else if((e=$(d).attr("value")||$(d).val()||null)&&e.search(/[^0-9.]/)===-1)e=parseFloat(e);
try{WorkerByName(c[0]).set("option."+c[1],e)}catch(f){debug(f.name+" in Config.updateOptions(): "+$(d).attr("id")+"("+JSON.stringify(c)+") = "+f.message)}}}});for(i in Workers)Workers[i]._save("option")};Config.getOrder=function(){var c=[];$("#golem_config > div").each(function(d,e){c.push($(e).attr("name"))});return unique(c)};var Dashboard=new Worker("Dashboard");Dashboard.settings={keep:true};Dashboard.defaults={castle_age:{pages:"*"}};Dashboard.option={display:"block",active:null};
Dashboard.init=function(){var c,d=[],e=[],f=this.option.active;for(i in Workers)if(Workers[i].dashboard){c="golem-dashboard-"+i;if(!f)this.option.active=f=c;Workers[i]===this?d.unshift('<h3 name="'+c+'" class="golem-tab-header'+(f===c?" golem-tab-header-active":"")+'">&nbsp;*&nbsp;</h3>'):d.push('<h3 name="'+c+'" class="golem-tab-header'+(f===c?" golem-tab-header-active":"")+'">'+(Workers[i]===this?"&nbsp;*&nbsp;":i)+"</h3>");e.push('<div id="'+c+'"'+(f===c?"":' style="display:none;"')+"></div>");
this._watch(Workers[i])}$('<div id="golem-dashboard" style="top:'+$("#app"+APPID+"_main_bn").offset().top+"px;display:"+this.option.display+';">'+d.join("")+"<div>"+e.join("")+"</div></div>").prependTo(".UIStandardFrame_Content");$(".golem-tab-header").click(function(){if(!$(this).hasClass("golem-tab-header-active")){if(Dashboard.option.active){$('h3[name="'+Dashboard.option.active+'"]').removeClass("golem-tab-header-active");$("#"+Dashboard.option.active).hide()}Dashboard.option.active=$(this).attr("name");
$(this).addClass("golem-tab-header-active");Dashboard.update();$("#"+Dashboard.option.active).show();Dashboard._save("option")}});$("#golem-dashboard .golem-panel > h3").live("click",function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind")}});$("#golem-dashboard thead th").live("click",function(){var g=WorkerByName(Dashboard.option.active.substr(16));
g._unflush();g.dashboard($(this).prevAll().length,$(this).attr("name")==="sort")});$("#golem_buttons").append('<img class="golem-button'+(Dashboard.option.display==="block"?"-active":"")+'" id="golem_toggle_dash" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%1EPLTE%BA%BA%BA%EF%EF%EF%E5%E5%E5%D4%D4%D4%D9%D9%D9%E3%E3%E3%F8%F8%F8%40%40%40%FF%FF%FF%00%00%00%83%AA%DF%CF%00%00%00%0AtRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%00%B2%CC%2C%CF%00%00%00EIDATx%DA%9C%8FA%0A%00%20%08%04%B5%CC%AD%FF%7F%B8%0D%CC%20%E8%D20%A7AX%94q!%7FA%10H%04%F4%00%19*j%07Np%9E%3B%C9%A0%0C%BA%DC%A1%91B3%98%85%AF%D9%E1%5C%A1%FE%F9%CB%14%60%00D%1D%07%E7%0AN(%89%00%00%00%00IEND%AEB%60%82">');
$("#golem_toggle_dash").click(function(){$(this).toggleClass("golem-button golem-button-active");Dashboard.option.display=Dashboard.option.display==="block"?"none":"block";Dashboard.option.display==="block"&&!$("#"+Dashboard.option.active).children().length&&WorkerByName(Dashboard.option.active.substr(16)).dashboard();$("#golem-dashboard").toggle("drop");Dashboard._save("option")});window.setInterval(function(){$(".golem-timer").each(function(g,h){(g=$(h).text().parseTimer())&&g>0?$(h).text(makeTimer($(h).text().parseTimer()-
1)):$(h).removeClass("golem-timer").text("now?")});$(".golem-time").each(function(g,h){(g=parseInt($(h).attr("name"))-Date.now())&&g>0?$(h).text(makeTimer(g/1E3)):$(h).removeClass("golem-time").text("now?")})},1E3)};Dashboard.parse=function(){$("#golem-dashboard").css("top",$("#app"+APPID+"_main_bn").offset().top+"px")};
Dashboard.update=function(c,d){if(this._loaded&&d){d=WorkerByName(Dashboard.option.active.substr(16));c="golem-dashboard-"+d.name;if(this.option.active===c&&this.option.display==="block")try{d._unflush();d.dashboard()}catch(e){debug(e.name+" in "+d.name+".dashboard(): "+e.message)}else $("#"+c).empty()}};
Dashboard.dashboard=function(){var c,d=[];for(c in Workers)this.data[c]&&d.push("<tr><th>"+c+':</th><td id="golem-status-'+c+'">'+this.data[c]+"</td></tr>");d.sort();$("#golem-dashboard-Dashboard").html('<table cellspacing="0" cellpadding="0" class="golem-status">'+d.join("")+"</table>")};Dashboard.status=function(c,d){if(d)this.data[c.name]=d;else delete this.data[c.name];this._save()};var Page=new Worker("Page");Page.settings={system:true,unsortable:true,keep:true};Page.option={timeout:15,retry:5};
Page.page="";Page.last=null;Page.lastclick=null;Page.when=null;Page.retry=0;Page.checking=true;Page.node_trigger=null;Page.loading=false;Page.display=[{id:"timeout",label:"Retry after",select:[10,15,30,60],after:"seconds"}];
Page.defaults={castle_age:{pageNames:{index:{url:"index.php",selector:"#app"+APPID+"_indexNewFeaturesBox"},quests_quest:{url:"quests.php",image:"tab_quest_on.gif"},quests_quest1:{url:"quests.php?land=1",image:"land_fire_sel.gif"},quests_quest2:{url:"quests.php?land=2",image:"land_earth_sel.gif"},quests_quest3:{url:"quests.php?land=3",image:"land_mist_sel.gif"},quests_quest4:{url:"quests.php?land=4",image:"land_water_sel.gif"},quests_quest5:{url:"quests.php?land=5",image:"land_demon_realm_sel.gif"},
quests_quest6:{url:"quests.php?land=6",image:"land_undead_realm_sel.gif"},quests_quest7:{url:"quests.php?land=7",image:"tab_underworld_big.gif"},quests_quest8:{url:"quests.php?land=8",image:"tab_heaven_big2.gif"},quests_demiquests:{url:"symbolquests.php",image:"demi_quest_on.gif"},quests_atlantis:{url:"monster_quests.php",image:"tab_atlantis_on.gif"},battle_battle:{url:"battle.php",image:"battle_on.gif"},battle_training:{url:"battle_train.php",image:"training_grounds_on_new.gif"},battle_rank:{url:"battlerank.php",
image:"tab_battle_rank_on.gif"},battle_raid:{url:"raid.php",image:"tab_raid_on.gif"},battle_war_council:{url:"war_council.php",image:"war_select_banner.jpg"},heroes_heroes:{url:"mercenary.php",image:"tab_heroes_on.gif"},heroes_generals:{url:"generals.php",image:"tab_generals_on.gif"},town_soldiers:{url:"soldiers.php",image:"tab_soldiers_on.gif"},town_blacksmith:{url:"item.php",image:"tab_black_smith_on.gif"},town_magic:{url:"magic.php",image:"tab_magic_on.gif"},town_land:{url:"land.php",image:"tab_land_on.gif"},
oracle_oracle:{url:"oracle.php",image:"oracle_on.gif"},oracle_demipower:{url:"symbols.php",image:"demi_on.gif"},oracle_treasurealpha:{url:"treasure_chest.php",image:"tab_treasure_alpha_on.gif"},oracle_treasurevanguard:{url:"treasure_chest.php?treasure_set=alpha",image:"tab_treasure_vanguard_on.gif"},oracle_treasureonslaught:{url:"treasure_chest.php?treasure_set=onslaught",image:"tab_treasure_onslaught_on.gif"},keep_stats:{url:"keep.php?user="+userID,image:"tab_stats_on.gif"},keep_eliteguard:{url:"party.php?user="+
userID,image:"tab_elite_guard_on.gif"},keep_achievements:{url:"achievements.php",image:"tab_achievements_on.gif"},keep_alchemy:{url:"alchemy.php",image:"tab_alchemy_on.gif"},keep_monster:{url:"battle_monster.php",image:"tab_monster_on.jpg"},keep_monster_active2:{url:"battle_monster.php",selector:'div[style*="nm_monster_list_button.gif"]'},keep_monster_active:{url:"raid.php",image:"dragon_view_more.gif"},army_invite:{url:"army.php",image:"invite_on.gif"},army_gifts:{url:"gift.php",selector:"#app"+
APPID+"_giftContainer"},army_viewarmy:{url:"army_member.php",image:"view_army_on.gif"},army_sentinvites:{url:"army_reqs.php",image:"sent_invites_on.gif"},army_newsfeed:{url:"army_news_feed.php",selector:"#app"+APPID+"_army_feed_header"},apprentice_collect:{url:"apprentice.php?collect=true",image:"ma_view_progress2.gif"}}}};
Page.init=function(){$("body").bind("DOMNodeInserted",function(c){if(!Page.node_trigger&&($(c.target).attr("id")==="app"+APPID+"_app_body_container"||$(c.target).attr("id")==="app"+APPID+"_globalContainer"))Page.node_trigger=window.setTimeout(function(){Page.node_trigger=null;Page.parse_all()},100)})};
Page.parse_all=function(){WorkerStack.push(this);Page.identify();var c,d=[];for(c in Workers)if(Workers[c].parse&&Workers[c].pages&&(Workers[c].pages.indexOf("*")>=0||Page.page!==""&&Workers[c].pages.indexOf(Page.page)>=0)){Workers[c]._unflush();Workers[c]._parse(false)&&d.push(Workers[c])}for(c in d)d[c]._parse(true);for(c in Workers)Workers[c]._flush();WorkerStack.pop()};
Page.work=function(c){if(!this.checking)return false;var d,e,f,g=null;for(d in Workers){if(Workers[d].pages){f=Workers[d].pages.split(" ");for(e=0;e<f.length;e++)if(f[e]!=="*"&&this.pageNames[f[e]]&&!this.data[f[e]]&&f[e].indexOf("_active")===-1){g=f[e];break}}if(g)break}if(!c){if(g)return true;return this.checking=false}if(g&&!this.to(g)){this.data[g]=Date.now();return true}return false};
Page.identify=function(){this.page="";if(!$("#app_content_"+APPID).length){this.reload();return null}var c=$("#app"+APPID+"_app_body"),d;$("img",c).each(function(e,f){e=$(f).attr("src").filepart();for(d in Page.pageNames)if(Page.pageNames[d].image&&e===Page.pageNames[d].image){Page.page=d;return}});if(!this.page)for(d in Page.pageNames)if(Page.pageNames[d].selector&&$(Page.pageNames[d].selector).length)Page.page=d;if(this.page!=="")this.data[this.page]=Date.now();return this.page};
Page.to=function(c,d,e){if(Queue.option.pause){debug("Trying to load page when paused...");return true}if(c===this.page&&(e||typeof d==="undefined"))return true;d||(d="");if(c&&this.pageNames[c]&&this.pageNames[c].url){this.clear();this.last=this.pageNames[c].url;this.when=Date.now();if(d.indexOf("?")===0&&this.last.indexOf("?")>0)this.last=this.last.substr(0,this.last.indexOf("?"))+d;else this.last+=d;debug("Navigating to "+c+" ("+(e?"FORCE: ":"")+this.last+")");if(e)window.location.href=this.last;
else this.ajaxload()}return false};
Page.ajaxload=function(){$.ajax({cache:false,dataType:"text",timeout:this.option.timeout*1E3,url:"http://apps.facebook.com/castle_age/"+this.last,error:function(){debug("Page not loaded correctly, reloading.");Page.ajaxload()},success:function(c){if(c.indexOf("app"+APPID+"_results_container")!==-1&&c.indexOf("</html>")!==-1&&c.indexOf("single_popup")!==-1&&c.indexOf("app"+APPID+"_index")!==-1){Page.loading=false;c=c.substring(c.indexOf('<div id="app'+APPID+'_globalContainer"'),c.indexOf('<div class="UIStandardFrame_SidebarAds"'));
$("#app"+APPID+"_AjaxLoadIcon").css("display","none");$("#app"+APPID+"_globalContainer").empty().append(c)}else{debug("Page not loaded correctly, reloading.");Page.ajaxload()}}});this.loading=true;setTimeout(function(){Page.loading&&$("#app"+APPID+"_AjaxLoadIcon").css("display","block")},1500)};Page.reload=function(){debug("Page.reload()");window.location.href=window.location.href};
Page.click=function(c){if(!$(c).length){log("Page.click: Unable to find element - "+c);return false}var d=document.createEvent("MouseEvents");d.initEvent("click",true,true);isGreasemonkey?$(c).get(0).wrappedJSObject.dispatchEvent(d):$(c).get(0).dispatchEvent(d);this.clear();this.lastclick=c;this.when=Date.now();return true};Page.clear=function(){this.last=this.lastclick=this.when=null;this.retry=0};var Queue=new Worker("Queue","*");Queue.data=null;
var QUEUE_FINISH=0,QUEUE_CONTINUE=1,QUEUE_RELEASE=2;Queue.settings={system:true,unsortable:true,keep:true};Queue.runtime={reminder:{},current:null};Queue.option={delay:5,clickdelay:5,queue:["Page","Queue","Settings","Title","Income","LevelUp","Elite","Quest","Monster","Battle","Heal","Land","Town","Bank","Alchemy","Blessing","Gift","Upgrade","Potions","Army","Idle"],start_stamina:0,stamina:0,start_energy:0,energy:0,pause:false};
Queue.display=[{label:"Drag the unlocked panels into the order you wish them run."},{id:"delay",label:"Delay Between Events",text:true,after:"secs",size:3},{id:"clickdelay",label:"Delay After Mouse Click",text:true,after:"secs",size:3,help:"This should be a multiple of Event Delay"},{id:"start_stamina",before:"Save",select:"stamina",after:"Stamina Before Using"},{id:"stamina",before:"Always Keep",select:"stamina",after:"Stamina"},{id:"start_energy",before:"Save",select:"energy",after:"Energy Before Using"},
{id:"energy",before:"Always Keep",select:"energy",after:"Energy"}];Queue.runfirst=[];Queue.lastclick=Date.now();Queue.lastrun=Date.now();Queue.burn={stamina:false,energy:false};Queue.timer=null;Queue.lasttimer=0;Queue.lastpause=false;
Queue.init=function(){if(iscaap())return false;var c,d;this.option.queue=unique(this.option.queue);for(c in Workers)if(Workers[c].work&&Workers[c].display&&!findInArray(this.option.queue,c)){log("Adding "+c+" to Queue");Workers[c].settings.unsortable?this.option.queue.unshift(c):this.option.queue.push(c)}for(c=0;c<this.option.queue.length;c++)if((d=WorkerByName(this.option.queue[c]))&&d.id){if(this.runtime.current&&d.name===this.runtime.current){debug("Trigger "+d.name+" (continue after load)");$("#"+
d.id+" > h3").css("font-weight","bold")}$("#golem_config").append($("#"+d.id))}$(document).click(function(){Queue.lastclick=Date.now()});$(document).keypress(function(){Queue.lastclick=Date.now()});Queue.lastpause=this.option.pause;$btn=$('<img class="golem-button'+(this.option.pause?" red":"")+'" id="golem_pause" src="'+(this.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82")+'">').click(function(){Queue.option.pause^=true;debug("State: "+(Queue.option.pause?"paused":"running"));$(this).toggleClass("red").attr("src",Queue.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82");Page.clear();Config.updateOptions()});$("#golem_buttons").prepend($btn)};
Queue.update=function(){if(iscaap())return false;if(!this.option.pause&&this.option.delay!==this.lasttimer){window.clearInterval(this.timer);this.timer=window.setInterval(function(){Queue.run()},this.option.delay*1E3);this.lasttimer=this.option.delay}else if(this.option.pause&&this.option.pause!==this.lastpause){window.clearInterval(this.timer);this.lasttimer=-1}this.lastpause=this.option.pause};
Queue.run=function(){var c,d,e;d=Date.now();var f=null,g=false;if(!(this.option.pause||d-this.lastclick<this.option.clickdelay*1E3))if(!Page.loading){WorkerStack.push(this);this.burn.stamina=this.burn.energy=0;if(this.option.burn_stamina||Player.get("stamina")>=this.option.start_stamina){this.burn.stamina=Math.max(0,Player.get("stamina")-this.option.stamina);this.option.burn_stamina=this.burn.stamina>0}if(this.option.burn_energy||Player.get("energy")>=this.option.start_energy){this.burn.energy=Math.max(0,
Player.get("energy")-this.option.energy);this.option.burn_energy=this.burn.energy>0}for(c in Workers)if(Workers[c].work&&!Workers[c].display){Workers[c]._unflush();Workers[c]._work(false)}for(c=0;c<this.option.queue.length;c++){d=WorkerByName(this.option.queue[c]);if(!(!d||!d.work||!d.display)){if(this.runtime.current===d.name){d._unflush();e=d._work(true);if(typeof e!=="boolean")d.settings.stateful=true;if(e===QUEUE_RELEASE)g=true;else if(!e){this.runtime.current=null;d.id&&$("#"+d.id+" > h3").css("font-weight",
"normal");debug("End "+d.name)}}else e=d._work(false);if(!f&&e)f=d}}d=this.runtime.current?WorkerByName(this.runtime.current):null;if(f!==d&&(!d||!d.settings.stateful||f.settings.important||g)){if(d){debug("Interrupt "+d.name+" with "+f.name);d.id&&$("#"+d.id+" > h3").css("font-weight","normal")}else debug("Trigger "+f.name);this.runtime.current=f.name;f.id&&$("#"+f.id+" > h3").css("font-weight","bold")}for(c in Workers)Workers[c]._flush();WorkerStack.pop()}};var Settings=new Worker("Settings");
Settings._rootpath=false;Settings.settings={system:true,unsortable:true,advanced:true};Settings.option={action:"None",which:"- default -",name:"- default -",confirm:false};Settings.display=[{title:"IMPORTANT!",label:"This will backup and restore your current options.<br>There is no confirmation dialog!"},{id:"action",label:"Action (<b>Immediate!!</b>)",select:["None","Load","Save","Delete"]},{id:"which",label:"Which",select:"settings"},{id:"name",label:"New Name",text:true}];Settings.oldwhich=null;
Settings.init=function(){this.data["- default -"]||this.set("- default -");Settings.oldwhich=this.option.which};
Settings.update=function(c){if(c==="option"){var d;c=[];if(this.oldwhich!==this.option.which){$("input:golem(settings,name)").val(this.option.which);this.oldwhich=this.option.name=this.option.which}switch(this.option.action){default:case "None":break;case "Load":debug("Loading "+this.option.which);this.get(this.option.which);break;case "Save":debug("Saving "+this.option.name);this.set(this.option.name);this.option.which=this.option.name;break;case "Delete":this.option.which!=="- default -"&&delete this.data[this.option.which];
this.option.which="- default -";this.option.name="- default -";break}$("select:golem(settings,action)").val("None");this.option.action="None";for(d in this.data)c.push(d);Config.set("settings",c.sort())}};Settings.set=function(c,d){var e=typeof c==="string"?c.split("."):typeof c==="object"?c:[];if(e.length&&(e[0]==="option"||e[0]==="runtime"))return this._set(c,d);this._unflush();this.data[c]={};for(var f in Workers)if(Workers[f]!==this&&Workers[f].option)this.data[c][f]=$.extend(true,{},Workers[f].option)};
Settings.get=function(c){var d,e=typeof c==="string"?c.split("."):typeof c==="object"?c:[];if(e.length&&(e[0]==="option"||e[0]==="runtime"))return this._get(c);this._unflush();if(this.data[c]){for(d in Workers)if(Workers[d]!==this&&Workers[d].option&&this.data[c][d]){Workers[d].option=$.extend(true,{},this.data[c][d]);Workers[d]._save("option")}Page.reload()}};var Update=new Worker("Update");Update.data=null;Update.option=null;Update.settings={gm_only:true,system:true};
Update.runtime={lastcheck:0,force:false,last:0,revision:0,beta:0,found:false};
Update.init=function(){if(!iscaap()){var c=$('<img class="golem-button" name="Script Update" id="golem_update" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C7%C7%C7UUU%7B%7B%7B%BF%BF%BF%A6%A6%A6%FF%FF%FF%40%40%40%FF%FF%FFk5%D0%FB%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00UIDATx%DAt%8F%5B%12%800%08%03%23%8Fx%FF%1B%5B%C0%96%EA%E8~%95%9D%C0%A48_%E0S%A8p%20%3A%85%F1%C6Jh%3C%DD%FD%205E%E4%3D%18%5B)*%9E%82-%24W6Q%F3Cp%09%E1%A2%8E%A2%13%E8b)lVGU%C7%FF%E7v.%01%06%005%D6%06%07%F9%3B(%D0%00%00%00%00IEND%AEB%60%82">').click(function(){if(Update.get("runtime.found"))window.location.href="http://game-golem.googlecode.com/svn/trunk/_release.user.js";
else{Update.set("runtime.force",true);Update.set("runtime.lastcheck",0)}});$("#golem_buttons").append(c);c=$('<img class="golem-button golem-advanced"'+(Config.get("option.advanced")?"":' style="display:none;"')+' name="Beta Update" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%FF%FF%FFiii%92%95*%C3%00%00%00%01tRNS%00%40%E6%D8f%00%00%00%2FIDATx%DAb%60%C0%00%8CP%8CO%80%91%90%00%08%80H%14%25h%C60%10%2B%80l%0E%98%C3%88%AE%0ES%80%91%91T%8B%C0%00%20%C0%00%17G%00(%A6%C6G%AA%00%00%00%00IEND%AEB%60%82">').click(function(){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>This will update to the latest Work-In-Progress version of Castle Age Golem.<br><br>Are you sure you wish to run a potentially buggy update?<br><br>You must reload the page after installing to use the new version.</div>');
$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close").remove();window.location.href="http://game-golem.googlecode.com/svn/trunk/_normal.user.js"},Skip:function(){$(this).dialog("close").remove()}}})});$("#golem_buttons").append(c)}};
Update.work=function(){if(!this.runtime.found&&Date.now()-this.runtime.lastcheck>216E5){this.runtime.lastcheck=Date.now();GM_xmlhttpRequest({method:"GET",url:"http://game-golem.googlecode.com/svn/trunk/_normal.user.js",onload:function(c){if(c.readyState===4&&c.status===200){c=c.responseText.regex(/@version[^0-9.]+([0-9.]+)/i);Update.get("runtime.force")&&$("#golem_request").remove();if(c>VERSION){Update.set("runtime.found",true);$("#golem_update").attr("src","data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C8%C8%C8%C1%C1%C1%BA%BA%BA%F1%F1%F1ggg%FF%FF%FF%40%40%40%FF%FF%FF%7D%5C%EC%14%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00OIDATx%DA%8C%8FA%0A%C0%20%0C%04W%8D%EB%FF%7F%AC1%5BQi%A1s%0A%C3%24%10%B4%0B%7C%89%9COa%A4%ED%22q%906a%2CE%09%14%D4%AA%04%BA0%8AH%5C%80%02%12%3E%FB%0A%19b%06%BE2%13D%F0%F0.~%3E%B7%E8%02%0C%00Z%03%06Q9dE%25%00%00%00%00IEND%AEB%60%82").toggleClass("golem-button golem-button-active");
if(Update.get("runtime.force")){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There is a new version of Castle Age Golem available.</p><p>Current&nbsp;version:&nbsp;'+VERSION+", New&nbsp;version:&nbsp;"+c+"</p></div>");$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close");window.location.href="http://game-golem.googlecode.com/svn/trunk/_release.user.js"},Skip:function(){$(this).dialog("close")}}})}log("New version available: "+c)}else if(Update.get("runtime.force")){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There are no new versions available.</p></div>');
$("#golem_request").dialog({modal:true,buttons:{Ok:function(){$(this).dialog("close")}}})}Update.set("runtime.force",false)}}})}};var Alchemy=new Worker("Alchemy");Alchemy.defaults.castle_age={pages:"keep_alchemy"};Alchemy.data={ingredients:{},summons:{},recipe:{}};Alchemy.option={perform:true,hearts:false,summon:false};Alchemy.runtime={best:null};
Alchemy.display=[{id:"perform",label:"Automatically Perform",checkbox:true},{id:"hearts",label:"Use Battle Hearts",checkbox:true},{id:"summon",label:"Use Summon Ingredients",checkbox:true}];
Alchemy.parse=function(){var c=this.data.ingredients={},d=this.data.recipe={};$("div.ingredientUnit").each(function(e,f){e=$("img",f).attr("src").filepart();c[e]=$(f).text().regex(/x([0-9]+)/)});$("div.alchemyQuestBack,div.alchemyRecipeBack,div.alchemyRecipeBackMonster").each(function(e,f){var g={};e=$("div.recipeTitle",f).text().trim().replace("RECIPES: ","");if(e.indexOf(" (")>0)e=e.substr(0,e.indexOf(" ("));if($(f).hasClass("alchemyQuestBack"))g.type="Quest";else if($(f).hasClass("alchemyRecipeBack"))g.type=
"Recipe";else if($(f).hasClass("alchemyRecipeBackMonster"))g.type="Summons";g.ingredients={};$("div.recipeImgContainer",f).parent().each(function(h,k){h=$("img",k).attr("src").filepart();g.ingredients[h]=$(k).text().regex(/x([0-9]+)/)||1});d[e]=g})};
Alchemy.update=function(){var c=null,d=this.data.recipe,e,f;for(e in d)if(d[e].type==="Summons")for(f in d[e].ingredients)this.data.summons[f]=true;for(e in d)if(d[e].type==="Recipe"){c=e;for(f in d[e].ingredients)if(!this.option.hearts&&f==="raid_hearts.gif"||!this.option.summon&&this.data.summons[f]||d[e].ingredients[f]>(this.data.ingredients[f]||0)){c=null;break}if(c)break}this.runtime.best=c};
Alchemy.work=function(c){if(!this.option.perform||!this.runtime.best)return QUEUE_FINISH;if(!c||!Page.to("keep_alchemy"))return QUEUE_CONTINUE;debug("Perform - "+this.runtime.best);Page.click($('input[type="image"]',$('div.recipeTitle:contains("'+this.runtime.best+'")').next()))||Page.reload();return QUEUE_RELEASE};var Bank=new Worker("Bank");Bank.data=null;Bank.settings={after:["Land","Town"]};Bank.defaults.castle_age={};Bank.option={general:true,above:1E4,hand:0,keep:1E4};
Bank.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"above",label:"Bank Above",text:true},{id:"hand",label:"Keep in Cash",text:true},{id:"keep",label:"Keep in Bank",text:true}];Bank.work=function(c){if(iscaap()&&this.option.above===null)return QUEUE_FINISH;if(Player.get("cash")<=10||Player.get("cash")<=this.option.above)return QUEUE_FINISH;else if(!c||this.stash(Player.get("cash")-this.option.hand))return QUEUE_CONTINUE;return QUEUE_RELEASE};
Bank.stash=function(c){if(!c||!Player.get("cash")||Math.min(Player.get("cash"),c)<=10)return true;if(this.option.general&&!Generals.to("bank")||!Page.to("keep_stats"))return false;$('input[name="stash_gold"]').val(Math.min(Player.get("cash"),c));Page.click('input[value="Stash"]');return true};
Bank.retrieve=function(c){!iscaap()&&(WorkerByName(Queue.get("runtime.current")).settings.bank=true);c-=Player.get("cash");if(c<=0||Player.get("bank")-this.option.keep<c)return true;if(!Page.to("keep_stats"))return false;$('input[name="get_gold"]').val(c.toString());Page.click('input[value="Retrieve"]');return false};Bank.worth=function(c){var d=Player.get("cash")+Math.max(0,Player.get("bank")-this.option.keep);if(typeof c==="number")return c<=d;return d};var Battle=new Worker("Battle");
Battle.defaults.castle_age={pages:"battle_rank battle_battle"};Battle.data={user:{},rank:{},points:{}};Battle.option={general:true,points:true,monster:true,arena:false,losses:5,type:"Invade",bp:"Always",army:1.1,level:1.1,preferonly:"Sometimes",prefer:[]};Battle.runtime={attacking:null};
Battle.symbol={1:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%17%90%B3%1AIn%99%AD%B0%3F%5Erj%7F%8A4%40J%22*1%FF%FF%FFm%0F%82%CD%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%ABIDATx%DAl%91%0B%0E%04!%08CAh%E7%FE7%DE%02%BA3%FBib%A2O%A8%02vm%91%00xN%B6%A1%10%EB%86O%0C%22r%AD%0Cmn%0C%8A%8Drxa%60-%B3p%AF%8C%05%0C%06%15d%E6-%5D%90%8D%E5%90~%B0x%A20e%117%0E%D9P%18%A1%60w%F3%B0%1D%1E%18%1C%85m'D%B9%08%E7%C6%FE%0F%B7%CF%13%C77%1Eo%F4%93%05%AA%24%3D%D9%3F%E1%DB%25%8E%07%BB%CA%D8%9C%8E%FE6%A6J%B9%1F%FB%DAa%8A%BFNW3%B5%9ANc%D5%FEn%9El%F7%20%F6tt%8C%12%F01%B4%CE%F8%9D%E5%B7%5E%02%0C%00n%97%07%B1AU%81%B7%00%00%00%00IEND%AEB%60%82",2:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%E0%0D%0CZ%5B%5Bv%13%0F%2F%1A%16%7Byx%8941DB%3F%FF%FF%FFOmpc%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B4IDATx%DAT%D1%5B%12%C5%20%08%03P%08%C2%DD%FF%8Eo%12%EB%D8%F2%D1%C7%C1%01%C5%F8%3DQ%05T%9D%BFxP%C6%07%EA%CDF%07p%998%B9%14%C3%C4aj%AE%9CI%A5%B6%875zFL%0F%C8%CD%19vrG%AC%CD%5C%BC%C6nM%D57'%EB%CA%AD%EC%C2%E5b%B5%93%5B%E9%97%99%40D%CC%97sw%DB%FByqwF%83u%FA%F2%C8%A3%93u%A0%FD%8C%B8%BA%96NAn%90%17%C1%C7%E1'%D7%F2%85%01%D4%DC%A7d%16%EDM2%1A%C3%C5%1E%15%7DX%C7%23%19%EB%1El%F5h%B2lV%5B%CF%ED%A0w%89~%AE'%CE%ED%01%F7%CA%5E%FC%8D%BF%00%03%00%AA%CE%08%23%FB4h%C4%00%00%00%00IEND%AEB%60%82",
3:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%B1%98g%DE%BCyqpq%8CnF%12%11%0EME7y8%0B%FF%FF%FF6%A1%E73%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B7IDATx%DA%5C%91Y%16C!%0CB%C9%40%BA%FF%1D%17%7Cz%9Em%BE%F4%8A%19%08%3E%3BX%40%F1%DC%B0%A1%99_xcT%EF(%BC8%D8%CC%9A%A9%D4!%0E%0E%8Bf%863%FE%16%0F%06%5BR%22%02%1C%A0%89%07w%E6T%AC%A8A%F6%C2%251_%9CPG%C2%A1r7N%CB%E1%1CtN%E7%06%86%7F%B85%8B%1A%22%2F%AC%3E%D4%B2_.%9C%C6%EA%B3%E2%C6%BB%24%CA%25uY%98%D5H%0D%EE%922%40b%19%09%CFNs%99%C8Y%E2XS%D2%F3*%0F7%B5%B9%B6%AA%16_%0E%9A%D61V%DCu-%E5%A2g%3BnO%C1%B3%1E%9C%EDiax%94%3F%F87%BE%02%0C%00%98%F2%07%E0%CE%8C%E4%B1%00%00%00%00IEND%AEB%60%82",
4:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%90%CA%3CSTRq%9B5On*%10%13%0Dx%7Ct6B'%FF%FF%FFx%0A%94%CE%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B2IDATx%DAT%D1A%16%C4%20%08%03P%20%92%B9%FF%8D'%80%B5%96%85%AF~%95*%D8o%07%09%90%CF%CC6%96%F5%CA%CD%E0%DAA%BC%0CM%B3C%CBxX%9A%E9%15Z%18%B7QW%E2%DB%9B%3D%E0%CD%99%11%18V%3AM%02%CD%FA%08.%8A%B5%D95%B1%A0%A7%E9Ci%D0%9Cb3%034D%F8%CB(%EE%F8%F0%F1%FA%C5ae9%BB%FD%B0%A7%CF%F9%1Au%9FfR%DB%A3%A19%179%CFa%B1%8E%EB*%91%BE_%B9*M%A9S%B7%97%AE)%15%B5%3F%BAX%A9%0Aw%C9m%9A%A0%CA%AA%20%5Eu%E5%D5%1DL%23%D4%9Eu7%AD%DBvZv%F17%FE%02%0C%00%D3%0A%07%E1%0961%CF%00%00%00%00IEND%AEB%60%82",
5:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%F2%F2%EF!!%20%A5%A5%A3vvv%5BZZ%3D%3D%3B%00%00%00%FF%FF%FF.%C4%F9%B3%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%BEIDATx%DA%5C%91Q%92%C30%08C%11B%DE%FB%DFx%25%C7n3%E5%23%E3%3Cd%01%A6%FEN%00%12p%FF%EA%40%A3%05%A7%F0%C6%C2%0A%CCW_%AC%B5%C4%1D9%5D%EC39%09'%B0y%A5%D8%E2H%5D%D53%DDH%E1%E05%A6%9A2'%9Bkcw%40%E9%C5e%5Ev%B6g%E4%B1)%DA%DF%EEQ%D3%A0%25Vw%EC%B9%D5)%C8%5Cob%9C%1E%E2%E2%D8%16%F1%94%F8%E0-%AF%B9%F8x%CB%F2%FE%C8g%1Eo%A03w%CA%86%13%DB%C4%1D%CA%7C%B7%E8w%E4d%FAL%E9%CE%9B%F3%F0%D0g%F8%F0%AD%CFSyD%DC%875%87%3B%B0%D1%5D%C4%D9N%5C%13%3A%EB%A9%F7.%F5%BB%CB%DF%F8%17%60%00%EF%2F%081%0F%2BNZ%00%00%00%00IEND%AEB%60%82"};
Battle.demi={1:"Ambrosia",2:"Malekus",3:"Corvintheus",4:"Aurora",5:"Azeron"};
Battle.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel","War"],help:"War needs level 150+, and is similar to Duel - though also uses 10 stamina"},{id:"losses",label:"Attack Until",select:["Ignore",1,2,3,4,5,6,7,8,9,10],after:"Losses"},{id:"points",label:"Always Get Demi-Points",checkbox:true},{advanced:true,id:"monster",label:"Fight Monsters First",checkbox:true},{id:"bp",label:"Get Battle Points<br>(Clears Cache)",select:["Always",
"Never","Don't Care"]},{advanced:true,id:"cache",label:"Limit Cache Length",select:[100,200,300,400,500]},{id:"army",label:"Target Army Ratio<br>(Only needed for Invade)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for smaller target army. Reduce this number if you're losing in Invade"},{id:"level",label:"Target Level Ratio<br>(Mainly used for Duel)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for lower target level. Reduce this number if you're losing a lot"},
{advanced:true,hr:true,title:"Preferred Targets"},{advanced:true,id:"preferonly",label:"Fight Preferred",select:["Never","Sometimes","Only","Until Dead"]},{advanced:true,id:"prefer",multiple:"userid"}];Battle.init=function(){this._watch(Monster);this.option.arena=false};
Battle.parse=function(){var c,d,e;if(Page.page==="battle_rank"){c={0:{name:"Newbie",points:0}};$('tr[height="23"]').each(function(f,g){f=$(g).text().regex(/Rank ([0-9]+) - (.*)\s*([0-9]+)/i);c[f[0]]={name:f[1],points:f[2]}});this.data.rank=c;this.data.bp=$('span:contains("Battle Points.")','div:contains("You are a Rank")').text().replace(/,/g,"").regex(/with ([0-9]+) Battle Points/i)}else if(Page.page==="battle_battle"){c=this.data.user;if(this.runtime.attacking){d=this.runtime.attacking;this.runtime.attacking=
null;if($("div.results").text().match(/You cannot battle someone in your army/i))delete c[d];else if($("div.results").text().match(/This trainee is too weak. Challenge someone closer to your level/i))delete c[d];else if($("div.results").text().match(/Your opponent is dead or too weak/i)){c[d].hide=(c[d].hide||0)+1;c[d].dead=Date.now()}else if($('img[src*="battle_victory"]').length){this.data.bp=$('span.result_body:contains("Battle Points.")').text().replace(/,/g,"").regex(/total of ([0-9]+) Battle Points/i);
c[d].win=(c[d].win||0)+1;History.add("battle+win",1)}else if($('img[src*="battle_defeat"]').length){c[d].loss=(c[d].loss||0)+1;History.add("battle+loss",-1)}else this.runtime.attacking=d}if(d=$("#app"+APPID+'_app_body table.layout table div div:contains("Once a day you can")').text().replace(/[^0-9\/]/g,"").regex(/([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10/))this.data.points=d;e=Player.get("rank");$("#app"+APPID+"_app_body table.layout table table tr:even").each(function(f,g){f=
$('img[uid!==""]',g).attr("uid");var h=$("td.bluelink",g).text().replace(/[ \t\n]+/g," "),k=h.regex(/Battle:[^(]+\(Rank ([0-9]+)\)/i);if(!(!f||!h||Battle.option.bp==="Always"&&e-k>5||!Battle.option.bp==="Never"&&e-k<=5)){c[f]=c[f]||{};c[f].name=$("a",g).text().trim();c[f].level=h.regex(/\(Level ([0-9]+)\)/i);c[f].rank=k;c[f].war=h.regex(/War:[^(]+\(Rank ([0-9]+)\)/i);c[f].army=$("td.bluelink",g).next().text().regex(/([0-9]+)/);c[f].align=$('img[src*="graphics/symbol_"]',g).attr("src").regex(/symbol_([0-9])/i)}})}return false};
Battle.update=function(){var c,d,e=this.data.user,f=[],g=false,h=[],k=Player.get("army"),l=Player.get("level"),m=Player.get("rank"),p=0;h.push("Rank "+Player.get("rank")+" "+(Player.get("rank")&&this.data.rank[Player.get("rank")].name)+" with "+addCommas(this.data.bp||0)+" Battle Points, Targets: "+length(e)+" / "+this.option.cache);if(this.option.points)h.push('Demi Points Earned Today: <img src="'+this.symbol[1]+'" alt=" " title="'+this.demi[1]+'" style="width:11px;height:11px;"> '+(this.data.points[0]||
0)+'/10 <img src="'+this.symbol[2]+'" alt=" " title="'+this.demi[2]+'" style="width:11px;height:11px;"> '+(this.data.points[1]||0)+'/10 <img src="'+this.symbol[3]+'" alt=" " title="'+this.demi[3]+'" style="width:11px;height:11px;"> '+(this.data.points[2]||0)+'/10 <img src="'+this.symbol[4]+'" alt=" " title="'+this.demi[4]+'" style="width:11px;height:11px;"> '+(this.data.points[3]||0)+'/10 <img src="'+this.symbol[5]+'" alt=" " title="'+this.demi[5]+'" style="width:11px;height:11px;"> '+(this.data.points[4]||
0)+"/10");for(c in e)if(this.option.bp==="Always"&&m-(e[c].rank||0)>=4||!this.option.bp==="Never"&&m-(e[c].rank||6)<=5)delete e[c];if(length(e)>this.option.cache){f=[];for(c in e)f.push(c);for(f.sort(function(n,q){var o=0;if((e[n].win||0)-(e[n].loss||0)<(e[q].win||0)-(e[q].loss||0))o+=10;else if((e[n].win||0)-(e[n].loss||0)>(e[q].win||0)-(e[q].loss||0))o-=10;if(Battle.option.bp==="Always")o+=((e[q].rank||0)-(e[n].rank||0))/2;if(Battle.option.bp==="Never")o+=((e[n].rank||0)-(e[q].rank||0))/2;o+=Math.range(-1,
(e[q].hide||0)-(e[n].hide||0),1);o+=Math.range(-10,((e[n].army||0)-(e[q].army||0))/10,10);o+=Math.range(-10,((e[n].level||0)-(e[q].level||0))/10,10);return o});f.length>this.option.cache;)delete e[f.pop()]}g=this.option.points&&this.data.points&&sum(this.data.points)<50;if(!g&&this.option.monster&&Monster.get("runtime.uid")&&Monster.get("runtime.type")){this.runtime.attacking=null;h.push("Attacking Monsters")}else{if(!this.runtime.attacking||!e[this.runtime.attacking]||this.option.army!=="Any"&&e[this.runtime.attacking].army/
k>this.option.army||this.option.level!=="Any"&&e[this.runtime.attacking].level/l>this.option.level)this.runtime.attacking=null;f=[];for(d=0;d<this.option.prefer.length;d++){c=this.option.prefer[d];if(!/[^0-9]/g.test(c)){e[c]=e[c]||{};if(!(e[c].dead&&e[c].dead+3E5>=Date.now()||typeof this.option.losses==="number"&&(e[c].loss||0)-(e[c].win||0)>=this.option.losses||g&&(!e[c].align||this.data.points[e[c].align-1]>=10))){f.push(c,c,c,c,c,c,c,c,c,c);p++}}}if(this.option.preferonly==="Never"||this.option.preferonly===
"Sometimes"||this.option.preferonly==="Only"&&!this.option.prefer.length||this.option.preferonly==="Until Dead"&&!f.length)for(c in e)if(!(e[c].dead&&e[c].dead+18E5>=Date.now()||typeof this.option.losses==="number"&&(e[c].loss||0)-(e[c].win||0)>=this.option.losses||this.option.army!=="Any"&&(e[c].army||0)/k>this.option.army||this.option.level!=="Any"&&(e[c].level||0)/l>this.option.level||g&&(!e[c].align||this.data.points[e[c].align-1]>=10))){for(d=Math.range(1,(e[c].rank||0)-m+1,5);d>0;d--)f.push(c);
p++}if(!this.runtime.attacking&&f.length)this.runtime.attacking=f[Math.floor(Math.random()*f.length)];if(this.runtime.attacking){c=this.runtime.attacking;h.push("Next Target: "+e[c].name+" (Level "+e[c].level+" "+this.data.rank[e[c].rank].name+" with "+e[c].army+" army)"+(p?", "+p+" valid target"+plural(p):""))}else{this.runtime.attacking=null;h.push("No valid targets found");this._remind(60)}}Dashboard.status(this,h.join("<br>"))};
Battle.work=function(c){if(!this.runtime.attacking||Player.get("health")<13||Queue.burn.stamina<(this.option.type==="War"?10:1))return QUEUE_FINISH;if(!c||this.option.general&&!Generals.to(Generals.best(this.option.type))||!Page.to("battle_battle"))return QUEUE_CONTINUE;c=$('form input[alt="'+this.option.type+'"]').first().parents("form");if(c.length){log("Battle: Attacking "+this.data.user[this.runtime.attacking].name+" ("+this.runtime.attacking+")");$('input[name="target_id"]',c).attr("value",this.runtime.attacking);
Page.click($('input[type="image"]',c))}else{debug("Unable to find attack buttons, forcing reload");Page.to("index")}return QUEUE_RELEASE};Battle.rank=function(c){for(var d in Battle.data.rank)if(Battle.data.rank[d].name===c)return parseInt(d,10);return 0};Battle.order=[];
Battle.dashboard=function(c,d){var e,f=[0,0,0,0,0,0],g=[],h=[],k=["align","name","level","rank","army","win","loss","hide"],l=this.data.user,m=Player.get("army"),p=Player.get("level");for(e in l)f[l[e].align]++;if(typeof c==="undefined"){this.order=[];for(e in l)this.order.push(e)}if(typeof c==="undefined")c=this.runtime.sort||1;if(typeof d==="undefined")d=this.runtime.rev||false;this.runtime.sort=c;this.runtime.rev=d;typeof k[c]==="string"&&this.order.sort(function(n,q){n=l[n][k[c]]||0;q=l[q][k[c]]||
0;if(typeof n==="string"||typeof q==="string")return d?q>n:q<n;return d?n-q:q-n});g.push('<div style="text-align:center;"><strong>Rank:</strong> '+this.data.rank[Player.get("rank")].name+" ("+Player.get("rank")+"), <strong>Targets:</strong> "+length(l)+" / "+this.option.cache+", <strong>By Alignment:</strong>");for(e=1;e<6;e++)g.push(' <img src="'+this.symbol[e]+'" alt="'+this.demi[e]+'" title="'+this.demi[e]+'" style="width:11px;height:11px;"> '+f[e]);g.push("</div><hr>");th(h,"Align");th(h,"Name");
th(h,"Level");th(h,"Rank");th(h,"Army");th(h,"Wins");th(h,"Losses");th(h,"Hides");g.push('<table cellspacing="0" style="width:100%"><thead><tr>'+h.join("")+"</tr></thead><tbody>");for(e=0;e<this.order.length;e++){l=this.data.user[this.order[e]];h=[];td(h,'<img src="'+this.symbol[l.align]+'" alt="'+this.demi[l.align]+'">','title="'+this.demi[l.align]+'"');th(h,l.name,'title="'+this.order[e]+'"');td(h,this.option.level!=="Any"&&l.level/p>this.option.level?"<i>"+l.level+"</i>":l.level);td(h,this.data.rank[l.rank]?
this.data.rank[l.rank].name:"");td(h,this.option.army!=="Any"&&l.army/m>this.option.army?"<i>"+l.army+"</i>":l.army);td(h,l.win||"");td(h,l.loss||"");td(h,l.hide||"");tr(g,h.join(""))}g.push("</tbody></table>");$("#golem-dashboard-Battle").html(g.join(""));$("#golem-dashboard-Battle tbody tr td:nth-child(2)").css("text-align","left");if(typeof c!=="undefined")$("#golem-dashboard-Battle thead th:eq("+c+")").attr("name",d?"reverse":"sort").append("&nbsp;"+(d?"&uarr;":"&darr;"))};var Blessing=new Worker("Blessing");
Blessing.data=null;Blessing.defaults.castle_age={pages:"oracle_demipower"};Blessing.option={which:"Stamina",display:false};Blessing.runtime={when:0};Blessing.which=["None","Energy","Attack","Defense","Health","Stamina"];Blessing.display=[{id:"which",label:"Which",select:Blessing.which},{id:"display",label:"Display in Blessing info on *",checkbox:true}];
Blessing.parse=function(){var c=$("div.results"),d;if(c.length)if((d=c.text().regex(/Please come back in: ([0-9]+) hours and ([0-9]+) minutes/i))&&d.length)this.runtime.when=Date.now()+(d[0]*60+d[1]+1)*6E4;else if(c.text().match(/You have paid tribute to/i))this.runtime.when=Date.now()+8646E4;return false};
Blessing.update=function(){var c,d;if(this.option.display&&this.option.which!=="None"){c=new Date(this.runtime.when);switch(this.option.which){case "Energy":d="Ambrosia ("+this.option.which+")";break;case "Attack":d="Malekus ("+this.option.which+")";break;case "Defense":d="Corvintheus ("+this.option.which+")";break;case "Defense":d="Corvintheus ("+this.option.which+")";break;case "Health":d="Aurora ("+this.option.which+")";break;case "Stamina":d="Azeron ("+this.option.which+")";break;default:d="Unknown";
break}Dashboard.status(this,'<span title="Next Blessing">Next Blessing performed on '+c.format("l g:i a")+" to "+d+" </span>")}else Dashboard.status(this)};Blessing.work=function(c){if(!this.option.which||this.option.which==="None"||Date.now()<=this.runtime.when)return QUEUE_FINISH;if(!c||!Page.to("oracle_demipower"))return QUEUE_CONTINUE;Page.click("#app"+APPID+"_symbols_form_"+this.which.indexOf(this.option.which)+" input.imgButton");return QUEUE_RELEASE};var Elite=new Worker("Elite","keep_eliteguard army_viewarmy battle_arena");
Elite.data={};Elite.defaults.castle_age={pages:"keep_eliteguard army_viewarmy battle_arena"};Elite.option={elite:true,arena:false,every:12,prefer:[],armyperpage:25};Elite.runtime={armylastpage:1,armyextra:0,waitelite:0,nextelite:0,waitarena:0,nextarena:0};
Elite.display=[{id:"elite",label:"Fill Elite Guard",checkbox:true},{id:"every",label:"Every",select:[1,2,3,6,12,24],after:"hours",help:"Although people can leave your Elite Guard after 24 hours, after 12 hours you can re-confirm them"},{advanced:true,label:"Add UserIDs to prefer them over random army members. These <b>must</b> be in your army to be checked.",id:"prefer",multiple:"userid"}];
Elite.init=function(){this.option.arena=false;if(length(this.data))for(var c in this.data){Army.set(["_info",c,"name"],this.data[c].name);Army.set(["_info",c,"level"],this.data[c].level);Army.set(["Army",c],true);this.data[c].elite&&Army.set([c,"elite"],this.data[c].elite)}this.data={};Army.section("Elite",function(d,e,f){switch(d){default:return null;case "key":case "name":case "show":return"Elite";case "label":return e[f].Elite.elite?'for <span class="golem-time" name="'+e[f].Elite.elite+'">'+makeTimer((e[f].Elite.elite-
Date.now())/1E3)+"</span>":"";case "sort":return typeof e[f].Elite.elite!=="undefined"?e[f].Elite.elite:null;case "has_tooltip":return true;case "tooltip":return"Added: "+(e[f]._info.name||"")}})};
Elite.parse=function(){$("span.result_body").each(function(d,e){d=$(e).text();if(d.match(/Elite Guard, and they have joined/i)){Army.set([$("img",e).attr("uid"),"elite"],Date.now()+432E5);Elite.runtime.nextelite=null}else if(d.match(/'s Elite Guard is FULL!/i)){Army.set([$("img",e).attr("uid"),"elite"],Date.now()+18E5);Elite.runtime.nextelite=null}else if(d.match(/YOUR Elite Guard is FULL!/i)){Elite.runtime.waitelite=Date.now();Elite.runtime.nextelite=null;debug("Elite guard full, wait "+Elite.option.every+
" hours")}});if(Page.page==="army_viewarmy"){var c=0;$('img[linked="true"][size="square"]').each(function(d,e){d=$(e).attr("uid");e=$(e).parent().parent().next();c++;Army.set(["Army",d],true);Army.set(["_info",d,"name"],$("a",e).text());Army.set(["_info",d,"level"],$(e).text().regex(/([0-9]+) Commander/i))});if(c<25)this.runtime.armyextra=Player.get("armymax")-length(this.data)-1}return false};
Elite.update=function(){var c,d,e,f=[],g=Date.now();this.runtime.nextelite=this.runtime.nextarena=0;if(this.option.elite){for(e=0;e<this.option.prefer.length;e++){d=this.option.prefer[e];if(Army.get(["Army",d])){c=Army.get([d,"elite"],null);if(c!==null&&c<g){this.runtime.nextelite=d;break}}}if(!this.runtime.nextelite){e=Army.get("Army");for(d=0;d<e.length;d++){c=Army.get([e[d],"elite"],null);if(!c||c<g){this.runtime.nextelite=e[d];break}}}c=this.runtime.waitelite+this.option.every*36E5;f.push("Elite Guard: Check"+
(c<g?"ing now":' in <span class="golem-time" name="'+c+'">'+makeTimer((c-g)/1E3)+"</span>"))}Dashboard.status(this,f.join(", "))};
Elite.work=function(c){if(Math.ceil((Player.get("armymax")-this.runtime.armyextra-1)/this.option.armyperpage)>this.runtime.armylastpage){if(c){debug("Filling army list");this.runtime.armylastpage=Math.max(this.runtime.armylastpage+1,Math.ceil((length(Army.get("Army"))+1)/this.option.armyperpage));Page.to("army_viewarmy","?page="+this.runtime.armylastpage)}return true}if((!this.option.elite||!this.runtime.nextelite||this.runtime.waitelite+this.option.every*36E5>Date.now())&&(!this.option.arena||!this.runtime.nextarena||
this.runtime.waitarena+this.option.every*36E5>Date.now()))return false;if(!c)return true;if(!this.runtime.nextelite&&!this.runtime.nextarena&&!length(Army.get("Army"))&&!Page.to("army_viewarmy"))return true;if(this.runtime.waitelite+this.option.every*36E5<=Date.now()){debug("Add "+Army.get(["_info",this.runtime.nextelite,"name"],this.runtime.nextelite)+" to Elite Guard");if(!Page.to("keep_eliteguard","?twt=jneg&jneg=true&user="+this.runtime.nextelite))return true}return false};var Generals=new Worker("Generals");
Generals.option=null;Generals.data={};Generals.defaults.castle_age={pages:"* heroes_generals"};Generals.runtime={disabled:false};Generals.init=function(){for(var c in this.data)c.indexOf("\t")!==-1&&delete this.data[c];if(!Player.get("attack")||!Player.get("defense"))this._watch(Player);this._watch(Town)};
Generals.parse=function(){$("div.results").text().match(/has gained a level!/i)&&this.data[Player.get("general")].level++;if(Page.page==="heroes_generals"){var c=$(".generalSmallContainer2"),d=this.data,e="";$('div.generalContainerBox div:contains("Item Bonuses")').nextAll().each(function(){var g=$("img",this).attr("title");if(g&&g.indexOf("[not owned]")==-1){if(e.length)e+=", ";e+=g.replace(/\<[^>]*\>|\s+|\n/g," ").trim()}});var f=$("div.general_name_div3").first().text().trim();if(d[f])d[f].weaponbonus=
e;if(c.length<length(d)){debug("Different number of generals, have "+c.length+", want "+length(d));return false}c.each(function(g,h){g=$(".general_name_div3_padding",h).text().trim();var k=parseInt($(h).text().regex(/Level ([0-9]+)/i)),l=parseInt($("div.generals_indv_stats",h).next().children().children().children().next().attr("style").regex(/width: ([0-9]*\.*[0-9]*)%/i));if(g&&g.indexOf("\t")===-1&&g.length<30)if(!d[g]||d[g].level!==k||d[g].progress!==l){d[g]=d[g]||{};d[g].img=$(".imgButton",h).attr("src").filepart();
d[g].att=$(".generals_indv_stats_padding div:eq(0)",h).text().regex(/([0-9]+)/);d[g].def=$(".generals_indv_stats_padding div:eq(1)",h).text().regex(/([0-9]+)/);d[g].progress=l;d[g].level=k;d[g].skills=$("table div",h).html().replace(/\<[^>]*\>|\s+|\n/g," ").trim();k>=4&&d[g].priority&&delete d[g].priority}})}return false};
Generals.update=function(c,d){var e=this.data,f,g=[],h=[],k=Town.get("runtime.invade"),l=Town.get("runtime.duel"),m,p,n,q,o,r,t,s,v=m=p=0,u=1,x,w,B=function(y,A){y.push(A)};if(!c||c==="data"){for(f in Generals.data)h.push(f);Config.set("generals",["any"].concat(h.sort()))}for(f in e)e[f].level<4&&g.push([f,e[f].priority]);g.sort(function(y,A){return y[1]-A[1]});for(f in g)e[g[f][0]].priority=parseInt(f)+1;this.runtime.max_priority=g.length;if((c==="data"||d===Town||d===Player)&&k&&l){d===Player&&
Player.get("attack")&&Player.get("defense")&&this._unwatch(Player);for(f in e){g=e[f].skills+(e[f].weaponbonus||"");m=Math.floor(sum(g.regex(/([-+]?[0-9]*\.?[0-9]*) Player Attack|Increase Player Attack by ([0-9]+)|Convert ([-+]?[0-9]*\.?[0-9]*) Attack/i))+(e[f].skills.regex(/Increase ([-+]?[0-9]*\.?[0-9]*) Player Attack for every Hero Owned/i)||0)*(length(e)-1));p=Math.floor(sum(g.regex(/([-+]?[0-9]*\.?[0-9]*) Player Defense|Increase Player Defense by ([0-9]+)/i))+(e[f].skills.regex(/Increase ([-+]?[0-9]*\.?[0-9]*) Player Defense for every Hero Owned/i)||
0)*(length(e)-1));c=Player.get("attack")+m;d=Player.get("defense")+p;h=Player.get("attack")+m*4/e[f].level;r=Player.get("defense")+p*4/e[f].level;n=Math.min(Player.get("armymax"),g.regex(/Increases? Army Limit to ([0-9]+)/i)||501);q=getAttDef(e,B,"att",Math.floor(n/5));o=getAttDef(e,B,"def",Math.floor(n/5));p=g.regex(/Increase Player Attack when Defending by ([-+]?[0-9]+)/i)||0;m=g.regex(/([-+]?[0-9]+) Defense when attacked/i)||0;t=p*4/e[f].level;s=m*4/e[f].level;v=g.regex(/([-+]?[0-9]+) Monster attack/i)||
0;u=1+(g.regex(/([-+]?[0-9]+)% Critical/i)||0)/100;x=e[f].att+parseInt(e[f].skills.regex(/'s Attack by ([-+]?[0-9]+)/i)||0)+(typeof e[f].weaponbonus!=="undefined"?parseInt(e[f].weaponbonus.regex(/([-+]?[0-9]+) attack/i)||0):0);w=e[f].def+(typeof e[f].weaponbonus!=="undefined"?parseInt(e[f].weaponbonus.regex(/([-+]?[0-9]+) defense/i)||0):0);e[f].invade={att:Math.floor(k.attack+x+w*0.7+(c+d*0.7)*n+q),def:Math.floor(k.defend+w+x*0.7+(d+m+(c+p)*0.7)*n+o)};e[f].duel={att:Math.floor(l.attack+x+w*0.7+c+
d*0.7),def:Math.floor(l.defend+w+x*0.7+d+m+(c+p)*0.7)};e[f].monster={att:Math.floor(u*(l.attack+x+c+v)),def:Math.floor(l.defend+w+d)};e[f].potential={bank:g.regex(/Bank Fee/i)?1:0,defense:Math.floor(l.defend+(e[f].def+4-e[f].level)+(e[f].att+4-e[f].level)*0.7+r+s+(h+t)*0.7),income:g.regex(/Increase Income by ([0-9]+)/i)*4/e[f].level,invade:Math.floor(k.attack+(e[f].att+4-e[f].level)+(e[f].def+4-e[f].level)*0.7+(h+r*0.7)*n+q),duel:Math.floor(l.attack+(e[f].att+4-e[f].level)+(e[f].def+4-e[f].level)*
0.7+h+r*0.7),monster:Math.floor(l.attack+(e[f].att+4-e[f].level)+h+v*4/e[f].level),raid_invade:0,raid_duel:0,influence:g.regex(/Influence ([0-9]+)% Faster/i)||0,drops:g.regex(/Chance ([0-9]+)% Drops/i)||0,demi:g.regex(/Extra Demi Points/i)?1:0,cash:g.regex(/Bonus ([0-9]+) Gold/i)||0};e[f].potential.raid_invade=e[f].potential.defense+e[f].potential.invade;e[f].potential.raid_duel=e[f].potential.defense+e[f].potential.duel}}};
Generals.to=function(c){if(this.runtime.disabled)return true;this._unflush();if(c&&!this.data[c])c=this.best(c);if(!c||Player.get("general")===c||c==="any")return true;if(!c||!this.data[c]){log('General "'+c+'" requested but not found!');return true}if(!Page.to("heroes_generals"))return false;debug("Changing to General "+c);Page.click('input[src$="'+this.data[c].img+'"]');this.data[c].used=(this.data[c].used||0)+1;return false};
Generals.best=function(c){this._unflush();var d="",e=null,f=0,g;d=Player.get("general");if(iscaap()){var h={BuyGeneral:"cost",LevelUpGeneral:"stamina",IncomeGeneral:"income",SubQuestGeneral:"influence",MonsterGeneral:"cash",BankingGeneral:"bank",BattleGeneral:"invade",MonsterGeneral:"monster",FortifyGeneral:"dispel",IdleGeneral:"defense"};if(h[c]){var k=gm.getValue(c,"best");if(/under level 4/i.test(k))c="under level 4";else if(/use current/i.test(k))return"any";else if(/^best$/i.test(k))c=h[c];else return k}}switch(c.toLowerCase()){case "cost":d=
/Decrease Soldier Cost by ([0-9]+)/i;break;case "stamina":d=/Increase Max Stamina by ([0-9]+)|\+([0-9]+) Max Stamina/i;break;case "energy":d=/Increase Max Energy by ([0-9]+)|\+([0-9]+) Max Energy/i;break;case "income":d=/Increase Income by ([0-9]+)/i;break;case "item":d=/([0-9]+)% Drops for Quest/i;break;case "influence":d=/Bonus Influence ([0-9]+)/i;break;case "attack":d=/([-+]?[0-9]+) Player Attack/i;break;case "defense":d=/([-+]?[0-9]+) Player Defense/i;break;case "cash":d=/Bonus ([0-9]+) Gold/i;
break;case "bank":return"Aeris";case "invade":for(g in this.data)if(!e||this.data[g].invade&&this.data[g].invade.att>this.data[e].invade.att||this.data[g].invade&&this.data[g].invade.att===this.data[e].invade.att&&e!==d)e=g;return e||"any";case "duel":for(g in this.data)if(!e||this.data[g].duel&&this.data[g].duel.att>this.data[e].duel.att||this.data[g].duel&&this.data[g].duel.att===this.data[e].duel.att&&e!==d)e=g;return e||"any";case "raid-invade":for(g in this.data)if(!e||this.data[g].invade&&this.data[g].invade.att>
this.data[e].invade.att)e=g;return e||"any";case "raid-duel":for(g in this.data)if(!e||this.data[g].duel&&this.data[g].duel.att>this.data[e].duel.att)e=g;return e||"any";case "monster":for(g in this.data)if(!e||this.data[g].monster&&this.data[g].monster.att>this.data[e].monster.att)e=g;return e||"any";case "dispel":case "fortify":for(g in this.data)if(!e||this.data[g].monster&&this.data[g].monster.def>this.data[e].monster.def)e=g;return e||"any";case "defend":for(g in this.data)if(!e||this.data[g].duel&&
this.data[g].duel.def>this.data[e].duel.def||this.data[g].duel.def===this.data[e].duel.def&&e!==d)e=g;return e||"any";case "under level 4":for(g in this.data)if(this.data[g].priority==1)return g;default:return"any"}for(g in this.data)if(c=this.data[g].skills.regex(d))if(!e||c>f){e=g;f=c}return e||"any"};Generals.order=[];
Generals.dashboard=function(c,d){var e,f,g=[],h=[],k=0,l=0,m=0,p=0,n=0,q=0;if(typeof c==="undefined"){Generals.order=[];for(e in Generals.data)Generals.order.push(e)}if(typeof c==="undefined")c=this.runtime.sort||1;if(typeof d==="undefined")d=this.runtime.rev||false;this.runtime.sort=c;this.runtime.rev=d;typeof c!=="undefined"&&Generals.order.sort(function(o,r){var t,s;if(c==1){o=o;r=r}else if(c==2){o=Generals.data[o].level||0;r=Generals.data[r].level||0}else if(c==3){o=Generals.data[o].priority||
999999;r=Generals.data[r].priority||999999}else{t=c<6?"invade":c<8?"duel":"monster";s=c%2?"def":"att";o=Generals.data[o][t][s]||0;r=Generals.data[r][t][s]||0}if(typeof o==="string"||typeof r==="string")return d?r>o:r<o;return d?o-r:r-o});for(e in Generals.data){k=Math.max(k,Generals.data[e].invade?Generals.data[e].invade.att:1);l=Math.max(l,Generals.data[e].invade?Generals.data[e].invade.def:1);m=Math.max(m,Generals.data[e].duel?Generals.data[e].duel.att:1);p=Math.max(p,Generals.data[e].duel?Generals.data[e].duel.def:
1);n=Math.max(n,Generals.data[e].monster?Generals.data[e].monster.att:1);q=Math.max(q,Generals.data[e].monster?Generals.data[e].monster.def:1)}h.push('<table cellspacing="0" style="width:100%"><thead><tr><th></th><th>General</th><th>Level</th><th>Quest<br>Rank</th><th>Invade<br>Attack</th><th>Invade<br>Defend</th><th>Duel<br>Attack</th><th>Duel<br>Defend</th><th>Monster<br>Attack</th><th>Fortify<br>Dispel</th></tr></thead><tbody>');for(f=0;f<Generals.order.length;f++){e=Generals.order[f];g=[];g.push('<img src="'+
imagepath+Generals.data[e].img+'" style="width:25px;height:25px;" title="Skills: '+Generals.data[e].skills+", Weapon Bonus: "+(typeof Generals.data[e].weaponbonus!=="unknown"?Generals.data[e].weaponbonus?Generals.data[e].weaponbonus:"none":"unknown")+'">');g.push(e);g.push("<div"+(isNumber(Generals.data[e].progress)?' title="'+Generals.data[e].progress+'%"':"")+">"+Generals.data[e].level+'</div><div style="background-color: #9ba5b1; height: 2px; width=100%;"><div style="background-color: #1b3541; float: left; height: 2px; width: '+
(Generals.data[e].progress||0)+'%;"></div></div>');g.push(Generals.data[e].priority?(Generals.data[e].priority!=1?'<a class="golem-moveup" name='+Generals.data[e].priority+">&uarr</a> ":"&nbsp;&nbsp; ")+Generals.data[e].priority+(Generals.data[e].priority!=this.runtime.max_priority?' <a class="golem-movedown" name='+Generals.data[e].priority+">&darr</a>":" &nbsp;&nbsp;"):"");g.push(Generals.data[e].invade?(k==Generals.data[e].invade.att?"<strong>":"")+addCommas(Generals.data[e].invade.att)+(k==Generals.data[e].invade.att?
"</strong>":""):"?");g.push(Generals.data[e].invade?(l==Generals.data[e].invade.def?"<strong>":"")+addCommas(Generals.data[e].invade.def)+(l==Generals.data[e].invade.def?"</strong>":""):"?");g.push(Generals.data[e].duel?(m==Generals.data[e].duel.att?"<strong>":"")+addCommas(Generals.data[e].duel.att)+(m==Generals.data[e].duel.att?"</strong>":""):"?");g.push(Generals.data[e].duel?(p==Generals.data[e].duel.def?"<strong>":"")+addCommas(Generals.data[e].duel.def)+(p==Generals.data[e].duel.def?"</strong>":
""):"?");g.push(Generals.data[e].monster?(n==Generals.data[e].monster.att?"<strong>":"")+addCommas(Generals.data[e].monster.att)+(n==Generals.data[e].monster.att?"</strong>":""):"?");g.push(Generals.data[e].monster?(q==Generals.data[e].monster.def?"<strong>":"")+addCommas(Generals.data[e].monster.def)+(q==Generals.data[e].monster.def?"</strong>":""):"?");h.push("<tr><td>"+g.join("</td><td>")+"</td></tr>")}h.push("</tbody></table>");$("a.golem-moveup").live("click",function(){var o=null,r=null,t=parseInt($(this).attr("name"));
Generals._unflush();for(var s in Generals.data){if(Generals.data[s].priority==t)r=s;if(Generals.data[s].priority==t-1)o=s}if(o&&r){debug("Priority: Swapping "+r+" with "+o);Generals.data[o].priority++;Generals.data[r].priority--}Generals.dashboard(c,d);return false});$("a.golem-movedown").live("click",function(){var o=null,r=null,t=parseInt($(this).attr("name"));Generals._unflush();for(var s in Generals.data){if(Generals.data[s].priority==t)o=s;if(Generals.data[s].priority==t+1)r=s}if(o&&r){debug("Priority: Swapping "+
r+" with "+o);Generals.data[o].priority++;Generals.data[r].priority--}Generals.dashboard(c,d);return false});$("#golem-dashboard-Generals").html(h.join(""));$("#golem-dashboard-Generals tbody tr td:nth-child(2)").css("text-align","left");if(typeof c!=="undefined")$("#golem-dashboard-Generals thead th:eq("+c+")").attr("name",d?"reverse":"sort").append("&nbsp;"+(d?"&uarr;":"&darr;"))};var Gift=new Worker("Gift");Gift.settings={keep:true};Gift.defaults.castle_age={pages:"* index army_invite army_gifts"};
Gift.data={received:[],todo:{},gifts:{}};Gift.option={type:"None"};Gift.runtime={work:false,gift_waiting:false,gift_sent:0,sent_id:null,gift:{sender_id:null,sender_ca_name:null,sender_fb_name:null,name:null,id:null}};Gift.display=[{label:"Work in progress..."},{id:"type",label:"Return Gifts",select:["None","Random","Same as Received"]}];
Gift.init=function(){delete this.data.uid;delete this.data.lastgift;if(length(this.data.gifts)){var c=[];for(var d in this.data.gifts)c.push(d);for(var e in this.data.todo)if(!/[^0-9]/g.test(e)){d=Math.floor(Math.random()*c.length);this.data.todo[c[d]]||(this.data.todo[c[d]]=[]);this.data.todo[c[d]].push(e);delete this.data.todo[e]}}};
Gift.parse=function(c){if(c)return false;var d=this.data.gifts;c=this.data.todo;var e=this.data.received;if(Page.page==="index")if($("span.result_body").text().indexOf("has sent you a gift")>=0){this.runtime.gift.sender_ca_name=$("span.result_body").text().regex(/[\t\n]*(.+) has sent you a gift/i);this.runtime.gift.name=$("span.result_body").text().regex(/has sent you a gift:\s+(.+)!/i);this.runtime.gift.id=$("span.result_body img").attr("src").filepart();debug(this.runtime.gift.sender_ca_name+" has a "+
this.runtime.gift.name+" waiting for you. ("+this.runtime.gift.id+")");return this.runtime.gift_waiting=true}else{if($("span.result_body").text().indexOf("warrior wants to join your Army")>=0){this.runtime.gift.sender_ca_name="A Warrior";this.runtime.gift.name="Random Soldier";this.runtime.gift.id="random_soldier";debug(this.runtime.gift.sender_ca_name+" has a "+this.runtime.gift.name+" waiting for you.");return this.runtime.gift_waiting=true}}else if(Page.page==="army_invite"){if(this.runtime.sent_id&&
$("div.result").text().indexOf("request sent")>=0){debug(d[this.runtime.sent_id].name+" sent.");for(j=0;j<Math.min(c[this.runtime.sent_id].length,30);j++)c[this.runtime.sent_id].shift();c[this.runtime.sent_id].length||delete c[this.runtime.sent_id];this.runtime.sent_id=null;if(c.length==0)this.runtime.work=false}if(this.runtime.gift.sender_id)if($("div.game").text().indexOf("accepted the gift")>=0||$("div.game").text().indexOf("have been awarded the gift")>=0){debug("Accepted "+this.runtime.gift.name+
" from "+this.runtime.gift.sender_ca_name+"(id:"+this.runtime.gift.sender_id+")");e.push(this.runtime.gift);this.runtime.work=true;this.runtime.gift={}}if($("div.messages").text().indexOf("gift")>=0){this.runtime.gift_waiting=true;if(!this.runtime.gift.id)return false;this.runtime.gift.sender_id=$("div.messages img[uid]").first().attr("uid");if(this.runtime.gift.sender_id)this.runtime.gift.sender_fb_name=$("div.messages img[uid]").first().attr("title");else log("Can't find the gift sender's ID.")}else{this.runtime.gift_waiting=
false;this.runtime.gift={}}}else if(Page.page==="army_gifts"){this.data.gifts={};d=this.data.gifts;$('div[id*="_giftContainer"] div[id*="_gift"]').each(function(f,g){f=$("img",g).attr("src").filepart();var h=$(g).text().trim().replace("!","");g=$(g).attr("id").regex(/_gift([0-9]+)/);d[f]={};d[f].name=h;d[f].slot=g})}else if($("div.result").text().indexOf("have exceed")!==-1){debug("We have run out of gifts to send.  Waiting one hour to retry.");this.runtime.gift_delay=Date.now()+36E5;iscaap()&&this.JustDidIt("WaitForNextGiftSend")}return false};
Gift.work=function(c){if(length(f)&&this.runtime.gift_delay<Date.now())return this.runtime.work=true;if(!c){if(this.runtime.gift_waiting||this.runtime.work)return true;return false}if(!this.runtime.gift_waiting&&!this.runtime.work)return false;if(this.runtime.gift_waiting&&!this.runtime.gift.id)if(!Page.to("index"))return true;if(this.runtime.gift.id&&!this.runtime.gift.sender_id)if(!Page.to("army_invite"))return true;if(this.runtime.gift.sender_id){if(!Page.to("army_invite"))return true;if(!Page.to("army_invite",
"?act=acpt&rqtp=gift&uid="+this.runtime.gift.sender_id)||this.runtime.gift.sender_id.length>0)return true}var d,e,f=this.data.todo;c=this.data.received;var g=[],h;if(!c.length&&(!length(f)||this.runtime.gift_delay>Date.now())){this.runtime.work=false;Page.to("keep_alchemy");return false}if(c.length){Page.to("army_gifts");for(d in c){g=this.option.type;if(typeof this.data.gifts[c[d].id]==="undefined"&&this.option.type!="None"){debug(c[d].id+" was not found in our sendable gift list.");g="Random"}switch(g){case "Random":if(length(this.data.gifts)){g=
[];for(e in this.data.gifts)g.push(e);h=Math.floor(Math.random()*g.length);debug("Will randomly send a "+this.data.gifts[g[h]].name+" to "+c[d].sender_ca_name);f[g[h]]||(f[g[h]]=[]);f[g[h]].push(c[d].sender_id)}this.runtime.work=true;break;case "Same as Received":debug("Will return a "+c[d].name+" to "+c[d].sender_ca_name);f[c[d].id]||(f[c[d].id]=[]);f[c[d].id].push(c[d].sender_id);this.runtime.work=true;break;case "None":default:this.runtime.work=false;break}}for(d in c)c.shift()}if(this.runtime.gift_sent>
Date.now()){if($('div.dialog_buttons input[name="sendit"]').length){this.runtime.gift_sent=null;Page.click('div.dialog_buttons input[name="sendit"]')}else if($('span:contains("Out of requests")')){debug("We have run out of gifts to send.  Waiting one hour to retry.");this.runtime.gift_delay=Date.now()+36E5;Page.click('div.dialog_buttons input[name="ok"]')}return true}else if(this.runtime.gift_sent)this.runtime.gift_sent=null;if(length(f)&&(!this.runtime.gift_delay||this.runtime.gift_delay<Date.now()))for(d in f){if(!Page.to("army_gifts"))return true;
if(typeof this.data.gifts[d]==="undefined"){g=[];for(e in this.data.gifts)g.push(e);h=Math.floor(Math.random()*g.length);debug("Unavaliable gift ("+d+") found in todo list. Will randomly send a "+this.data.gifts[g[h]].name+" instead.");f[g[h]]||(f[g[h]]=[]);for(e in f[d])f[g[h]].push(f[d][e]);delete f[d];return true}if($('div[style*="giftpage_select"] div a[href*="giftSelection='+this.data.gifts[d].slot+'"]').length)if($('img[src*="gift_invite_castle_on"]').length){if($("div.unselected_list").children().length){debug("Sending out "+
this.data.gifts[d].name);c=0;for(e in f[d])if(c<30)if($("div.unselected_list input[value='"+f[d][e]+"']").length){Page.click('div.unselected_list input[value="'+f[d][e]+'"]');c++}if(c==0){delete f[d];return true}this.runtime.sent_id=d;this.runtime.gift_sent=Date.now()+6E4;Page.click('input[name="send"]')}}else $('div.tabBtn img.imgButton[src*="gift_invite_castle_off"]').length&&Page.click('div.tabBtn img.imgButton[src*="gift_invite_castle_off"]');else $('div[style*="giftpage_select"]').length&&Page.click('a[href*="giftSelection='+
this.data.gifts[d].slot+'"]:parent');return true}return false};var Heal=new Worker("Heal");Heal.data=null;Heal.defaults.castle_age={};Heal.option={stamina:0,health:0};Heal.display=[{id:"stamina",label:"Heal Above",after:"stamina",select:"stamina"},{id:"health",label:"...And Below",after:"health",select:"health"}];
Heal.work=function(c){if(Player.get("health")>=Player.get("maxhealth")||Player.get("stamina")<Heal.option.stamina||Player.get("health")>=Heal.option.health)return QUEUE_FINISH;if(!c||this.me())return QUEUE_CONTINUE;return QUEUE_RELEASE};Heal.me=function(){if(!Page.to("keep_stats"))return true;debug("Healing...");$('input[value="Heal Wounds"]').length?Page.click('input[value="Heal Wounds"]'):log("Danger Danger Will Robinson... Unable to heal!");return false};var History=new Worker("History");
History.option=null;History.defaults={castle_age:{init:function(){if(Player.data.history){this.data=Player.data.history;delete Player.data.history}}}};
History.dashboard=function(){var c=[];c.push('<table cellspacing="0" cellpadding="0" class="golem-graph"><thead><tr><th></th><th colspan="73"><span style="float:left;">&lArr; Older</span>72 Hour History<span style="float:right;">Newer &rArr;</span><th></th></th></tr></thead><tbody>');c.push(this.makeGraph(["land","income"],"Income",true,{"Average Income":this.get("land.mean")+this.get("income.mean")}));c.push(this.makeGraph("bank","Bank",true,Land.runtime.best?{"Next Land":Land.runtime.cost}:null));
c.push(this.makeGraph("exp","Experience",false,{"Next Level":Player.get("maxexp")}));c.push(this.makeGraph("exp.change","Exp Gain",false,{Average:this.get("exp.average.change"),"Standard Deviation":this.get("exp.stddev.change"),"Ignore entries above":this.get("exp.mean.change")+2*this.get("exp.stddev.change")}));c.push("</tbody></table>");$("#golem-dashboard-History").html(c.join(""))};History.update=function(){var c,d=Math.floor(Date.now()/36E5)-168;for(c in this.data)c<d&&delete this.data[c]};
History.set=function(c,d){if(d){this._unflush();var e=Math.floor(Date.now()/36E5);c=typeof c==="string"?c.split("."):typeof c==="object"?c:[];if(c.length&&(typeof c[0]==="number"||!c[0].regex(/[^0-9]/gi)))e=c.shift();this.data[e]=this.data[e]||{};this.data[e][c[0]]=d}};
History.add=function(c,d){if(d){this._unflush();var e=Math.floor(Date.now()/36E5);c=typeof c==="string"?c.split("."):typeof c==="object"?c:[];if(c.length&&(typeof c[0]==="number"||!c[0].regex(/[^0-9]/gi)))e=c.shift();this.data[e]=this.data[e]||{};this.data[e][c[0]]=(this.data[e][c[0]]||0)+d}};
History.math={stddev:function(c){var d,e=0,f=this.mean(c);for(d in c)e+=Math.pow(c[d]-f,2);e/=c.length;return Math.sqrt(e)},average:function(c){var d,e=this.mean(c),f=this.stddev(c);for(d in c)Math.abs(c[d]-e)>f*2&&delete c[d];return sum(c)/c.length},mean:function(c){return sum(c)/c.length},harmonic:function(c){var d,e=[];for(d in c)c[d]&&e.push(1/c[d]);return e.length/sum(e)},geometric:function(c){var d,e=1;for(d in c)e*=c[d]||1;return Math.pow(e,1/c.length)},median:function(c){c.sort(function(d,
e){return d-e});if(c.length%2)return(c[Math.floor(c.length/2)]+c[Math.ceil(c.length/2)])/2;return c[Math.floor(c.length/2)]},mode:function(c){var d,e=0,f=0,g={};for(d in c)g[c[d]]=(g[c[d]]||0)+1;g=sortObject(g,function(h,k){return g[k]-g[h]});for(d in g)if(g[d]===g[0]){e+=parseInt(g[d]);f++}return e/f},max:function(c){c.sort(function(d,e){return e-d});return c[0]},min:function(c){c.sort(function(d,e){return d-e});return c[0]}};
History.get=function(c){this._unflush();var d,e,f,g=null,h=[],k=this.data;c=typeof c==="string"?c.split("."):typeof c==="object"?c:[];var l=Math.floor(Date.now()/36E5),m=false,p=168,n=false;if(c.length&&(typeof c[0]==="number"||!c[0].regex(/[^0-9]/gi)))l=c.shift();if(c.length&&(typeof c[c.length-1]==="number"||!c[c.length-1].regex(/[^0-9]/gi)))p=Math.range(1,parseInt(c.pop()),168);if(!c.length)return k;for(d in k)if(typeof k[d][c[0]]==="number"){m=true;break}if(c.length===1){if(m)return k[l][c[0]];
for(e in k[l])if(e.indexOf(c[0]+"+")===0&&typeof k[l][e]==="number")f=(f||0)+k[l][e];return f}if(c.length===2&&c[1]==="change"){if(k[l]&&k[l-1]){d=this.get([l,c[0]]);e=this.get([l-1,c[0]]);if(typeof d==="number"&&typeof e==="number")return d-e;return 0}return 0}if(c.length>2&&c[2]==="change")n=true;for(d=l-p;d<=l;d++)if(k[d]){f=null;if(m){if(typeof k[d][c[0]]==="number")f=k[d][c[0]]}else for(e in k[d])if(e.indexOf(c[0]+"+")===0&&typeof k[d][e]==="number")f=(f||0)+k[d][e];if(n){if(f!==null&&g!==null){h.push(f-
g);isNaN(h[h.length-1])&&debug("NaN: "+f+" - "+g)}g=f}else f!==null&&h.push(f)}if(History.math[c[1]])return History.math[c[1]](h);throw"Wanting to get unknown History type "+c[1]+" on "+c[0];};History.getTypes=function(c){var d,e=[],f={},g=this.data;c=c+"+";for(d in g)if(d.indexOf(c)===0)f[d]=true;for(d in f)e.push(d);return e};
History.makeGraph=function(c,d,e,f){var g,h,k=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,m,p=[],n=[],q=[],o=[],r={},t="";o=1;var s="",v=Math.floor(Date.now()/36E5);if(typeof f==="number")f=[f];else if(typeof f!=="array"&&typeof f!=="object")f=null;if(f&&length(f))for(g in f){k=Math.min(k,f[g]);l=Math.max(l,f[g])}if(typeof c==="string")c=[c];for(g=v-72;g<=v;g++){r[g]=[0];if(this.data[g]){for(h in c)r[g][h]=this.get(g+"."+c[h]);if(sum(r[g]))k=Math.min(k,sum(r[g]));l=Math.max(l,sum(r[g]))}}if(l>=
1E9){o=1E9;s="b"}else if(l>=1E6){o=1E6;s="m"}else if(l>=1E3){o=1E3;s="k"}l=Math.ceil(l/o)*o;c=(e?"$":"")+addCommas(l/o)+s;k=Math.floor(k/o)*o;m=(e?"$":"")+addCommas(k/o)+s;if(f&&length(f)){for(g in f){q.push('<div style="bottom:'+Math.max(Math.floor((f[g]-k)/(l-k)*100),0)+'px;"></div>');p.push("<div"+(typeof g!=="number"?' title="'+g+'"':"")+' style="bottom:'+Math.range(2,Math.ceil((f[g]-k)/(l-k)*100)-2,92)+'px;">'+(e?"$":"")+addCommas((f[g]/o).round(1))+s+"</div>")}t='<div class="goal">'+q.reverse().join("")+
"</div>";p.reverse()}th(n,"<div>"+c+"</div><div>"+d+"</div><div>"+m+"</div>");for(g=v-72;g<=v;g++){q=[];o=[];f=[];d=v-g+" hour"+(v-g==1?"":"s")+" ago";s=0;for(h in r[g]){q.push('<div style="height:'+Math.max(Math.ceil(100*(r[g][h]-(!s?k:0))/(l-k)),0)+'px;"></div>');s++;if(r[g][h])f.push(r[g][h]?(e?"$":"")+addCommas(r[g][h]):"")}o.push('<div class="bars">'+q.reverse().join("")+"</div>"+t);f.reverse();d=d+(f.length?", ":"")+f.join(" + ")+(f.length>1?" = "+(e?"$":"")+addCommas(sum(r[g])):"");td(n,o.join(""),
'title="'+d+'"')}th(n,p.join(""));return"<tr>"+n.join("")+"</tr>"};var Idle=new Worker("Idle");Idle.defaults.castle_age={};Idle.settings={after:["LevelUp"]};Idle.data=null;Idle.option={general:"any",index:"Daily",alchemy:"Daily",quests:"Never",town:"Never",battle:"Quarterly",monsters:"Hourly",collect:"Never"};Idle.when=["Never","Quarterly","Hourly","2 Hours","6 Hours","12 Hours","Daily","Weekly"];
Idle.display=[{label:"<strong>NOTE:</strong> Any workers below this will <strong>not</strong> run!<br>Use this for disabling workers you do not use."},{id:"general",label:"Idle General",select:"generals"},{label:"Check Pages:"},{id:"index",label:"Home Page",select:Idle.when},{id:"alchemy",label:"Alchemy",select:Idle.when},{id:"quests",label:"Quests",select:Idle.when},{id:"town",label:"Town",select:Idle.when},{id:"battle",label:"Battle",select:Idle.when},{id:"monsters",label:"Monsters",select:Idle.when},
{id:"collect",label:"Apprentice Reward",select:Idle.when}];
Idle.work=function(c){if(!c)return true;var d,e,f={index:["index"],alchemy:["keep_alchemy"],quests:["quests_quest1","quests_quest2","quests_quest3","quests_quest4","quests_quest5","quests_quest6","quests_quest7","quests_quest8","quests_demiquests","quests_atlantis"],town:["town_soldiers","town_blacksmith","town_magic","town_land"],battle:["battle_battle"],monsters:["keep_monster","battle_raid"],collect:["apprentice_collect"]},g={Never:0,Quarterly:9E5,Hourly:36E5,"2 Hours":72E5,"6 Hours":216E5,"12 Hours":432E5,
Daily:864E5,Weekly:6048E5};if(!Generals.to(this.option.general))return true;for(d in f)if(g[this.option[d]]){e=Date.now()-g[this.option[d]];for(c=0;c<f[d].length;c++)if(!Page.get(f[d][c])||Page.get(f[d][c])<e)if(!Page.to(f[d][c])){Page.set(f[d][c],Date.now());return true}}return true};var Income=new Worker("Income");Income.data=null;Income.settings={important:true};Income.defaults.castle_age={};Income.option={general:true,bank:true,margin:45};
Income.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true},{advanced:true,id:"margin",label:"Safety Margin",select:[15,30,45,60],suffix:"seconds"}];
Income.work=function(c){if(!Income.option.margin)return QUEUE_FINISH;if(Player.get("cash_timer")>this.option.margin){if(c&&this.option.bank)return Bank.work(true);return QUEUE_FINISH}if(!c||this.option.general&&!Generals.to("income"))return QUEUE_CONTINUE;debug("Waiting for Income... ("+Player.get("cash_timer")+" seconds)");return QUEUE_CONTINUE};var Land=new Worker("Land");Land.defaults.castle_age={pages:"town_land"};Land.option={enabled:true,onlyten:false,sell:false,land_exp:false};
Land.runtime={lastlevel:0,best:null,buy:0,cost:0};Land.display=[{id:"enabled",label:"Auto-Buy Land",checkbox:true},{advanced:true,id:"sell",label:"Sell Extra Land",checkbox:true,help:"You can sell land above your Max at full price."},{exploit:true,id:"land_exp",label:"Sell Extra Land 10 at a time",checkbox:true,help:"If you have extra lands, this will sell 10x.  The extra sold lands will be repurchased at a lower cost."}];
Land.parse=function(c){$("tr.land_buy_row,tr.land_buy_row_unique").each(function(d,e){d=$("img",e).attr("alt");var f;if(c){iscaap()&&$(".land_buy_info strong:first",e).after('<strong title="Daily Return On Investment - higher is better"> | ROI '+(Land.data[d].own<Land.data[d].max?Land.data[d].income*2400/Land.data[d].cost:0).round(3)+"%</strong>");!iscaap()&&$(".land_buy_info strong:first",e).after(' - (<strong title="Return On Investment - higher is better">ROI</strong>: '+(Land.data[d].income*100/
Land.data[d].cost).round(3)+"%)")}else{!$(".land_buy_image_int",e).length&&$(".land_buy_image",e).prepend('<div class="land_buy_image_int"></div>').children(".land_buy_image_int").append($('.land_buy_image >[class!="land_buy_image_int"]',e));!$(".land_buy_info_int",e).length&&$(".land_buy_info",e).prepend('<div class="land_buy_info_int"></div>').children(".land_buy_info_int").append($('.land_buy_info >[class!="land_buy_info_int"]',e));Land.data[d]={};Land.data[d].income=$(".land_buy_info .gold",e).text().replace(/[^0-9]/g,
"").regex(/([0-9]+)/);Land.data[d].max=$(".land_buy_info",e).text().regex(/Max Allowed For your level: ([0-9]+)/i);Land.data[d].cost=$(".land_buy_costs .gold",e).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);if(f=$("option",$(".land_buy_costs .gold",e).parent().next()).last().attr("value"))Land.data[d].buy=f;Land.data[d].own=$(".land_buy_costs span",e).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)}});return true};
Land.update=function(){var c,d=Bank.worth(),e=Player.get("income")+History.get("income.mean"),f,g=0;if(this.option.land_exp){$("input:golem(land,sell)").attr("checked",true);this.option.sell=true}for(c in this.data){if(this.option.sell&&this.data[c].own>this.data[c].max){f=c;g=this.data[c].max-this.data[c].own;if(this.option.land_exp)g=-10;break}if(this.data[c].buy)if(!f||this.data[f].cost/e+this.data[c].cost/(e+this.data[f].income)>this.data[c].cost/e+this.data[f].cost/(e+this.data[c].income))f=
c}if(f){if(!g){c=this.data[f].cost/(10+this.data[f].own)/this.data[f].income;c*=1.5;g=this.data[f].cost*10<=d?Math.min(this.data[f].max-this.data[f].own,10):this.data[f].cost/e>c?1:this.data[f].cost*5/e>c?Math.min(this.data[f].max-this.data[f].own,5):Math.min(this.data[f].max-this.data[f].own,10)}this.runtime.buy=g;this.runtime.cost=g*this.data[f].cost;Dashboard.status(this,(g>0?this.runtime.buy?"Buying ":"Want to buy ":this.runtime.buy?"Selling ":"Want to sell ")+Math.abs(g)+"x "+f+" for $"+addCommas(Math.abs(this.runtime.cost)))}else Dashboard.status(this);
this.runtime.best=f};
Land.work=function(c){if(!this.option.enabled||!this.runtime.best||!this.runtime.buy||!Bank.worth(this.runtime.cost)){if(!this.runtime.best&&this.runtime.lastlevel<Player.get("level")){if(!c||!Page.to("town_land"))return QUEUE_CONTINUE;this.runtime.lastlevel=Player.get("level")}return QUEUE_FINISH}if(!c||!Bank.retrieve(this.runtime.cost)||!Page.to("town_land"))return QUEUE_CONTINUE;$("tr.land_buy_row,tr.land_buy_row_unique").each(function(d,e){if($("img",e).attr("alt")===Land.runtime.best){Land.runtime.buy>0?
$("select",$(".land_buy_costs .gold",e).parent().next()).val(Land.runtime.buy>5?10:Land.runtime.buy>1?5:1):$("select",$(".land_buy_costs .gold",e).parent().parent().next()).val(Land.runtime.buy<=-10?10:Land.runtime.buy<=-5?5:1);debug((Land.runtime.buy>0?"Buy":"Sell")+"ing "+Math.abs(Land.runtime.buy)+" x "+Land.runtime.best+" for $"+addCommas(Math.abs(Land.runtime.cost)));Page.click($('.land_buy_costs input[name="'+(Land.runtime.buy>0?"Buy":"Sell")+'"]',e))}});return QUEUE_RELEASE};var LevelUp=new Worker("LevelUp");
LevelUp.data=null;LevelUp.settings={before:["Idle","Battle","Monster","Quest"]};LevelUp.defaults.castle_age={pages:"*"};LevelUp.option={enabled:false,income:true,bank:true,general:"any",order:"stamina",algorithm:"Per Action"};LevelUp.runtime={level:0,heal_me:false,battle_monster:false,old_quest:null,old_quest_energy:0,running:false,energy:0,stamina:0,exp:0,exp_possible:0,energy_samples:0,exp_per_energy:1,stamina_samples:0,exp_per_stamina:1,quests:[]};
LevelUp.display=[{title:"Important!",label:"This will spend Energy and Stamina to force you to level up quicker."},{id:"enabled",label:"Enabled",checkbox:true},{id:"income",label:"Allow Income General",checkbox:true},{id:"bank",label:"Allow Bank General",checkbox:true},{id:"general",label:"Best General",select:["any","Energy","Stamina"],help:"Select which type of general to use when leveling up."},{id:"order",label:"Spend first ",select:["Energy","Stamina"],help:"Select which resource you want to spend first when leveling up."},
{id:"algorithm",label:"Estimation Method",select:["Per Action","Per Hour"],help:"'Per Hour' uses your gain per hour. 'Per Action' uses your gain per action."}];LevelUp.init=function(){this._watch(Player);this._watch(Quest);this.runtime.exp=this.runtime.exp||Player.get("exp");this.runtime.level=this.runtime.level||Player.get("level")};
LevelUp.parse=function(c){c?$("#app"+APPID+"_st_2_5 strong").attr("title",Player.get("exp")+"/"+Player.get("maxexp")+" at "+addCommas(this.get("exp_average").round(1))+" per hour").html(addCommas(Player.get("exp_needed"))+'<span style="font-weight:normal;"> in <span class="golem-time" style="color:rgb(25,123,48);" name="'+this.get("level_time")+'">'+makeTimer(this.get("level_timer"))+"</span></span>"):$(".result_body").each(function(d,e){if($('img[src$="battle_victory.gif"]',e).length){d=$(e).text().replace(/,|\t/g,
"");(e=d.regex(/([+-][0-9]+) Experience/i))&&History.add("exp+battle",e);(e=(d.regex(/\+\$([0-9]+)/i)||0)-(d.regex(/\-\$([0-9]+)/i)||0))&&History.add("income+battle",e);(e=d.regex(/([+-][0-9]+) Battle Points/i))&&History.add("bp+battle",e);(e=d.regex(/([+-][0-9]+) Stamina/i))&&History.add("stamina+battle",e);(e=d.regex(/([+-][0-9]+) Energy/i))&&History.add("energy+battle",e)}});return true};
LevelUp.update=function(c,d){var e,f,g,h=Player.get("energy"),k=Player.get("stamina");f=Player.get("exp");c=this.runtime;var l=Config.getOrder();if(d===Player||!length(c.quests)){if(f!==c.exp)if(c.stamina>k){c.exp_per_stamina=(c.exp_per_stamina*Math.min(c.stamina_samples,49)+(f-c.exp)/(c.stamina-k))/Math.min(c.stamina_samples+1,50);c.stamina_samples=Math.min(c.stamina_samples+1,50)}else if(c.energy>h){c.exp_per_energy=(c.exp_per_energy*Math.min(c.energy_samples,9)+(f-c.exp)/(c.energy-h))/Math.min(c.energy_samples+
1,10);c.energy_samples=Math.min(c.energy_samples+1,10)}c.energy=h;c.stamina=k;c.exp=f}if(d===Quest||!length(c.quests)){f=Quest.get();c.quests=d=[[0]];for(e in f)if(!d[f[e].energy]||f[e].exp>d[f[e].energy][0])d[f[e].energy]=[f[e].exp,[e]];f=1;g=[0];for(e=1;e<d.length;e++)if(d[e]&&d[e][0]/e>=g[0]/f){f=e;g=d[e]}else d[e]=[g[0],[g[1][0]]];for(;d.length>1&&d[d.length-1][0]===d[d.length-2][0];)d.pop()}c.exp_possible=this.runtime.quests.length<=1?1:h<this.runtime.quests.length?this.runtime.quests[Math.min(h,
this.runtime.quests.length-1)][0]:this.runtime.quests[this.runtime.quests.length-1][0]*Math.floor(h/(this.runtime.quests.length-1))+this.runtime.quests[h%(this.runtime.quests.length-1)][0];if(arrayIndexOf(l,"Idle")>=arrayIndexOf(l,"Monster")&&Monster.runtime.attack||arrayIndexOf(l,"Idle")>=arrayIndexOf(l,"Battle"))c.exp_possible+=Math.floor(k*c.exp_per_stamina);e=new Date(this.get("level_time"));if(this.option.enabled)c.running?Dashboard.status(this,'<span title="Exp Possible: '+this.runtime.exp_possible+
", per Hour: "+addCommas(this.get("exp_average").round(1))+", per Energy: "+this.runtime.exp_per_energy.round(2)+", per Stamina: "+this.runtime.exp_per_stamina.round(2)+'">LevelUp Running Now!</span>'):Dashboard.status(this,'<span title="Exp Possible: '+this.runtime.exp_possible+", per Energy: "+this.runtime.exp_per_energy.round(2)+", per Stamina: "+this.runtime.exp_per_stamina.round(2)+'">'+e.format("l g:i a")+" (at "+addCommas(this.get("exp_average").round(1))+" exp per hour)</span>");else Dashboard.status(this)};
LevelUp.work=function(c){var d=this.runtime,e=Player.get("energy"),f=Player.get("stamina"),g=Config.getOrder();d.running&&this.option.income&&Queue.get("runtime.current")===Income&&Generals.set("runtime.disabled",false);d.running&&this.option.bank&&Queue.get("runtime.current")===Bank&&Generals.set("runtime.disabled",false);if(d.old_quest){Quest.runtime.best=d.old_quest;Quest.runtime.energy=d.old_quest_energy;d.old_quest=null;d.old_quest_energy=0}if(!this.option.enabled||d.exp_possible<Player.get("exp_needed")){if(d.running&&
d.level<Player.get("level")){if($("#app"+APPID+"_energy_current_value").next().css("color")==="rgb(25, 123, 48)"&&e>=Player.get("maxenergy")){Queue.burn.energy=e;Queue.burn.stamina=0;return false}if($("#app"+APPID+"_stamina_current_value").next().css("color")==="rgb(25, 123, 48)"&&f>=Player.get("maxstamina")){Queue.burn.energy=0;Queue.burn.stamina=f;return false}Generals.set("runtime.disabled",false);Queue.burn.stamina=Math.max(0,f-Queue.get("option.stamina"));Queue.burn.energy=Math.max(0,e-Queue.get("option.energy"));
Battle.set("option.monster",d.battle_monster);d.running=false}else if(d.running&&d.level==Player.get("level")){Generals.set("runtime.disabled",false);Queue.burn.stamina=Math.max(0,f-Queue.get("option.stamina"));Queue.burn.energy=Math.max(0,e-Queue.get("option.energy"));Battle.set("option.monster",d.battle_monster);d.running=false}return false}if(c&&d.heal_me){if(Heal.me())return true;d.heal_me=false}if(c&&!d.running){d.level=Player.get("level");d.battle_monster=Battle.get("option.monster");d.running=
true;Battle.set("option.monster",false)}if((c=Generals.best(this.option.general))&&c!=="any"&&Player.get("exp_needed")<100){Generals.set("runtime.disabled",false);if(c===Player.get("general")||Generals.to(c))Generals.set("runtime.disabled",true);else return true}if(this.option.order!=="Stamina"||!f||f<Monster.runtime.stamina&&(!Battle.runtime.attacking||arrayIndexOf(g,"Idle")<=arrayIndexOf(g,"Battle"))||arrayIndexOf(g,"Idle")<=arrayIndexOf(g,"Monster")||!Monster.runtime.attack){debug("Running Energy Burn");
if(Player.get("energy")){d.old_quest=Quest.runtime.best;d.old_quest_energy=Quest.runtime.energy;Queue.burn.energy=e;Queue.burn.stamina=0;Quest.runtime.best=d.quests[Math.min(d.energy,d.quests.length-1)][1][0];Quest.runtime.energy=e;return false}}else debug("Running Stamina Burn");Quest._update("data");if(d.level===Player.get("level")&&Player.get("health")<13&&f)return d.heal_me=true;Queue.burn.energy=0;Queue.burn.stamina=f;return false};
LevelUp.get=function(c){var d=Date.now();switch(c){case "timer":return makeTimer(this.get("level_timer"));case "time":return(new Date(this.get("level_time"))).format("l g:i a");case "level_timer":return Math.floor((this.get("level_time")-d)/1E3);case "level_time":return d+Math.floor(36E5*((Player.get("exp_needed")-this.runtime.exp_possible)/(this.get("exp_average")||10)));case "exp_average":return this.option.algorithm=="Per Hour"?History.get("exp.average.change"):12*(this.runtime.exp_per_stamina+
this.runtime.exp_per_energy);default:return this._get(c)}};var Monster=new Worker("Monster");Monster.data={};Monster.defaults.castle_age={pages:"keep_monster keep_monster_active keep_monster_active2 battle_raid"};
Monster.option={fortify:30,min_to_attack:0,fortify_active:false,choice:"Any",ignore_stats:true,stop:"Never",own:true,armyratio:1,levelratio:"Any",force1:true,raid:"Invade x5",assist:true,maxstamina:5,minstamina:5,maxenergy:10,minenergy:10,monster_check:"Hourly",check_interval:36E5,avoid_behind:false,avoid_hours:5,behind_override:false};Monster.runtime={check:false,uid:null,type:null,fortify:false,attack:false,stamina:5,health:10};
Monster.display=[{title:"Fortification"},{id:"fortify",label:"Fortify Below (AB)",text:30,help:"Fortify if ATT BONUS is under this value. Range of -50% to +50%.",after:"%"},{id:"min_to_attack",label:"Attack Over (AB)",text:1,help:"Attack if ATT BONUS is over this value. Range of -50% to +50%.",after:"%"},{id:"fortify_active",label:"Fortify Active",checkbox:true,help:"Must be checked to fortify."},{title:"Who To Fight"},{advanced:true,id:"ignore_stats",label:"Ignore Player Stats",checkbox:true,help:"Do not use the current health or stamina as criteria for choosing monsters."},
{id:"choice",label:"Attack",select:["Any","Strongest","Weakest","Shortest ETD","Longest ETD","Spread","Max Damage","Mim Damage","ETD Maintain"]},{id:"stop",label:"Stop",select:["Never","Achievement","Loot"],help:"Select when to stop attacking a target."},{id:"maxstamina",label:"Max Stamina Cost",select:[1,5,10,20,50],help:"Select the maximum stamina for a single attack"},{id:"minstamina",label:"Min Stamina Cost",select:[1,5,10,20,50],help:"Select the minimum stamina for a single attack"},{id:"maxenergy",
label:"Max Energy Cost",select:[10,20,40,100],help:"Select the maximum energy for a single energy action"},{id:"minenergy",label:"Min Energy Cost",select:[10,20,40,100],help:"Select the minimum energy for a single energy action"},{advanced:true,id:"own",label:"Never stop on Your Monsters",checkbox:true,help:"Never stop attacking your own summoned monsters (Ignores Stop option)."},{advanced:true,id:"avoid_behind",label:"Avoid Upside-Down Monsters",checkbox:true,help:"Avoid Monsters that behind in ETD as compared to CA Timer."},
{advanced:true,id:"avoid_hours",label:"Upside-Down Hours",text:true,help:"# of Hours Monster must be behind before preventing attacks."},{advanced:true,id:"behind_override",label:"Stop Override",checkbox:true,help:"Continue attacking monsters that meet Stop option but are upside-down (Kill In greater than Time Left). Attempts to bring Kill In below Time Left if damage is at or above Stop Option. Works in coordination with Avoid Upside-Down Monsters)"},{title:"Raids"},{id:"raid",label:"Raid",select:["Invade",
"Invade x5","Duel","Duel x5"]},{id:"armyratio",label:"Target Army Ratio<br>(Only needed for Invade)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for smaller target army. Reduce this number if you're losing in Invade"},{id:"levelratio",label:"Target Level Ratio<br>(Mainly used for Duel)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for lower target level. Reduce this number if you're losing a lot"},{id:"force1",label:"Force +1",checkbox:true,
help:"Force the first player in the list to aid."},{title:"Siege Assist Options"},{id:"assist",label:"Assist with Sieges",help:"Spend stamina to assist with sieges.",checkbox:true},{id:"assist_links",label:"Use Assist Links in Dashboard",checkbox:true},{advanced:true,id:"monster_check",label:"Monster Review",select:["Quarterly","1/2 Hour","Hourly","2 Hours","6 Hours","12 Hours","Daily","Weekly"],help:"Sets how ofter to check Monster Stats."}];
Monster.types={raid_easy:{name:"The Deathrune Siege",list:"deathrune_list1.jpg",image:"raid_title_raid_a1.jpg",image2:"raid_title_raid_a2.jpg",dead:"raid_1_large_victory.jpg",achievement:100,timer:216E3,timer2:302400,raid:true},raid:{name:"The Deathrune Siege",list:"deathrune_list2.jpg",image:"raid_title_raid_b1.jpg",image2:"raid_title_raid_b2.jpg",dead:"raid_1_large_victory.jpg",achievement:100,timer:319920,timer2:519960,raid:true},colossus:{name:"Colossus of Terra",list:"stone_giant_list.jpg",image:"stone_giant_large.jpg",
dead:"stone_giant_dead.jpg",achievement:2E4,timer:259200,mpool:1,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},gildamesh:{name:"Gildamesh, the Orc King",list:"orc_boss_list.jpg",image:"orc_boss.jpg",dead:"orc_boss_dead.jpg",achievement:15E3,timer:259200,mpool:1,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},keira:{name:"Keira the Dread Knight",list:"boss_keira_list.jpg",image:"boss_keira.jpg",dead:"boss_keira_dead.jpg",achievement:3E4,timer:172800,mpool:1,atk_btn:'input[name="Attack Dragon"]',
attacks:[1,5]},lotus:{name:"Lotus Ravenmoore",list:"boss_lotus_list.jpg",image:"boss_lotus.jpg",dead:"boss_lotus_big_dead.jpg",achievement:5E5,timer:172800,mpool:1,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},mephistopheles:{name:"Mephistopheles",list:"boss_mephistopheles_list.jpg",image:"boss_mephistopheles_large.jpg",dead:"boss_mephistopheles_dead.jpg",achievement:1E5,timer:172800,mpool:1,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},skaar:{name:"Skaar Deathrune",list:"death_list.jpg",
image:"death_large.jpg",dead:"death_dead.jpg",achievement:1E6,timer:345E3,mpool:1,atk_btn:'input[name="Attack Dragon"][src*="attack"]',attacks:[1,5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="dispel"]',defends:[10,20,40,100]},sylvanus:{name:"Sylvana the Sorceress Queen",list:"boss_sylvanus_list.jpg",image:"boss_sylvanus_large.jpg",dead:"boss_sylvanus_dead.jpg",achievement:5E4,timer:172800,mpool:1,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},dragon_emerald:{name:"Emerald Dragon",list:"dragon_list_green.jpg",
image:"dragon_monster_green.jpg",dead:"dead_dragon_image_green.jpg",achievement:1E5,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},dragon_frost:{name:"Frost Dragon",list:"dragon_list_blue.jpg",image:"dragon_monster_blue.jpg",dead:"dead_dragon_image_blue.jpg",achievement:1E5,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},dragon_gold:{name:"Gold Dragon",list:"dragon_list_yellow.jpg",image:"dragon_monster_gold.jpg",dead:"dead_dragon_image_gold.jpg",
achievement:1E5,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},dragon_red:{name:"Ancient Red Dragon",list:"dragon_list_red.jpg",image:"dragon_monster_red.jpg",dead:"dead_dragon_image_red.jpg",achievement:1E5,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5]},serpent_amethyst:{name:"Amethyst Sea Serpent",list:"seamonster_list_purple.jpg",image:"seamonster_purple.jpg",dead:"seamonster_dead.jpg",title:"seamonster_title_amethyst.jpg",achievement:25E4,
timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5],def_btn:'input[name="Defend against Monster"]',defends:[10]},serpent_ancient:{name:"Ancient Sea Serpent",list:"seamonster_list_red.jpg",image:"seamonster_red.jpg",dead:"seamonster_dead.jpg",title:"seamonster_title_ancient.jpg",achievement:25E4,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5],def_btn:'input[name="Defend against Monster"]',defends:[10]},serpent_emerald:{name:"Emerald Sea Serpent",list:"seamonster_list_green.jpg",
image:"seamonster_green.jpg",dead:"seamonster_dead.jpg",title:"seamonster_title_emerald.jpg",achievement:25E4,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5],def_btn:'input[name="Defend against Monster"]',defends:[10]},serpent_sapphire:{name:"Sapphire Sea Serpent",list:"seamonster_list_blue.jpg",image:"seamonster_blue.jpg",dead:"seamonster_dead.jpg",title:"seamonster_title_sapphire.jpg",achievement:25E4,timer:259200,mpool:2,atk_btn:'input[name="Attack Dragon"]',attacks:[1,
5],def_btn:'input[name="Defend against Monster"]',defends:[10]},cronus:{name:"Cronus, The World Hydra",list:"hydra_head.jpg",image:"hydra_large.jpg",dead:"hydra_dead.jpg",achievement:5E5,timer:604800,mpool:3,atk_btn:'input[name="Attack Dragon"]',attacks:[1,5,10,20,50]},legion:{name:"Battle of the Dark Legion",list:"castle_siege_list.jpg",image:"castle_siege_large.jpg",dead:"castle_siege_dead.jpg",achievement:1E3,timer:604800,mpool:3,atk_btn:'input[name="Attack Dragon"][src*="attack"]',attacks:[1,
5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="fortify"]',defends:[10,20,40,100],orcs:true},genesis:{name:"Genesis, The Earth Elemental",list:"earth_element_list.jpg",image:"earth_element_large.jpg",dead:"earth_element_dead.jpg",achievement:1E6,timer:604800,mpool:3,atk_btn:'input[name="Attack Dragon"][src*="attack"]',attacks:[1,5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="fortify"]',defends:[10,20,40,100]},ragnarok:{name:"Ragnarok, The Ice Elemental",list:"water_list.jpg",image:"water_large.jpg",
dead:"water_dead.jpg",achievement:1E6,timer:604800,mpool:3,atk_btn:'input[name="Attack Dragon"][src*="attack"]',attacks:[1,5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="dispel"]',defends:[10,20,40,100]},bahamut:{name:"Bahamut, the Volcanic Dragon",list:"nm_volcanic_list.jpg",image:"nm_volcanic_large.jpg",dead:"nm_volcanic_dead.jpg",achievement:1E6,timer:604800,mpool:3,atk_btn:'input[name="Attack Dragon"][src*="stab"],input[name="Attack Dragon"][src*="bolt"],input[name="Attack Dragon"][src*="smite"],input[name="Attack Dragon"][src*="bash"]',
attacks:[5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="cripple"],input[name="Attack Dragon"][src*="deflect"],input[name="Attack Dragon"][src*="heal"],input[name="Attack Dragon"][src*="strengthen"]',defends:[10,20,40,100]},alpha_bahamut:{name:"Alpha Bahamut, the Volcanic Dragon",list:"nm_volcanic_list_2.jpg",image:"nm_volcanic_large_2.jpg",dead:"nm_volcanic_dead_2.jpg",achievement:3E6,timer:604800,mpool:3,atk_btn:'input[name="Attack Dragon"][src*="stab"],input[name="Attack Dragon"][src*="bolt"],input[name="Attack Dragon"][src*="smite"],input[name="Attack Dragon"][src*="bash"]',
attacks:[5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="cripple"],input[name="Attack Dragon"][src*="deflect"],input[name="Attack Dragon"][src*="heal"],input[name="Attack Dragon"][src*="strengthen"]',defends:[10,20,40,100]},azriel:{name:"Azriel, the Angel of Wrath",list:"nm_azriel_list.jpg",image:"nm_azriel_large2.jpg",dead:"nm_azriel_dead.jpg",achievement:3E6,timer:604800,mpool:1,atk_btn:'input[name="Attack Dragon"][src*="stab"],input[name="Attack Dragon"][src*="bolt"],input[name="Attack Dragon"][src*="smite"],input[name="Attack Dragon"][src*="bash"]',
attacks:[5,10,20,50],def_btn:'input[name="Attack Dragon"][src*="cripple"],input[name="Attack Dragon"][src*="deflect"],input[name="Attack Dragon"][src*="heal"],input[name="Attack Dragon"][src*="strengthen"]',defends:[10,20,40,100]}};Monster.health_img=['img[src$="nm_red.jpg"]','img[src$="monster_health_background.jpg"]'];Monster.shield_img=['img[src$="bar_dispel.gif"]'];Monster.defense_img=['img[src$="nm_green.jpg"]','img[src$="seamonster_ship_health.jpg"]'];Monster.secondary_img=['img[src$="nm_stun_bar.gif"]'];
Monster.class_img=['div[style*="nm_bottom"] img[src$="nm_class_warrior.jpg"]','div[style*="nm_bottom"] img[src$="nm_class_cleric.jpg"]','div[style*="nm_bottom"] img[src$="nm_class_rogue.jpg"]','div[style*="nm_bottom"] img[src$="nm_class_mage.jpg"]'];Monster.class_name=["Warrior","Cleric","Rogue","Mage"];Monster.class_off=["","",'img[src$="nm_s_off_cripple.gif"]','img[src$="nm_s_off_deflect.gif"]'];
Monster.init=function(){var c,d;this.runtime.count=0;for(c in this.data)for(d in this.data[c]){this.data[c][d].state==="engage"&&this.runtime.count++;if(typeof this.data[c][d].ignore==="unknown")this.data[c][d].ignore=false;if(typeof this.data[c][d].dispel!=="undefined"){this.data[c][d].defense=100-this.data[c][d].dispel;delete this.data[c][d].dispel}}this._watch(Player);$("#golem-dashboard-Monster tbody td a").live("click",function(){var e=$(this).attr("href");Page.to(e.indexOf("raid")>0?"battle_raid":
"keep_monster",e.substr(e.indexOf("?")));return false})};
Monster.parse=function(){var c;Battle.get("user");var d,e,f=false,g,h,k=Monster.data,l=Monster.types;if(Page.page==="keep_monster_active"||Page.page==="keep_monster_active2"){d=$('img[linked][size="square"]').attr("uid");for(c in l)if(l[c].dead&&$('img[src$="'+l[c].dead+'"]').length&&!l[c].title){e=c;h=l[c].timer;f=true}else if(l[c].dead&&$('img[src$="'+l[c].dead+'"]').length&&l[c].title&&$('div[style*="'+l[c].title+'"]').length){e=c;h=l[c].timer;f=true}else if(l[c].image&&($('img[src$="'+l[c].image+
'"]').length||$('div[style*="'+l[c].image+'"]').length)){e=c;h=l[c].timer}else if(l[c].image2&&($('img[src$="'+l[c].image2+'"]').length||$('div[style*="'+l[c].image2+'"]').length)){e=c;h=l[c].timer2||l[c].timer}if(!d||!e){debug("Unknown monster (probably dead)");return false}k[d]=k[d]||{};k[d][e]=k[d][e]||{};g=k[d][e];g.last=Date.now();if($('input[src*="collect_reward_button.jpg"]').length){g.state="reward";return false}if(f&&g.state==="assist")g.state=null;else if(f&&g.state==="engage")g.state="reward";
else{if(!g.state&&$("span.result_body").text().match(/for your help in summoning|You have already assisted on this objective|You don't have enough stamina assist in summoning/i)){if($("span.result_body").text().match(/for your help in summoning/i))g.assist=Date.now();g.state="assist"}if(this.runtime.attacked&&$('span[class="positive"]').length&&typeof $('span[class="positive"]').prevAll("span").text().regex(/([0-9]+)/)==="number"){this.runtime.post_stamina=Player.get("stamina");if(g.battle_stamina)g.battle_stamina+=
this.runtime.pre_stamina-this.runtime.post_stamina;else g.battle_stamina=this.runtime.pre_stamina-this.runtime.post_stamina;if(d=$('span[class="positive"]').prevAll("span").text().regex(/([0-9]+)/)){g.dmg_per_stamina=g.dmg_per_stamina?Math.ceil((g.dmg_per_stamina+d/(this.runtime.pre_stamina-this.runtime.post_stamina))/2):Math.ceil(d/g.battle_stamina);g.dmg_avg=g.dmg_avg?Math.ceil((g.dmg_avg+d)/2):d}this.runtime.pre_stamina=this.runtime.post_stamina=0;this.runtime.attacked=false}if(this.runtime.defended&&
$('span[class="positive"]').length&&typeof $('span[class="positive"]').prevAll("span").text().regex(/([0-9]+)/)==="number"){this.runtime.post_energy=Player.get("energy");d=$('span[class="positive"]').prevAll("span").text().regex(/([0-9]+)/);if(g.battle_energy)g.battle_energy+=this.runtime.pre_energy-this.runtime.post_energy;else g.battle_energy=this.runtime.pre_energy-this.runtime.post_energy;if(d){g.dfd_per_energy=g.dfd_per_energy?Math.ceil((g.dfd_per_energy+d/(this.runtime.pre_energy-this.runtime.post_energy))/
2):Math.ceil(d/g.battle_energy);g.dfd_avg=g.dfd_avg?Math.ceil((g.dfd_avg+d)/2):d}this.runtime.pre_energy=this.runtime.post_energy=0;this.runtime.defended=false}if($('img[src$="battle_victory.gif"],img[src$="battle_defeat.gif"],span["result_body"] a:contains("Attack Again")').length)g.battle_count=(g.battle_count||0)+1;$('img[src$="battle_victory"]').length&&History.add("raid+win",1);$('img[src$="battle_defeat"]').length&&History.add("raid+loss",-1);if(!g.name){d=$('img[linked][size="square"]').parent().parent().next().text().trim().replace(/[\s\n\r]{2,}/g,
" ");g.name=d.regex(/(.+)'s /i)}for(c in Monster.class_img)if($(Monster.class_img[c]).length)g.mclass=c;if(g.mclass>1)if($(Monster.class_off[g.mclass]).length===0)for(c in Monster.secondary_img){d=$(Monster.secondary_img[c]);if(d.length){g.secondary=100*d.width()/d.parent().width();break}}for(c in Monster.health_img)if($(Monster.health_img[c]).length){d=$(Monster.health_img[c]).parent();g.health=d.length?100*d.width()/d.parent().width():0;break}for(c in Monster.shield_img)if($(Monster.shield_img[c]).length){d=
$(Monster.shield_img[c]).parent();g.defense=100*(1-d.width()/(d.next().length?d.width()+d.next().width():d.parent().width()));g.attackbonus=g.defense*(isNumber(g.strength)?g.strength/100:1)-50;break}for(c in Monster.defense_img)if($(Monster.defense_img[c]).length){c=$(Monster.defense_img[c]).parent();g.defense=c.width()/(c.next().length?c.width()+c.next().width():c.parent().width())*100;g.strength=c.parent().width()<c.parent().parent().width()?100*c.parent().width()/c.parent().parent().width():100;
g.attackbonus=g.defense*(isNumber(g.strength)?g.strength/100:1)-50;break}g.timer=$("#app"+APPID+"_monsterTicker").text().parseTimer();g.finish=Date.now()+g.timer*1E3;g.damage_total=0;g.damage_siege=0;g.damage_players=0;g.fortify=0;g.damage={};$('img[src*="siege_small"]').each(function(m,p){m=$(p).parent().next().next().next().children().eq(0).text();p=$(p).parent().next().next().next().children().eq(1).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);g.damage[m]=[p];g.damage_siege+=p});$('td.dragonContainer table table a[href^="http://apps.facebook.com/castle_age/keep.php?user="]').each(function(m,
p){m=$(p).attr("href").regex(/user=([0-9]+)/i);var n=null;n=l[e].raid?$(p).parent().next().text().replace(/[^0-9\/]/g,""):$(p).parent().parent().next().text().replace(/[^0-9\/]/g,"");p=n.regex(/([0-9]+)/);n=n.regex(/\/([0-9]+)/);g.damage[m]=n?[p,n]:[p];if(m===userID){g.damage_user=p;if(g.dmg_per_stamina&&g.battle_stamina){for(;g.dmg_per_stamina*g.battle_stamina<g.damage_user*0.99;)g.battle_stamina++;for(;g.dmg_per_stamina*g.battle_stamina>=g.damage_user*1.01;)g.battle_stamina--}}g.damage_players+=
p;if(n)g.fortify+=n});g.damage_total=l[e].orcs?Math.ceil(g.damage_siege/1E3)+g.damage_players:g.damage_siege+g.damage_players;g.dps=g.damage_players/(h-g.timer);g.total=l[e].raid?g.damage_total+$('div[style*="monster_health_back.jpg"] div:nth-child(2)').text().regex(/([0-9]+)/):Math.ceil((1+100*g.damage_total)/(g.health==100?0.1:100-g.health));g.eta=Date.now()+Math.floor((g.total-g.damage_total)/g.dps)*1E3}}else if(Page.page==="keep_monster"||Page.page==="battle_raid"){if(!$("#app"+APPID+"_app_body div.imgButton").length)return false;
if(Page.page==="battle_raid")raid=true;for(d in k)for(e in k[d])if((Page.page==="battle_raid"&&this.types[e].raid||Page.page==="keep_monster"&&!this.types[e].raid)&&(k[d][e].state==="complete"||k[d][e].state==="assist"&&k[d][e].finish<Date.now()))k[d][e].state=null;$("#app"+APPID+"_app_body div.imgButton").each(function(m,p){var n=$("a",p).attr("href").regex(/user=([0-9]+)/i),q=$(p).parent().parent().children().eq(1).html().regex(/graphics\/([^.]*\....)/i),o="unknown";for(m in l)if(q==l[m].list){o=
m;break}if(!(!n||o==="unknown")){k[n]=k[n]||{};k[n][o]=k[n][o]||{};if(n===userID)k[n][o].name="You";else{q=$(p).parent().parent().children().eq(2).text().trim();k[n][o].name=q.regex(/(.+)'s /i)}switch($("img",p).attr("src").regex(/dragon_list_btn_([0-9])/)){case 2:k[n][o].state="reward";break;case 3:k[n][o].state="engage";break;case 4:k[n][o].state="complete";break;default:k[n][o].state="unknown";break}}})}return false};
Monster.update=function(){var c,d,e=[],f=this.runtime.uid,g=this.runtime.type,h=null,k,l,m;this.runtime.count=0;for(c in this.data){for(d in this.data[c])if(!this.data[c][d].state||this.data[c][d].state===null){log("Found Invalid Monster State=("+this.data[c][d].state+")");delete this.data[c][d]}else this.data[c][d].state==="engage"&&this.runtime.count++;if(!length(this.data[c])){log("Found Invalid Monster ID=("+this.data[c]+")");delete this.data[c]}}if(!f||!g||!this.data[f]||!this.data[f][g]||this.data[f][g].state!==
"engage"&&this.data[f][g].state!=="assist"){this.runtime.uid=f=null;this.runtime.type=g=null}g=f=null;switch(this.option.monster_check){case "Quarterly":if(this.option.check_interval!==9E5)this.option.check_interval=9E5;break;case "1/2 Hour":if(this.option.check_interval!==18E5)this.option.check_interval=18E5;break;case "Hourly":if(this.option.check_interval!==36E5)this.option.check_interval=36E5;break;case "2 Hours":if(this.option.check_interval!==72E5)this.option.check_interval=72E5;break;case "6 Hours":if(this.option.check_interval!==
216E5)this.option.check_interval=216E5;break;case "12 Hours":if(this.option.check_interval!==432E5)this.option.check_interval=432E5;break;case "Daily":if(this.option.check_interval!==864E5)this.option.check_interval=864E5;break;case "Weekly":if(this.option.check_interval!==6048E5)this.option.check_interval=6048E5;break}for(c in this.data)for(d in this.data[c]){if((!this.data[c][d].health&&this.data[c][d].state==="engage"||typeof this.data[c][d].last==="undefined"||this.data[c][d].last<Date.now()-
this.option.check_interval)&&(typeof this.data[c][d].ignore==="undefined"||!this.data[c][d].ignore&&this.data[c][d].state!=="complete")&&!this.runtime.check){this.runtime.check=true;break}k=this.types[d].raid&&this.option.raid.search("x5")==-1?1:this.types[d].raid?5:this.option.minstamina<Math.min.apply(Math,this.types[d].attacks)||this.option.maxstamina<Math.min.apply(Math,this.types[d].attacks)?Math.min.apply(Math,this.types[d].attacks):this.option.minstamina>Math.max.apply(Math,this.types[d].attacks)?
Math.max.apply(Math,this.types[d].attacks):this.option.minstamina>this.option.maxstamina?this.option.maxstamina:this.option.minstamina;m=this.types[d].def_btn?this.option.minenergy:null;l=this.types[d].raid?13:10;if((typeof this.data[c][d].ignore==="undefined"||!this.data[c][d].ignore)&&this.data[c][d].state==="engage"&&this.data[c][d].finish>Date.now()&&(this.option.ignore_stats||Player.get("health")>=l)&&(Queue.burn.energy>=m||(this.option.ignore_stats||Queue.burn.stamina>=k)&&(typeof this.data[c][d].attackbonus===
"undefined"||this.data[c][d].attackbonus>=this.option.min_to_attack||this.data[c][d].attackbonus<=this.option.fortify&&this.option.fortify_active&&Queue.burn.energy>=m))){if(!this.data[c][d].battle_count)this.data[c][d].battle_count=1;if(this.data[c][d].name==="You"&&this.option.own){e.push([c,d,this.data[c][d].health,this.data[c][d].eta,this.data[c][d].battle_count,((sum(this.data[c][d].damage[userID])||0)/this.data[c][d].damage_total*100).round(4),this.data[c][d].finish,(this.data[c][d].eta-this.data[c][d].finish)/
36E5]);break}else if(this.option.behind_override&&this.data[c][d].eta>=this.data[c][d].finish-this.option.check_interval&&sum(this.data[c][d].damage[userID])>this.types[d].achievement){e.push([c,d,this.data[c][d].health,this.data[c][d].eta,this.data[c][d].battle_count,((sum(this.data[c][d].damage[userID])||0)/this.data[c][d].damage_total*100).round(4),this.data[c][d].finish,(this.data[c][d].eta-this.data[c][d].finish)/36E5]);break}else switch(this.option.stop){default:case "Never":e.push([c,d,this.data[c][d].health,
this.data[c][d].eta,this.data[c][d].battle_count,((sum(this.data[c][d].damage[userID])||0)/this.data[c][d].damage_total*100).round(4),this.data[c][d].finish,(this.data[c][d].eta-this.data[c][d].finish)/36E5]);break;case "Achievement":if(isNumber(this.types[d].achievement)&&(typeof this.data[c][d].damage[userID]==="undefined"||sum(this.data[c][d].damage[userID])<this.types[d].achievement))e.push([c,d,this.data[c][d].health,this.data[c][d].eta,this.data[c][d].battle_count,((sum(this.data[c][d].damage[userID])||
0)/this.data[c][d].damage_total*100).round(4),this.data[c][d].finish,(this.data[c][d].eta-this.data[c][d].finish)/36E5]);break;case "Loot":if(isNumber(this.types[d].achievement)&&(typeof this.data[c][d].damage[userID]==="undefined"||sum(this.data[c][d].damage[userID])<(c==userID&&d==="keira"?2E5:2*this.types[d].achievement)))e.push([c,d,this.data[c][d].health,this.data[c][d].eta,this.data[c][d].battle_count,((sum(this.data[c][d].damage[userID])||0)/this.data[c][d].damage_total*100).round(4),this.data[c][d].finish,
(this.data[c][d].eta-this.data[c][d].finish)/36E5]);break}}}if(e.length){e.sort(function(p,n){switch(Monster.option.choice){case "Any":return Math.random()-0.5;case "Strongest":return n[2]-p[2];case "Weakest":return p[2]-n[2];case "Shortest ETD":return p[3]-n[3];case "Longest ETD":return n[3]-p[3];case "Spread":return p[4]-n[4];case "Max Damage":return n[5]-p[5];case "Min Damage":return p[5]-n[5];case "ETD Maintain":return p[7]<n[7]?1:p[7]>n[7]?-1:0}});if(this.option.avoid_behind)for(c=0;c<=e.length-
1;c++){if((e[c][3]/36E5-e[c][6]/36E5).round(0)<=this.option.avoid_hours){h=e[c];break}}else h=e[0]}delete e;if(h){f=h[0];g=h[1]}this.runtime.uid=f;this.runtime.type=g;if(f&&g){this.runtime.stamina=this.types[g].raid&&this.option.raid.search("x5")==-1?1:this.types[g].raid?5:this.option.minstamina<Math.min.apply(Math,this.types[g].attacks)||this.option.maxstamina<Math.min.apply(Math,this.types[g].attacks)?Math.min.apply(Math,this.types[g].attacks):this.option.minstamina>Math.max.apply(Math,this.types[g].attacks)?
Math.max.apply(Math,this.types[g].attacks):this.option.minstamina>this.option.maxstamina?this.option.maxstamina:this.option.minstamina;this.runtime.health=this.types[g].raid?13:10;this.runtime.energy=!this.types[g].defends?10:this.option.minenergy<Math.min.apply(Math,this.types[g].defends)||this.option.maxenergy<Math.min.apply(Math,this.types[g].defends)?Math.min.apply(Math,this.types[g].defends):this.option.minenergy>Math.max.apply(Math,this.types[g].defends)?Math.max.apply(Math,this.types[g].defends):
this.option.minenergy>this.option.maxenergy?this.option.maxenergy:this.option.minenergy;this.runtime.fortify=this.option.fortify_active&&(typeof this.data[f][g].mclass==="undefined"||this.data[f][g].mclass<2)&&typeof this.data[f][g].attackbonus!=="undefined"&&this.data[f][g].attackbonus<this.option.fortify&&this.data[f][g].defense<100?true:this.option.fortify_active&&typeof this.data[f][g].mclass!=="undefined"&&this.data[f][g].mclass>1&&typeof this.data[f][g].secondary!=="undefined"&&this.data[f][g].secondary<
100?true:false;if(Queue.burn.energy<this.runtime.energy)this.runtime.fortify=false;this.runtime.attack=true;if(Player.get("health")>this.runtime.health&&(this.runtime.attack&&Queue.burn.stamina>this.runtime.stamina||this.runtime.fortify&&Queue.burn.energy>this.runtime.energy))Dashboard.status(this,(this.runtime.fortify?"Fortify":"Attack")+" "+this.data[f][g].name+"'s "+this.types[g].name+" (Min Stamina = "+this.runtime.stamina+" & Min Energy = "+this.runtime.energy+")");else if(this.runtime.fortify&&
Queue.burn.energy<this.runtime.energy||!this.runtime.attack)Dashboard.status(this,"Waiting for "+(LevelUp.runtime.running&&LevelUp.option.enabled?this.runtime.energy-Queue.burn.energy:Math.max(this.runtime.energy-Queue.burn.energy,this.runtime.energy+Queue.option.energy-Player.get("energy"),Queue.option.start_energy-Player.get("energy")))+" energy to "+(this.runtime.fortify||!this.runtime.attack?"Fortify":"Attack")+" "+this.data[f][g].name+"'s "+this.types[g].name+" (Min Stamina = "+this.runtime.stamina+
" & Min Energy = "+this.runtime.energy+")");else if(Queue.burn.stamina<this.runtime.stamina)Dashboard.status(this,"Waiting for "+(LevelUp.runtime.running&&LevelUp.option.enabled?this.runtime.stamina-Queue.burn.stamina:Math.max(this.runtime.stamina-Queue.burn.stamina,this.runtime.stamina+Queue.option.stamina-Player.get("stamina"),Queue.option.start_stamina-Player.get("stamina")))+" stamina to "+(this.runtime.fortify?"Fortify":"Attack")+" "+this.data[f][g].name+"'s "+this.types[g].name+" (Min Stamina = "+
this.runtime.stamina+" & Min Energy = "+this.runtime.energy+")");else if(Player.get("health")<this.runtime.health)Dashboard.status(this,"Waiting for "+(this.runtime.health-Player.get("health"))+" health to "+(this.runtime.fortify?"Fortify":"Attack")+" "+this.data[f][g].name+"'s "+this.types[g].name+" (Min Stamina = "+this.runtime.stamina+" & Min Energy = "+this.runtime.energy+")")}else{this.runtime.attack=false;this.runtime.fortify=false;Dashboard.status(this,"Nothing to do.")}};
Monster.work=function(c){var d,e,f=[];f=[];var g=this.runtime.uid,h=this.runtime.type,k=null;if(!this.runtime.check&&(!this.runtime.fortify||Queue.burn.energy<this.runtime.energy||Player.get("health")<10)&&(!this.runtime.attack||Queue.burn.stamina<this.runtime.stamina||Player.get("health")<this.runtime.health))return QUEUE_FINISH;if(!c)return QUEUE_CONTINUE;if(this.runtime.check){for(d in this.data)for(e in this.data[d])if((!this.data[d][e].health&&this.data[d][e].state==="engage"||typeof this.data[d][e].last===
"undefined"||this.data[d][e].last<Date.now()-this.option.check_interval)&&(typeof this.data[d][e].ignore==="undefined"||!this.data[d][e].ignore)){debug("Reviewing "+this.data[d][e].name+"'s "+this.types[e].name);Page.to(this.types[e].raid?"battle_raid":"keep_monster","?user="+d+(this.types[e].mpool?"&mpool="+this.types[e].mpool:""));return QUEUE_CONTINUE}this.runtime.check=false;debug("Finished Monster / Raid review");return QUEUE_RELEASE}if(this.types[h].raid){if(!Generals.to(this.option.raid.search("Invade")==
-1?"raid-duel":"raid-invade"))return QUEUE_CONTINUE;switch(this.option.raid){case "Invade":k=$('input[src$="raid_attack_button.gif"]:first');break;case "Invade x5":k=$('input[src$="raid_attack_button3.gif"]:first');break;case "Duel":k=$('input[src$="raid_attack_button2.gif"]:first');break;case "Duel x5":k=$('input[src$="raid_attack_button4.gif"]:first');break}}else{if(this.data[g][h].button_fail<=10||!this.data[g][h].button_fail){e=this.runtime.fortify&&Queue.burn.energy>=this.runtime.energy?"fortify":
"attack";if(!Generals.to(e))return QUEUE_CONTINUE;debug("Try to "+e+" [UID="+g+"]"+this.data[g][h].name+"'s "+this.types[h].name);switch(e){case "fortify":if(!k&&this.option.maxenergy<this.types[h].defends[0])k=$(this.types[h].def_btn).eq(0);else for(d=d=$(this.types[h].def_btn).length-1;d>=0;d--)if(this.types[h].defends[d]<=this.option.maxenergy&&Queue.burn.energy>=this.types[h].defends[d]){k=$(this.types[h].def_btn).eq(d);break}break;case "attack":if(!k&&this.option.maxstamina<Math.min.apply(Math,
this.types[h].attacks))k=$(this.types[h].atk_btn).eq(0).name;else for(d=d=$(this.types[h].atk_btn).length-1;d>=0;d--)if(this.types[h].attacks[d]<=this.option.maxstamina&&Queue.burn.stamina>=this.types[h].attacks[d]){k=$(this.types[h].atk_btn).eq(d);break}break;default:break}}if(!k||!k.length)this.data[g][h].button_fail+=1;if(this.data[g][h].button_fail>10){log("Ignoring Monster "+this.data[g][h].name+"'s "+this.types[h].name+this.data[g][h]+": Unable to locate "+e+" button "+this.data[g][h].button_fail+
" times!");this.data[g][h].ignore=true;this.data[g][h].button_fail=0}}if(!k||!k.length||Page.page!=="keep_monster_active"&&Page.page!=="keep_monster_active2"||$('div[style*="dragon_title_owner"] img[linked]').attr("uid")!=g&&$('div[style*="nm_top"] img[linked]').attr("uid")!=g){Page.to(this.types[h].raid?"battle_raid":"keep_monster","?user="+g+(this.types[h].mpool?"&mpool="+this.types[h].mpool:""));return QUEUE_CONTINUE}if(this.option.assist&&typeof $('input[name*="help with"]')!=="undefined"&&(typeof this.data[g][h].phase===
"undefined"||$('input[name*="help with"]').attr("title").regex(/ (.*)/i)!==this.data[g][h].phase)){debug("Current Siege Phase is: "+this.data[g][h].phase);this.data[g][h].phase=$('input[name*="help with"]').attr("title").regex(/ (.*)/i);debug("Found a new siege phase ("+this.data[g][h].phase+"), assisting now.");Page.to(this.types[h].raid?"battle_raid":"keep_monster","?user="+g+"&action=doObjective"+(this.types[h].mpool?"&mpool="+this.types[h].mpool:"")+"&lka="+d+"&ref=nf");return QUEUE_RELEASE}if(this.types[h].raid){c=
Battle.get("user");if(this.option.force1){for(d in c)f.push(d);$('input[name*="target_id"]').val(f[Math.floor(Math.random()*f.length)]||0)}f=$('div[id*="raid_atk_lst0"] div div').text().regex(/Lvl\s*([0-9]+).*Army: ([0-9]+)/);if(this.option.armyratio!=="Any"&&f[1]/Player.get("army")>this.option.armyratio||this.option.levelratio!=="Any"&&f[0]/Player.get("level")>this.option.levelratio){log("No valid Raid target!");Page.to("battle_raid","");return QUEUE_CONTINUE}}this.runtime.uid=this.runtime.type=
null;switch(e){case "fortify":this.runtime.pre_energy=Player.get("energy");Page.click(k);this.runtime.defended=true;this.data[g][h].button_fail=0;return QUEUE_RELEASE;case "attack":this.runtime.pre_stamina=Player.get("stamina");Page.click(k);this.runtime.attacked=true;this.data[g][h].button_fail=0;return QUEUE_RELEASE;default:Page.click(k);return QUEUE_RELEASE}};Monster.order=null;
Monster.dashboard=function(c,d){var e,f,g,h,k,l=[],m=[],p=[null,"name","health","defense",null,"timer","eta"],n={engage:0,assist:1,reward:2,complete:3},q;if(typeof c==="undefined"){this.order=[];for(e in this.data)for(f in this.data[e])this.order.push([e,f])}if(typeof c==="undefined")c=this.runtime.sort||1;if(typeof d==="undefined")d=this.runtime.rev||false;this.runtime.sort=c;this.runtime.rev=d;this.order.sort(function(o,r){var t,s;if(n[Monster.data[o[0]][o[1]].state]>n[Monster.data[r[0]][r[1]].state])return 1;
if(n[Monster.data[o[0]][o[1]].state]<n[Monster.data[r[0]][r[1]].state])return-1;if(typeof p[c]==="string"){t=Monster.data[o[0]][o[1]][p[c]];s=Monster.data[r[0]][r[1]][p[c]]}else if(c==4){if(typeof Monster.data[o[0]][o[1]].damage!=="undefined"&&typeof Monster.data[r[0]][r[1]].total!=="undefined")t=sum(Monster.data[o[0]][o[1]].damage[userID]/Monster.data[o[0]][o[1]].total);if(typeof Monster.data[r[0]][r[1]].damage!=="undefined"&&typeof Monster.data[r[0]][r[1]].total!=="undefined")s=sum(Monster.data[r[0]][r[1]].damage[userID]/
Monster.data[r[0]][r[1]].total)}if(typeof t==="undefined")return 1;else if(typeof s==="undefined")return-1;if(typeof t==="string"||typeof s==="string")return d?(s||"")>(t||""):(s||"")<(t||"");return d?(t||0)-(s||0):(s||0)-(t||0)});th(m,"");th(m,"User");th(m,"Health",'title="(estimated)"');th(m,"Att Bonus",'title="Composite of Fortification or Dispel into an approximate attack bonus (+50%...-50%)."');th(m,"Damage");th(m,"Time Left");th(m,"Kill In (ETD)",'title="(estimated)"');th(m,"");l.push('<table cellspacing="0" style="width:100%"><thead><tr>'+
m.join("")+"</tr></thead><tbody>");for(g=0;g<this.order.length;g++){e=this.order[g][0];f=this.order[g][1];if(this.types[f]){m=[];h=this.data[e][f];q=!((h.state==="engage"||h.state==="assist")&&h.total);k=Monster.option.assist_link&&(h.state==="engage"||h.state==="assist")?"?user="+e+"&action=doObjective"+(Monster.types[f].mpool?"&mpool="+Monster.types[f].mpool:"")+"&lka="+e+"&ref=nf":"?user="+e+(Monster.types[f].mpool?"&mpool="+Monster.types[f].mpool:"");td(m,'<a href="http://apps.facebook.com/castle_age/'+
(Monster.types[f].raid?"raid.php":"battle_monster.php")+k+'"><img src="'+imagepath+Monster.types[f].list+'" style="width:72px;height:20px; position: relative; left: -8px; opacity:.7;" alt="'+f+'"><strong class="overlay">'+h.state+"</strong></a>",'title="'+Monster.types[f].name+" | Achievement: "+addCommas(Monster.types[f].achievement)+" | Loot: "+addCommas(Monster.types[f].achievement*2)+'"');th(m,'<a class="golem-monster-ignore" name="'+e+"+"+f+'" title="Toggle Active/Inactive"'+(Monster.data[e][f].ignore?
' style="text-decoration: line-through;"':"")+">"+Monster.data[e][f].name+"</a>");td(m,q?"":h.health===100?"100%":addCommas(h.total-h.damage_total)+" ("+h.health.round(1)+"%)");td(m,q?"":isNumber(h.attackbonus)?h.attackbonus.round(1)+"%":"",isNumber(h.strength)?'title="Max: '+(h.strength-50).round(1)+'%"':"");td(m,q?"":h.state!=="engage"?"":typeof h.damage[userID]==="undefined"?"":addCommas(h.damage[userID][0]||0)+" ("+((h.damage[userID][0]||0)/h.total*100).round(2)+"%)",q?"":'title="In '+(h.battle_count||
"an unknown number of")+' attacks"');td(m,q?"":h.timer?'<span class="golem-timer">'+makeTimer((h.finish-Date.now())/1E3)+"</span>":"?");td(m,q?"":'<span class="golem-timer">'+(h.health===100?makeTimer((h.finish-Date.now())/1E3):makeTimer((h.eta-Date.now())/1E3))+"</span>");th(m,'<a class="golem-monster-delete" name="'+e+"+"+f+'" title="Delete this Monster from the dashboard">[x]</a>');tr(l,m.join(""))}}l.push("</tbody></table>");$("#golem-dashboard-Monster").html(l.join(""));$("a.golem-monster-delete").live("click",
function(){var o=$(this).attr("name").split("+");Monster._unflush();delete Monster.data[o[0]][o[1]];length(Monster.data[o[0]])||delete Monster.data[o[0]];Monster.dashboard();return false});$("a.golem-monster-ignore").live("click",function(){var o=$(this).attr("name").split("+");Monster._unflush();Monster.data[o[0]][o[1]].ignore=!Monster.data[o[0]][o[1]].ignore;Monster.dashboard();Page.page!=="keep_monster"?Page.to("keep_monster"):Page.to("index");return false});if(typeof c!=="undefined")$("#golem-dashboard-Monster thead th:eq("+
c+")").attr("name",d?"reverse":"sort").append("&nbsp;"+(d?"&uarr;":"&darr;"))};var News=new Worker("News");News.data=null;News.option=null;News.defaults.castle_age={pages:"index"};News.runtime={last:0};
News.parse=function(c){if(c){var d=0,e=0,f=0,g=0,h=0,k=0,l;c=[];var m={},p=this.runtime.last;News.runtime.last=Date.now();$("#app"+APPID+"_battleUpdateBox .alertsContainer .alert_content").each(function(n,q){var o;n=$(q).text().replace(/,/g,"");o=$(q).prev().text();var r=o.regex(/([0-9]+) days/i),t=o.regex(/([0-9]+) hours/i),s=o.regex(/([0-9]+) minutes/i),v=o.regex(/([0-9]+) seconds/i),u=o=0,x=0;r=Date.now()-((((r||0)*24+(t||0))*60+(s||59))*60+(v||59))*1E3;if(n.regex(/You were killed/i))h++;else{o=
$("a:eq(0)",q).attr("href").regex(/user=([0-9]+)/i);m[o]=m[o]||{name:$("a:eq(0)",q).text(),win:0,lose:0};q=null;if(n.regex(/Victory!/i)){f++;m[o].lose++;o=n.regex(/([0-9]+) experience/i);u=n.regex(/([0-9]+) Battle Points!/i);x=n.regex(/\$([0-9]+)/i);q="win"}else{g++;m[o].win++;o=0-n.regex(/([0-9]+) experience/i);u=0-n.regex(/([0-9]+) Battle Points!/i);x=0-n.regex(/\$([0-9]+)/i);q="loss"}if(r>p){r=Math.floor(r/36E5);History.add([r,"exp+battle"],o);History.add([r,"bp+battle"],u);History.add([r,"income+battle"],
x);switch(q){case "win":History.add([r,"battle+win"],1);break;case "loss":History.add([r,"battle+loss"],-1);break}}d+=o;e+=u;k+=x}});if(f||g){c.push("You were challenged <strong>"+(f+g)+"</strong> times, winning <strong>"+f+"</strong> and losing <strong>"+g+"</strong>.");c.push("You "+(d>=0?'gained <span class="positive">':'lost <span class="negative">')+addCommas(Math.abs(d))+"</span> experience points.");c.push("You "+(k>=0?'gained <span class="positive">':'lost <span class="negative">')+'<b class="gold">$'+
addCommas(Math.abs(k))+"</b></span>.");c.push("You "+(e>=0?'gained <span class="positive">':'lost <span class="negative">')+addCommas(Math.abs(e))+"</span> Battle Points.");c.push("");m=sortObject(m,function(n,q){return m[q].win+m[q].lose/100-(m[n].win+m[n].lose/100)});for(l in m)c.push('<strong title="'+l+'">'+m[l].name+"</strong> "+(m[l].win?'beat you <span class="negative">'+m[l].win+"</span> time"+(m[l].win>1?"s":""):"")+(m[l].lose?(m[l].win?" and ":"")+'was beaten <span class="positive">'+m[l].lose+
"</span> time"+(m[l].lose>1?"s":""):"")+".");if(h)c.push("You died "+(h>1?h+" times":"once")+"!");$("#app"+APPID+"_battleUpdateBox  .alertsContainer").prepend('<div style="padding: 0pt 0pt 10px;"><div class="alert_title">Summary:</div><div class="alert_content">'+c.join("<br>")+"</div></div>")}}return true};var Player=new Worker("Player");Player.option=null;Player.settings={keep:true};Player.defaults.castle_age={pages:"*"};
Player.runtime={cash_timeout:null,energy_timeout:null,health_timeout:null,stamina_timeout:null};var use_average_level=false;Player.init=function(){var c=new Date(script_started+$("*").html().regex(/gold_increase_ticker\(([0-9]+),/)*1E3);this.data.cash_time=c.getSeconds()+c.getMinutes()*60;this.runtime.cash_timeout=null;this.runtime.energy_timeout=null;this.runtime.health_timeout=null;this.runtime.stamina_timeout=null};
Player.parse=function(){var c=this.data,d;if($("#app"+APPID+"_energy_current_value").length){d=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);c.energy=d[0]||0}if($("#app"+APPID+"_health_current_value").length){d=$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);c.health=d[0]||0}if($("#app"+APPID+"_stamina_current_value").length){d=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);
c.stamina=d[0]||0}if($("#app"+APPID+"_st_2_5 strong:not([title])").length){d=$("#app"+APPID+"_st_2_5").text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);c.exp=d[0]||0;c.maxexp=d[1]||0}c.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);c.level=$("#app"+APPID+"_st_5").text().regex(/Level: ([0-9]+)!/i);c.armymax=$("a[href*=army.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/);c.army=Math.min(c.armymax,501);c.upgrade=$("a[href*=keep.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/)||
0;c.general=$("div.general_name_div3").first().text().trim();c.imagepath=$("#app"+APPID+"_globalContainer img:eq(0)").attr("src").pathpart();if(Page.page==="keep_stats"){d=$("div.keep_attribute_section").first();if(d.length){c.myname=$("div.keep_stat_title_inc > span",d).text().regex(/"(.*)"/);c.rank=$("td.statsTMainback img[src*=rank_medals]").attr("src").filepart().regex(/([0-9]+)/);d=$("div.attribute_stat_container",d);c.maxenergy=$(d).eq(0).text().regex(/([0-9]+)/);c.maxstamina=$(d).eq(1).text().regex(/([0-9]+)/);
c.attack=$(d).eq(2).text().regex(/([0-9]+)/);c.defense=$(d).eq(3).text().regex(/([0-9]+)/);c.maxhealth=$(d).eq(4).text().regex(/([0-9]+)/);c.bank=parseInt($("td.statsTMainback b.money").text().replace(/[^0-9]/g,""),10);d=$('.statsTB table table:contains("Total Income")').text().replace(/[^0-9$]/g,"").regex(/([0-9]+)\$([0-9]+)\$([0-9]+)/);c.maxincome=d[0];c.upkeep=d[1];c.income=d[2]}}if(Page.page==="town_land"){d=$(".mContTMainback div:last-child");c.income=d.eq(d.length-4).text().replace(/[^0-9]/g,
"").regex(/([0-9]+)/)}$("span.result_body").each(function(e,f){e=$(f).text().replace(/,|\s+|\n/g,"");History.add("income",sum(e.regex(/Gain.*\$([0-9]+).*Cost|stealsGold:\+\$([0-9]+)|Youreceived\$([0-9]+)|Yougained\$([0-9]+)/i)));e.regex(/incomepaymentof\$([0-9]+)gold/i)&&History.set("land",sum(e.regex(/incomepaymentof\$([0-9]+)gold|backinthemine:Extra([0-9]+)Gold/i)))});if($("#app"+APPID+"_energy_time_value").length){window.clearTimeout(this.runtime.energy_timeout);this.runtime.energy_timeout=window.setTimeout(function(){Player.get("energy")},
$("#app"+APPID+"_energy_time_value").text().parseTimer()*1E3)}if($("#app"+APPID+"_health_time_value").length){window.clearTimeout(this.runtime.health_timeout);this.runtime.health_timeout=window.setTimeout(function(){Player.get("health")},$("#app"+APPID+"_health_time_value").text().parseTimer()*1E3)}if($("#app"+APPID+"_stamina_time_value").length){window.clearTimeout(this.runtime.stamina_timeout);this.runtime.stamina_timeout=window.setTimeout(function(){Player.get("stamina")},$("#app"+APPID+"_stamina_time_value").text().parseTimer()*
1E3)}$("strong#app"+APPID+"_gold_current_value").attr("title","Cash in Bank: $"+addCommas(c.bank));return false};
Player.update=function(c){if(c!=="option"){var d,e=["stamina","energy","health"],f,g;for(d=0;d<e.length;d++){f=[];g=Divisor(Player.data["max"+e[d]]);for(c=0;c<=Player.data["max"+e[d]];c+=g)f.push(c);Config.set(e[d],f)}History.set("bank",this.data.bank);History.set("exp",this.data.exp)}Dashboard.status(this,"Income: $"+addCommas(Math.max(this.data.income,(History.get("land.average.1")+History.get("income.average.24")).round()))+" per hour (currently $"+addCommas(History.get("land.average.1"))+" from land)")};
Player.get=function(c){var d=this.data;Date.now();switch(c){case "cash":return this.data.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);case "cash_timer":c=new Date;return(3600+d.cash_time-(c.getSeconds()+c.getMinutes()*60))%3600;case "energy":return this.data.energy=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "energy_timer":return $("#app"+APPID+"_energy_time_value").text().parseTimer();case "health":return this.data.health=
$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "health_timer":return $("#app"+APPID+"_health_time_value").text().parseTimer();case "stamina":return this.data.stamina=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "stamina_timer":return $("#app"+APPID+"_stamina_time_value").text().parseTimer();case "exp_needed":return d.maxexp-d.exp;case "pause":return Queue.get("option.pause")?"(Paused) ":"";default:return this._get(c)}};
var Potions=new Worker("Potions");Potions.defaults.castle_age={pages:"*"};Potions.option={energy:35,stamina:35};Potions.runtime={drink:false};
Potions.display=[{id:"energy",label:"Maximum Energy Potions",select:{0:0,5:5,10:10,15:15,20:20,25:25,30:30,35:35,40:40,infinite:"&infin;"},help:"Will use them when you have to many, if you collect more than 40 they will be lost anyway"},{id:"stamina",label:"Maximum Stamina Potions",select:{0:0,5:5,10:10,15:15,20:20,25:25,30:30,35:35,40:40,infinite:"&infin;"},help:"Will use them when you have to many, if you collect more than 40 they will be lost anyway"}];
Potions.parse=function(){$('.result_body:contains("You have acquired the Energy Potion!")').each(function(){Potions.data.Energy=(Potions.data.Energy||0)+1});if(Page.page==="keep_stats"){this.data={};$(".statsT2:eq(2) .statUnit").each(function(c,d){if((c=$(d).text().replace(/\s+/g," ").trim().regex(/(.*) Potion x ([0-9]+)/i))&&c[0]&&c[1])Potions.data[c[0]]=c[1]})}return false};
Potions.update=function(){var c=[],d=LevelUp.get("runtime.running");this.runtime.drink=false;for(var e in this.data){this.data[e]&&c.push(e+": "+this.data[e]+"/"+this.option[e.toLowerCase()]);if(!d&&typeof this.option[e.toLowerCase()]==="number"&&this.data[e]>this.option[e.toLowerCase()]&&(Player.get(e.toLowerCase())||0)<(Player.get("max"+e.toLowerCase())||0))this.runtime.drink=true}Dashboard.status(this,c.join(", "))};
Potions.work=function(c){if(!this.runtime.drink)return QUEUE_FINISH;if(!c||!Page.to("keep_stats"))return QUEUE_CONTINUE;for(var d in this.data)if(typeof this.option[d.toLowerCase()]==="number"&&this.data[d]>this.option[d.toLowerCase()]){debug("Wanting to drink a "+d+" potion");Page.click('.statUnit:contains("'+d+'") form .imgButton input');break}return QUEUE_RELEASE};var Quest=new Worker("Quest");Quest.defaults.castle_age={pages:"quests_quest1 quests_quest2 quests_quest3 quests_quest4 quests_quest5 quests_quest6 quests_quest7 quests_quest8 quests_demiquests quests_atlantis"};
Quest.option={general:true,what:"Influence",unique:true,monster:true,bank:true};Quest.runtime={best:null,energy:0};Quest.land=["Land of Fire","Land of Earth","Land of Mist","Land of Water","Demon Realm","Undead Realm","Underworld","Kingdom of Heaven"];Quest.area={quest:"Quests",demiquest:"Demi Quests",atlantis:"Atlantis"};Quest.current=null;
Quest.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"what",label:"Quest for",select:"quest_reward",help:"Once you have unlocked all areas (Advancement) it will switch to Influence. Once you have 100% Influence it will switch to Experience"},{id:"unique",label:"Get Unique Items First",checkbox:true},{id:"monster",label:"Fortify Monsters First",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true}];
Quest.init=function(){for(var c in this.data)c.indexOf("\t")!==-1&&delete this.data[c]};
Quest.parse=function(){var c=this.data,d=null,e=null,f;if(Page.page==="quests_quest")return false;else if(Page.page==="quests_demiquests")d="demiquest";else if(Page.page==="quests_atlantis")d="atlantis";else{d="quest";e=Page.page.regex(/quests_quest([0-9]+)/i)-1}for(f in c)if(c[f].area===d&&(d!=="quest"||c[f].land===e))delete c[f];if($("div.quests_background,div.quests_background_sub").length!==$("div.quests_background .quest_progress,div.quests_background_sub .quest_sub_progress").length){Page.to(Page.page,"");
return false}$("div.quests_background,div.quests_background_sub,div.quests_background_special").each(function(g,h){var k,l,m,p,n,q=0;if($(h).hasClass("quests_background_sub")){g=$(".quest_sub_title",h).text().trim();m=$(".qd_2_sub",h).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);n=$(".qd_3_sub",h).text().regex(/([0-9]+)/);k=$(".quest_sub_progress",h).text().regex(/LEVEL ([0-9]+)/i);l=$(".quest_sub_progress",h).text().regex(/INFLUENCE: ([0-9]+)%/i);q=2}else{g=$(".qd_1 b",h).text().trim();
m=$(".qd_2",h).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);n=$(".quest_req b",h).text().regex(/([0-9]+)/);if($(h).hasClass("quests_background")){k=$(".quest_progress",h).text().regex(/LEVEL ([0-9]+)/i);l=$(".quest_progress",h).text().regex(/INFLUENCE: ([0-9]+)%/i);q=1}else q=3}if(!(!g||g.indexOf("\t")!==-1)){c[g]={};c[g].area=d;c[g].type=q;c[g].id=parseInt($('input[name="quest"]',h).val());if(typeof e==="number")c[g].land=e;if(typeof l==="number"){c[g].level=k||0;c[g].influence=
l}c[g].exp=m[0];c[g].reward=(m[1]+m[2])/2;c[g].energy=n;if(q!==2){if(q===3)c[g].unique=true;k=$(".qd_1 img",h).last();if(k.length&&k.attr("title")){c[g].item=k.attr("title").trim();c[g].itemimg=k.attr("src").filepart()}p={};$(".quest_req >div >div >div",h).each(function(o,r){o=$("img",r).attr("title");p[o]=$(r).text().regex(/([0-9]+)/)});if(length(p))c[g].units=p;k=$(".quest_act_gen img",h);if(k.length&&k.attr("title"))c[g].general=k.attr("title")}}});this.data=sortObject(c,function(g,h){return g>
h});return false};
Quest.update=function(c,d){if(!(d===Town&&c!=="data")){var e,f,g,h=false,k=d=null,l=null,m=null,p=0;h=[];var n=this.data;if(!c||c==="data"){for(e in n)n[e].item&&!n[e].unique&&h.push(n[e].item);Config.set("quest_reward",["Nothing","Influence","Advancement","Experience","Cash"].concat(unique(h).sort()))}if(this.option.unique&&Alchemy._changed>this.lastunique){for(e in n)if(n[e].unique)if(!Alchemy.get(["ingredients",n[e].itemimg])&&(!d||n[e].energy<n[d].energy))d=e;this.lastunique=Date.now()}if(!d&&
this.option.what!=="Nothing"){for(e in n){if(n[e].units){h=false;for(f in n[e].units){c=Town.get([f,"own"],0);g=n[e].units[f];if(g>c)h=true}if(h)continue}switch(this.option.what){case "Advancement":if(n[e].type!==2&&typeof n[e].land==="number"&&n[e].land>=p&&(n[e].influence<100||n[e].unique&&!Alchemy.get(["ingredients",n[e].itemimg]))&&(!k||n[e].land>(n[k].land||0)||n[e].land===n[k].land&&n[e].unique&&!length(Player.data[n[e].item]))){p=Math.max(p,n[e].land);k=e}case "Influence":if(typeof n[e].influence!==
"undefined"&&n[e].influence<100&&(!l||n[e].energy<n[l].energy))l=e;case "Experience":if(!m||n[e].energy/n[e].exp<n[m].energy/n[m].exp)m=e;break;case "Cash":if(!d||n[e].energy/n[e].reward<n[d].energy/n[d].reward)d=e;break;default:if(n[e].item===this.option.what&&(!d||n[e].energy<n[d].energy))d=e;break}}switch(this.option.what){case "Advancement":d=k||l||m;break;case "Influence":d=l||m;break;case "Experience":d=m;break;default:break}}if(d!==this.runtime.best)if(this.runtime.best=d){this.runtime.energy=
n[d].energy;debug("Wanting to perform - "+d+" in "+(typeof n[d].land==="number"?this.land[n[d].land]:this.area[n[d].area])+" (energy: "+n[d].energy+", experience: "+n[d].exp+", reward: $"+addCommas(n[d].reward)+")")}d?Dashboard.status(this,(typeof n[d].land==="number"?this.land[n[d].land]:this.area[n[d].area])+": "+d+" (energy: "+n[d].energy+", experience: "+n[d].exp+", reward: $"+addCommas(n[d].reward)+(typeof n[d].influence!=="undefined"?", influence: "+n[d].influence+"%)":"")):Dashboard.status(this)}};
Quest.work=function(c){var d,e,f=null,g=this.runtime.best;if(!g||this.runtime.energy>Queue.burn.energy){if(c&&this.option.bank)return Bank.work(true);return QUEUE_FINISH}if(this.option.monster&&Monster.data&&Monster.option.fortify_active)for(d in Monster.data)for(e in Monster.data[d]){if(Monster.data[d][e].state==="engage"&&typeof Monster.data[d][e].defense==="number"&&(typeof Monster.data[d][e].mclass==="undefined"||Monster.data[d][e].mclass<2)&&typeof Monster.data[d][e].attackbonus!=="undefined"&&
Monster.data[d][e].attackbonus<Monster.option.fortify&&Monster.data[d][e].defense<100)return QUEUE_FINISH;if(Monster.option.fortify_active&&typeof Monster.data[d][e].mclass!=="undefined"&&Monster.data[d][e].mclass>1&&typeof Monster.data[d][e].secondary!=="undefined"&&Monster.data[d][e].secondary<100)return QUEUE_FINISH}if(!c)return QUEUE_CONTINUE;if(this.option.general)if(this.data[g].general&&typeof this.data[g].influence==="number"&&this.data[g].influence<100){if(!Generals.to(this.data[g].general))return QUEUE_CONTINUE}else{switch(this.option.what){case "Influence":case "Advancement":case "Experience":f=
Generals.best("under level 4");if(f==="any"&&this.data[g].influence<100)f=Generals.best("influence");break;case "Cash":f=Generals.best("cash");break;default:f=Generals.best("item");break}if(!Generals.to(f))return QUEUE_CONTINUE}switch(this.data[g].area){case "quest":if(!Page.to("quests_quest"+(this.data[g].land+1)))return QUEUE_CONTINUE;break;case "demiquest":if(!Page.to("quests_demiquests"))return QUEUE_CONTINUE;break;case "atlantis":if(!Page.to("quests_atlantis"))return QUEUE_CONTINUE;break;default:log("Can't get to quest area!");
return QUEUE_FINISH}debug("Performing - "+g+" (energy: "+this.data[g].energy+")");if(!Page.click($('input[name="quest"][value="'+this.data[g].id+'"]').siblings(".imgButton").children('input[type="image"]'))){debug("Can't find button for "+g+", so deleting and re-visiting page...");delete this.data[g];Page.reload()}this.option.unique&&this.data[g].unique&&!Alchemy.get(["ingredients",this.data[d].itemimg])&&Alchemy.set(["ingredients",this.data[d].itemimg],1);this.option.what==="Advancement"&&this.data[g].unique&&
this.data[g].land<6&&Page.to("quests_quest"+(this.data[g].land+2));return QUEUE_RELEASE};Quest.order=[];
Quest.dashboard=function(c,d){function e(l){switch(c){case 0:return Quest.data[l].general||"zzz";case 1:return l;case 2:return typeof Quest.data[l].land==="number"&&typeof Quest.land[Quest.data[l].land]!=="undefined"?Quest.land[Quest.data[l].land]:Quest.area[Quest.data[l].area];case 3:return(typeof Quest.data[l].level!=="undefined"?Quest.data[l].level:-1)*100+(Quest.data[l].influence||0);case 4:return Quest.data[l].energy;case 5:return Quest.data[l].exp/Quest.data[l].energy;case 6:return Quest.data[l].reward/
Quest.data[l].energy;case 7:return Quest.data[l].item||"zzz"}return 0}var f,g,h=[],k=[];if(typeof c==="undefined"){this.order=[];for(f in this.data)this.order.push(f)}if(typeof c==="undefined")c=this.runtime.sort||1;if(typeof d==="undefined")d=this.runtime.rev||false;this.runtime.sort=c;this.runtime.rev=d;this.order.sort(function(l,m){l=e(l);m=e(m);if(typeof l==="string"||typeof m==="string")return d?(m||"")>(l||""):(m||"")<(l||"");return d?(l||0)-(m||0):(m||0)-(l||0)});th(k,"General");th(k,"Name");
th(k,"Area");th(k,"Level");th(k,"Energy");th(k,"@&nbsp;Exp");th(k,"@&nbsp;Reward");th(k,"Item");h.push('<table cellspacing="0" style="width:100%"><thead><tr>'+k.join("")+"</tr></thead><tbody>");for(g=0;g<this.order.length;g++){f=this.order[g];k=[];td(k,Generals.get([this.data[f].general])?'<img style="width:25px;height:25px;" src="'+imagepath+Generals.get([this.data[f].general,"img"])+'" alt="'+this.data[f].general+'" title="'+this.data[f].general+'">':"");th(k,f);td(k,typeof this.data[f].land===
"number"?this.land[this.data[f].land].replace(" ","&nbsp;"):this.area[this.data[f].area].replace(" ","&nbsp;"));td(k,typeof this.data[f].level!=="undefined"?this.data[f].level+"&nbsp;("+this.data[f].influence+"%)":"");td(k,this.data[f].energy);td(k,(this.data[f].exp/this.data[f].energy).round(2),'title="'+this.data[f].exp+" total, "+(this.data[f].exp/this.data[f].energy*12).round(2)+' per hour"');td(k,"$"+addCommas((this.data[f].reward/this.data[f].energy).round()),'title="$'+addCommas(this.data[f].reward)+
" total, $"+addCommas((this.data[f].reward/this.data[f].energy*12).round())+' per hour"');td(k,this.data[f].itemimg?'<img style="width:25px;height:25px;" src="'+imagepath+this.data[f].itemimg+'" alt="'+this.data[f].item+'" title="'+this.data[f].item+'">':"");tr(h,k.join(""),'style="height:25px;"')}h.push("</tbody></table>");$("#golem-dashboard-Quest").html(h.join(""));$("#golem-dashboard-Quest tbody tr td:nth-child(2)").css("text-align","left");if(typeof c!=="undefined")$("#golem-dashboard-Quest thead th:eq("+
c+")").attr("name",d?"reverse":"sort").append("&nbsp;"+(d?"&uarr;":"&darr;"))};var Title=new Worker("Title");Title.data=null;Title.settings={system:true,unsortable:true,advanced:true};Title.option={enabled:false,title:"CA: {Queue:runtime.current} | {energy}e | {stamina}s | {exp_needed}xp by {LevelUp:time}"};Title.display=[{id:"enabled",label:"Change Window Title",checkbox:true},{id:"title",text:true,size:24},{title:"Useful Values",info:'{myname}<br>{energy} / {maxenergy}<br>{health} / {maxhealth}<br>{stamina} / {maxstamina}<br>{level}<br>{pause} - "(Paused) " when paused<br>{LevelUp:time} - Next level time<br>{Queue:runtime.current} - Activity'}];
Title.old=null;Title.init=function(){this._watch(Player)};
Title.update=function(){if(this.option.enabled&&this.option.title){var c,d,e,f,g="",h=this.option.title.match(/([^}]+\}?)/g);for(c in h){d=h[c].regex(/([^{]*)\{?([^}]*)\}?/);g+=d[0];if(d[1]){f=Player;e=d[1].split(":");if(e[1])f=WorkerByName(e.shift());if(f){d=f.get(e[0]);g+=typeof d==="number"?addCommas(d):typeof d==="string"?d:"";this._watch(f)}else debug('Bad worker specified = "'+d[1]+'"')}}if(!this.old)this.old=document.title;document.title=g}else if(this.old){document.title=this.old;this.old=
null}};var Town=new Worker("Town");Town.data={};Town.defaults.castle_age={pages:"town_soldiers town_blacksmith town_magic"};Town.option={general:true,number:"Minimum",maxcost:"$100k",units:"All",sell:false};Town.runtime={best:null,buy:0,cost:0};
Town.display=[{label:"Work in progress..."},{id:"general",label:"Use Best General",checkbox:true},{id:"number",label:"Buy Number",select:["None","Minimum","Match Army","Maximum"],help:"Minimum will buy before any quests (otherwise only bought when needed), Maximum will buy 501 (depending on generals)"},{advanced:true,id:"maxcost",label:"Maximum Buy Cost",select:["$10k","$100k","$1m","$10m","$100m","$1b","$10b","$100b"]},{advanced:true,id:"units",label:"Buy Type",select:["All","Best Offense","Best Defense",
"Best of Both"]},{advanced:true,id:"sell",label:"Auto-Sell<br>(Not enabled)",checkbox:true}];
Town.blacksmith={Weapon:/avenger|axe|blade|bow|cleaver|cudgel|dagger|halberd|mace|morningstar|rod|saber|spear|staff|stave|sword|talon|trident|wand|Daedalus|Dragonbane|Dreadnought Greatsword|Excalibur|Incarnation|Ironhart's Might|Judgement|Justice|Lightbringer|Oathkeeper|Onslaught/i,Shield:/buckler|shield|tome|Defender|Dragon Scale|Frost Dagger|Frost Tear Dagger|Harmony|Sword of Redemption|Terra's Guard|The Dreadnought/i,Helmet:/cowl|crown|helm|horns|mask|veil/i,Gloves:/gauntlet|glove|hand|bracer|Slayer's Embrace/i,
Armor:/armor|chainmail|cloak|pauldrons|plate|raiments|robe|Blood Vestment|Garlans Battlegear|Faerie Wings/i,Amulet:/amulet|bauble|charm|crystal|eye|heart|insignia|jewel|lantern|memento|orb|shard|soul|talisman|trinket|Paladin's Oath|Poseidons Horn| Ring|Ring of|Ruby Ore|Thawing Star/i};
Town.parse=function(c){if(c)Page.page==="town_blacksmith"&&$("tr.eq_buy_row,tr.eq_buy_row2").each(function(f,g){f=$("div.eq_buy_txt strong:first-child",g);g=f.text().trim();Town.data[g].type&&f.parent().append("<br>"+Town.data[g].type)});else{var d=Town.data,e=Page.page.substr(5);$(".eq_buy_row,.eq_buy_row2").each(function(f,g){!$("div.eq_buy_costs_int",g).length&&$("div.eq_buy_costs",g).prepend('<div class="eq_buy_costs_int"></div>').children("div.eq_buy_costs_int").append($('div.eq_buy_costs >[class!="eq_buy_costs_int"]',
g));!$("div.eq_buy_stats_int",g).length&&$("div.eq_buy_stats",g).prepend('<div class="eq_buy_stats_int"></div>').children("div.eq_buy_stats_int").append($('div.eq_buy_stats >[class!="eq_buy_stats_int"]',g));!$("div.eq_buy_txt_int",g).length&&$("div.eq_buy_txt",g).prepend('<div class="eq_buy_txt_int"></div>').children("div.eq_buy_txt_int").append($('div.eq_buy_txt >[class!="eq_buy_txt_int"]',g));var h;f=$("div.eq_buy_stats",g);var k=$("div.eq_buy_txt strong:first",g).text().trim(),l=$("div.eq_buy_costs",
g),m=$("strong:first-child",l).text().replace(/[^0-9]/g,"");d[k]=d[k]||{};d[k].page=e;d[k].img=$("div.eq_buy_image img",g).attr("src").filepart();d[k].own=$(l).text().regex(/Owned: ([0-9]+)/i);d[k].att=$("div.eq_buy_stats_int div:eq(0)",f).text().regex(/([0-9]+)\s*Attack/);d[k].def=$("div.eq_buy_stats_int div:eq(1)",f).text().regex(/([0-9]+)\s*Defense/);if(m){d[k].cost=parseInt(m,10);d[k].buy=[];$('select[name="amount"]:first option',l).each(function(p,n){d[k].buy.push(parseInt($(n).val(),10))})}if(e===
"blacksmith")for(h in Town.blacksmith)if(k.match(Town.blacksmith[h]))d[k].type=h})}return true};
Town.getInvade=function(c){var d=0,e=0,f=this.data;d+=getAttDef(f,function(g,h,k){k[h].page==="soldiers"&&g.push(h)},"att",c,"invade");e+=getAttDef(f,null,"def",c,"invade");d+=getAttDef(f,function(g,h,k){k[h].type&&k[h].type!=="Weapon"&&g.push(h)},"att",c,"invade");e+=getAttDef(f,null,"def",c,"invade");d+=getAttDef(f,function(g,h,k){k[h].type==="Weapon"&&g.push(h)},"att",c,"invade");e+=getAttDef(f,null,"def",c,"invade");d+=getAttDef(f,function(g,h,k){k[h].page==="magic"&&g.push(h)},"att",c,"invade");
e+=getAttDef(f,null,"def",c,"invade");return{attack:d,defend:e}};
Town.getDuel=function(){var c=0,d=0,e=this.data;c+=getAttDef(e,function(f,g,h){h[g].type==="Weapon"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",1,"duel");c+=getAttDef(e,function(f,g,h){h[g].page==="magic"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",1,"duel");c+=getAttDef(e,function(f,g,h){h[g].type==="Shield"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",1,"duel");c+=getAttDef(e,function(f,g,h){h[g].type==="Helmet"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",
1,"duel");c+=getAttDef(e,function(f,g,h){h[g].type==="Gloves"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",1,"duel");c+=getAttDef(e,function(f,g,h){h[g].type==="Armor"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",1,"duel");c+=getAttDef(e,function(f,g,h){h[g].type==="Amulet"&&f.push(g)},"att",1,"duel");d+=getAttDef(e,null,"def",1,"duel");return{attack:c,defend:d}};
Town.update=function(){var c,d,e=null,f=0,g=this.data,h;this.runtime.invade=this.getInvade(Player.get("army"));this.runtime.duel=this.getDuel();if(this.option.number!=="None"){h=Quest.get();for(c in h)if(h[c].units)for(d in h[c].units)if(g[d]&&g[d].cost&&g[d].own<h[c].units[d]){e=d;f=h[c].units[d]-g[d].own}}if(this.runtime.best=e){this.runtime.buy=f;this.runtime.cost=f*g[e].cost;Dashboard.status(this,"Want to buy "+f+" x "+e+" for $"+addCommas(this.runtime.cost))}else Dashboard.status(this)};
Town.work=function(c){if(!this.runtime.best||!this.runtime.buy||!Bank.worth(this.runtime.cost))return QUEUE_FINISH;if(!c||!this.buy(this.runtime.best,this.runtime.buy))return QUEUE_CONTINUE;return QUEUE_RELEASE};
Town.buy=function(c,d){this._unflush();if(!this.data[c]||!this.data[c].buy||!Bank.worth(this.runtime.cost))return true;if(!Generals.to(this.option.general?"cost":"any")||!Bank.retrieve(this.runtime.cost)||this.data[c].page==="soldiers"&&!Generals.to("cost")||!Page.to("town_"+this.data[c].page))return false;var e,f=0;for(e=0;e<this.data[c].buy.length&&this.data[c].buy[e]<=d;e++)f=this.data[c].buy[e];$("tr.eq_buy_row,tr.eq_buy_row2").each(function(g,h){if($("div.eq_buy_txt strong:first",h).text().trim()===
c){debug("Buying "+f+" x "+c+" for $"+addCommas(f*Town.data[c].cost));$('div.eq_buy_costs select[name="amount"]:eq(0)',h).val(f);Page.click($('div.eq_buy_costs input[name="Buy"]',h))}});return false};
var makeTownDash=function(c,d,e,f,g,h){var k=[],l=[],m=e==="att"?"def":"att",p,n={Weapon:1,Shield:2,Helmet:3,Armor:4,Amulet:5,Gloves:6,Magic:7};g&&l.push('<div class="golem-panel"><h3 class="golem-panel-header">'+g+'</h3><div class="golem-panel-content">');for(p in c)d(k,p,c);if(c[k[0]])if(f==="duel"&&c[k[0]].type)k.sort(function(q,o){return n[c[q].type]-n[c[o].type]});else c[k[0]]&&c[k[0]].skills&&c[k[0]][f]?k.sort(function(q,o){return(c[o][f][e]||0)-(c[q][f][e]||0)}):k.sort(function(q,o){return c[o][e]+
0.7*c[o][m]-(c[q][e]+0.7*c[q][m])});for(p=0;p<(h?h:k.length);p++)if(c[k[0]]&&c[k[0]].skills||c[k[p]].use&&c[k[p]].use[f+"_"+e])l.push('<div style="height:25px;margin:1px;"><img src="'+imagepath+c[k[p]].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+(c[k[p]].use?c[k[p]].use[f+"_"+e]+" x ":"")+k[p]+" ("+c[k[p]].att+" / "+c[k[p]].def+")"+(c[k[p]].cost?"<br>$"+addCommas(c[k[p]].cost):"")+"</div>");g&&l.push("</div></div>");return l.join("")};
Town.dashboard=function(){var c,d;d=Generals.get();var e;e=Generals.best("duel");c='<div style="float:left;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(d,function(f,g){f.push(g)},"att","invade","Heroes")+makeTownDash(this.data,function(f,g,h){h[g].page==="soldiers"&&h[g].use&&f.push(g)},"att","invade","Soldiers")+makeTownDash(this.data,function(f,g,h){h[g].use&&h[g].type==="Weapon"&&f.push(g)},
"att","invade","Weapons")+makeTownDash(this.data,function(f,g,h){h[g].page==="blacksmith"&&h[g].use&&h[g].type!=="Weapon"&&f.push(g)},"att","invade","Equipment")+makeTownDash(this.data,function(f,g,h){h[g].page==="magic"&&h[g].use&&f.push(g)},"att","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+(e!=="any"?'<div style="height:25px;margin:1px;"><img src="'+imagepath+d[e].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+
e+" ("+d[e].att+" / "+d[e].def+")</div>":"")+makeTownDash(this.data,function(f,g,h){h[g].page==="blacksmith"&&h[g].use&&f.push(g)},"att","duel")+makeTownDash(this.data,function(f,g,h){h[g].page==="magic"&&h[g].use&&f.push(g)},"att","duel")+"</div></div></div>";e=Generals.best("defend");d='<div style="float:right;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(d,function(f,g){f.push(g)},"def",
"invade","Heroes")+makeTownDash(this.data,function(f,g,h){h[g].page==="soldiers"&&h[g].use&&f.push(g)},"def","invade","Soldiers")+makeTownDash(this.data,function(f,g,h){h[g].use&&h[g].type==="Weapon"&&f.push(g)},"def","invade","Weapons")+makeTownDash(this.data,function(f,g,h){h[g].page==="blacksmith"&&h[g].use&&h[g].type!=="Weapon"&&f.push(g)},"def","invade","Equipment")+makeTownDash(this.data,function(f,g,h){h[g].page==="magic"&&h[g].use&&f.push(g)},"def","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+
(e!=="any"?'<div style="height:25px;margin:1px;"><img src="'+imagepath+d[e].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+e+" ("+d[e].att+" / "+d[e].def+")</div>":"")+makeTownDash(this.data,function(f,g,h){h[g].page==="blacksmith"&&h[g].use&&f.push(g)},"def","duel")+makeTownDash(this.data,function(f,g,h){h[g].page==="magic"&&h[g].use&&f.push(g)},"def","duel")+"</div></div></div>";$("#golem-dashboard-Town").html(c+d)};var Upgrade=new Worker("Upgrade");Upgrade.data=null;
Upgrade.defaults.castle_age={pages:"keep_stats"};Upgrade.option={order:[]};Upgrade.runtime={working:false,run:0};Upgrade.display=[{label:"Points will be allocated in this order, add multiple entries if wanted (ie, 3x Attack and 1x Defense would put &frac34; on Attack and &frac14; on Defense)"},{id:"order",multiple:["Energy","Stamina","Attack","Defense","Health"]}];
Upgrade.init=function(){if(this.option.run){this.runtime.run=this.option.run;delete this.option.run}if(this.option.working){this.runtime.working=this.option.working;delete this.option.working}};Upgrade.parse=function(){var c=$("div.results");if(this.runtime.working&&c.length&&c.text().match(/You just upgraded your/i)){this.runtime.working=false;this.runtime.run++}return false};
Upgrade.work=function(c){var d=Player.get("upgrade");if(this.runtime.run>=this.option.order.length)this.runtime.run=0;if(!this.option.order.length||!d||this.option.order[this.runtime.run]==="Stamina"&&d<2)return QUEUE_FINISH;if(!c||!Page.to("keep_stats"))return QUEUE_CONTINUE;switch(this.option.order[this.runtime.run]){case "Energy":c='a[href$="?upgrade=energy_max"]';break;case "Stamina":c='a[href$="?upgrade=stamina_max"]';break;case "Attack":c='a[href$="?upgrade=attack"]';break;case "Defense":c=
'a[href$="?upgrade=defense"]';break;case "Health":c='a[href$="?upgrade=health_max"]';break;default:this.runtime.run++;return true}if(Page.click(c))this.runtime.working=true;else Page.reload();return QUEUE_RELEASE};var Caap=new Worker("Caap","keep_eliteguard army_viewarmy battle_arena");Caap.data={};Caap.init=function(){};Worker.prototype._oldunflush=Worker.prototype._unflush;
Worker.prototype._unflush=function(){this._oldunflush();if(typeof this.caap_values!="undefined")for(i in this.caap_values)this.option[i]=gm.getValue(this.caap_values[i]);typeof this.caap_load=="function"&&this.caap_load()};Queue.caap_load=function(){this.option.pause=false};
global={gameName:"castle_age",discussionURL:"http://senses.ws/caap/index.php",debug:false,newVersionAvailable:false,documentTitle:document.title,is_chrome:navigator.userAgent.toLowerCase().indexOf("chrome")!==-1?true:false,is_firefox:navigator.userAgent.toLowerCase().indexOf("firefox")!==-1?true:false,os:"\n",vs:"\t",ls:"\u000c",AddCSS:function(){try{$('link[href*="jquery-ui-1.8.1.custom.css"').length||$("<link>").appendTo("head").attr({rel:"stylesheet",type:"text/css",href:"http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/jquery-ui-1.8.1/css/smoothness/jquery-ui-1.8.1.custom.css"});
$('link[href*="farbtastic.css"').length||$("<link>").appendTo("head").attr({rel:"stylesheet",type:"text/css",href:"http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/farbtastic12/farbtastic/farbtastic.css"});return true}catch(c){log("ERROR in AddCSS: "+c);return false}},alert_id:0,alert:function(c){try{global.alert_id+=1;var d=global.alert_id;$('<div id="alert_'+d+'" title="Alert!"><p>'+c+"</p></div>").appendTo(document.body);$("#alert_"+d).dialog({buttons:{Ok:function(){$(this).dialog("close")}}});
return true}catch(e){log("ERROR in alert: "+e);return false}},hashStr:["41030325072","4200014995461306","2800013751923752","55577219620","65520919503","2900007233824090","2900007233824090","3100017834928060","3500032575830770","32686632448","2700017666913321"]};
gm={log:function(c){var d=new Date,e=d.getHours(),f=d.getMinutes();d=d.getSeconds();e+="";if(e.length===1)e="0"+e;f+="";if(f.length===1)f="0"+f;d+="";if(d.length===1)d="0"+d;GM_log("v"+caapVersion+" ("+(e+":"+f+":"+d)+") : "+c)},debug:function(c){global.debug&&this.log(c)},isInt:function(c){try{var d=parseInt(c,10);if(isNaN(d))return false;return c==d&&c.toString()==d.toString()}catch(e){log("ERROR in gm.isInt: "+e);return false}},setValue:function(c,d){try{this.debug("Set "+c+" to "+d);if(this.isInt(d))if(d>
999999999&&!global.is_chrome)d+="";else d=Number(d);GM_setValue(global.gameName+"__"+c,d);return d}catch(e){log("ERROR in gm.setValue: "+e);return null}},getValue:function(c,d){d=GM_getValue(global.gameName+"__"+c,d);this.debug("Get "+c+" value "+d);return d},deleteValue:function(c){this.debug("Delete "+c+" value ");GM_deleteValue(global.gameName+"__"+c)},setList:function(c,d){if($.isArray(d)){GM_setValue(global.gameName+"__"+c,d.join(global.os));return d}else this.log("Attempted to SetList "+c+" to "+
d.toString()+" which is not an array.")},getList:function(c){var d=GM_getValue(global.gameName+"__"+c,"");this.debug("GetList "+c+" value "+d);c=[];if(d!=="")c=d.split(global.os);return c},getListFromText:function(c){var d=gm.getValue(c)?gm.getValue(c).split(/[\n,]/):[];this.debug("GetList "+c+" value "+d);return d.filter(function(e){return e.trim()||false})},listAddBefore:function(c,d){d=d.concat(this.getList(c));this.setList(c,d);return d},listPop:function(c){var d=this.getList(c);if(!d.length)return null;
var e=d.pop();this.setList(c,d);return e},listPush:function(c,d,e){var f=this.getList(c);if(f.indexOf(d)==-1){f.push(d);if(e>0)for(;e<f.length;){d=f.shift();this.debug("Removing "+d+" from "+c+".")}this.setList(c,f)}},listFindItemByPrefix:function(c,d){var e=c.filter(function(f){return f.indexOf(d)===0});this.debug("List: "+c+" prefix "+d+" filtered "+e);if(e.length)return e[0];return null},setObjVal:function(c,d,e){var f=this.getValue(c);if(f){var g=this.listFindItemByPrefix(f.split(global.vs),d+
global.ls);if(g){f=f.split(global.vs);f.splice(f.indexOf(g),1,d+global.ls+e);this.setValue(c,f.join(global.vs))}else this.setValue(c,d+global.ls+e+global.vs+f)}else this.setValue(c,d+global.ls+e)},getObjVal:function(c,d,e){var f=null;f=c.indexOf(global.ls)<0?this.getValue(c):c;if(!f)return e;c=this.listFindItemByPrefix(f.split(global.vs),d+global.ls);if(!c)return e;return c.split(global.ls)[1]},getListObjVal:function(c,d,e,f){c=this.getList(c);if(!c.length)return f;this.debug("have list "+c);d=this.listFindItemByPrefix(c,
d+global.vs);if(!d)return f;this.debug("have obj "+d);e=this.listFindItemByPrefix(d.split(global.vs),e+global.ls);if(!e)return f;this.debug("have val "+e);return e.split(global.ls)[1]},setListObjVal:function(c,d,e,f,g){var h=this.getList(c);if(h.length){var k=this.listFindItemByPrefix(h,d+global.vs);if(k){d=k.split(global.vs);if(g=this.listFindItemByPrefix(d,e+global.ls)){d.splice(d.indexOf(g),1,e+global.ls+f);h.splice(h.indexOf(k),1,d.join(global.vs))}else{d.push(e+global.ls+f);h.splice(h.indexOf(k),
1,k+global.vs+e+global.ls+f)}this.setList(c,h)}else this.listPush(c,d+global.vs+e+global.ls+f,g)}else this.setValue(c,d+global.vs+e+global.ls+f)},deleteListObj:function(c,d){var e=this.getList(c);if(e.length)if(d=this.listFindItemByPrefix(e,d)){e.splice(e.indexOf(d),1);this.setList(c,e)}},getNumber:function(c,d){try{var e=this.getValue(c),f=null;if(!e&&e!==0||isNaN(e))if(!d&&d!==0||isNaN(d))throw"Value of "+c+" and defaultValue are not numbers: '"+e+"', '"+d+"'";else f=d;else f=e;return Number(f)}catch(g){this.log("ERROR in GetNumber: "+
g);return""}}};
nHtml={xpath:{string:XPathResult.STRING_TYPE,unordered:XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,first:XPathResult.FIRST_ORDERED_NODE_TYPE},FindByAttrContains:function(c,d,e,f,g,h){if(e=="className")e="class";g||(g=document);if(h){if(c=g.evaluate(".//"+d+"[contains(translate(@"+e+",'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'),'"+f.toLowerCase()+"')]",c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null))if(h<c.snapshotLength)return c.snapshotItem(h);else if(h>=c.snapshotLength)return c.snapshotItem(c.snapshotLength-1)}else if((h=
g.evaluate(".//"+d+"[contains(translate(@"+e+",'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'),'"+f.toLowerCase()+"')]",c,null,this.xpath.first,null))&&h.singleNodeValue)return h.singleNodeValue;return null},FindByAttrXPath:function(c,d,e,f){var g=null;d=".//"+d+"["+e+"]";try{if(c===null){log("Trying to find xpath with null obj:"+d);return null}f||(f=document);g=f.evaluate(d,c,null,this.xpath.first,null)}catch(h){log("XPath Failed:"+d+","+h)}if(g&&g.singleNodeValue)return g.singleNodeValue;
return null},FindByAttr:function(c,d,e,f,g){if(f.exec===undefined){if(e=="className")e="class";g||(g=document);if((e=g.evaluate(".//"+d+"[@"+e+"='"+f+"']",c,null,this.xpath.first,null))&&e.singleNodeValue)return e.singleNodeValue;return null}c=c.getElementsByTagName(d);for(d=0;d<c.length;d+=1){g=c[d];if(f.exec!==undefined){if(f.exec(g[e]))return g}else if(g[e]==f)return g}return null},FindByClassName:function(c,d,e){return this.FindByAttr(c,d,"className",e)},spaceTags:{td:1,br:1,hr:1,span:1,table:1},
GetText:function(c){var d=" ";if(c.tagName!==undefined&&this.spaceTags[c.tagName.toLowerCase()])d+=" ";if(c.nodeName=="#text")return d+c.textContent;for(var e=0;e<c.childNodes.length;e+=1)d+=this.GetText(c.childNodes[e]);return d},timeouts:{},setTimeout:function(c,d){var e=window.setTimeout(function(){c();nHtml.timeouts[e]=undefined},d);this.timeouts[e]=1},clearTimeouts:function(){for(var c in this.timeouts)this.timeouts.hasOwnProperty(c)&&window.clearTimeout(c);this.timeouts={}},getX:function(c,
d,e){var f=null;switch(e){case this.xpath.string:f=document.evaluate(c,d,null,e,null).stringValue;break;case this.xpath.first:f=document.evaluate(c,d,null,e,null).singleNodeValue;break;case this.xpath.unordered:f=document.evaluate(c,d,null,e,null);break;default:}return f},getHTMLPredicate:function(c){for(var d=c.length;d>1;d-=1)if(c.substr(d,1)=="/")return c.substr(d+1);return c},OpenInIFrame:function(c,d){var e=document.createElement("iframe");e.setAttribute("src",c);e.setAttribute("id",d);e.setAttribute("style",
"width:0;height:0;");document.documentElement.appendChild(e)},ResetIFrame:function(c){var d=document.getElementById(c);if(d){log("Deleting iframe = "+c);d.parentNode.removeChild(d)}else log("Frame not found = "+c);document.getElementById(c)&&log("Found iframe")},Gup:function(c,d){c=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");c=(new RegExp("[\\?&]"+c+"=([^&#]*)")).exec(d);return c===null?"":c[1]},ScrollToBottom:function(){if(document.body.scrollHeight)if(global.is_chrome){var c=document.body.scrollHeight,
d=document.body.clientHeight;if(c>d){c=c-d;log("Scrolling down by: "+c+"px");window.scroll(0,c);log("Scrolled ok")}else log("Not scrolling to bottom. Client height is greater than document height!")}else window.scrollBy(0,document.body.scrollHeight)},ScrollToTop:function(){if(global.is_chrome){log("Scrolling to top");window.scroll(0,0);log("Scrolled ok")}else window.scrollByPages(-1000)},CountInstances:function(c,d){return c.split(d).length-1}};
caap={stats:{},lastReload:new Date,waitingForDomLoad:false,node_trigger:null,newLevelUpMode:false,autoReloadMilliSecs:9E5,userRe:/(userId=|user=|\/profile\/|uid=)([0-9]+)/,levelRe:/Level\s*:\s*([0-9]+)/i,rankRe:/,\s*level\s*:?\s*[0-9]+\s+([a-z ]+)/i,armyRe:/My Army\s*\(?([0-9]+)/i,statusRe:/([0-9\.]+)\s*\/\s*([0-9]+)/i,energyRe:/([0-9]+)\s+(energy)/i,experienceRe:/\+([0-9]+)/,influenceRe:/([0-9]+)%/,moneyRe:/\$([0-9,]+)\s*-\s*\$([0-9,]+)/i,caapDivObject:null,caapTopObject:null,init:function(){try{gm.deleteValue("statsMatch");
gm.deleteValue(this.friendListType.gifta.name+"Requested");gm.deleteValue(this.friendListType.giftb.name+"Requested");gm.deleteValue(this.friendListType.giftc.name+"Requested");gm.deleteValue(this.friendListType.facebook.name+"Requested");gm.getValue("HideAds",false)&&$(".UIStandardFrame_SidebarAds").css("display","none");var c=gm.getValue("ShiftDown","");c&&$(this.controlXY.selector).css("padding-top",c);this.AddControl();this.AddColorWheels();this.AddDashboard();this.AddListeners();this.CheckResults();
return true}catch(d){log("ERROR in init: "+d);return false}},VisitUrl:function(c,d){try{this.waitMilliSecs=d?d:5E3;window.location.href=c;return true}catch(e){log("ERROR in VisitUrl: "+e);return false}},Click:function(c,d){try{if(!c)throw"Null object passed to Click";if(this.waitingForDomLoad===false){this.JustDidIt("clickedOnSomething");this.waitingForDomLoad=true}this.waitMilliSecs=d?d:5E3;var e=document.createEvent("MouseEvents");e.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,
false,false,0,null);return!c.dispatchEvent(e)}catch(f){log("ERROR in Click: "+f)}},ClickAjax:function(c,d){try{if(!c)throw"No link passed to Click Ajax";if(gm.getValue("clickUrl","").indexOf(c)<0){gm.setValue("clickUrl","http://apps.facebook.com/castle_age/"+c);this.waitingForDomLoad=false}return this.VisitUrl("javascript:void(a46755028429_ajaxLinkSend('globalContainer', '"+c+"'))",d)}catch(e){log("ERROR in ClickAjax: "+e);return false}},ClickWait:function(c,d){try{this.setTimeout(function(){this.Click(c,
d)},1E3+Math.floor(Math.random()*1E3));return true}catch(e){log("ERROR in ClickWait: "+e);return false}},generalList:[],standardGeneralList:["Idle","Monster","Fortify","Battle","SubQuest","Buy","Income","Banking"],BuildGeneralLists:function(){try{this.generalList=["Best","Use Current","Under Level 4"].concat(gm.getList("AllGenerals"));return true}catch(c){log("ERROR in BuildGeneralLists: "+c);return false}},ClearGeneral:function(c){try{log("Setting "+c+' to "Use Current"');gm.setValue(c,"Use Current");
this.BuildGeneralLists();for(var d in this.standardGeneralList)this.standardGeneralList.hasOwnProperty(d)&&this.ChangeDropDownList(this.standardGeneralList[d]+"General",this.generalList,gm.getValue(this.standardGeneralList[d]+"General","Use Current"));this.ChangeDropDownList("LevelUpGeneral",this.generalList,gm.getValue("LevelUpGeneral","Use Current"));return true}catch(e){log("ERROR in ClearGeneral: "+e);return false}},SelectGeneral:function(c){if(!Generals.to(Generals.best(c)))return true;return false},
oneMinuteUpdate:function(c){try{if(!gm.getValue("reset"+c)&&!this.WhileSinceDidIt(c+"Timer",60))return false;this.JustDidIt(c+"Timer");gm.setValue("reset"+c,false);return true}catch(d){log("ERROR in oneMinuteUpdate: "+d);return false}},NavigateTo:function(c,d){try{var e=document.getElementById("content");if(!e){log("No content to Navigate to "+d+" using "+c);return false}if(d&&this.CheckForImage(d))return false;for(var f=c.split(","),g=f.length-1;g>=0;g-=1){var h=nHtml.FindByAttrXPath(e,"a","contains(@href,'/"+
f[g]+".php') and not(contains(@href,'"+f[g]+".php?'))");if(h){log("Go to "+f[g]);gm.setValue("clickUrl","http://apps.facebook.com/castle_age/"+f[g]+".php");this.Click(h);return true}var k=f[g];if(k.indexOf(".")==-1)k+=".";var l=nHtml.FindByAttrContains(document.body,"input","src",k);if(l){log("Click on image "+l.src.match(/[\w.]+$/));this.Click(l);return true}var m=nHtml.FindByAttrContains(document.body,"img","src",k);if(m){log("Click on image "+m.src.match(/[\w.]+$/));this.Click(m);return true}}log("Unable to Navigate to "+
d+" using "+c);return false}catch(p){log("ERROR in NavigateTo: "+d+" using "+c+" : "+p);return false}},CheckForImage:function(c,d,e,f){try{d||(d=e?e.body:document.body);var g=nHtml.FindByAttrContains(d,"input","src",c,e,f);if(g)return g;if(g=nHtml.FindByAttrContains(d,"img","src",c,e,f))return g;if(g=nHtml.FindByAttrContains(d,"div","style",c,e,f))return g;return null}catch(h){log("ERROR in CheckForImage: "+h);return null}},WhileSinceDidIt:function(c,d){try{/\d+/.test(c)||(c=gm.getValue(c,0));var e=
(new Date).getTime();return parseInt(c,10)<e-1E3*d}catch(f){log("ERROR in WhileSinceDidIt: "+f);return false}},JustDidIt:function(c){try{if(!c)throw"name not provided!";var d=(new Date).getTime();gm.setValue(c,d.toString());return true}catch(e){log("ERROR in JustDidIt: "+e);return false}},DeceiveDidIt:function(c){try{if(!c)throw"name not provided!";log("Deceive Did It");var d=(new Date).getTime()-65E5;gm.setValue(c,d.toString());return true}catch(e){log("ERROR in DeceiveDidIt: "+e);return false}},
CheckTimer:function(c){try{if(!c)throw"name not provided!";var d=gm.getValue(c),e=(new Date).getTime();if(!d)return true;return d<e}catch(f){log("ERROR in CheckTimer: "+f);return false}},FormatTime:function(c){try{var d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],e=c.getDay(),f=c.getHours(),g=c.getMinutes();c="PM";if(gm.getValue("use24hr",true)){f+="";if(f.length===1)f="0"+f;g+="";if(g.length===1)g="0"+g;return d[e]+" "+f+":"+g}else{if(f<12)c="AM";if(f===0)f=12;if(f>12)f-=12;g+="";if(g.length===1)g=
"0"+g;return d[e]+" "+f+":"+g+" "+c}}catch(h){log("ERROR in FormatTime: "+h);return"Time Err"}},DisplayTimer:function(c){try{if(!c)throw"name not provided!";var d=gm.getValue(c),e=new Date;if(!d)return false;e.setTime(parseInt(d,10));return this.FormatTime(e)}catch(f){log("ERROR in DisplayTimer: "+f);return false}},SetTimer:function(c,d){try{if(!c)throw"name not provided!";if(!d)throw"time not provided!";var e=(new Date).getTime();e+=d*1E3;gm.setValue(c,e.toString());return true}catch(f){log("ERROR in SetTimer: "+
f);return false}},NumberOnly:function(c){try{return parseFloat(c.toString().replace(new RegExp("[^0-9\\.]","g"),""))}catch(d){log("ERROR in NumberOnly: "+d);return null}},RemoveHtmlJunk:function(c){try{return c.replace(new RegExp("\\&[^;]+;","g"),"")}catch(d){log("ERROR in RemoveHtmlJunk: "+d);return null}},AppendTextToDiv:function(c,d){try{$("#"+c).append(d);return true}catch(e){log("ERROR in AppendTextToDiv: "+e);return false}},defaultDropDownOption:"<option disabled='disabled' value='not selected'>Choose one</option>",
MakeDropDown:function(c,d,e,f){try{var g=gm.getValue(c,"defaultValue");if(g=="defaultValue")g=gm.setValue(c,d[0]);var h=0;for(var k in d)if(d.hasOwnProperty(k)){if(g==d[k])break;h+=1}var l="<select id='caap_"+c+"' "+(e[h]?" title='"+e[h]+"' ":"")+f+">";l+=this.defaultDropDownOption;for(var m in d)if(d.hasOwnProperty(m))l+=e?"<option value='"+d[m]+"'"+(g==d[m]?" selected='selected'":"")+(e[m]?" title='"+e[m]+"'":"")+">"+d[m]+"</option>":"<option value='"+d[m]+"'"+(g==d[m]?" selected='selected'":"")+
">"+d[m]+"</option>";l+="</select>";return l}catch(p){log("ERROR in MakeDropDown: "+p);return""}},DBDropDown:function(c,d,e,f){try{var g=gm.getValue(c,"defaultValue");if(g=="defaultValue")g=gm.setValue(c,d[0]);c=" <select id='caap_"+c+"' "+f+"'><option>"+g;for(var h in d)if(d.hasOwnProperty(h))if(g!=d[h])c+=e?"<option value='"+d[h]+"' "+(e[h]?" title='"+e[h]+"'":"")+">"+d[h]:"<option value='"+d[h]+"'>"+d[h];c+="</select>";return c}catch(k){log("ERROR in DBDropDown: "+k);return""}},MakeCheckBox:function(c,
d,e,f,g){try{gm.getValue(c,"defaultValue")=="defaultValue"&&gm.setValue(c,d);var h="<input type='checkbox' id='caap_"+c+"' title=\""+f+'"'+(e?" class='"+e+"'":"")+(gm.getValue(c)?"checked":"")+" />";if(e){h+=g?"</td></tr></table>":"<br />";h+=this.AddCollapsingDiv(c,e)}return h}catch(k){log("ERROR in MakeCheckBox: "+k);return""}},MakeNumberForm:function(c,d,e,f){try{gm.getValue(c,"defaultValue")=="defaultValue"&&gm.setValue(c,e);f||(f="size='4'");return" <input type='text' id='caap_"+c+"' "+f+' title="'+
d+"\" value='"+gm.getValue(c,"")+"' />"}catch(g){log("ERROR in MakeNumberForm: "+g);return""}},MakeCheckTR:function(c,d,e,f,g,h){try{var k="<tr><td style='width: 90%'>"+c+"</td><td style='width: 10%; text-align: right'>"+this.MakeCheckBox(d,e,f,g,h);h||(k+="</td></tr>");return k}catch(l){log("ERROR in MakeCheckTR: "+l);return""}},AddCollapsingDiv:function(c,d){try{return"<div id='caap_"+d+"' style='display: "+(gm.getValue(c,false)?"block":"none")+"'>"}catch(e){log("ERROR in AddCollapsingDiv: "+e);
return""}},ToggleControl:function(c,d){try{var e=gm.getValue("Control_"+c,"none"),f="-";if(e=="none")f="+";return'<b><a id="caap_Switch_'+c+'" href="javascript:;" style="text-decoration: none;"> '+f+" "+d+"</a></b><br /><div id='caap_"+c+"' style='display: "+e+"'>"}catch(g){log("ERROR in ToggleControl: "+g);return""}},MakeTextBox:function(c,d,e){try{return'<textarea title="'+d+"\" type='text' id='caap_"+c+"' "+e+">"+gm.getValue(c,"")+"</textarea>"}catch(f){log("ERROR in MakeTextBox: "+f);return""}},
SaveBoxText:function(c){try{var d=$("#caap_"+c).val();if(typeof d!="string")throw"Value of the textarea id='caap_"+c+"' is not a string: "+d;gm.setValue(c,d);return true}catch(e){log("ERROR in SaveBoxText: "+e);return false}},SetDivContent:function(c,d){try{if(gm.getValue("SetTitle",false)&&gm.getValue("SetTitleAction",false)&&c=="activity_mess"){var e=d.replace("Activity: ","")+" - ";if(gm.getValue("SetTitleName",false))e+=gm.getValue("PlayerName","CAAP")+" - ";document.title=e+global.documentTitle}$("#caap_"+
c).html(d)}catch(f){log("ERROR in SetDivContent: "+f)}},questWhenList:["Energy Available","At Max Energy","At X Energy","Not Fortifying","Never"],questWhenInst:["Energy Available - will quest whenever you have enough energy.","At Max Energy - will quest when energy is at max and will burn down all energy when able to level up.","At X Energy - (EXPERIMENTAL) allows you to set maximum and minimum energy values to start and stop questing. Will burn down all energy when able to level up.","Not Fortifying - will quest only when your fortify settings are matched.",
"Never - disables questing."],questAreaList:["Quest","Demi Quests","Atlantis"],landQuestList:["Land of Fire","Land of Earth","Land of Mist","Land of Water","Demon Realm","Undead Realm","Underworld","Kingdom of Heaven"],demiQuestList:["Ambrosia","Malekus","Corvintheus","Aurora","Azeron"],atlantisQuestList:["Atlantis"],questForList:["Advancement","Max Influence","Max Gold","Max Experience","Manual"],SelectDropOption:function(c,d){try{$("#caap_"+c+" option").removeAttr("selected");$("#caap_"+c+" option[value='"+
d+"']").attr("selected","selected");return true}catch(e){log("ERROR in SelectDropOption: "+e);return false}},ShowAutoQuest:function(){try{$("#stopAutoQuest").text("Stop auto quest: "+gm.getObjVal("AutoQuest","name")+" (energy: "+gm.getObjVal("AutoQuest","energy")+")");$("#stopAutoQuest").css("display","block");return true}catch(c){log("ERROR in ShowAutoQuest: "+c);return false}},ClearAutoQuest:function(){try{$("#stopAutoQuest").text("");$("#stopAutoQuest").css("display","none");return true}catch(c){log("ERROR in ClearAutoQuest: "+
c);return false}},ManualAutoQuest:function(){try{this.SelectDropOption("WhyQuest","Manual");this.ClearAutoQuest();return true}catch(c){log("ERROR in ManualAutoQuest: "+c);return false}},ChangeDropDownList:function(c,d,e){try{$("#caap_"+c+" option").remove();$("#caap_"+c).append(this.defaultDropDownOption);for(var f in d)if(d.hasOwnProperty(f)){if(f=="0"&&!e){gm.setValue(c,d[f]);log("Saved: "+c+"  Value: "+d[f])}$("#caap_"+c).append("<option value='"+d[f]+"'>"+d[f]+"</option>")}e?$("#caap_"+c+" option[value='"+
e+"']").attr("selected","selected"):$("#caap_"+c+" option:eq(1)").attr("selected","selected");return true}catch(g){log("ERROR in ChangeDropDownList: "+g);return false}},divList:["banner","activity_mess","idle_mess","quest_mess","battle_mess","monster_mess","fortify_mess","heal_mess","demipoint_mess","demibless_mess","level_mess","exp_mess","arena_mess","debug1_mess","debug2_mess","control"],controlXY:{selector:".UIStandardFrame_Content",x:0,y:0},GetControlXY:function(c){try{var d=0,e=0;d=c?$(this.controlXY.selector).offset().top:
this.controlXY.y;e=this.controlXY.x===""||c?$(this.controlXY.selector).offset().left+$(this.controlXY.selector).width()+10:$(this.controlXY.selector).offset().left+this.controlXY.x;return{x:e,y:d}}catch(f){log("ERROR in GetControlXY: "+f);return{x:0,y:0}}},SaveControlXY:function(){try{var c=$(this.controlXY.selector).offset();gm.setValue("caap_div_menuTop",caap.caapDivObject.offset().top);gm.setValue("caap_div_menuLeft",caap.caapDivObject.offset().left-c.left);gm.setValue("caap_top_zIndex","1");gm.setValue("caap_div_zIndex",
"2")}catch(d){log("ERROR in SaveControlXY: "+d)}},dashboardXY:{selector:"#app46755028429_app_body_container",x:0,y:0},GetDashboardXY:function(c){try{var d=0,e=0;d=c?$(this.dashboardXY.selector).offset().top-10:this.dashboardXY.y;e=this.dashboardXY.x===""||c?$(this.dashboardXY.selector).offset().left:$(this.dashboardXY.selector).offset().left+this.dashboardXY.x;return{x:e,y:d}}catch(f){log("ERROR in GetDashboardXY: "+f);return{x:0,y:0}}},SaveDashboardXY:function(){try{var c=$(this.dashboardXY.selector).offset();
gm.setValue("caap_top_menuTop",this.caapTopObject.offset().top);gm.setValue("caap_top_menuLeft",this.caapTopObject.offset().left-c.left);gm.setValue("caap_div_zIndex","1");gm.setValue("caap_top_zIndex","2")}catch(d){log("ERROR in SaveDashboardXY: "+d)}},AddControl:function(){try{var c="<div id='caap_div'>",d=0,e={x:0,y:0},f="",g="";for(d in this.divList)if(this.divList.hasOwnProperty(d))c+="<div id='caap_"+this.divList[d]+"'></div>";c+="</div>";this.controlXY.x=gm.getValue("caap_div_menuLeft","");
this.controlXY.y=gm.getValue("caap_div_menuTop",$(this.controlXY.selector).offset().top);e=this.GetControlXY();$(c).css({width:"180px",background:gm.getValue("StyleBackgroundLight","#E0C691"),padding:"4px",border:"2px solid #444",top:e.y+"px",left:e.x+"px",zIndex:gm.getValue("caap_div_zIndex","2"),position:"absolute"}).appendTo(document.body);this.caapDivObject=$("#caap_div");g+="<div id='caap_BannerHide' style='display: "+(gm.getValue("BannerDisplay",true)?"block":"none")+"'>";g+="<img src='http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/Castle-Age-Autoplayer.png' alt='Castle Age Auto Player' /><br /><hr /></div>";
this.SetDivContent("banner",g);f+=this.AddPauseMenu();f+=this.AddDisableMenu();f+=this.AddCashHealthMenu();f+=this.AddQuestMenu();f+=this.AddBattleMenu();f+=this.AddMonsterMenu();f+=this.AddMonsterFinderMenu();f+=this.AddReconMenu();f+=this.AddGeneralsMenu();f+=this.AddSkillPointsMenu();f+=this.AddOtherOptionsMenu();f+=this.AddFooterMenu();this.SetDivContent("control",f);this.CheckLastAction(gm.getValue("LastAction","none"));$("#caap_resetElite").button();$("#caap_StartedColourSelect").button();$("#caap_StopedColourSelect").button();
$("#caap_FillArmy").button();$("#caap_ResetMenuLocation").button();return true}catch(h){log("ERROR in AddControl: "+h);return false}},AddPauseMenu:function(){try{var c="";if(global.is_chrome)c+="<div id='caapPausedDiv' style='display: none'><a href='javascript:;' id='caapPauseA' >Pause</a></div>";c+="<div id='caapPaused' style='display: "+gm.getValue("caapPause","block")+"'><b>Paused on mouse click.</b><br /><a href='javascript:;' id='caapRestart' >Click here to restart</a></div><hr />";return c}catch(d){log("ERROR in AddPauseMenu: "+
d);return false}},AddDisableMenu:function(){try{var c="";c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+=this.MakeCheckTR("Disable Autoplayer","Disabled",false,"","Disable auto running of CAAP. Stays persistent even on page reload and the autoplayer will not autoplay.")+"</table><hr />";return c}catch(d){log("ERROR in AddDisableMenu: "+d);return false}},AddCashHealthMenu:function(){return""},AddQuestMenu:function(){try{gm.getObjVal("AutoQuest","name");var c="";c+=this.ToggleControl("Quests",
"QUEST");c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td width=80>Quest When</td><td style='text-align: right; width: 60%'>"+this.MakeDropDown("WhenQuest",this.questWhenList,this.questWhenInst,"style='font-size: 10px; width: 100%'")+"</td></tr></table>";c+="<div id='caap_WhenQuestHide' style='display: "+(gm.getValue("WhenQuest",false)!="Never"?"block":"none")+"'>";c+="<div id='caap_WhenQuestXEnergy' style='display: "+(gm.getValue("WhenQuest",false)!="At X Energy"?"none":
"block")+"'>";c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td>Start At Or Above Energy</td><td style='text-align: right'>"+this.MakeNumberForm("XQuestEnergy","(EXPERIMENTAL) Start questing when energy is at or above this value.",1,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr>";c+="<tr><td style='padding-left: 10px'>Stop At Or Below Energy</td><td style='text-align: right'>"+this.MakeNumberForm("XMinQuestEnergy","(EXPERIMENTAL) Stop quest when energy is at or below this value.",
0,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr></table>";c+="</div>";return c}catch(d){log("ERROR in AddQuestMenu: "+d);return false}},AddBattleMenu:function(){try{var c="";c+=this.ToggleControl("Battling","BATTLE");c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td>Battle When</td><td style='text-align: right; width: 65%'>"+this.MakeDropDown("WhenBattle",["Stamina Available","At Max Stamina","At X Stamina","No Monster","Stay Hidden","Never"],["Stamina Available will battle whenever you have enough stamina",
"At Max Stamina will battle when stamina is at max and will burn down all stamina when able to level up","At X Stamina you can set maximum and minimum stamina to battle","No Monster will battle only when there are no active monster battles",'Stay Hidden uses stamina to try to keep you under 10 health so you cannot be attacked, while also attempting to maximize your stamina use for Monster attacks. YOU MUST SET MONSTER OR ARENA TO "STAY HIDDEN" TO USE THIS FEATURE.',"Never - disables player battles"],
"style='font-size: 10px; width: 100%'")+"</td></tr></table>";c+="<div id='caap_WhenBattleStayHidden1' style='display: "+(gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("WhenMonster",false)!="Stay Hidden"?"block":"none")+"'>";c+="</div>";c+="<div id='caap_WhenBattleStayHidden2' style='display: "+(gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",false)=="None"?"block":"none")+"'>";c+="<font color='red'><b>Warning: Arena Must Have 'Hide Using' Active To Support Hiding</b></font>";
c+="</div>";c+="<div id='caap_WhenBattleXStamina' style='display: "+(gm.getValue("WhenBattle",false)!="At X Stamina"?"none":"block")+"'>";c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td>Start Battles When Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XBattleStamina","Start battling if stamina is above this points",1,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";c+="<tr><td style='padding-left: 10px'>Keep This Stamina</td><td style='text-align: right'>"+
this.MakeNumberForm("XMinBattleStamina","Don't battle if stamina is below this points",0,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";c+="</div>";c+="<div id='caap_WhenBattleHide' style='display: "+(gm.getValue("WhenBattle",false)!="Never"?"block":"none")+"'>";return c}catch(d){log("ERROR in AddBattleMenu: "+d);return false}},AddMonsterMenu:function(){try{var c=["Ambrosia","Malekus","Corvintheus","Aurora","Azeron"],d=['<img src="http://image2.castleagegame.com/graphics/symbol_tiny_1.jpg" height="15" width="14"/>',
'<img src="http://image2.castleagegame.com/graphics/symbol_tiny_2.jpg" height="15" width="14"/>','<img src="http://image2.castleagegame.com/graphics/symbol_tiny_3.jpg" height="15" width="14"/>','<img src="http://image2.castleagegame.com/graphics/symbol_tiny_4.jpg" height="15" width="14"/>','<img src="http://image2.castleagegame.com/graphics/symbol_tiny_5.jpg" height="15" width="14"/>'],e=0,f="";f+=this.ToggleControl("Monster","MONSTER");f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
f+="<tr><td style='width: 35%'>Attack When</td><td style='text-align: right'>"+this.MakeDropDown("WhenMonster",["Stamina Available","At Max Stamina","At X Stamina","Stay Hidden","Never"],["Stamina Available will attack whenever you have enough stamina","At Max Stamina will attack when stamina is at max and will burn down all stamina when able to level up","At X Stamina you can set maximum and minimum stamina to battle",'Stay Hidden uses stamina to try to keep you under 10 health so you cannot be attacked, while also attempting to maximize your stamina use for Monster attacks. YOU MUST SET BATTLE WHEN TO "STAY HIDDEN" TO USE THIS FEATURE.',
"Never - disables attacking monsters"],"style='font-size: 10px; width: 100%;'")+"</td></tr></table>";f+="<div id='caap_WhenMonsterXStamina' style='display: "+(gm.getValue("WhenMonster",false)!="At X Stamina"?"none":"block")+"'>";f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";f+="<tr><td>Battle When Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XMonsterStamina","Start attacking if stamina is above this points",1,"size='3' style='font-size: 10px; text-align: right'")+
"</td></tr>";f+="<tr><td style='padding-left: 10px'>Keep This Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XMinMonsterStamina","Don't attack if stamina is below this points",0,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr></table>";f+="</div>";f+="<div id='caap_WhenMonsterHide' style='display: "+(gm.getValue("WhenMonster",false)!="Never"?"block":"none")+"'>";f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";f+="<tr><td>Monster delay secs</td><td style='text-align: right'>"+
this.MakeNumberForm("seedTime","Max random delay to battle monsters",300,"type='text' size='4' style='font-size: 10px; text-align: right'")+"</td></tr>";f+=this.MakeCheckTR("Power Attack Only","PowerAttack",true,"PowerAttack_Adv","Use power attacks. Only do normal attacks if power attack not possible",true);f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";f+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Power Attack Max","PowerAttackMax",false,"","(EXPERIMENTAL) Use maximum power attacks globally on Skaar, Genesis, Ragnarok, and Bahamut types. Only do normal power attacks if maximum power attack not possible")+
"</table>";f+="</div>";f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";f+=this.MakeCheckTR("Power Fortify Max","PowerFortifyMax",false,"","(EXPERIMENTAL) Use maximum power fortify globally on Skaar, Genesis, Ragnarok, and Bahamut types. Only do normal power attacks if maximum power attack not possible");f+=this.MakeCheckTR("Siege weapon assist","DoSiege",true,"","Turns on or off automatic siege assist for all monsters and raids.");f+=this.MakeCheckTR("Clear Complete Monsters","clearCompleteMonsters",
false,"","");f+=this.MakeCheckTR("Achievement Mode","AchievementMode",true,"","Check if monsters have reached achievement damage level first. Switch when achievement met.");f+=this.MakeCheckTR("Get Demi Points First","DemiPointsFirst",false,"DemiList","Don't attack monsters until you've gotten all your demi points from battling.",true);f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";for(e in d)if(d.hasOwnProperty(e))f+=d[e]+this.MakeCheckBox("DemiPoint"+e,true,"",c[e]);f+="</table>";
f+="</div>";f+="<table width='180px' cellpadding='0px' cellspacing='0px'>";f+="<tr><td>Fortify If Percentage Under</td><td style='text-align: right'>"+this.MakeNumberForm("MaxToFortify","Fortify if ship health is below this % (leave blank to disable)",50,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";f+="<tr><td style='padding-left: 10px'>Quest If Percentage Over</td><td style='text-align: right'>"+this.MakeNumberForm("MaxHealthtoQuest","Do Quests if ship health is above this % and quest mode is set to Not Fortify (leave blank to disable)",
60,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";f+="<tr><td>No Attack If Percentage Under</td><td style='text-align: right'>"+this.MakeNumberForm("MinFortToAttack","Don't attack if ship health is below this % (leave blank to disable)",10,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";f+="Attack Monsters in this order <a href='http://senses.ws/caap/index.php?topic=1502.0' target='_blank'><font color='red'>?</font></a><br />";f+=this.MakeTextBox("orderbattle_monster",
"List of search words that decide which monster to attack first. Use words in player name or in monster name. To specify max damage follow keyword with :max token and specifiy max damage values. Use 'k' and 'm' suffixes for thousand and million. To override achievement use the ach: token and specify damage values."," rows='3' cols='25'");f+="</div>";f+="<hr/></div>";return f}catch(g){log("ERROR in AddMonsterMenu: "+g);return false}},AddMonsterFinderMenu:function(){try{var c="";c+=this.ToggleControl("MonsterFinder",
"MONSTER FINDER");c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+=this.MakeCheckTR("Use Monster Finder","MonsterFinderUse",false,"MonsterFinderUse_Adv","When monsters are over max damage, use Monster Finder?",true);c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td>Monster Find Min Stam</td><td style='text-align: right'>"+this.MakeNumberForm("MonsterFinderMinStam","Don't find new monster if stamina under this amount",50,"size='3' style='font-size: 10px; text-align: right'")+
"</td></tr>";c+="<tr><td>Min-Check Feed (minutes)</td><td style='text-align: right'>"+this.MakeNumberForm("MonsterFinderFeedMin","Wait at least this many minutes before checking the Castle Age feed (in Facebook) (Max 120)",15,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr></table>";c+="Find Monster Priority <a href='http://senses.ws/caap/index.php?topic=66.0' target='_blank'><font color='red'>?</font></a>";c+=this.MakeTextBox("MonsterFinderOrder","List of search words that decide which monster to attack first.  Can be names or monster types.",
" rows='3' cols='25'");c+="</div>";c+="<hr/></div>";return c}catch(d){log("ERROR in AddMonsterFinderMenu: "+d);return false}},AddReconMenu:function(){try{var c="";c+=this.ToggleControl("Recon","RECON");c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+=this.MakeCheckTR("Enable Player Recon","DoPlayerRecon",false,"PlayerReconControl","Enable player battle reconnaissance to run as an idle background task. Battle targets will be collected and can be displayed using the 'Target List' selection on the dashboard.",
true);c+="Find battle targets that are:";c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td style='padding-left: 10px'>Not Lower Than Rank Minus</td><td style='text-align: right'>"+this.MakeNumberForm("ReconPlayerRank","Provide the number of ranks below you which recon will use to filter targets. This value will be subtracted from your rank to establish the minimum rank that recon will consider as a viable target. Default 3.","3","size='2' style='font-size: 10px; text-align: right'")+
"</td></tr>";c+="<tr><td style='padding-left: 10px'>Not Higher Than Level Plus</td><td style='text-align: right'>"+this.MakeNumberForm("ReconPlayerLevel","Provide the number of levels above you which recon will use to filter targets. This value will be added to your level to establish the maximum level that recon will consider as a viable target. Default 10.","10","size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";c+="<tr><td style='padding-left: 10px'>Not Higher Than X*Army</td><td style='text-align: right'>"+
this.MakeNumberForm("ReconPlayerARBase","This value sets the base for your army ratio calculation. It is basically a multiplier for the army size of a player at your equal level. For example, a value of .5 means you will battle an opponent the same level as you with an army half the size of your army or less. Default 1.","1","size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";c+="</div>";c+="<hr/></div>";return c}catch(d){log("ERROR in AddReconMenu: "+d);return false}},AddGeneralsMenu:function(){try{var c=
0,d="";this.BuildGeneralLists();d+=this.ToggleControl("Generals","GENERALS");d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Do not reset General","ignoreGeneralImage",false,"","(EXPERIMENTAL) This will prevent the script from changing your selected General to 'Use Current' if the script is unable to find the General's image when changing activities. Instead it will use the current General for the activity and try to select the correct General again next time.")+
"</table>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";for(c in this.standardGeneralList)if(this.standardGeneralList.hasOwnProperty(c))d+="<tr><td>"+this.standardGeneralList[c]+"</td><td style='text-align: right'>"+this.MakeDropDown(this.standardGeneralList[c]+"General",this.generalList,"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+"</td></tr>";d+="<tr><td>Level Up</td><td style='text-align: right'>"+this.MakeDropDown("LevelUpGeneral",this.generalList,
"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+"</td></tr></table>";d+="<div id='caap_LevelUpGeneralHide' style='display: "+(gm.getValue("LevelUpGeneral",false)!="Use Current"?"block":"none")+"'>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td>Exp To Use LevelUp Gen </td><td style='text-align: right'>"+this.MakeNumberForm("LevelUpGeneralExp","Specify the number of experience points below the next level up to begin using the level up general.",
20,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";d+=this.MakeCheckTR("Level Up Gen For Idle","IdleLevelUpGeneral",true,"","Use the Level Up General for Idle mode.");d+=this.MakeCheckTR("Level Up Gen For Monsters","MonsterLevelUpGeneral",true,"","Use the Level Up General for Monster mode.");d+=this.MakeCheckTR("Level Up Gen For Fortify","FortifyLevelUpGeneral",true,"","Use the Level Up General for Fortify mode.");d+=this.MakeCheckTR("Level Up Gen For Battles","BattleLevelUpGeneral",
true,"","Use the Level Up General for Battle mode.");d+=this.MakeCheckTR("Level Up Gen For SubQuests","SubQuestLevelUpGeneral",true,"","Use the Level Up General for doing sub-quests.");d+=this.MakeCheckTR("Level Up Gen For MainQuests","QuestLevelUpGeneral",true,"","Use the Level Up General for doing primary quests (Warning: May cause you not to gain influence if wrong general is equipped.)");d+="</table></div>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Reverse Under Level 4 Order",
"ReverseLevelUpGenerals",false,"","This will make the script level Generals under level 4 from Top-down instead of Bottom-up")+"</table>";d+="<hr/></div>";return d}catch(e){log("ERROR in AddGeneralsMenu: "+e);return false}},AddSkillPointsMenu:function(){try{var c=["","Energy","Attack","Defense","Stamina","Health"],d="";d+=this.ToggleControl("Status","UPGRADE SKILL POINTS");d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Auto Add Upgrade Points","AutoStat",false,
"AutoStat_Adv","Automatically increase attributes when upgrade skill points are available.",true);d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Upgrade Immediately","StatImmed",false,"","Update Stats Immediately");d+=this.MakeCheckTR("Advanced Settings <a href='http://userscripts.org/posts/207279' target='_blank'><font color='red'>?</font></a>","AutoStatAdv",false,"","USE WITH CAUTION: You can use numbers or formulas(ie. level * 2 + 10). Variable keywords include energy, health, stamina, attack, defense, and level. JS functions can be used (Math.min, Math.max, etc) !!!Remember your math class: 'level + 20' not equals 'level * 2 + 10'!!!")+
"</table>";d+="<div id='caap_Status_Normal' style='display: "+(gm.getValue("AutoStatAdv",false)?"none":"block")+"'>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td style='width: 25%; text-align: right'>Increase</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute0",c,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue0","Automatically increase attributes when upgrade skill points are available.",
0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute1",c,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue1","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+
" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute2",c,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue2","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+
this.MakeDropDown("Attribute3",c,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue3","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute4",c,"","style='font-size: 10px'")+
"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue4","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr></table>";d+="</div>";d+="<div id='caap_Status_Adv' style='display: "+(gm.getValue("AutoStatAdv",false)?"block":"none")+"'>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td style='width: 25%; text-align: right'>Increase</td><td style='width: 50%; text-align: center'>"+
this.MakeDropDown("Attribute5",c,"","style='font-size: 10px'")+"</td><td style='width: 25%; text-align: left'>using</td></tr>";d+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue5","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute6",c,"","style='font-size: 10px'")+
"</td><td style='width: 25%'>using</td></tr>";d+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue6","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute7",c,"","style='font-size: 10px'")+"</td><td style='width: 25%'>using</td></tr>";d+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue7",
"Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute8",c,"","style='font-size: 10px'")+"</td><td style='width: 25%'>using</td></tr>";d+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue8","Automatically increase attributes when upgrade skill points are available.",
0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";d+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute9",c,"","style='font-size: 10px'")+"</td><td style='width: 25%'>using</td></tr>";d+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue9","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr></table>";
d+="</div>";d+="</table></div>";d+="<hr/></div>";return d}catch(e){log("ERROR in AddSkillPointsMenu: "+e);return false}},AddOtherOptionsMenu:function(){try{var c=["Same Gift As Received","Random Gift"],d="";c=c.concat(gm.getList("GiftList"));c.push("Get Gift List");d+=this.ToggleControl("Other","OTHER OPTIONS");d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Display CAAP Banner","BannerDisplay",true,"","Uncheck if you wish to hide the CAAP banner.");d+=this.MakeCheckTR("Use 24 Hour Format",
"use24hr",true,"","Use 24 hour format for displayed times.");d+=this.MakeCheckTR("Set Title","SetTitle",false,"SetTitle_Adv","Set the title bar.",true);d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Display Action","SetTitleAction",false,"","Add the current action.");d+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Display Name","SetTitleName",false,"","Add the player name.")+"</td></tr></table>";d+="</div>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
d+=this.MakeCheckTR("Hide Sidebar Adverts","HideAds",false,"","Hides the sidebar adverts.");d+=this.MakeCheckTR("Auto Collect MA","AutoCollectMA",true,"","Auto collect your Master and Apprentice rewards.");d+=this.MakeCheckTR("Auto Alchemy","AutoAlchemy",false,"AutoAlchemy_Adv","AutoAlchemy will combine all recipes that do not have missing ingredients. By default, it will not combine Battle Hearts recipes.",true);d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Do Battle Hearts",
"AutoAlchemyHearts",false,"","If for some reason you do not want to skip Battle Hearts")+"</td></tr></table>";d+="</div>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Auto Potions","AutoPotions",false,"AutoPotions_Adv","Enable or disable the auto consumption of energy and stamina potions.",true);d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td style='padding-left: 10px'>Spend Stamina Potions At</td><td style='text-align: right'>"+this.MakeNumberForm("staminaPotionsSpendOver",
"Number of stamina potions at which to begin consuming.",39,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 10px'>Keep Stamina Potions</td><td style='text-align: right'>"+this.MakeNumberForm("staminaPotionsKeepUnder","Number of stamina potions to keep.",35,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 10px'>Spend Energy Potions At</td><td style='text-align: right'>"+this.MakeNumberForm("energyPotionsSpendOver",
"Number of energy potions at which to begin consuming.",39,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 10px'>Keep Energy Potions</td><td style='text-align: right'>"+this.MakeNumberForm("energyPotionsKeepUnder","Number of energy potions to keep.",35,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 10px'>Wait If Exp. To Level</td><td style='text-align: right'>"+this.MakeNumberForm("potionsExperience",
"Do not consume potions if the experience points to the next level are within this value.",20,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";d+="</div>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Auto Elite Army","AutoElite",true,"AutoEliteControl","Enable or disable Auto Elite function",true);d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Timed Only","AutoEliteIgnore",false,
"","Use this option if you have a small army and are unable to fill all 10 Elite positions. This prevents the script from checking for any empty places and will cause Auto Elite to run on its timer only.")+"</table>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td><input type='button' id='caap_resetElite' value='Do Now' style='padding: 0; font-size: 10px; height: 18px' /></tr></td>";d+="<tr><td>"+this.MakeTextBox("EliteArmyList","Try these UserIDs first. Use ',' between each UserID",
" rows='3' cols='25'")+"</td></tr></table>";d+="</div>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+=this.MakeCheckTR("Auto Return Gifts","AutoGift",false,"GiftControl","Automatically receive and send return gifts.",true);d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td style='width: 25%; padding-left: 10px'>Give</td><td style='text-align: right'>"+this.MakeDropDown("GiftChoice",c,"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";d+="</div>";
d+="<table width='180px' cellpadding='0px' cellspacing='0px' style='margin-top: 3px'>";d+="<tr><td style='width: 50%'>Auto bless</td><td style='text-align: right'>"+this.MakeDropDown("AutoBless",["None","Energy","Attack","Defense","Stamina","Health"],"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";d+="<table width='180px' cellpadding='0px' cellspacing='0px' style='margin-top: 3px'>";d+="<tr><td style='width: 50%'>Style</td><td style='text-align: right'>"+this.MakeDropDown("DisplayStyle",
["CA Skin","Original","Custom","None"],"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";d+="<div id='caap_DisplayStyleHide' style='display: "+(gm.getValue("DisplayStyle",false)=="Custom"?"block":"none")+"'>";d+="<table width='180px' cellpadding='0px' cellspacing='0px'>";d+="<tr><td style='padding-left: 10px'><b>Started</b></td><td style='text-align: right'><input type='button' id='caap_StartedColorSelect' value='Select' style='padding: 0; font-size: 10px; height: 18px' /></td></tr>";
d+="<tr><td style='padding-left: 20px'>RGB Color</td><td style='text-align: right'>"+this.MakeNumberForm("StyleBackgroundLight","FFF or FFFFFF","#E0C691","type='text' size='5' style='font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 20px'>Transparency</td><td style='text-align: right'>"+this.MakeNumberForm("StyleOpacityLight","0 ~ 1","1","type='text' size='5' style='vertical-align: middle; font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 10px'><b>Stoped</b></td><td style='text-align: right'><input type='button' id='caap_StopedColorSelect' value='Select' style='padding: 0; font-size: 10px; height: 18px' /></td></tr>";
d+="<tr><td style='padding-left: 20px'>RGB Color</td><td style='text-align: right'>"+this.MakeNumberForm("StyleBackgroundDark","FFF or FFFFFF","#B09060","type='text' size='5' style='font-size: 10px; text-align: right'")+"</td></tr>";d+="<tr><td style='padding-left: 20px'>Transparency</td><td style='text-align: right'>"+this.MakeNumberForm("StyleOpacityDark","0 ~ 1","1","type='text' size='5' style='font-size: 10px; text-align: right'")+"</td></tr></table>";d+="</div>";d+="<table width='180px' cellpadding='0px' cellspacing='0px' style='margin-top: 3px'>";
d+="<tr><td><input type='button' id='caap_FillArmy' value='Fill Army' style='padding: 0; font-size: 10px; height: 18px' /></td></tr></table>";d+="</div>";d+="<hr/></div>";return d}catch(e){log("ERROR in AddOtherOptionsMenu: "+e);return false}},AddFooterMenu:function(){try{var c="";c+="<table width='180px' cellpadding='0px' cellspacing='0px'>";c+="<tr><td style='width: 90%'>Unlock Menu <input type='button' id='caap_ResetMenuLocation' value='Reset' style='padding: 0; font-size: 10px; height: 18px' /></td><td style='width: 10%; text-align: right'><input type='checkbox' id='unlockMenu' /></td></tr></table>";
c+="Version: "+caapVersion+" - <a href='"+global.discussionURL+"' target='_blank'>CAAP Forum</a><br />";if(global.newVersionAvailable)c+="<a href='http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/Castle-Age-Autoplayer.user.js'>Install new CAAP version: "+gm.getValue("SUC_remote_version")+"!</a>";return c}catch(d){log("ERROR in AddFooterMenu: "+d);return false}},AddColorWheels:function(){try{$.farbtastic($("<div id='caap_ColorSelectorDiv1'></div>").css({background:gm.getValue("StyleBackgroundLight",
"#E0C691"),padding:"5px",border:"2px solid #000",top:window.innerHeight/2-100+"px",left:window.innerWidth/2-290+"px",zIndex:"1337",position:"fixed",display:"none"}).appendTo(document.body),function(d){$("#caap_ColorSelectorDiv1").css({"background-color":d});$("#caap_StyleBackgroundLight").val(d);gm.setValue("StyleBackgroundLight",d);gm.setValue("CustStyleBackgroundLight",d)}).setColor(gm.getValue("StyleBackgroundLight","#E0C691"));$.farbtastic($("<div id='caap_ColorSelectorDiv2'></div>").css({background:gm.getValue("StyleBackgroundDark",
"#B09060"),padding:"5px",border:"2px solid #000",top:window.innerHeight/2-100+"px",left:window.innerWidth/2+"px",zIndex:"1337",position:"fixed",display:"none"}).appendTo(document.body),function(d){$("#caap_ColorSelectorDiv2").css({"background-color":d});$("#caap_StyleBackgroundDark").val(d);gm.setValue("StyleBackgroundDark",d);gm.setValue("CustStyleBackgroundDark",d)}).setColor(gm.getValue("StyleBackgroundDark","#B09060"));return true}catch(c){log("ERROR in AddColorWheels: "+c);return false}},AddDashboard:function(){try{var c=
"<div id='caap_top'>",d={x:0,y:0};c+="<div id='caap_buttonMonster' style='position:absolute;top:0px;left:250px;display:"+(gm.getValue("DBDisplay","Monster")=="Monster"?"block":"none")+"'><input type='button' id='caap_refreshMonsters' value='Refresh Monster List' style='padding: 0; font-size: 9px; height: 18px' /></div>";c+="<div id='caap_buttonTargets' style='position:absolute;top:0px;left:250px;display:"+(gm.getValue("DBDisplay","Monster")=="Target List"?"block":"none")+"'><input type='button' id='caap_clearTargets' value='Clear Targets List' style='padding: 0; font-size: 9px; height: 18px' /></div>";
c+="<div id='caap_buttonFeed' style='position:absolute;top:0px;left:0px;'><input id='caap_liveFeed' type='button' value='LIVE FEED! Your friends are calling.' style='padding: 0; font-size: 9px; height: 18px' /></div>";c+="<div id='caap_DBDisplay' style='font-size: 9px;position:absolute;top:0px;right:0px;'>Display: "+this.DBDropDown("DBDisplay",["Monster","Target List"],"","style='font-size: 9px; min-width: 120px; max-width: 120px; width : 120px;'")+"</div>";c+="<div id='caap_infoMonster' style='position:relative;top:15px;width:610px;height:165px;overflow:auto;display:"+
(gm.getValue("DBDisplay","Monster")=="Monster"?"block":"none")+"'></div>";c+="<div id='caap_infoTargets1' style='position:relative;top:15px;width:610px;height:165px;overflow:auto;display:"+(gm.getValue("DBDisplay","Monster")=="Target List"?"block":"none")+"'></div>";c+="<div id='caap_infoTargets2' style='position:relative;top:15px;width:610px;height:165px;overflow:auto;display:"+(gm.getValue("DBDisplay","Monster")=="Target Stats"?"block":"none")+"'></div>";c+="</div>";this.dashboardXY.x=gm.getValue("caap_top_menuLeft",
"");this.dashboardXY.y=gm.getValue("caap_top_menuTop",$(this.dashboardXY.selector).offset().top-10);d=this.GetDashboardXY();$(c).css({background:gm.getValue("StyleBackgroundLight","white"),padding:"5px",height:"185px",width:"610px",margin:"0 auto",opacity:gm.getValue("StyleOpacityLight","1"),top:d.y+"px",left:d.x+"px",zIndex:gm.getValue("caap_top_zIndex","1"),position:"absolute"}).appendTo(document.body);this.caapTopObject=$("#caap_top");$("#caap_refreshMonsters").button();$("#caap_clearTargets").button();
$("#caap_liveFeed").button();return true}catch(e){log("ERROR in AddDashboard: "+e);return false}},makeCommaValue:function(c){c=c.split(".")[0];for(var d=/(\d+)(\d{3})/;d.test(c);)c=c.replace(d,"$1,$2");return c},makeTd:function(c,d){if(gm.getObjVal(d,"color"))d=gm.getObjVal(d,"color");d||(d="black");return"<td><font size=1 color='"+d+"'>"+c+"</font></td>"},UpdateDashboard:function(){try{if($("#caap_top").length===0)throw"We are missing the Dashboard div!";if(!this.oneMinuteUpdate("dashboard")&&$("#caap_infoMonster").html()&&
$("#caap_infoMonster").html())return false;this.UpdateDashboardWaitLog=true;var c="<table width=570 cellpadding=0 cellspacing=0 ><tr>",d=["Name","Damage","Damage%","Fort%","TimeLeft","T2K","Phase","Link"];for(var e in d)if(d.hasOwnProperty(e))c+="<td><b><font size=1>"+d[e]+"</font></b></td>";c+="</tr>";d.shift();gm.getList("monsterOl").forEach(function(r){var t=r.split(global.vs)[0],s=caap.getMonstType(t),v=10,u=0;if(caap.monsterInfo[s]){var x=caap.monsterInfo[s].staLvl;if(!caap.InLevelUpMode()&&
gm.getValue("PowerFortifyMax")&&x)for(u=caap.monsterInfo[s].staLvl.length-1;u>=0;u-=1)if(caap.stats.stamina.max>caap.monsterInfo[s].staLvl[u])break;if(u&&gm.getValue("PowerAttackMax")&&caap.monsterInfo[s].nrgMax)v=caap.monsterInfo[s].nrgMax[u]}var w="";c+="<tr>";w=t==gm.getValue("targetFromfortify")&&caap.CheckEnergy(v,gm.getValue("WhenFortify","Energy Available"),"fortify_mess")?"blue":t==gm.getValue("targetFromraid")||t==gm.getValue("targetFrombattle_monster")?"green":gm.getObjVal(r,"color","black");
c+=caap.makeTd(t,w);d.forEach(function(B){if(B=="Phase"&&w=="grey")c+=caap.makeTd(gm.getObjVal(r,"status"),w);else{var y=gm.getObjVal(r,B);if(y&&!(B=="Fort%"&&y==101)){if(parseInt(y,10).toString()==y)y=caap.makeCommaValue(y);c+=caap.makeTd(y+(B.match(/%/)?"%":""),w)}else c+="<td></td>"}});c+="</tr>"});c+="</table>";$("#caap_infoMonster").html(c);c="<table width=570 cellpadding=0 cellspacing=0 ><tr>";e=["UserId","Name","Deity#","Rank","Rank#","Level","Army","Last Alive"];var f=["nameStr","deityNum",
"rankStr","rankNum","levelNum","armyNum","aliveTime"];for(var g in e)if(e.hasOwnProperty(g))c+="<td><b><font size=1>"+e[g]+"</font></b></td>";var h=gm.getList("targetsOl");for(var k in h)if(h.hasOwnProperty(k)){var l=h[k],m=l.split(global.vs)[0];c+="<tr>";c+=this.makeTd("<a href='http://apps.facebook.com/castle_age/keep.php?user="+m+"'>"+m+"</a>","blue");for(var p in f)if(f.hasOwnProperty(p)){var n=gm.getObjVal(l,f[p]);if(n){if(/\S+Num/.test(f[p]))n=this.makeCommaValue(n);if(/\S+Time/.test(f[p])){var q=
new Date(parseInt(n,10));n=q.getMonth()+1+"/"+q.getDate()+" "+q.getHours()+":"+(q.getMinutes()<10?"0":"")+q.getMinutes()}c+=this.makeTd(n,"black")}else c+="<td></td>"}c+="</tr>"}c+="</table>";$("#caap_infoTargets1").html(c);return true}catch(o){log("ERROR in UpdateDashboard: "+o);return false}},dbDisplayListener:function(c){try{var d=c.target.options[c.target.selectedIndex].value;gm.setValue("DBDisplay",d);switch(d){case "Target List":caap.SetDisplay("infoMonster",false);caap.SetDisplay("infoTargets1",
true);caap.SetDisplay("infoTargets2",false);caap.SetDisplay("buttonMonster",false);caap.SetDisplay("buttonTargets",true);break;case "Target Stats":caap.SetDisplay("infoMonster",false);caap.SetDisplay("infoTargets1",false);caap.SetDisplay("infoTargets2",true);caap.SetDisplay("buttonMonster",false);caap.SetDisplay("buttonTargets",true);break;case "Monster":caap.SetDisplay("infoMonster",true);caap.SetDisplay("infoTargets1",false);caap.SetDisplay("infoTargets2",false);caap.SetDisplay("buttonMonster",
true);caap.SetDisplay("buttonTargets",false);break;default:}gm.setValue("resetdashboard",true);return true}catch(e){log("ERROR in dbDisplayListener: "+e);return false}},refreshMonstersListener:function(){gm.setValue("monsterReview",0);gm.setValue("monsterReviewCounter",-3);gm.setValue("NotargetFrombattle_monster",0);gm.setValue("ReleaseControl",true)},liveFeedButtonListener:function(){caap.ClickAjax("army_news_feed.php")},clearTargetsButtonListener:function(){gm.setValue("targetsOl","");gm.setValue("resetdashboard",
true)},AddDBListener:function(){try{document.getElementById("caap_DBDisplay")||this.ReloadCastleAge();$("#caap_DBDisplay").change(this.dbDisplayListener);$("#caap_refreshMonsters").click(this.refreshMonstersListener);$("#caap_liveFeed").click(this.liveFeedButtonListener);$("#caap_clearTargets").click(this.clearTargetsButtonListener);return true}catch(c){log("ERROR in AddDBListener: "+c);return false}},SetDisplay:function(c,d){try{d===true?$("#caap_"+c).css("display","block"):$("#caap_"+c).css("display",
"none");return true}catch(e){log("ERROR in SetDisplay: "+e);return false}},CheckBoxListener:function(c){try{var d=c.target.id.replace(/caap_/i,"");log("Change: setting '"+d+"' to "+c.target.checked);gm.setValue(d,c.target.checked);c.target.className&&caap.SetDisplay(c.target.className,c.target.checked);switch(d){case "AutoStatAdv":if(c.target.checked){caap.SetDisplay("Status_Normal",false);caap.SetDisplay("Status_Adv",true)}else{caap.SetDisplay("Status_Normal",true);caap.SetDisplay("Status_Adv",false)}caap.statsMatch=
true;break;case "HideAds":c.target.checked?$(".UIStandardFrame_SidebarAds").css("display","none"):$(".UIStandardFrame_SidebarAds").css("display","block");break;case "BannerDisplay":c.target.checked?$("#caap_BannerHide").css("display","block"):$("#caap_BannerHide").css("display","none");break;case "IgnoreBattleLoss":if(c.target.checked){log("Ignore Battle Losses has been enabled.");gm.deleteValue("BattlesLostList");log("Battle Lost List has been cleared.")}break;case "SetTitle":case "SetTitleAction":case "SetTitleName":if(c.target.checked){d=
"";if(gm.getValue("SetTitleAction",false)){var e=$("#caap_activity_mess").html();if(e)d+=e.replace("Activity: ","")+" - "}if(gm.getValue("SetTitleName",false))d+=gm.getValue("PlayerName","CAAP")+" - ";document.title=d+global.documentTitle}else document.title=global.documentTitle;break;case "unlockMenu":if(c.target.checked){$(":input[id^='caap_']").attr({disabled:true});caap.caapDivObject.css("cursor","move").draggable({stop:function(){caap.SaveControlXY()}});caap.caapTopObject.css("cursor","move").draggable({stop:function(){caap.SaveDashboardXY()}})}else{caap.caapDivObject.css("cursor",
"").draggable("destroy");caap.caapTopObject.css("cursor","").draggable("destroy");$(":input[id^='caap_']").attr({disabled:false})}break;case "AutoElite":gm.deleteValue("AutoEliteGetList");gm.deleteValue("AutoEliteReqNext");gm.deleteValue("AutoEliteEnd");gm.deleteValue("MyEliteTodo");if(!gm.getValue("FillArmy",false)){gm.deleteValue(caap.friendListType.giftc.name+"Requested");gm.deleteValue(caap.friendListType.giftc.name+"Responded")}break;case "AutoPotions":gm.deleteValue("AutoPotionTimer");break;
default:}return true}catch(f){log("ERROR in CheckBoxListener: "+c);return false}},TextBoxListener:function(c){try{var d=c.target.id.replace(/caap_/i,"");log('Change: setting "'+d+'" to "'+c.target.value+'"');if(/Style+/.test(d))switch(d){case "StyleBackgroundLight":if(c.target.value.substr(0,1)!=="#")c.target.value="#"+c.target.value;gm.setValue("CustStyleBackgroundLight",c.target.value);break;case "StyleBackgroundDark":if(c.target.value.substr(0,1)!=="#")c.target.value="#"+c.target.value;gm.setValue("CustStyleBackgroundDark",
c.target.value);break;case "StyleOpacityLight":gm.setValue("CustStyleOpacityLight",c.target.value);break;case "StyleOpacityDark":gm.setValue("CustStyleOpacityDark",c.target.value);break;default:}else if(/AttrValue+/.test(d))caap.statsMatch=true;else if(/energyPotions+/.test(d)||/staminaPotions+/.test(d))gm.deleteValue("AutoPotionTimer");gm.setValue(d,c.target.value);return true}catch(e){log("ERROR in TextBoxListener: "+c);return false}},DropBoxListener:function(c){try{if(c.target.selectedIndex>0){var d=
c.target.id.replace(/caap_/i,""),e=c.target.options[c.target.selectedIndex].value,f=c.target.options[c.target.selectedIndex].title;log('Change: setting "'+d+'" to "'+e+'" with title "'+f+'"');gm.setValue(d,e);c.target.title=f;if(d=="WhenQuest"||d=="WhenBattle"||d=="WhenMonster"||d=="LevelUpGeneral"){caap.SetDisplay(d+"Hide",e!="Never");if(d=="WhenBattle"||d=="WhenMonster"){caap.SetDisplay(d+"XStamina",e=="At X Stamina");caap.SetDisplay("WhenBattleStayHidden1",gm.getValue("WhenBattle",false)=="Stay Hidden"&&
gm.getValue("WhenMonster",false)!="Stay Hidden")}d=="WhenBattle"&&caap.SetDisplay("WhenBattleStayHidden2",gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",false)=="None");d=="WhenQuest"&&caap.SetDisplay(d+"XEnergy",e=="At X Energy")}else if(d=="QuestArea"||d=="QuestSubArea"||d=="WhyQuest"){gm.setValue("AutoQuest","");caap.ClearAutoQuest();if(d=="QuestArea")switch(e){case "Quest":$("#trQuestSubArea").css("display","table-row");caap.ChangeDropDownList("QuestSubArea",
caap.landQuestList);break;case "Demi Quests":$("#trQuestSubArea").css("display","table-row");caap.ChangeDropDownList("QuestSubArea",caap.demiQuestList);break;case "Atlantis":$("#trQuestSubArea").css("display","table-row");caap.ChangeDropDownList("QuestSubArea",caap.atlantisQuestList);break;default:}}else if(d=="IdleGeneral"){gm.setValue("MaxIdleEnergy",0);gm.setValue("MaxIdleStamina",0)}else if(d=="ArenaHide"){caap.SetDisplay("ArenaHSub",e!="None");caap.SetDisplay("WhenBattleStayHidden2",gm.getValue("WhenBattle",
false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",false)=="None")}else if(d=="TargetType"){caap.SetDisplay("WhenBattleStayHidden2",gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",false)=="None");switch(e){case "Freshmeat":caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",false);break;case "Userid List":caap.SetDisplay("FreshmeatSub",
false);caap.SetDisplay("UserIdsSub",true);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",false);break;case "Raid":caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",true);caap.SetDisplay("ArenaSub",false);break;case "Arena":caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",true);break;default:caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",
false);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",false)}}else if(/Attribute?/.test(d)){gm.setValue("SkillPointsNeed",1);caap.statsMatch=true}else if(d=="DisplayStyle"){caap.SetDisplay(d+"Hide",e=="Custom");switch(e){case "CA Skin":gm.setValue("StyleBackgroundLight","#E0C691");gm.setValue("StyleBackgroundDark","#B09060");gm.setValue("StyleOpacityLight","1");gm.setValue("StyleOpacityDark","1");break;case "None":gm.setValue("StyleBackgroundLight","white");gm.setValue("StyleBackgroundDark",
"white");gm.setValue("StyleOpacityLight","1");gm.setValue("StyleOpacityDark","1");break;case "Custom":gm.setValue("StyleBackgroundLight",gm.getValue("CustStyleBackgroundLight","#E0C691"));gm.setValue("StyleBackgroundDark",gm.getValue("CustStyleBackgroundDark","#B09060"));gm.setValue("StyleOpacityLight",gm.getValue("CustStyleOpacityLight","1"));gm.setValue("StyleOpacityDark",gm.getValue("CustStyleOpacityDark","1"));break;default:gm.setValue("StyleBackgroundLight","#efe");gm.setValue("StyleBackgroundDark",
"#fee");gm.setValue("StyleOpacityLight","1");gm.setValue("StyleOpacityDark","1")}caap.caapDivObject.css({background:gm.getValue("StyleBackgroundDark","#fee"),opacity:gm.getValue("StyleOpacityDark","1")});caap.caapTopObject.css({background:gm.getValue("StyleBackgroundDark","#fee"),opacity:gm.getValue("StyleOpacityDark","1")})}}return true}catch(g){log("ERROR in DropBoxListener: "+g);return false}},TextAreaListener:function(c){try{var d=c.target.id.replace(/caap_/i,"");log('Change: setting "'+d+'" to "'+
c.target.value+'"');if(d=="orderbattle_monster"||d=="orderraid"){gm.setValue("monsterReview",0);gm.setValue("monsterReviewCounter",-3);gm.setValue("monsterReview",0);gm.setValue("monsterReviewCounter",-3)}caap.SaveBoxText(d);return true}catch(e){log("ERROR in TextAreaListener: "+e);return false}},PauseListener:function(){try{$("#caap_div").css({background:gm.getValue("StyleBackgroundDark","#fee"),opacity:"1","z-index":"3"});$("#caap_top").css({background:gm.getValue("StyleBackgroundDark","#fee"),
opacity:"1"});$("#caapPaused").css("display","block");global.is_chrome&&CE_message("paused",null,"block");gm.setValue("caapPause","block");return true}catch(c){log("ERROR in PauseListener: "+c);return false}},RestartListener:function(){try{$("#caapPaused").css("display","none");$("#caap_div").css({background:gm.getValue("StyleBackgroundLight","#efe"),opacity:gm.getValue("StyleOpacityLight","1"),"z-index":gm.getValue("caap_div_zIndex","2"),cursor:""});$("#caap_top").css({background:gm.getValue("StyleBackgroundLight",
"#efe"),opacity:gm.getValue("StyleOpacityLight","1"),"z-index":gm.getValue("caap_top_zIndex","1"),cursor:""});$(":input[id*='caap_']").attr({disabled:false});$("#unlockMenu").attr("checked",false);gm.setValue("caapPause","none");global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause","none"));gm.setValue("ReleaseControl",true);gm.setValue("resetselectMonster",true);caap.waitingForDomLoad=false;return true}catch(c){log("ERROR in RestartListener: "+c);return false}},ResetMenuLocationListener:function(){try{var c=
{x:0,y:0},d={x:0,y:0};gm.deleteValue("caap_div_menuLeft");gm.deleteValue("caap_div_menuTop");gm.deleteValue("caap_div_zIndex");caap.controlXY.x="";caap.controlXY.y=$(caap.controlXY.selector).offset().top;c=caap.GetControlXY(true);caap.caapDivObject.css({cursor:"","z-index":"2",top:c.y+"px",left:c.x+"px"});gm.deleteValue("caap_top_menuLeft");gm.deleteValue("caap_top_menuTop");gm.deleteValue("caap_top_zIndex");caap.dashboardXY.x="";caap.dashboardXY.y=$(caap.dashboardXY.selector).offset().top-10;d=caap.GetDashboardXY(true);
caap.caapTopObject.css({cursor:"","z-index":"1",top:d.y+"px",left:d.x+"px"});$(":input[id^='caap_']").attr({disabled:false});return true}catch(e){log("ERROR in ResetMenuLocationListener: "+e);return false}},FoldingBlockListener:function(c){try{var d=c.target.id.replace(/_Switch/i,""),e=document.getElementById(d);if(e.style.display=="block"){log("Folding: "+d);e.style.display="none";c.target.innerHTML=c.target.innerHTML.replace(/-/,"+");gm.setValue("Control_"+d.replace(/caap_/i,""),"none")}else{log("Unfolding: "+
d);e.style.display="block";c.target.innerHTML=c.target.innerHTML.replace(/\+/,"-");gm.setValue("Control_"+d.replace(/caap_/i,""),"block")}return true}catch(f){log("ERROR in FoldingBlockListener: "+f);return false}},whatClickedURLListener:function(c){try{for(var d=c.target;d&&!d.href;)d=d.parentNode;d&&d.href&&gm.setValue("clickUrl",d.href);return true}catch(e){log("ERROR in whatClickedURLListener: "+e);return false}},windowResizeListener:function(){try{if(window.location.href.indexOf("castle_age")){var c=
caap.GetControlXY();caap.caapDivObject.css("left",c.x+"px");var d=caap.GetDashboardXY();caap.caapTopObject.css("left",d.x+"px")}return true}catch(e){log("ERROR in windowResizeListener: "+e);return false}},AddListeners:function(){try{log("Adding listeners for caap_div");if($("#caap_div").length===0)throw"Unable to find div for caap_div";$('#caap_div input:checkbox[id^="caap_"]').change(this.CheckBoxListener);$('#caap_div input:text[id^="caap_"]').change(this.TextBoxListener);$("#unlockMenu").change(this.CheckBoxListener);
$('#caap_div select[id^="caap_"]').change(this.DropBoxListener);$('#caap_div textarea[id^="caap_"]').change(this.TextAreaListener);$('#caap_div a[id^="caap_Switch"]').click(this.FoldingBlockListener);$("#caap_FillArmy").click(function(){gm.setValue("FillArmy",true);gm.deleteValue("ArmyCount");gm.deleteValue("FillArmyList");gm.deleteValue(caap.friendListType.giftc.name+"Responded");gm.deleteValue(caap.friendListType.facebook.name+"Responded")});$("#caap_StartedColorSelect").click(function(){var d=
"none";if($("#caap_ColorSelectorDiv1").css("display")=="none")d="block";$("#caap_ColorSelectorDiv1").css("display",d)});$("#caap_StopedColorSelect").click(function(){var d="none";if($("#caap_ColorSelectorDiv2").css("display")=="none")d="block";$("#caap_ColorSelectorDiv2").css("display",d)});$("#caap_ResetMenuLocation").click(this.ResetMenuLocationListener);$("#caap_resetElite").click(function(){Elite.runtime.waitelite=0;log(" elite run "+Elite.runtime.waitelite);if(!gm.getValue("FillArmy",false)){gm.deleteValue(caap.friendListType.giftc.name+
"Requested");gm.deleteValue(caap.friendListType.giftc.name+"Responded")}});$("#caapRestart").click(this.RestartListener);$("#caap_control").mousedown(this.PauseListener);global.is_chrome&&$("#caap_control").mousedown(this.PauseListener);$("#stopAutoQuest").click(function(){gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");log("Change: setting stopAutoQuest and go to Manual");caap.ManualAutoQuest()});if($("#app46755028429_globalContainer").length===0)throw"Global Container not found";$("#app46755028429_globalContainer").find("a").bind("click",
this.whatClickedURLListener);$("#app46755028429_globalContainer").bind("DOMNodeInserted",function(d){d=$(d.target);if(d.is("#app46755028429_app_body")||d.is("#app46755028429_index")||d.is("#app46755028429_keep")||d.is("#app46755028429_generals")||d.is("#app46755028429_battle_monster")||d.is("#app46755028429_battle")||d.is("#app46755028429_battlerank")||d.is("#app46755028429_battle_train")||d.is("#app46755028429_arena")||d.is("#app46755028429_quests")||d.is("#app46755028429_raid")||d.is("#app46755028429_symbolquests")||
d.is("#app46755028429_alchemy")||d.is("#app46755028429_soldiers")||d.is("#app46755028429_item")||d.is("#app46755028429_land")||d.is("#app46755028429_magic")||d.is("#app46755028429_oracle")||d.is("#app46755028429_symbols")||d.is("#app46755028429_treasure_chest")||d.is("#app46755028429_gift")||d.is("#app46755028429_apprentice")||d.is("#app46755028429_news")||d.is("#app46755028429_friend_page")||d.is("#app46755028429_comments")||d.is("#app46755028429_army")||d.is("#app46755028429_army_news_feed")||d.is("#app46755028429_army_reqs")){caap.waitingForDomLoad=
false;$("#app46755028429_globalContainer").find("a").unbind("click",caap.whatClickedURLListener);$("#app46755028429_globalContainer").find("a").bind("click",caap.whatClickedURLListener);caap.node_trigger=window.setTimeout(function(){caap.node_trigger=null;caap.CheckResults()},100)}if(d.is(caap.dashboardXY.selector)){d=caap.GetDashboardXY();caap.caapTopObject.css("left",d.x+"px")}});$(window).unbind("resize",this.windowResizeListener);$(window).bind("resize",this.windowResizeListener);this.AddDBListener();
return true}catch(c){log("ERROR in AddListeners: "+c);return false}},GetStatusNumbers:function(c){try{if(!c)throw'No "node" supplied';var d=null,e=null,f=null,g=null;if(typeof c!="string"){var h=nHtml.GetText(c);if(!h)throw"No text found";d=this.statusRe.exec(h);if(!d)throw"Cannot find status:"+h;e=parseInt(d[1],10);f=parseInt(d[2],10);g=parseInt(d[2],10)-parseInt(d[1],10)}else{d=c.split("/");if(d.length!==2)throw"String did not split into 2 parts";e=parseInt(d[0],10);f=parseInt(d[1],10);g=parseInt(d[1],
10)-parseInt(d[0],10)}return{num:e,max:f,dif:g}}catch(k){log("ERROR in GetStatusNumbers: "+k);return{num:0,max:0,dif:0}}},GetStats:function(){try{this.stats={};var c=nHtml.FindByAttrContains(document.body,"div","class","keep_stat_title");if(c){var d=nHtml.GetText(c),e=this.rankRe.exec(d);if(e){var f=this.rankTable[$.trim(e[1].toString().toLowerCase())];if(f!==undefined){this.stats.rank=f;gm.setValue("MyRank",this.stats.rank);this.JustDidIt("MyRankLast")}else log("Unknown rank "+f+":"+e[1].toString())}var g=
d.match(/"(.+)"/);gm.setValue("PlayerName",g[1])}var h=nHtml.FindByAttrContains(document.body,"span","id","_current_health");h||(h=nHtml.FindByAttrXPath(document.body,"span","contains(@id,'_health') and not(contains(@id,'health_time'))"));this.stats.health=this.GetStatusNumbers(h.parentNode);this.stats.stamina=null;var k=nHtml.FindByAttrContains(document.body,"span","id","_current_stamina");k||(k=nHtml.FindByAttrXPath(document.body,"span","contains(@id,'_stamina') and not(contains(@id,'stamina_time'))"));
this.stats.stamina=this.GetStatusNumbers(k.parentNode);var l=nHtml.FindByAttrContains(document.body,"span","id","_current_energy");l||(l=nHtml.FindByAttrXPath(document.body,"span","contains(@id,'_energy') and not(contains(@id,'energy_time'))"));this.stats.energy=this.GetStatusNumbers(l.parentNode);var m=nHtml.FindByAttrContains(document.body,"div","title","experience points"),p=this.levelRe.exec(nHtml.GetText(m));if(p){this.stats.level=parseInt(p[1],10);gm.getValue("Level",0)!=this.stats.level&&gm.deleteValue("BestLandCost");
gm.setValue("Level",this.stats.level)}else log("Could not find level re");this.stats.rank=parseInt(gm.getValue("MyRank"),10);var n=nHtml.FindByAttrContains(document.body,"div","id","main_bntp"),q=nHtml.FindByAttrContains(n,"a","href","army"),o=nHtml.GetText(q),r=this.armyRe.exec(o);if(r){var t=parseInt(r[1],10);t=Math.min(t,501);this.stats.army=t}else log("Can't find armyRe in "+o);var s=nHtml.FindByAttrXPath(document.body,"strong","contains(string(),'$')");this.stats.cash=this.NumberOnly(nHtml.GetText(s));
this.stats.exp={};this.stats.exp.dif=Player.get("exp_needed");var v=parseFloat(gm.getObjVal("AutoQuest","expRatio"))||1.4,u=(Player.get("exp_needed")-this.stats.stamina.num*2.4-this.stats.energy.num*v)/(2.4+v)/12*60;this.stats.levelTime=new Date;var x=this.stats.levelTime.getMinutes();x+=u;this.stats.levelTime.setMinutes(x);this.SetDivContent("level_mess","Expected next level: "+this.FormatTime(this.stats.levelTime));if(this.DisplayTimer("DemiPointTimer"))this.CheckTimer("DemiPointTimer")?this.SetDivContent("demipoint_mess",
"Battle demipoints cleared"):this.SetDivContent("demipoint_mess","Next Battle DemiPts: "+this.DisplayTimer("DemiPointTimer"));if(this.DisplayTimer("ArenaRankTimer"))this.CheckTimer("ArenaRankTimer")?this.SetDivContent("arena_mess",""):this.SetDivContent("arena_mess","Next Arena Rank Check: "+this.DisplayTimer("ArenaRankTimer"));var w=nHtml.FindByAttrContains(document.body,"span","id","_gold_time_value");if(w){this.stats.paytime=$.trim(nHtml.GetText(w));this.stats.payminute=this.stats.paytime.substr(0,
this.stats.paytime.indexOf(":"))}return s&&h!==null}catch(B){log("ERROR GetStats: "+B);return false}},SetCheckResultsFunction:function(c){this.JustDidIt("SetResultsFunctionTimer");gm.setValue("ResultsFunction",c)},pageList:{index:{signaturePic:"gif",CheckResultsFunction:"CheckResults_index"},battle_monster:{signaturePic:"tab_monster_on.jpg",CheckResultsFunction:"CheckResults_fightList",subpages:["onMonster"]},onMonster:{signaturePic:"tab_monster_active.jpg",CheckResultsFunction:"CheckResults_viewFight"},
raid:{signaturePic:"tab_raid_on.gif",CheckResultsFunction:"CheckResults_fightList",subpages:["onRaid"]},onRaid:{signaturePic:"raid_back.jpg",CheckResultsFunction:"CheckResults_viewFight"},arena:{signaturePic:"tab_arena_on.gif",CheckResultsFunction:"CheckBattleResults"},land:{signaturePic:"tab_land_on.gif",CheckResultsFunction:"CheckResults_land"},generals:{signaturePic:"tab_generals_on.gif",CheckResultsFunction:"CheckResults_generals"},quests:{signaturePic:"tab_quest_on.gif",CheckResultsFunction:"CheckResults_quests"},
symbolquests:{signaturePic:"demi_quest_on.gif",CheckResultsFunction:"CheckResults_quests"},monster_quests:{signaturePic:"tab_atlantis_on.gif",CheckResultsFunction:"CheckResults_quests"},gift_accept:{signaturePic:"gif",CheckResultsFunction:"CheckResults_gift_accept"},army:{signaturePic:"invite_on.gif",CheckResultsFunction:"CheckResults_army"}},trackPerformance:false,performanceTimer:function(c){if(this.trackPerformance){var d=(new Date).getTime(),e=d-parseInt(gm.getValue("performanceTimer",0),10);
log("Performance Timer At "+c+" Time elapsed: "+e);gm.setValue("performanceTimer",d.toString())}},CheckResults:function(){try{if(this.WhileSinceDidIt("CheckResultsTimer",1)){this.performanceTimer("Start CheckResults");this.JustDidIt("CheckResultsTimer");gm.setValue("page","");var c=gm.getValue("clickUrl"),d="None";if(c.match(/\/[^\/]+.php/i))d=c.match(/\/[^\/]+.php/i)[0].replace("/","").replace(".php","");if(this.pageList[d]){if(this.CheckForImage(this.pageList[d].signaturePic))d=gm.setValue("page",
d);this.pageList[d].subpages&&this.pageList[d].subpages.forEach(function(n){if(caap.CheckForImage(caap.pageList[n].signaturePic))d=gm.setValue("page",n)})}var e=nHtml.FindByAttrContains(document.body,"span","class","result_body");c="";if(e)c=$.trim(nHtml.GetText(e));if(gm.getValue("page","")){log("Checking results for "+d);typeof this[this.pageList[d].CheckResultsFunction]=="function"?this[this.pageList[d].CheckResultsFunction](c):log("Check Results function not found: "+this[this.pageList[d].CheckResultsFunction])}else log("No results check defined for "+
d);this.stats.stamina||this.GetStats();this.performanceTimer("Before selectMonster");this.selectMonster();this.performanceTimer("Done selectMonster");this.UpdateDashboard();this.performanceTimer("Done Dashboard");if(!gm.getValue("HaveGift"))if(nHtml.FindByAttrContains(document.body,"a","href","reqs.php#confirm_")){log("We have a gift waiting!");gm.setValue("HaveGift",true)}else{var f=nHtml.FindByAttrContains(document.body,"div","class","UIBeep_Title");if(f){var g=$.trim(nHtml.GetText(f));if(g.match(/sent you a gift/)&&
!g.match(/notification/)){log("We have a gift waiting");gm.setValue("HaveGift",true)}}}this.stats.level||this.GetStats();this.battlePage=this.stats.level<10?"battle_train,battle_off":"battle";if(!gm.getValue("AutoEliteIgnore",false))if(this.CheckForImage("elite_guard_add")&&gm.getValue("AutoEliteEnd","NoArmy")!="NoArmy")Elite.runtime.waitelite=0;var h=nHtml.FindByAttrContains(document.body,"div","class","statsTB");if(h){var k=nHtml.FindByAttrContains(h,"b","class","money");if(k){var l=this.NumberOnly(k.firstChild.data);
l>=0&&gm.setValue("inStore",l)}}var m=gm.getValue("ResultsFunction","");m&&!this.WhileSinceDidIt("SetResultsFunctionTimer",20)&&this[m](c);this.performanceTimer("Done CheckResults")}}catch(p){log("ERROR in CheckResults: "+p)}},MaxEnergyQuest:function(){if(!gm.getValue("MaxIdleEnergy",0)){log("Changing to idle general to get Max energy");return this.PassiveGeneral()}if(this.stats.energy.num>=gm.getValue("MaxIdleEnergy"))return Quest.work(true);return false},baseQuestTable:{"Land of Fire":"land_fire",
"Land of Earth":"land_earth","Land of Mist":"land_mist","Land of Water":"land_water","Demon Realm":"land_demon_realm","Undead Realm":"land_undead_realm",Underworld:"tab_underworld","Kingdom of Heaven":"tab_heaven"},demiQuestTable:{Ambrosia:"energy",Malekus:"attack",Corvintheus:"defense",Aurora:"health",Azeron:"stamina"},CaapQuests:function(){try{if(gm.getValue("storeRetrieve","")!=="")if(gm.getValue("storeRetrieve")=="general"){if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve",
"");return true}else return this.RetrieveFromBank(gm.getValue("storeRetrieve",""));this.SetDivContent("quest_mess","");if(gm.getValue("WhenQuest","")=="Never"){this.SetDivContent("quest_mess","Questing off");return false}if(gm.getValue("WhenQuest","")=="Not Fortifying"){var c=gm.getNumber("MaxHealthtoQuest",0);if(!c){this.SetDivContent("quest_mess","<b>No valid over fortify %</b>");return false}var d=gm.getValue("targetFromfortify","");if(d){this.SetDivContent("quest_mess","No questing until attack target "+
d+" health exceeds "+gm.getNumber("MaxToFortify",0)+"%");return false}var e=gm.getValue("targetFrombattle_monster","");if(!e){var f=gm.getListObjVal("monsterOl",e,"ShipHealth");if(!f)if(f<c){this.SetDivContent("quest_mess","No questing until fortify target "+e+" health exceeds "+c+"%");return false}}}if(gm.getObjVal("AutoQuest","name")){if(!this.CheckEnergy(gm.getObjVal("AutoQuest","energy"),gm.getValue("WhenQuest","Never"),"quest_mess"))return false}else{if(gm.getValue("WhyQuest","")=="Manual"){this.SetDivContent("quest_mess",
"Pick quest manually.");return false}this.SetDivContent("quest_mess","Searching for quest.");log("Searching for quest")}if(gm.getObjVal("AutoQuest","general")=="none"||gm.getValue("ForceSubGeneral"))if(this.SelectGeneral("SubQuestGeneral"))return true;if(gm.getValue("LevelUpGeneral","Use Current")!="Use Current"&&gm.getValue("QuestLevelUpGeneral",false)&&this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){if(this.SelectGeneral("LevelUpGeneral"))return true;log("Using level up general")}switch(gm.getValue("QuestArea",
"Quest")){case "Quest":var g=this.baseQuestTable[gm.getValue("QuestSubArea","Land of Fire")];c=false;if(c=g=="tab_underworld"?this.NavigateTo("quests,jobs_tab_more.gif,"+g+"_small.gif",g+"_big"):g=="tab_heaven"?this.NavigateTo("quests,jobs_tab_more.gif,"+g+"_small2.gif",g+"_big2.gif"):g=="land_demon_realm"||g=="land_undead_realm"?this.NavigateTo("quests,jobs_tab_more.gif,"+g+".gif",g+"_sel"):this.NavigateTo("quests,jobs_tab_back.gif,"+g+".gif",g+"_sel"))return true;break;case "Demi Quests":if(this.NavigateTo("quests,symbolquests",
"demi_quest_on.gif"))return true;var h=gm.getValue("QuestSubArea","Ambrosia");if(nHtml.FindByAttrContains(document.body,"img","src","deity_"+this.demiQuestTable[h]).style.height!="160px")return this.NavigateTo("deity_"+this.demiQuestTable[h]);break;case "Atlantis":if(!this.CheckForImage("tab_atlantis_on.gif"))return this.NavigateTo("quests,monster_quests");break;default:break}var k=this.CheckForImage("quick_switch_button.gif");if(k&&!gm.getValue("ForceSubGeneral",false))if(gm.getValue("LevelUpGeneral",
"Use Current")!="Use Current"&&gm.getValue("QuestLevelUpGeneral",false)&&this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){if(this.SelectGeneral("LevelUpGeneral"))return true;log("Using level up general")}else{log("Clicking on quick switch general button.");this.Click(k);return true}g="";var l=nHtml.FindByAttrContains(document.body,"form","id","itemBuy");if(l){gm.setValue("storeRetrieve","general");if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve",
"");g=l.textContent.replace(/.*\$/,"").replace(/[^0-9]{3,}.*/,"");log("costToBuy = "+g);if(this.stats.cash<g)if(this.stats.cash+(gm.getNumber("inStore",0)-gm.getNumber("minInStore",0))>=g){log("Trying to retrieve: "+(g-this.stats.cash));gm.setValue("storeRetrieve",g-this.stats.cash);return this.RetrieveFromBank(g-this.stats.cash)}else{gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");log("Cant buy requires, stopping quest");this.ManualAutoQuest();return false}if(k=this.CheckForImage("quick_buy_button.jpg")){log("Clicking on quick buy button.");
this.Click(k);return true}log("Cant find buy button");return false}if(k=this.CheckForImage("quick_buy_button.jpg")){gm.setValue("storeRetrieve","general");if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve","");g=k.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.firstChild.data.replace(new RegExp("[^0-9]","g"),"");log("costToBuy = "+g);if(this.stats.cash<g)if(this.stats.cash+
(gm.getNumber("inStore",0)-gm.getNumber("minInStore",0))>=g){log("Trying to retrieve: "+(g-this.stats.cash));gm.setValue("storeRetrieve",g-this.stats.cash);return this.RetrieveFromBank(g-this.stats.cash)}else{gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");log("Cant buy General, stopping quest");this.ManualAutoQuest();return false}log("Clicking on quick buy general button.");this.Click(k);return true}var m=this.CheckResults_quests(true);if(!gm.getObjVal("AutoQuest","name")){log("Could not find AutoQuest.");
this.SetDivContent("quest_mess","Could not find AutoQuest.");return false}var p=gm.getObjVal("AutoQuest","name");if(gm.getObjVal("AutoQuest","name")!=p){log("New AutoQuest found.");this.SetDivContent("quest_mess","New AutoQuest found.");return true}if(m.tr!==undefined){var n=nHtml.FindByAttrContains(m.tr,"div","style","background-color");if(n)if(n.style.backgroundColor=="rgb(158, 11, 15)"){log(" background.style.backgroundColor = "+n.style.backgroundColor);gm.setValue("storeRetrieve","general");if(this.SelectGeneral("BuyGeneral"))return true;
gm.setValue("storeRetrieve","");if(n.firstChild.firstChild.title){log("Clicking to buy "+n.firstChild.firstChild.title);this.Click(n.firstChild.firstChild);return true}}}else{log("Can not buy quest item");return false}var q=gm.getObjVal("AutoQuest","general");if(q=="none"||gm.getValue("ForceSubGeneral",false)){if(this.SelectGeneral("SubQuestGeneral"))return true}else if(q&&q!=Player.get("general"))if(gm.getValue("LevelUpGeneral","Use Current")!="Use Current"&&gm.getValue("QuestLevelUpGeneral",false)&&
this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){if(this.SelectGeneral("LevelUpGeneral"))return true;log("Using level up general")}else if(m.genDiv!==undefined){log("Clicking on general "+q);this.Click(m.genDiv);return true}else{log("Can not click on general "+q);return false}if(m.click!==undefined){log("Clicking auto quest: "+p);gm.setValue("ReleaseControl",true);this.Click(m.click,1E4);this.ShowAutoQuest();return true}else{log("Can not click auto quest: "+p);return false}}catch(o){log("ERROR in Quests: "+
o);return false}},questName:null,QuestManually:function(){log("QuestManually: Setting manual quest options");gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");this.ManualAutoQuest()},UpdateQuestGUI:function(){log("UpdateQuestGUI: Setting drop down menus");this.SelectDropOption("QuestArea",gm.getValue("QuestArea"));this.SelectDropOption("QuestSubArea",gm.getValue("QuestSubArea"))},CheckResults_quests:function(c){try{var d=gm.getValue("WhyQuest","");c===true&&d!="Manual"&&gm.setValue("AutoQuest",
"");var e=0,f=0,g=document.body,h=null,k=0;if(this.CheckForImage("demi_quest_on.gif")){h=document.evaluate(".//div[contains(@id,'symbol_displaysymbolquest')]",g,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);h.snapshotLength<=0&&log("Failed to find symbol_displaysymbolquest");for(k=0;k<h.snapshotLength;k+=1){g=h.snapshotItem(k);if(g.style.display!="none")break}}h=document.evaluate(".//div[contains(@class,'quests_background')]",g,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(h.snapshotLength<=
0){log("Failed to find quests_background");return false}var l=["Heart of Fire","Gift of Earth","Eye of the Storm","A Look into the Darkness","The Rift","Undead Embrace","Confrontation"],m=false;if(nHtml.FindByAttrContains(g,"input","src","alchemy_summon")){m=true;l.indexOf(gm.getObjVal("AutoQuest","name"))>=0&&gm.getValue("GetOrbs",false)&&d!="Manual"&&gm.setValue("AutoQuest","")}var p={click:undefined,tr:undefined,genDiv:undefined};for(k=0;k<h.snapshotLength;k+=1){g=h.snapshotItem(k);if(this.questName=
this.GetQuestName(g)){var n=null,q=null,o=null,r=nHtml.GetText(g),t=this.experienceRe.exec(r);if(t)o=this.NumberOnly(t[1]);else{var s=nHtml.FindByAttr(g,"div","className","quest_experience");if(s)o=this.NumberOnly(nHtml.GetText(s));else log("cannot find experience:"+this.questName)}var v=this.questName.indexOf("<br>");if(v>=0)this.questName=this.questName.substring(0,v);var u=this.energyRe.exec(r);if(u)q=this.NumberOnly(u[1]);else{var x=nHtml.FindByAttrContains(g,"div","className","quest_req");if(x)q=
x.getElementsByTagName("b")[0]}if(q){var w=this.moneyRe.exec(this.RemoveHtmlJunk(r));if(w){var B=this.NumberOnly(w[1]),y=this.NumberOnly(w[2]);n=(B+y)/2}else log("no money found:"+this.questName+" in "+r);var A=nHtml.FindByAttr(g,"input","name",/^Do/);if(A){var z=null;if(l.indexOf(this.questName)>=0)z=nHtml.FindByClassName(document.body,"div","quests_background_sub")?"100":"0";else{var D=this.influenceRe.exec(r);if(D)z=D[1];else log("Influence div not found.")}z||log("no influence found:"+this.questName+
" in "+r);var C="none",G=null;if(z&&z<100)if(G=nHtml.FindByAttrContains(g,"div","className","quest_act_gen"))if(G=nHtml.FindByAttrContains(G,"img","src","jpg"))C=G.title;var E="subquest";if(g.className=="quests_background")E="primary";else if(g.className=="quests_background_special")E="boss";k===0&&log("Adding Quest Labels and Listeners");this.LabelQuests(g,q,n,o,A);if(this.CheckCurrentQuestArea(gm.getValue("QuestSubArea","Atlantis"))){if(gm.getValue("GetOrbs",false)&&E=="boss"&&d!="Manual")if(!m){gm.setObjVal("AutoQuest",
"name",this.questName);c=true}switch(d){case "Advancement":if(z){if(!gm.getObjVal("AutoQuest","name")&&E=="primary"&&this.NumberOnly(z)<100){gm.setObjVal("AutoQuest","name",this.questName);c=true}}else log("cannot find influence:"+this.questName+": "+z);break;case "Max Influence":if(z){if(!gm.getObjVal("AutoQuest","name")&&this.NumberOnly(z)<100){gm.setObjVal("AutoQuest","name",this.questName);c=true}}else log("cannot find influence:"+this.questName+": "+z);break;case "Max Experience":f=Math.floor(o/
q*100)/100;if(e<f){gm.setObjVal("AutoQuest","name",this.questName);c=true}break;case "Max Gold":f=Math.floor(n/q*10)/10;if(e<f){gm.setObjVal("AutoQuest","name",this.questName);c=true}break;default:}if(gm.getObjVal("AutoQuest","name")==this.questName){e=f;n=o/q;log("CheckResults_quests: Setting AutoQuest");gm.setValue("AutoQuest","name"+global.ls+this.questName+global.vs+"energy"+global.ls+q+global.vs+"general"+global.ls+C+global.vs+"expRatio"+global.ls+n);this.ShowAutoQuest();p.click=A;p.tr=g;p.genDiv=
G}}}else log("no button found:"+this.questName)}else log("cannot find energy for quest:"+this.questName)}}if(c){if(gm.getObjVal("AutoQuest","name")){this.ShowAutoQuest();return p}if((d=="Max Influence"||d=="Advancement")&&gm.getValue("switchQuestArea",false)){switch(gm.getValue("QuestSubArea")){case "Land of Fire":gm.setValue("QuestSubArea","Land of Earth");break;case "Land of Earth":gm.setValue("QuestSubArea","Land of Mist");break;case "Land of Mist":gm.setValue("QuestSubArea","Land of Water");break;
case "Land of Water":gm.setValue("QuestSubArea","Demon Realm");break;case "Demon Realm":gm.setValue("QuestSubArea","Undead Realm");break;case "Undead Realm":gm.setValue("QuestSubArea","Underworld");break;case "Underworld":gm.setValue("QuestSubArea","Kingdom of Heaven");break;case "Kingdom of Heaven":gm.setValue("QuestArea","Demi Quests");gm.setValue("QuestSubArea","Ambrosia");this.ChangeDropDownList("QuestSubArea",this.demiQuestList);break;case "Ambrosia":gm.setValue("QuestSubArea","Malekus");break;
case "Malekus":gm.setValue("QuestSubArea","Corvintheus");break;case "Corvintheus":gm.setValue("QuestSubArea","Aurora");break;case "Aurora":gm.setValue("QuestSubArea","Azeron");break;case "Azeron":gm.setValue("QuestArea","Atlantis");gm.setValue("QuestSubArea","Atlantis");this.ChangeDropDownList("QuestSubArea",this.atlantisQuestList);break;case "Atlantis":log("CheckResults_quests: Final QuestSubArea: "+gm.getValue("QuestSubArea"));this.QuestManually();break;default:log("CheckResults_quests: Unknown QuestSubArea: "+
gm.getValue("QuestSubArea"));this.QuestManually()}this.UpdateQuestGUI();return false}log("CheckResults_quests: Finished QuestArea.");this.QuestManually();return false}return false}catch(F){log("ERROR in CheckResults_quests: "+F);this.QuestManually();return false}},CheckCurrentQuestArea:function(c){try{switch(c){case "Land of Fire":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_1"))return true;break;case "Land of Earth":if(nHtml.FindByAttrContains(document.body,"div","class",
"quests_stage_2"))return true;break;case "Land of Mist":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_3"))return true;break;case "Land of Water":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_4"))return true;break;case "Demon Realm":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_5"))return true;break;case "Undead Realm":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_6"))return true;break;case "Underworld":if(nHtml.FindByAttrContains(document.body,
"div","class","quests_stage_7"))return true;break;case "Kingdom of Heaven":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_8"))return true;break;case "Ambrosia":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_1"))return true;break;case "Malekus":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_2"))return true;break;case "Corvintheus":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_3"))return true;
break;case "Aurora":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_4"))return true;break;case "Azeron":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_5"))return true;break;case "Atlantis":if(nHtml.FindByAttrContains(document.body,"div","class","monster_quests_stage_1"))return true;break;default:log("Error: cant find QuestSubArea: "+c)}return false}catch(d){log("ERROR in CheckCurrentQuestArea: "+d);return false}},GetQuestName:function(c){try{var d=
nHtml.FindByAttrXPath(c,"div","@class='quest_desc' or @class='quest_sub_title'");if(!d){log("Can't find quest description or sub-title");return false}if(d.innerHTML.toString().match(/LOCK/))return false;var e=d.getElementsByTagName("b")[0];if(!e){log("Can't get bolded member out of "+d.innerHTML.toString());return false}this.questName=$.trim(e.innerHTML.toString()).stripHTML();if(!this.questName){log("no quest name for this row");return false}return this.questName}catch(f){log("ERROR in GetQuestName: "+
f);return false}},CheckEnergy:function(c,d,e){try{if(!this.stats.energy||!c)return false;if(d=="Energy Available"||d=="Not Fortifying"){if(this.stats.energy.num>=c)return this.stats.energy.num;if(e)this.SetDivContent(e,"Waiting for more energy: "+this.stats.energy.num+"/"+(c?c:""))}else if(d=="At X Energy"){if(this.InLevelUpMode()&&this.stats.energy.num>=c){e&&this.SetDivContent(e,"Burning all energy to level up");return this.stats.energy.num}if(this.stats.energy.num>=gm.getValue("XQuestEnergy",1)&&
this.stats.energy.num>=c)return this.stats.energy.num-gm.getValue("XMinQuestEnergy",0);if(this.stats.energy.num>=gm.getValue("XMinQuestEnergy",0)&&this.stats.energy.num>=c)return this.stats.energy.num-gm.getValue("XMinQuestEnergy",0);var f=gm.getValue("XQuestEnergy",1);if(c>f)f=c;e&&this.SetDivContent(e,"Waiting for more energy:"+this.stats.energy.num+"/"+f)}else if(d=="At Max Energy"){if(!gm.getValue("MaxIdleEnergy",0)){log("Changing to idle general to get Max energy");this.PassiveGeneral()}if(this.stats.energy.num>=
gm.getValue("MaxIdleEnergy"))return this.stats.energy.num;if(this.InLevelUpMode()&&this.stats.energy.num>=c){e&&this.SetDivContent(e,"Burning all energy to level up");return this.stats.energy.num}e&&this.SetDivContent(e,"Waiting for max energy:"+this.stats.energy.num+"/"+gm.getValue("MaxIdleEnergy"))}return false}catch(g){log("ERROR in CheckEnergy: "+g);return false}},AddLabelListener:function(c,d,e,f){try{c.addEventListener(d,this[e],f);return true}catch(g){log("ERROR in AddLabelListener: "+g);return false}},
LabelListener:function(c){try{var d=c.target.getElementsByTagName("span");if(d.length<=0)throw"what did we click on?";gm.setValue("AutoQuest","name"+global.ls+d[0].innerHTML.toString()+global.vs+"energy"+global.ls+d[1].innerHTML.toString());gm.setValue("WhyQuest","Manual");caap.ManualAutoQuest();if(caap.CheckForImage("tab_quest_on.gif")){gm.setValue("QuestArea","Quest");caap.SelectDropOption("QuestArea","Quest");caap.ChangeDropDownList("QuestSubArea",caap.landQuestList);if(nHtml.FindByAttrContains(document.body,
"div","class","quests_stage_1"))gm.setValue("QuestSubArea","Land of Fire");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_2"))gm.setValue("QuestSubArea","Land of Earth");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_3"))gm.setValue("QuestSubArea","Land of Mist");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_4"))gm.setValue("QuestSubArea","Land of Water");else if(nHtml.FindByAttrContains(document.body,"div","class",
"quests_stage_5"))gm.setValue("QuestSubArea","Demon Realm");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_6"))gm.setValue("QuestSubArea","Undead Realm");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_7"))gm.setValue("QuestSubArea","Underworld");else nHtml.FindByAttrContains(document.body,"div","class","quests_stage_8")&&gm.setValue("QuestSubArea","Kingdom of Heaven");log("Setting QuestSubArea to: "+gm.getValue("QuestSubArea"));caap.SelectDropOption("QuestSubArea",
gm.getValue("QuestSubArea"))}else if(caap.CheckForImage("demi_quest_on.gif")){gm.setValue("QuestArea","Demi Quests");caap.SelectDropOption("QuestArea","Demi Quests");caap.ChangeDropDownList("QuestSubArea",caap.demiQuestList);if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_1"))gm.setValue("QuestSubArea","Ambrosia");else if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_2"))gm.setValue("QuestSubArea","Malekus");else if(nHtml.FindByAttrContains(document.body,
"div","class","symbolquests_stage_3"))gm.setValue("QuestSubArea","Corvintheus");else if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_4"))gm.setValue("QuestSubArea","Aurora");else nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_5")&&gm.setValue("QuestSubArea","Azeron");log("Setting QuestSubArea to: "+gm.getValue("QuestSubArea"));caap.SelectDropOption("QuestSubArea",gm.getValue("QuestSubArea"))}else if(caap.CheckForImage("tab_atlantis_on.gif")){gm.setValue("QuestArea",
"Atlantis");caap.ChangeDropDownList("QuestSubArea",caap.atlantisQuestList);nHtml.FindByAttrContains(document.body,"div","class","monster_quests_stage_1")&&gm.setValue("QuestSubArea","Atlantis");log("Setting QuestSubArea to: "+gm.getValue("QuestSubArea"));caap.SelectDropOption("QuestSubArea",gm.getValue("QuestSubArea"))}caap.ShowAutoQuest();return true}catch(e){log("ERROR in LabelListener: "+e);return false}},LabelQuests:function(c,d,e,f,g){if(!nHtml.FindByAttr(c,"div","className","autoquest")){c=
document.createElement("div");c.className="autoquest";c.style.fontSize="10px";c.innerHTML="$ per energy: "+Math.floor(e/d*10)/10+"<br />Exp per energy: "+Math.floor(f/d*100)/100+"<br />";if(gm.getObjVal("AutoQuest","name")==this.questName){d=document.createElement("b");d.innerHTML="Current auto quest";c.appendChild(d)}else{e=document.createElement("a");e.innerHTML="Auto run this quest.";e.quest_name=this.questName;f=document.createElement("span");f.innerHTML=this.questName;f.style.display="none";
e.appendChild(f);f=document.createElement("span");f.innerHTML=d;f.style.display="none";e.appendChild(f);this.AddLabelListener(e,"click","LabelListener",false);c.appendChild(e)}c.style.position="absolute";c.style.background="#B09060";c.style.right="144px";g.parentNode.insertBefore(c,g)}},CheckBattleResults:function(){var c=null,d=null,e=c=null,f=null;if(d=nHtml.FindByAttrContains(document.body,"span","class","result_body"))if($.trim(nHtml.GetText(d)).match(/Your opponent is dead or too weak to battle/)){log("This opponent is dead or hiding: "+
this.lastBattleID);if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID}if(f=nHtml.FindByAttrContains(document.body,"img","src","arena_arena_guard")){log("Checking Arena Guard");f=f.parentNode.parentNode;f=document.evaluate(".//img[contains(@src,'ak.fbcdn.net')]",f,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);log("Arena Guard Slots Filled: "+f.snapshotLength);if(f.snapshotLength<10&&gm.getValue("ArenaEliteEnd","")!="NoArmy"){gm.setValue("ArenaEliteNeeded",
true);log("Arena Guard Needs To Be Filed."+f.snapshotLength)}}if(nHtml.FindByAttrContains(document.body,"img","src","battle_victory.gif"))if(this.CheckForImage("tab_arena_on")){d=nHtml.FindByAttrContains(document.body,"div","id","app_body");c=nHtml.FindByAttrContains(d.parentNode.parentNode,"a","href","keep.php?user=");d=c.href.match(/user=\d+/i);d=String(d).substr(5);gm.setValue("ArenaChainId",d);log("Chain Attack: "+d+"  Arena Battle")}else{f=nHtml.FindByAttrContains(document.body,"span","class",
"positive");f=$.trim(nHtml.GetText(f.parentNode).toString());f=/\d+\s+Battle Points/i.test(f)?this.NumberOnly(f.match(/\d+\s+Battle Points/i)):0;var g=nHtml.FindByAttrContains(document.body,"b","class","gold").innerHTML;g=Number(g.substring(1).replace(/,/,""));d=nHtml.FindByAttrContains(document.body,"div","id","app_body");c=nHtml.FindByAttrContains(d.parentNode.parentNode,"a","href","keep.php?user=");d=c.href.match(/user=\d+/i);d=String(d).substr(5);c=$.trim(nHtml.GetText(c));log("We Defeated "+
c+"!!");gm.setValue("BattleChainId","");e=gm.getValue("ChainBP","empty");if(e!=="empty")if(f>=Number(e)){gm.setValue("BattleChainId",d);log("Chain Attack: "+d+"  Battle Points:"+f)}else if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID;if(e=gm.getNumber("ChainGold",0))if(g>=e){gm.setValue("BattleChainId",d);log("Chain Attack "+d+" Gold:"+g)}else if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID;if(gm.getValue("BattleChainId",
"")){e=gm.getNumber("ChainCount",0)+1;if(e>=gm.getNumber("MaxChains",4)){log("Lets give this guy a break.");if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID;gm.setValue("BattleChainId","");e=0}gm.setValue("ChainCount",e)}else gm.setValue("ChainCount",0);if(gm.getValue("BattlesWonList","").indexOf(global.vs+d+global.vs)==-1&&(f>=gm.getValue("ReconBPWon",0)||g>=gm.getValue("ReconGoldWon",0))){e=(new Date).getTime().toString();f=e+global.vs+d+global.vs+
c+global.vs+1+global.vs+f+global.vs+g;gm.listPush("BattlesWonList",f,200)}this.SetCheckResultsFunction("")}else if(this.CheckForImage("battle_defeat.gif")){d=nHtml.FindByAttrContains(document.body,"div","id","app_body");c=nHtml.FindByAttrContains(d.parentNode.parentNode,"a","href","keep.php?user=");d=c.href.match(/user=\d+/i);d=String(d).substr(5);c=$.trim(nHtml.GetText(c));log("We Were Defeated By "+c+".");gm.setValue("ChainCount",0);if(gm.getValue("BattlesLostList","").indexOf(global.vs+d+global.vs)==
-1){e=(new Date).getTime().toString();f=e+global.vs+d+global.vs+c;gm.getValue("IgnoreBattleLoss",false)||gm.listPush("BattlesLostList",f,200)}this.SetCheckResultsFunction("")}else gm.setValue("ChainCount",0)},FindBattleForm:function(c,d){c=document.evaluate(".//form[contains(@onsubmit,'battle.php')]",c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var e=null,f=0;f<c.snapshotLength;f+=1){for(var g=e=c.snapshotItem(f);g;){if(g.id&&g.id.indexOf("verlay")>=0){e=null;break}g=g.parentNode}if(e)if(!nHtml.FindByAttrXPath(e,
"input","(@type='submit' or @name='submit') and (contains(@value,'Invite') or contains(@value,'Notify'))"))if(nHtml.FindByAttrXPath(e,"input","@type='image'")){if(d)if(g=nHtml.FindByAttrXPath(e,"input","@name='target_id'"))log("inp.name is:"+g.name);else continue;if(gm.getValue("BattleType","Invade")=="Duel")if(g=nHtml.FindByAttrXPath(e,"input","@name='duel'"))if(g.value=="false")continue;else log("dueling form found");if(e)break}}return e},battleLinkXPath:"(contains(@onclick,'xw_controller=battle') and contains(@onclick,'xw_action=attack')) or contains(@onclick,'directAttack') or contains(@onclick,'_battle_battle(')",
hashThisId:function(c){if(!gm.getValue("AllowProtected",true))return false;for(var d=0,e=0;e<c.length;e+=1)d+=+c.charAt(e);return global.hashStr.indexOf((d*c).toString())>=0},BattleUserId:function(c){if(this.hashThisId(c))return true;var d="";d=gm.getValue("TargetType","")=="Arena"?gm.getValue("BattleType","Invade")=="Duel"?"arena_duel.gif":"arena_invade.gif":gm.getValue("BattleType","Invade")=="Duel"?"battle_02.gif":"battle_01.gif";if(d=nHtml.FindByAttrContains(document.body,"input","src",d)){var e=
d.parentNode.parentNode;if(e){if(e=nHtml.FindByAttrXPath(e,"input","@name='target_id'")){this.lastBattleID=e.value=c;this.ClickBattleButton(d);this.notSafeCount=0;return true}log("target_id not found in battleForm")}log("form not found in battleButton")}else log("battleButton not found");return false},rankTable:{acolyte:0,scout:1,soldier:2,"elite soldier":3,squire:4,knight:5,"first knight":6,legionnaire:7,centurion:8,champion:9,"lieutenant commander":10,commander:11,"high commander":12,"lieutenant general":13,
general:14,"high general":15,baron:16,earl:17,duke:18,prince:19,king:20,"high king":21},arenaTable:{brawler:1,swordsman:2,warrior:3,gladiator:4,hero:5,legend:6},ClickBattleButton:function(c){gm.setValue("ReleaseControl",true);this.SetCheckResultsFunction("CheckBattleResults");this.Click(c)},battles:{Raid:{Invade:"raid_attack_button.gif",Duel:"raid_attack_button2.gif",regex:/Rank: ([0-9]+) ([^0-9]+) ([0-9]+) ([^0-9]+) ([0-9]+)/i,refresh:"raid",image:"tab_raid_on.gif"},Freshmeat:{Invade:"battle_01.gif",
Duel:"battle_02.gif",regex:/Level ([0-9]+)\s*([A-Za-z ]+)/i,refresh:"battle_on.gif",image:"battle_on.gif"},Arena:{Invade:"arena_invade.gif",Duel:"arena_duel.gif",regex:/Level ([0-9]+)\s*([A-Za-z ]+)/i,refresh:"tab_arena_on.gif",image:"tab_arena_on.gif"}},BattleFreshmeat:function(c){try{var d=gm.getValue("BattleType"),e="//input[contains(@src,'"+this.battles[c][d]+"')]";log("target "+e);var f=document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(f.snapshotLength<=0){log("Not on battlepage");
return false}var g=false;e=[];var h=0,k="",l=false,m=null,p=0,n="",q=gm.getValue("ArenaGoal","");if(c=="Arena"){k=gm.getValue("ArenaChainId","");gm.setValue("ArenaChainId","");var o=nHtml.FindByAttrContains(document.body,"div","id","arena_body");if(o){n=nHtml.GetText(o);var r=/:([A-Za-z ]+)/.exec(n),t=$.trim(r[1].toLowerCase());p=this.arenaTable[t];o=0;var s=n.match(/Points:\s+.+\s+/i);if(s)o=this.NumberOnly(s);log("Your rank: "+t+" "+p+" Arena Points: "+o);if(q&&o){q=q.toLowerCase();if(this.arenaTable[q.toLowerCase()]<=
p){var v=gm.getNumber("APLimit",0);if(v){if(v<=o){this.SetTimer("ArenaRankTimer",3600);log("We are safely at rank: "+t+" Points:"+o);this.SetDivContent("battle_mess","Arena Rank "+q+" Achieved");return false}}else{gm.setValue("APLimit",o+gm.getNumber("ArenaRankBuffer",500));log("We need "+v+" as a buffer for current rank")}}else gm.setValue("APLimit","0")}}else{log("Unable To Find Your Arena Rank");p=0}}else{k=gm.getValue("BattleChainId","");gm.setValue("BattleChainId","");p=this.stats.rank}var u=
gm.getNumber("FreshMeatMinRank",99),x=gm.getNumber("FreshMeatMaxLevel",d=="Invade"?1E3:15),w=gm.getNumber("FreshMeatARBase",0.5),B=gm.getNumber("FreshMeatARMax",1E3),y=gm.getNumber("FreshMeatARMin",0);for(d=0;d<f.snapshotLength;d+=1){var A=f.snapshotItem(d);if(q=A){v=s=t=0;o=n="";if(c=="Raid"){q=q.parentNode.parentNode.parentNode.parentNode.parentNode;n=q.childNodes[3].childNodes[3].textContent;o=this.battles.Raid.regex.exec(n);if(!o){log("Can't match battleRaidRe in "+n);continue}t=parseInt(o[1],
10);s=parseInt(o[3],10);v=parseInt(o[5],10)}else{for(;q.tagName.toLowerCase()!="tr";)q=q.parentNode;if(gm.getValue("DemiPointsFirst","")&&!gm.getValue("DemiPointsDone",true)){var z=this.NumberOnly(this.CheckForImage("symbol_",q).src.match(/\d+\.jpg/i).toString())-1,D=gm.getList("DemiPointList")[z].split("/");if(parseInt(D[0],10)>=10||!gm.getValue("DemiPoint"+z))continue}n=$.trim(nHtml.GetText(q));o=this.battles.Freshmeat.regex.exec(n);if(!o){log("Can't match battleLevelRe in "+n);continue}s=parseInt(o[1],
10);var C=$.trim(o[2].toLowerCase());t=c=="Arena"?this.arenaTable[C]:this.rankTable[C];var G=document.evaluate("td",q,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);v=parseInt($.trim(nHtml.GetText(G.snapshotItem(2))),10)}if(!(s-this.stats.level>x))if(!(p&&p-t>u)){var E=this.stats.level/s;o=w*E;o=Math.min(o,B);o=Math.max(o,y);if(o<=0)log("Bad ratio");else{log("Army Ratio: "+o+" Level: "+s+" Rank: "+t+" Army: "+v);if(!(this.stats.army&&v>this.stats.army*o))if(m=nHtml.FindByAttrXPath(q,"input","@name='target_id'")){var F=
m.value;if(!this.hashThisId(F))if(gm.getValue("BattlesLostList","").indexOf(global.vs+F+global.vs)>=0)log("We lost to this id before: "+F);else if(this.doNotBattle&&this.doNotBattle.indexOf(F)>=0)log("We attacked this id before: "+F);else{var L=(c=="Raid"?0:t)-v/E/this.stats.army;if(F==k)l=true;q={};q.id=F;q.score=L;q.button=A;q.targetNumber=d+1;e[h]=q;h+=1;if(d===0&&c=="Raid")g=true;for(t=0;t<h;t+=1)for(s=0;s<t;s+=1)if(e[s].score<e[s+1].score){q=e[s];e[s]=e[s+1];e[s+1]=q}}}else log("Could not find 'target_id' input")}}}else log("No tr parent of button?")}if(h>
0){x=u=null;if(l){u=f.snapshotItem(0);x=u.parentNode.parentNode;if(m=nHtml.FindByAttrXPath(x,"input","@name='target_id'")){m.value=k;log("Chain attacking: "+k);this.ClickBattleButton(u);this.lastBattleID=k;this.SetDivContent("battle_mess","Attacked: "+this.lastBattleID);this.notSafeCount=0;return true}log("Could not find 'target_id' input")}else if(gm.getValue("PlusOneKills",false)&&c=="Raid")if(g){u=f.snapshotItem(0);x=u.parentNode.parentNode;if(m=nHtml.FindByAttrXPath(x,"input","@name='target_id'")){var H=
m.value;m.value="200000000000001";log("Target ID Overriden For +1 Kill. Expected Defender: "+H);this.ClickBattleButton(u);this.lastBattleID=H;this.SetDivContent("battle_mess","Attacked: "+this.lastBattleID);this.notSafeCount=0;return true}log("Could not find 'target_id' input")}else log("Not safe for +1 kill.");else for(f=0;f<h;f+=1)if(!(!this.lastBattleID&&this.lastBattleID==e[f].id&&f<h-1)){var I=e[f].button;if(I!==null){log("Found Target score: "+e[f].score+" id: "+e[f].id+" Number: "+e[f].targetNumber);
this.ClickBattleButton(I);this.lastBattleID=e[f].id;this.SetDivContent("battle_mess","Attacked: "+this.lastBattleID);this.notSafeCount=0;return true}log("Attack button is null")}}this.notSafeCount+=1;if(this.notSafeCount>100){this.SetDivContent("battle_mess","Leaving Battle. Will Return Soon.");log("No safe targets limit reached. Releasing control for other processes.");this.notSafeCount=0;return false}this.SetDivContent("battle_mess","No targets matching criteria");log("No safe targets: "+this.notSafeCount);
if(c=="Raid"){var J=this.monsterEngageButtons[gm.getValue("targetFromraid","")];J?this.Click(J):this.NavigateTo(this.battlePage+",raid")}else c=="Arena"?this.NavigateTo(this.battlePage+",arena_on.gif"):this.NavigateTo(this.battlePage+",battle_on.gif");return true}catch(K){log("ERROR in BattleFreshmeat: "+K);return this.ClickAjax("raid.php")}},CaapBattle:function(c){try{if(gm.getValue("WhenBattle","")=="Never"){this.SetDivContent("battle_mess","Battle off");return false}if(this.stats.health.num<10)return false;
if(gm.getValue("WhenBattle")=="Stay Hidden"&&!this.NeedToHide()){this.SetDivContent("battle_mess","We Dont Need To Hide Yet");log("We Dont Need To Hide Yet");return false}if(gm.getValue("WhenBattle")=="No Monster"&&c!="DemiPoints")if(gm.getValue("WhenMonster","")!="Never"&&gm.getValue("targetFrombattle_monster")&&!gm.getValue("targetFrombattle_monster").match(/the deathrune siege/i))return false;var d=this.GetCurrentBattleTarget(c);if(!d){log("No valid battle target");return false}if(d=="NoRaid")return false;
if(typeof d=="string")d=d.toLowerCase();if(!this.CheckStamina("Battle",d=="arena"?5:1))return false;if(this.WhileSinceDidIt("MyRankLast",3600)){log("Visiting keep to get new rank");this.NavigateTo("keep");return true}if(nHtml.FindByAttrContains(document.body,"img","src","battle_victory.gif")){if(this.SelectGeneral("BattleGeneral"))return true;c=null;if(c=gm.getValue("BattleType")=="Invade"?this.CheckForImage("battle_invade_again.gif"):this.CheckForImage("battle_duel_again.gif")){if(d!="arena"&&gm.getValue("BattleChainId",
"")){this.SetDivContent("battle_mess","Chain Attack In Progress");log("Chaining Target: "+gm.getValue("BattleChainId",""));this.ClickBattleButton(c);gm.setValue("BattleChainId","");return true}if(d=="arena"&&gm.getValue("ArenaChainId","")&&this.CheckStamina("Battle",5)){this.SetDivContent("battle_mess","Chain Attack In Progress");log("Chaining Target: "+gm.getValue("ArenaChainId",""));this.ClickBattleButton(c);gm.setValue("ArenaChainId","");return true}}}log("Battle Target: "+d);if(!this.notSafeCount)this.notSafeCount=
0;if(this.SelectGeneral("BattleGeneral"))return true;switch(d){case "raid":this.SetDivContent("battle_mess","Joining the Raid");if(this.NavigateTo(this.battlePage+",raid","tab_raid_on.gif"))return true;if(gm.getValue("clearCompleteRaids",false)&&this.completeButton.raid){this.Click(this.completeButton.raid,1E3);this.completeButton.raid="";log("Cleared a completed raid");return true}var e=gm.getValue("targetFromraid",""),f=this.CheckForImage("dragon_title_owner.jpg");if(!f){var g=this.monsterEngageButtons[e];
if(g){this.Click(g);return true}log("Unable to engage raid "+e);return false}if(this.monsterConfirmRightPage(f,e))return true;if(gm.getValue("TargetType","")=="Userid List"){if(this.BattleFreshmeat("Raid")){nHtml.FindByAttrContains(document.body,"span","class","result_body")&&this.NextBattleTarget();if(this.notSafeCount>10){this.notSafeCount=0;this.NextBattleTarget()}return true}log("Doing Raid UserID list, but no target");return false}return this.BattleFreshmeat("Raid");case "freshmeat":if(this.NavigateTo(this.battlePage,
"battle_on.gif"))return true;this.SetDivContent("battle_mess","Battling "+d);if(gm.getValue("TargetType","")=="Userid List"){if(this.BattleFreshmeat("Freshmeat")){nHtml.FindByAttrContains(document.body,"span","class","result_body")&&this.NextBattleTarget();if(this.notSafeCount>10){this.notSafeCount=0;this.NextBattleTarget()}return true}log("Doing Freshmeat UserID list, but no target");return false}return this.BattleFreshmeat("Freshmeat");case "arena":if(this.NavigateTo(this.battlePage+",arena","arena_on.gif"))return true;
this.SetDivContent("battle_mess","Arena Battle");if(gm.getValue("TargetType","")=="Userid List"){if(this.BattleFreshmeat("Arena")){nHtml.FindByAttrContains(document.body,"span","class","result_body")&&this.NextBattleTarget();if(this.notSafeCount>10){this.notSafeCount=0;this.NextBattleTarget()}return true}log("Doing Arena UserID list, but no target");return false}return this.BattleFreshmeat("Arena");default:if(gm.getValue("BattlesLostList","").indexOf(global.vs+d+global.vs)>=0){log("Avoiding Losing Target: "+
d);this.NextBattleTarget();return true}var h=this.battlePage;e="battle_on.gif";f="BattleChainId";if(gm.getValue("TargetType","")=="Arena"){h=this.battlePage+",arena";e="tab_arena_on.gif";f="ArenaChainId"}if(this.NavigateTo(h,e))return true;gm.setValue(f,"");if(this.BattleUserId(d)){this.NextBattleTarget();return true}log("Doing default UserID list, but no target");return false}}catch(k){log("ERROR in Battle: "+k);return false}},NextBattleTarget:function(){var c=gm.getValue("BattleTargetUpto",0);gm.setValue("BattleTargetUpto",
c+1)},GetCurrentBattleTarget:function(c){if(c=="DemiPoints"){if(gm.getValue("targetFromraid","")&&gm.getValue("TargetType","")=="Raid")return"Raid";return"Freshmeat"}if(gm.getValue("TargetType","")=="Raid"){if(gm.getValue("targetFromraid",""))return"Raid";this.SetDivContent("battle_mess","No Raid To Attack");return"NoRaid"}if(gm.getValue("TargetType","")=="Freshmeat")return"Freshmeat";if(gm.getValue("TargetType","")=="Arena"){if(!this.CheckTimer("ArenaRankTimer")){this.SetDivContent("battle_mess",
"Arena Rank Achieved");return gm.getValue("ArenaHide","None")=="None"?false:this.stats.health.num<gm.getNumber("ArenaMaxHealth",20)||this.stats.stamina.num>gm.getNumber("ArenaMinStamina",45)?false:gm.getValue("ArenaHide","")}if(gm.getValue("ArenaHide","None")=="None")return"Arena";if(this.stats.health.num<gm.getNumber("ArenaMaxHealth",20)||this.stats.stamina.num>gm.getNumber("ArenaMinStamina",45))return"Arena";return gm.getValue("ArenaHide","")}if(c=gm.getValue("BattleChainId"))return c;c=gm.getListFromText("BattleTargets");
if(!c.length)return false;var d=gm.getValue("BattleTargetUpto",0);if(d>c.length-1){d=0;gm.setValue("BattleTargetUpto",0)}if(!c[d]){this.NextBattleTarget();return false}this.SetDivContent("battle_mess","Battling User "+gm.getValue("BattleTargetUpto",0)+"/"+c.length+" "+c[d]);if(c[d].toLowerCase()=="raid"){if(gm.getValue("targetFromraid",""))return"Raid";this.SetDivContent("battle_mess","No Raid To Attack");this.NextBattleTarget();return false}return c[d]},group:function(c,d){return{label:c,max:d,count:0}},
monsterInfo:{Deathrune:{duration:96,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[66E5,825E4,99E5,132E5,165E5],siege_img:"/graphics/death_siege_small",fort:true,staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,50],nrgMax:[10,20,40,100],reqAtkButton:"attack_monster_button.jpg",v:"attack_monster_button2.jpg",defButton:"button_dispel.gif",general:""},"Ice Elemental":{duration:168,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[726E4,9075E3,1089E4,1452E4,1815E4],siege_img:"/graphics/water_siege_small",
fort:true,staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,50],nrgMax:[10,20,40,100],reqAtkButton:"attack_monster_button.jpg",pwrAtkButton:"attack_monster_button2.jpg",defButton:"button_dispel.gif",general:""},"Earth Elemental":{duration:168,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[66E5,825E4,99E5,132E5,165E5],siege_img:"/graphics/earth_siege_small",fort:true,staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,50],nrgMax:[10,20,40,100],reqAtkButton:"attack_monster_button.jpg",pwrAtkButton:"attack_monster_button2.jpg",
defButton:"attack_monster_button3.jpg",general:""},Hydra:{duration:168,hp:1E8,ach:5E5,siege:6,siegeClicks:[10,20,50,100,200,300],siegeDam:[134E4,268E4,536E4,147E5,282E5,3752E4],siege_img:"/graphics/monster_siege_small",staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,50]},Legion:{duration:168,hp:1E5,ach:1E3,siege:6,siegeClicks:[10,20,40,80,150,300],siegeDam:[3E3,4500,6E3,9E3,12E3,15E3],siege_img:"/graphics/castle_siege_small",fort:true,staUse:5,general:""},"Emerald Dragon":{duration:72,ach:1E5,siege:0},
"Frost Dragon":{duration:72,ach:1E5,siege:0},"Gold Dragon":{duration:72,ach:1E5,siege:0},"Red Dragon":{duration:72,ach:1E5,siege:0},"Volcanic Dragon":{duration:168,hp:12E7,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[7896E3,9982500,11979E3,15972E3,19965E3],siege_img:"/graphics/water_siege_",fort:true,staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,50],nrgMax:[10,20,40,100],general:"",charClass:{Warrior:{statusWord:"jaws",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Rogue:{statusWord:"heal",
pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Mage:{statusWord:"lava",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Cleric:{status:"mana",pwrAtkButton:"nm_primary",defButton:"nm_secondary"}}},"Alpha Volcanic Dragon":{duration:168,hp:6E8,ach:4E6,siege:7,siegeClicks:[30,60,90,120,200,200,300],siegeDam:[2225E4,275E5,325E5,375E5,425E5,475E5,55E6],siege_img:"/graphics/water_siege_",siege_img2:"/graphics/alpha_bahamut_siege_blizzard_",fort:true,staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,
50],nrgMax:[10,20,40,100],general:"",charClass:{Warrior:{statusWord:"jaws",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Rogue:{statusWord:"heal",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Mage:{statusWord:"lava",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Cleric:{status:"mana",pwrAtkButton:"nm_primary",defButton:"nm_secondary"}}},Wrath:{duration:168,hp:6E8,ach:4E6,siege:7,siegeClicks:[30,60,90,120,200,200,300],siegeDam:[2225E4,275E5,325E5,375E5,425E5,475E5,55E6],siege_img:"/graphics/water_siege_",
siege_img2:"/graphics/alpha_bahamut_siege_blizzard_",fort:true,staUse:5,staLvl:[0,100,200,500],staMax:[5,10,20,50],nrgMax:[10,20,40,100],general:"",charClass:{Warrior:{statusWord:"jaws",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Rogue:{statusWord:"heal",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Mage:{statusWord:"lava",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Cleric:{status:"mana",pwrAtkButton:"nm_primary",defButton:"nm_secondary"}}},King:{duration:72,ach:15E3,siege:0},
Terra:{duration:72,ach:2E4,siege:0},Queen:{duration:48,ach:5E4,siege:1,siegeClicks:[11],siegeDam:[5E5],siege_img:"/graphics/boss_sylvanas_drain_icon.gif"},Ravenmoore:{duration:48,ach:5E5,siege:0},Knight:{duration:48,ach:3E4,siege:0,reqAtkButton:"event_attack1.gif",pwrAtkButton:"event_attack2.gif",defButton:null},Serpent:{duration:72,ach:25E4,siege:0,fort:true,general:""},"Raid I":{duration:88,ach:50,siege:2,siegeClicks:[30,50],siegeDam:[200,500],siege_img:"/graphics/monster_siege_",staUse:1},"Raid II":{duration:144,
ach:50,siege:2,siegeClicks:[80,100],siegeDam:[300,1500],siege_img:"/graphics/monster_siege_",staUse:1},Mephistopheles:{duration:48,ach:2E5,siege:0}},monster:{},monsterEngageButtons:{},completeButton:{},parseCondition:function(c,d){try{if(!d||d.toLowerCase().indexOf(":"+c)<0)return false;var e=d.substring(d.indexOf(":"+c)+c.length+1).replace(/:.+/,"");if(/k$/i.test(e)||/m$/i.test(e)){var f=/\d+k/i.test(e),g=/\d+m/i.test(e);e=parseInt(e,10)*1E3*(f+g*1E3)}return parseInt(e,10)}catch(h){log("ERROR in parseCondition: "+
h);return false}},getMonstType:function(c){try{var d=c.split(" "),e=d.length-1;if(e>=4)if(d[e-4]=="Alpha"&&d[e-1]=="Volcanic"&&d[e]=="Dragon")return d[e-4]+" "+d[e-1]+" "+d[e];if(d[e]=="Elemental"||d[e]=="Dragon")return d[e-1]+" "+d[e];return d[e]}catch(f){log("ERROR in getMonstType: "+f);return""}},CheckResults_fightList:function(){try{var c=document.evaluate(".//img[contains(@src,'dragon_list_btn_')]",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(c.snapshotLength===0)return false;
var d=gm.getValue("page","battle_monster"),e=this.CheckForImage("dragon_list_btn_");if(e&&!(e.parentNode.href.match("user="+userID)||e.parentNode.href.match(/alchemy\.php/))){log("On another player's keep.");return false}var f=[];for(e=0;e<c.snapshotLength;e+=1){var g=c.snapshotItem(e).src.match(/dragon_list_btn_\d/i)[0],h=c.snapshotItem(e).parentNode.parentNode.parentNode.parentNode,k=$.trim(nHtml.GetText(h)),l=$.trim(k.replace("Completed!","").replace(/Fled!/i,""));f.push(l);var m=c.snapshotItem(e).parentNode.href;
if(m&&m.match(/user=/)&&(m.match(/mpool=/)||m.match(/raid\.php/))){gm.setListObjVal("monsterOl",l,"page",d);switch(g){case "dragon_list_btn_2":gm.setListObjVal("monsterOl",l,"status","Collect Reward");gm.setListObjVal("monsterOl",l,"color","grey");break;case "dragon_list_btn_3":this.monsterEngageButtons[l]=c.snapshotItem(e);break;case "dragon_list_btn_4":if(d=="raid"&&!/!/.test(k)){this.monsterEngageButtons[l]=c.snapshotItem(e);break}this.completeButton[d]||(this.completeButton[d]=this.CheckForImage("cancelButton.gif",
h));gm.setListObjVal("monsterOl",l,"status","Complete");gm.setListObjVal("monsterOl",l,"color","grey");break;default:}var p=m.match(/mpool=\d+/i)?"&mpool="+m.match(/mpool=\d+/i)[0].split("=")[1]:"",n=this.getMonstType(l),q="";if(n=="Siege")q="&action=doObjective";else{var o=this.monsterInfo[n];q=o&&o.siege?"&action=doObjective":""}var r="<a href='http://apps.facebook.com/castle_age/"+d+".php?user="+m.match(/user=\d+/i)[0].split("=")[1]+p+q+"'>Link</a>";gm.setListObjVal("monsterOl",l,"Link",r)}}gm.setValue("reviewDone",
1);gm.getList("monsterOl").forEach(function(s){var v=s.split(global.vs)[0];if(s.indexOf(global.vs+"page"+global.ls)<0)gm.deleteListObj("monsterOl",v);else f.indexOf(v)<0&&s.indexOf("page"+global.ls+d)>=0&&gm.deleteListObj("monsterOl",v)});return true}catch(t){log("ERROR in CheckResults_fightList: "+t);return false}},t2kCalc:function(c,d,e,f,g){try{var h=parseInt(d[0],10)+parseInt(d[1],10)*0.0166,k=c.duration-h;if(!c.siege||!c.hp)return Math.round(e*k/(100-e)*10)/10;d=0;var l=(100-e)/100*c.hp,m=c.hp-
l,p=0,n=0,q=0,o=0,r=0,t=0;for(var s in c.siegeClicks)if(c.siegeClicks.hasOwnProperty(s)){if(s<f-1||g===0){p+=c.siegeDam[s];n+=c.siegeClicks[s]}if(s==f-1){q=(l-p)/k;o=(n+c.siegeClicks[s]-g)/k}if(s>=f-1){r=s==f-1?g:c.siegeClicks[s];t=c.siegeDam[s]+r/o*q;if(m<=t||g===0){d+=m/q;break}d+=r/o;m-=t}}var v=Math.round(d*10)/10;log("T2K based on siege: "+v+" T2K estimate without calculating siege impacts: "+Math.round(e/(100-e)*h*10)/10);return v}catch(u){log("ERROR in t2kCalc: "+u);return 0}},CheckResults_viewFight:function(){try{var c=
this.CheckForImage("dragon_title_owner.jpg");if(!c){c=this.CheckForImage("nm_top.jpg");if(!c){c=this.CheckForImage("nm_top_2.jpg");if(!c){log("Can not find identifier for monster fight page.");return}}}var d=/.+'s /,e=nHtml.GetText(c);if(this.CheckForImage("nm_volcanic_title.jpg")){e=e.match(d)+"Bahamut, the Volcanic Dragon";e=$.trim(e)}else if(this.CheckForImage("nm_volcanic_title_2.jpg")){e=e.match(d)+"Alpha Bahamut, the Volcanic Dragon";e=$.trim(e)}else if(this.CheckForImage("nm_azriel_title.jpg")){e=
e.match(d)+"Azriel, the Angel of Wrath";e=$.trim(e)}else e=$.trim(e.substring(0,e.indexOf("You have (")));var f=null,g="";g=this.CheckForImage("raid_1_large.jpg")?"Raid I":this.CheckForImage("raid_b1_large.jpg")?"Raid II":this.CheckForImage("nm_volcanic_large_2.jpg")?"Alpha Volcanic Dragon":this.CheckForImage("nm_azriel_large2.jpg")?"Wrath":this.getMonstType(e);if(nHtml.FindByAttr(c,"img","uid",userID))e=e.replace(d,"Your ");var h=(new Date).getTime();gm.setListObjVal("monsterOl",e,"review",h.toString());
gm.setValue("monsterRepeatCount",0);var k=gm.getListObjVal("monsterOl",e,"Damage",0);gm.setListObjVal("monsterOl",e,"Type",g);d=[];var l=$("#app46755028429_monsterTicker");if(l.length)d=l.text().split(":");else log("Could not locate Monster ticker.");h="";var m=0,p="";l=null;if(d.length==3&&this.monsterInfo[g]&&this.monsterInfo[g].fort){g=="Deathrune"||g=="Ice Elemental"?gm.setListObjVal("monsterOl",e,"Fort%",100):gm.setListObjVal("monsterOl",e,"Fort%",0);var n=this.CheckForImage("bar_dispel");if(n){var q=
n.parentNode.style.width;q=q.substring(0,q.length-1);l=100-Number(q)}else if(n=this.CheckForImage("seamonster_ship_health")){var o=n.parentNode.style.width;l=o.substring(0,o.length-1);if(g=="Legion"||g.indexOf("Elemental")>=0)if(n=this.CheckForImage("repair_bar_grey")){var r=n.parentNode.style.width;r=r.substring(0,r.length-1);l=Math.round(Number(l)*(100/(100-Number(r))))}}else if(n=this.CheckForImage("nm_green")){var t=n.parentNode.style.width;l=t.substring(0,t.length-1)}l!==null&&gm.setListObjVal("monsterOl",
e,"Fort%",Math.round(l*10)/10)}n=0;if(c=nHtml.FindByAttrContains(document.body,"td","class","dragonContainer"))if(c=nHtml.FindByAttrContains(c,"td","valign","top"))if(c=nHtml.FindByAttrContains(c,"a","href","keep.php?user="+userID)){q=null;if(g=="Serpent"||g.indexOf("Elemental")>=0||g=="Deathrune"){q=$.trim(nHtml.GetText(c.parentNode.parentNode.nextSibling.nextSibling)).split("/");f=this.NumberOnly(q[1]);n=this.NumberOnly(q[0])+f;gm.setListObjVal("monsterOl",e,"Fort",f)}else{q=g=="Siege"||g=="Raid I"||
g=="Raid II"?$.trim(nHtml.GetText(c.parentNode.nextSibling.nextSibling)):$.trim(nHtml.GetText(c.parentNode.parentNode.nextSibling.nextSibling));n=this.NumberOnly(q)}gm.setListObjVal("monsterOl",e,"Damage",n)}else log("Player hasn't done damage yet");else log("couldn't get top table");else log("couldn't get dragoncontainer");var s=gm.getListObjVal("monsterOl",e,"conditions","");if(/:ac\b/.test(s)){var v=parseInt(gm.getValue("monsterReviewCounter",-3),10),u=gm.getList("monsterOl");if(v>=0&&u[v].indexOf(e)>=
0&&(nHtml.FindByAttrContains(document.body,"a","href","&action=collectReward")||nHtml.FindByAttrContains(document.body,"input","alt","Collect Reward"))){log("Collecting Reward");gm.setListObjVal("monsterOl",e,"review","1");gm.setValue("monsterReviewCounter",v-=1);gm.setListObjVal("monsterOl",e,"status","Collect Reward");if(e.indexOf("Siege")>=0)nHtml.FindByAttrContains(document.body,"a","href","&rix=1")?gm.setListObjVal("monsterOl",e,"rix",1):gm.setListObjVal("monsterOl",e,"rix",2)}}c=0;f="";f=g.indexOf("Volcanic")>=
0||g.indexOf("Wrath")>=0?"nm_red.jpg":"monster_health_background.jpg";if(d.length==3&&this.CheckForImage(f)){gm.setListObjVal("monsterOl",e,"TimeLeft",d[0]+":"+d[1]);var x=null,w=nHtml.FindByAttrContains(document.body,"img","src",f);if(w){var B=w.parentNode.getAttribute("style").split(";")[1].split(":");x=$.trim(B[1])}else log("Could not find monster health div.");if(x){c=Math.round(x.replace(/%/,"")*10)/10;gm.setListObjVal("monsterOl",e,"Damage%",c);h=this.monsterInfo[g];if(!h){log("Unknown monster");
return}}if(h&&h.siege){w=/.*Need (\d+) more.*/;if(g.indexOf("Volcanic")>=0||g.indexOf("Wrath")>=0){p=$.trim($("#app46755028429_action_logs").prev().children().eq(1).children().eq(3).text().replace(w,"$1"));if(g.indexOf("Alpha")>=0||g.indexOf("Wrath")>=0){var y=$("img[src*="+h.siege_img+"]").size(),A=$("img[src*="+h.siege_img2+"]").size();m=Math.min(y+A,h.siege)}else m=Math.min($("img[src*="+h.siege_img+"]").size(),h.siege)}else{p=g.indexOf("Raid")>=0?$.trim($("img[src*="+h.siege_img+"]").parent().parent().text().replace(w,
"$1")):$.trim($("#app46755028429_action_logs").prev().children().eq(3).children().eq(2).children().eq(1).text().replace(w,"$1"));var z=document.getElementById("app46755028429_siege_log");if(z&&!m){var D=z.getElementsByTagName("div").length;if(D)m=Math.round(D/4)+1;else log("Could not count siege logs.")}else log("Could not find siege logs.")}var C=Math.min(m,h.siege)+"/"+h.siege+" need "+(isNaN(p)?0:p);gm.setListObjVal("monsterOl",e,"Phase",C)}if(h){if(isNaN(p))p=0;var G=this.t2kCalc(h,d,c,m,p);gm.setListObjVal("monsterOl",
e,"T2K",G.toString()+" hr")}h=this.monsterInfo[g];var E=this.parseCondition("ach",s);if(h&&E===false)E=h.ach;var F=this.parseCondition("max",s);l=gm.getListObjVal("monsterOl",e,"Fort%","");var L=this.parseCondition("f%",s)!==false?this.parseCondition("f%",s):gm.getNumber("MaxToFortify",0),H=e==gm.getValue("targetFromraid","")||e==gm.getValue("targetFrombattle_monster","")||e==gm.getValue("targetFromfortify","");e==gm.getValue("targetFromfortify","")&&l>L&&gm.setValue("resetselectMonster",true);log("Start of Keep On Budget (KOB) Code");
y=false;A=0;C=D=z=false;var I=this.parseCondition("kob",s);if(isNaN(I)){log("NaN branch");y=true;A=0}else if(I){log("passed value branch");y=true;A=I}else{log("false branch");y=false;A=0}if(this.InLevelUpMode()||this.stats.stamina.num>=this.stats.stamina.max-5)y=false;log("Level Up Mode: "+this.InLevelUpMode()+" Stamina Avail: "+this.stats.stamina.num+" Stamina Max: "+this.stats.stamina.max);log("KOBenable: "+y+" KOB Bias Hours: "+A);var J=this.monsterInfo[g].duration;log("Total Time for Monster: "+
J);log("HP left: "+c);var K=parseInt(d[0],10)+parseInt(d[1],10)*0.0166;log("TimeLeft: "+K);var M=Math.round((K-A)/J*1E3)/10;log("Percent Time Remaining: "+M);if(F&&n>=F){gm.setListObjVal("monsterOl",e,"color","red");gm.setListObjVal("monsterOl",e,"over","max");D=true;log("KOB - max activated");H&&gm.setValue("resetselectMonster",true)}else if(l&&l<gm.getNumber("MinFortToAttack",1)){gm.setListObjVal("monsterOl",e,"color","purple");C=true;log("KOB - MinFort activated");H&&gm.setValue("resetselectMonster",
true)}else if(n>=E&&gm.getValue("AchievementMode")){gm.setListObjVal("monsterOl",e,"color","orange");gm.setListObjVal("monsterOl",e,"over","ach");z=true;log("KOB - achievement reached");H&&k<E&&gm.setValue("resetselectMonster",true)}if(y&&!D&&!C&&z&&c<M){gm.setListObjVal("monsterOl",e,"color","red");gm.setListObjVal("monsterOl",e,"over","max");log("KOB - budget reached");if(H){gm.setValue("resetselectMonster",true);log("This monster no longer a target due to kob")}}else!D&&!C&&!z&&gm.setListObjVal("monsterOl",
e,"color","black");this.CheckTimer("battleTimer")&&window.setTimeout(function(){caap.SetDivContent("monster_mess","")},2E3)}else{log("Monster is dead or fled");gm.setListObjVal("monsterOl",e,"color","grey");x=gm.getListObjVal("monsterOl",e,"status");x!="Complete"&&x!="Collect Reward"&&gm.setListObjVal("monsterOl",e,"status","Dead or Fled");gm.setValue("resetselectMonster",true)}}catch(N){log("ERROR in CheckResults_viewFight: "+N)}},selectMonster:function(){try{if(this.oneMinuteUpdate("selectMonster")){gm.setValue("targetFrombattle_monster",
"");gm.setValue("targetFromfortify","");gm.setValue("targetFromraid","");var c={};c.battle_monster=[];c.raid=[];c.any=[];var d="";gm.getList("monsterOl").forEach(function(C){gm.setListObjVal("monsterOl",C.split(global.vs)[0],"conditions","none");d=gm.getObjVal(C,"page");if(gm.getValue("SerializeRaidsAndMonsters",false))c.any.push(C);else if(d=="raid"||d=="battle_monster")c[d].push(C)});var e=[];e=gm.getValue("SerializeRaidsAndMonsters",false)?["any"]:["battle_monster","raid"];for(var f in e)if(e.hasOwnProperty(f)){var g=
e[f],h="",k="",l="",m="",p=[];if(g=="any"){var n=gm.getListFromText("orderbattle_monster",""),q=gm.getListFromText("orderraid","").concat("your","'");p=n.concat(q)}else p=gm.getListFromText("order"+g,"").concat("your","'");var o="",r="",t="";for(var s in p)if(p.hasOwnProperty(s)){var v=$.trim(p[s].match(/^[^:]+/).toString()).toLowerCase();r=$.trim(p[s].replace(/^[^:]+/,"").toString());var u=c[g];for(var x in u)if(u.hasOwnProperty(x)){var w=u[x];o=w.split(global.vs)[0];d=gm.getObjVal(w,"page");if(gm.getListObjVal("monsterOl",
o,"conditions")=="none")if(!(o.toLowerCase().indexOf(v)<0||g!="any"&&d!=g)){gm.setListObjVal("monsterOl",o,"conditions",r);var B=gm.getObjVal(w,"color","");if(B!="grey"){var y=gm.getObjVal(w,"over","");if(!k&&B!="purple")if(y=="ach")h||(h=o);else if(y!="max")k=o;var A=parseFloat(gm.getObjVal(w,"Fort%",0)),z=this.parseCondition("f%",r)!==false?this.parseCondition("f%",r):gm.getNumber("MaxToFortify",0);t=this.getMonstType(o);if(!m&&A<z&&d=="battle_monster"&&this.monsterInfo[t]&&this.monsterInfo[t].fort)if(y==
"ach")l||(l=o);else if(y!="max")m=o}}}}(o=k)||(o=h);if(g!="raid"){gm.setValue("targetFromfortify",m);gm.getValue("targetFromfortify","")||gm.setValue("targetFromfortify",l)}if(o){d=gm.getListObjVal("monsterOl",o,"page");gm.setValue("targetFrom"+d,o);r=gm.getListObjVal("monsterOl",o,"conditions");t=gm.getListObjVal("monsterOl",o,"Type","");if(d=="battle_monster"){h=0;if(!this.InLevelUpMode()&&this.monsterInfo[t]&&this.monsterInfo[t].staLvl)for(h=this.monsterInfo[t].staLvl.length-1;h>=0;h-=1)if(this.stats.stamina.max>
this.monsterInfo[t].staLvl[h])break;if(!this.InLevelUpMode()&&this.monsterInfo[t]&&this.monsterInfo[t].staMax&&gm.getValue("PowerAttack")&&gm.getValue("PowerAttackMax"))gm.setValue("MonsterStaminaReq",this.monsterInfo[t].staMax[h]);else if(this.monsterInfo[t]&&this.monsterInfo[t].staUse)gm.setValue("MonsterStaminaReq",this.monsterInfo[t].staUse);else if(this.InLevelUpMode()&&this.stats.stamina.num>=10||r.match(/:pa/i))gm.setValue("MonsterStaminaReq",5);else if(r.match(/:sa/i))gm.setValue("MonsterStaminaReq",
1);else gm.getValue("PowerAttack")?gm.setValue("MonsterStaminaReq",5):gm.setValue("MonsterStaminaReq",1);gm.getValue("MonsterGeneral")=="Orc King"&&gm.setValue("MonsterStaminaReq",gm.getValue("MonsterStaminaReq")*5);gm.getValue("MonsterGeneral")=="Barbarus"&&gm.setValue("MonsterStaminaReq",gm.getValue("MonsterStaminaReq")*3)}else if(gm.getValue("RaidPowerAttack",false)||r.match(/:pa/i))gm.setValue("RaidStaminaReq",5);else this.monsterInfo[t]&&this.monsterInfo[t].staUse?gm.setValue("RaidStaminaReq",
this.monsterInfo[t].staUse):gm.setValue("RaidStaminaReq",1)}}gm.setValue("resetdashboard",true)}}catch(D){log("ERROR in selectMonster: "+D)}},monsterConfirmRightPage:function(c,d){try{var e=/.+'s /,f=nHtml.GetText(c);if(this.CheckForImage("nm_volcanic_title.jpg")){f=f.match(e)+"Bahamut, the Volcanic Dragon";f=$.trim(f)}else if(this.CheckForImage("nm_volcanic_title_2.jpg")){f=f.match(e)+"Alpha Bahamut, the Volcanic Dragon";f=$.trim(f)}else if(this.CheckForImage("nm_azriel_title.jpg")){f=f.match(e)+
"Azriel, the Angel of Wrath";f=$.trim(f)}else f=$.trim(f.substring(0,f.indexOf("You have (")));if(nHtml.FindByAttr(c,"img","uid",userID))f=f.replace(e,"Your ");if(d!=f){log("Looking for "+d+" but on "+f+". Going back to select screen");return this.NavigateTo("keep,"+gm.getListObjVal("monsterOl",d,"page"))}return false}catch(g){log("ERROR in monsterConfirmRightPage: "+g);return false}},MonsterReview:function(){try{if(!this.WhileSinceDidIt("monsterReview",3600))return false;var c=parseInt(gm.getValue("monsterReviewCounter",
-3),10);if(c==-3){gm.setValue("monsterOl","");gm.setValue("monsterReviewCounter",c+1);return true}if(c==-2){if(this.NavigateTo("battle_monster","tab_monster_on.jpg")){gm.setValue("reviewDone",0);return true}if(gm.getValue("reviewDone",1)>0)gm.setValue("monsterReviewCounter",c+=1);else return true}if(c==-1){if(this.NavigateTo(this.battlePage+",raid","tab_raid_on.gif")){gm.setValue("reviewDone",0);return true}if(gm.getValue("reviewDone",1)>0)gm.setValue("monsterReviewCounter",c+=1);else return true}if(!gm.getValue("monsterOl",
""))return false;for(var d=gm.getList("monsterOl");c<d.length;){var e=d[c];if(e)if(!this.WhileSinceDidIt(gm.getObjVal(e,"review"),3600)||gm.getValue("monsterRepeatCount",0)>2){gm.setValue("monsterReviewCounter",c+=1);gm.setValue("monsterRepeatCount",0)}else{var f=e.split(global.vs)[0];this.SetDivContent("monster_mess","Reviewing/sieging "+(c+1)+"/"+d.length+" "+f);var g=gm.getObjVal(e,"Link");if(/href/.test(g)){g=g.split("'")[1];var h=gm.getObjVal(e,"conditions");if(h&&/:ac\b/.test(h)&&gm.getObjVal(e,
"status")=="Collect Reward"){g+="&action=collectReward";if(f.indexOf("Siege")>=0)g+="&rix="+gm.getObjVal(e,"rix","2");g=g.replace("&action=doObjective","")}else if(h&&h.match(":!s")||!gm.getValue("DoSiege",true)||this.stats.stamina.num===0)g=g.replace("&action=doObjective","");log("Reviewing "+(c+1)+"/"+d.length+" "+f);gm.setValue("ReleaseControl",true);g=g.replace("http://apps.facebook.com/castle_age/","");g=g.replace("?","?twt2&");this.ClickAjax(g);gm.setValue("monsterRepeatCount",gm.getValue("monsterRepeatCount",
0)+1);gm.setValue("resetselectMonster",true);gm.setValue("resetdashboard",true);return true}}else gm.setValue("monsterReviewCounter",c+=1)}this.JustDidIt("monsterReview");gm.setValue("resetselectMonster",true);gm.setValue("resetdashboard",true);gm.setValue("monsterReviewCounter",-3);log("Done with monster/raid review.");this.SetDivContent("monster_mess","");return true}catch(k){log("ERROR in MonsterReview: "+k);return false}},Monsters:function(){try{if(gm.getValue("WhenMonster","")=="Never"){this.SetDivContent("monster_mess",
"Monster off");return false}if(gm.getValue("WhenMonster")=="Stay Hidden"&&this.NeedToHide()&&this.CheckStamina("Monster",1)){log("Stay Hidden Mode: We're not safe. Go battle.");this.SetDivContent("monster_mess","Not Safe For Monster. Battle!");return false}if(!this.CheckTimer("NotargetFrombattle_monster"))return false;if(!this.InLevelUpMode()&&this.stats.stamina.num==gm.getNumber("MonsterStaminaReq",1)-1&&this.CheckTimer("battleTimer")&&gm.getNumber("seedTime",0)>0){this.SetTimer("battleTimer",300+
Math.floor(Math.random()*gm.getValue("seedTime",0)));this.SetDivContent("monster_mess","Monster Delay Until: "+this.DisplayTimer("battleTimer"));return false}if(!this.CheckTimer("battleTimer"))if(this.stats.stamina.num<gm.getNumber("MaxIdleStamina",this.stats.stamina.max)){this.SetDivContent("monster_mess","Monster Delay Until: "+this.DisplayTimer("battleTimer"));return false}var c="",d=gm.getValue("targetFromfortify"),e=this.getMonstType(d),f=0,g=null,h=10;if(e){g=this.monsterInfo[e].staLvl;if(!this.InLevelUpMode()&&
gm.getValue("PowerFortifyMax")&&g)for(f=this.monsterInfo[e].staLvl.length-1;f>=0;f-=1)if(this.stats.stamina.max>this.monsterInfo[e].staLvl[f])break;if(f&&gm.getValue("PowerAttackMax"))h=this.monsterInfo[e].nrgMax[f]}if(d&&this.CheckEnergy(h,gm.getValue("WhenFortify","Energy Available"),"fortify_mess"))c=gm.setValue("fightMode","Fortify");else if((d=gm.getValue("targetFrombattle_monster"))&&this.CheckStamina("Monster",gm.getValue("MonsterStaminaReq",1))&&gm.getListObjVal("monsterOl",d,"page")=="battle_monster")c=
gm.setValue("fightMode","Monster");else{this.SetTimer("NotargetFrombattle_monster",60);return false}if(this.SelectGeneral(c+"General"))return true;e=this.getMonstType(d);h="";h=e=="Volcanic Dragon"||e=="Wrath"?"nm_top.jpg":e=="Alpha Volcanic Dragon"?"nm_top_2.jpg":"dragon_title_owner.jpg";var k=this.CheckForImage(h);if(k){if(this.monsterConfirmRightPage(k,d))return true;k=null;var l=["button_nm_p_attack.gif","attack_monster_button.jpg","event_attack1.gif","seamonster_attack.gif","event_attack2.gif",
"attack_monster_button2.jpg"],m=[];m=c=="Fortify"?["seamonster_fortify.gif","button_nm_s_","button_dispel.gif","attack_monster_button3.jpg"]:gm.getValue("MonsterStaminaReq",1)==1?l:["button_nm_p_power","button_nm_p_","power_button_","attack_monster_button2.jpg","event_attack2.gif","seamonster_power.gif","event_attack1.gif","attack_monster_button.jpg"].concat(l);f=0;g=this.monsterInfo[e].staLvl;if(!this.InLevelUpMode())if((c=="Fortify"&&gm.getValue("PowerFortifyMax")||c!="Fortify"&&gm.getValue("PowerAttack")&&
gm.getValue("PowerAttackMax"))&&g)for(f=this.monsterInfo[e].staLvl.length-1;f>=0;f-=1)if(this.stats.stamina.max>this.monsterInfo[e].staLvl[f])break;for(var p in m)if(m.hasOwnProperty(p))if(k=this.CheckForImage(m[p],null,null,f))break;if(k){e="";e=c=="Fortify"?"Fortifying "+d:(gm.getValue("MonsterStaminaReq",1)>=5?"Power":"Single")+" Attacking "+d;log(e);this.SetDivContent("monster_mess",e);gm.setValue("ReleaseControl",true);this.Click(k,8E3);return true}else{log("ERROR - No button to attack/fortify with.");
this.SetTimer("NotargetFrombattle_monster",60);return false}}if(this.NavigateTo("keep,battle_monster","tab_monster_on.jpg"))return true;if(gm.getValue("clearCompleteMonsters",false)&&this.completeButton.battle_monster){this.Click(this.completeButton.battle_monster,1E3);log("Cleared a completed monster");this.completeButton.battle_monster="";return true}if((l=this.CheckForImage("dragon_list_btn_"))&&!(l.parentNode.href.match("user="+userID)||l.parentNode.href.match(/alchemy\.php/))){log("On another player's keep.");
return this.NavigateTo("keep,battle_monster")}if(m=this.monsterEngageButtons[d]){this.SetDivContent("monster_mess","Opening "+d);this.Click(m);return true}else{this.SetTimer("NotargetFrombattle_monster",60);log('No "Engage" button for '+d);return false}}catch(n){log("ERROR in Monsters: "+n);return false}},DemiPoints:function(){try{if(!gm.getValue("DemiPointsFirst"))return false;if(this.CheckForImage("battle_on.gif")){var c=this.CheckForImage("symbol_tiny_1.jpg");if(c){var d=nHtml.GetText(c.parentNode.parentNode.parentNode).match(/\d+ \/ 10/g);
if(d){gm.setList("DemiPointList",d);log("DemiPointList: "+d);if(this.CheckTimer("DemiPointTimer")){log("Set DemiPointTimer to 6 hours, and check if DemiPoints done");this.SetTimer("DemiPointTimer",21600)}gm.setValue("DemiPointsDone",true);for(var e in d)if(d.hasOwnProperty(e)){var f=d[e];if(f){var g=f.split("/");if(g.length!=2)log("Continue due to demiPoints: "+g);else if(parseInt(g[0],10)<10&&gm.getValue("DemiPoint"+e)){gm.setValue("DemiPointsDone",false);break}}else log("Continue due to demiPointStr: "+
f)}log("Demi Point Timer "+this.DisplayTimer("DemiPointTimer")+" demipoints done is  "+gm.getValue("DemiPointsDone",false))}else log("Unable to get demiPointList")}}if(this.CheckTimer("DemiPointTimer"))return this.NavigateTo(this.battlePage,"battle_on.gif");if(!gm.getValue("DemiPointsDone",true))return this.Battle("DemiPoints");return false}catch(h){log("ERROR in DemiPoints: "+h);return false}},minutesBeforeLevelToUseUpStaEnergy:5,InLevelUpMode:function(){try{if(!gm.getValue("EnableLevelUpMode",true))return this.newLevelUpMode=
false;if(!this.stats.levelTime)return this.newLevelUpMode=false;var c=new Date;if(this.stats.levelTime.getTime()-c.getTime()<this.minutesBeforeLevelToUseUpStaEnergy*60*1E3){if(!this.newLevelUpMode){this.newLevelUpMode=true;this.refreshMonstersListener()}return true}return this.newLevelUpMode=false}catch(d){log("ERROR in InLevelUpMode: "+d);return false}},CheckStamina:function(c,d){try{d||(d=1);var e=gm.getValue("When"+c,"");if(e=="Never")return false;if(!this.stats.stamina||!this.stats.health){this.SetDivContent("battle_mess",
"Health or stamina not known yet.");return false}if(this.stats.health.num<10){this.SetDivContent("battle_mess","Need health to fight: "+this.stats.health.num+"/10");return false}if(e=="At X Stamina"){if(this.InLevelUpMode()&&this.stats.stamina.num>=d){this.SetDivContent("battle_mess","Burning stamina to level up");return this.stats.stamina.num}c=c+"Stamina";if(gm.getValue("BurnMode_"+c,false)||this.stats.stamina.num>=gm.getValue("X"+c,1)){if(this.stats.stamina.num<d||this.stats.stamina.num<=gm.getValue("XMin"+
c,0)){gm.setValue("BurnMode_"+c,false);return false}gm.setValue("BurnMode_"+c,true);return this.stats.stamina.num-gm.getValue("XMin"+c,0)}else gm.setValue("BurnMode_"+c,false);this.SetDivContent("battle_mess","Waiting for stamina: "+this.stats.stamina.num+"/"+gm.getValue("X"+c,1));return false}if(e=="At Max Stamina"){if(!gm.getValue("MaxIdleStamina",0)){log("Changing to idle general to get Max Stamina");this.PassiveGeneral()}if(this.stats.stamina.num>=gm.getValue("MaxIdleStamina")){this.SetDivContent("battle_mess",
"Using max stamina");return this.stats.stamina.num}if(this.InLevelUpMode()&&this.stats.stamina.num>=d){this.SetDivContent("battle_mess","Burning all stamina to level up");return this.stats.stamina.num}this.SetDivContent("battle_mess","Waiting for max stamina: "+this.stats.stamina.num+"/"+gm.getValue("MaxIdleStamina"));return false}if(this.stats.stamina.num>=d)return this.stats.stamina.num;this.SetDivContent("battle_mess","Waiting for more stamina: "+this.stats.stamina.num+"/"+d);return false}catch(f){log("ERROR in CheckStamina: "+
f);return false}},NeedToHide:function(){if(gm.getValue("WhenMonster","")=="Never"){log("Stay Hidden Mode: Monster battle not enabled");return true}if(!gm.getValue("targetFrombattle_monster","")){log("Stay Hidden Mode: No monster to battle");return true}return this.stats.health.num-(this.stats.stamina.num-1)*gm.getNumber("HidingRiskConstant",1.7)<10&&this.stats.stamina.num*(5/3)>=5?false:true},mf_attackButton:null,monstArgs:{doaid:{fname:"Any Weapon Aid",sname:"Aid",urlid:"doObjective"},urlix:{fname:"Any Monster",
sname:"Any",urlid:"user"},legio:{fname:"Battle of the Dark Legion",sname:"Legion",nname:"castle",imgid:"cta_castle_",twt2:"corc_"},hydra:{fname:"Cronus, The World Hydra ",sname:"Cronus",nname:"hydra",imgid:"twitter_hydra_objective",twt2:"hydra_"},earth:{fname:"Genesis, The Earth Elemental ",sname:"Genesis",nname:"earthelemental",imgid:"cta_earth_",twt2:"earth_"},ice:{fname:"Ragnarok, The Ice Elemental ",sname:"Ragnarok",nname:"iceelemental",imgid:"cta_water_",twt2:"water_"},kull:{fname:"Kull, the Orc Captain",
sname:"Kull",nname:"captain",imgid:"cta_orc_captain.gif",twt2:"bosscaptain"},gilda:{fname:"Gildamesh, the Orc King",sname:"Gildamesh",nname:"king",imgid:"cta_orc_king.gif",twt2:"bossgilda"},colos:{fname:"Colossus of Terra",sname:"Colossus",nname:"stone",imgid:"cta_stone.gif",twt2:"bosscolossus"},sylva:{fname:"Sylvanas the Sorceress Queen",sname:"Sylvanas",nname:"sylvanas",imgid:"cta_sylvanas.gif",twt2:"bosssylvanus"},mephi:{fname:"Mephistophles",sname:"Mephisto",nname:"mephi",imgid:"cta_mephi.gif",
twt2:"bossmephistopheles"},keira:{fname:"Keira",sname:"keira",nname:"keira",imgid:"cta_keira.gif",twt2:"boss_img"},lotus:{fname:"Lotus Ravenmoore",sname:"Ravenmoore",nname:"lotus",imgid:"cta_lotus.gif",twt2:"bosslotus_"},skaar:{fname:"Skaar Deathrune",sname:"Deathrune",nname:"skaar",imgid:"cta_death_",twt2:"death_",deadimg:"cta_death_dead.gif"},serps:{fname:"Any Serpent",sname:"Serpent",nname:"seamonster",imgid:"twitter_seamonster_",twt2:"sea_"},eserp:{fname:"Emerald Serpent",sname:"Emerald Serpent",
nname:"greenseamonster",imgid:"twitter_seamonster_green_1",twt2:"sea_"},sserp:{fname:"Saphire Serpent",sname:"Saphire Serpent",nname:"blueseamonster",imgid:"twitter_seamonster_blue_1",twt2:"sea_"},aserp:{fname:"Amethyst Serpent",sname:"Amethyst Serpent",nname:"purpleseamonster",imgid:"twitter_seamonster_purple_1",twt2:"sea_"},rserp:{fname:"Ancient Serpent",sname:"Ancient Serpent",nname:"redseamonster",imgid:"twitter_seamonster_red_1",twt2:"sea_"},drags:{fname:"Any Dragon",sname:"Dragon",nname:"drag",
imgid:"_dragon.gif",twt2:"dragon_"},edrag:{fname:"Emerald Dragon",sname:"Emerald Dragon",nname:"greendragon",imgid:"cta_green_dragon.gif",twt2:"dragon_"},fdrag:{fname:"Frost Dragon",sname:"Frost Dragon",nname:"bluedragon",imgid:"cta_blue_dragon.gif",twt2:"dragon_"},gdrag:{fname:"Gold Dragon",sname:"Gold Dragon",nname:"yellowdragon",imgid:'cta_yellow_dragon.gif"',twt2:"dragon_"},rdrag:{fname:"Ancient Red Dragon",sname:"Red Dragon",nname:"reddragon",imgid:"cta_red_dragon.gif",twt2:"dragon_"},deas:{fname:"Any Deathrune Raid",
sname:"Deathrune Raid",nname:"deathrune",imgid:"raid_deathrune_",twt2:"deathrune_"},a1dea:{fname:"Deathrune Raid I Part 1",sname:"Deathrune Raid A1",nname:"deathrunea1",imgid:"raid_deathrune_a1.gif",twt2:"deathrune_"},a2dea:{fname:"Deathrune Raid I Part 2",sname:"Deathrune Raid A2",nname:"deathrunea2",imgid:"raid_deathrune_a2.gif",twt2:"deathrune_"},b1dea:{fname:"Deathrune Raid II Part 1",sname:"Deathrune Raid B1",nname:"deathruneb1",imgid:"raid_deathrune_b1.gif",twt2:"deathrune_"},b2dea:{fname:"Deathrune Raid II Part 2",
sname:"Deathrune Raid B2",nname:"deathruneb2",imgid:"raid_deathrune_b2.gif",twt2:"deathrune_"}},monstGroups:{doaid:{monst:"legio~hydra~earth~ice~sylva~skaar~a1dea~a2dea~b1dea~b2dea"},world:{monst:"legio~hydra~earth~ice",max:"5"},serps:{monst:"eserp~sserp~aserp~rserp"},drags:{monst:"edrag~fdrag~gdrag~rdrag"},deas:{monst:"a1dea~a2dea~b1dea~b2dea"},elems:{monst:"earth~ice"}},MonsterFinder:function(){if(!gm.getValue("MonsterFinderUse",false)||this.stats.stamina.num<gm.getValue("MonsterFinderMinStam",
20)||this.stats.health.num<10)return false;if(gm.getValue("urlix","").replace("~","")===""&&gm.getValue("mfStatus","")!="OpenMonster"&&caap.WhileSinceDidIt("clearedMonsterFinderLinks",86400)){gm.setValue("mfStatus","");log("Resetting monster finder history");this.clearLinks()}log("All checks passed to enter Monster Finder");if(window.location.href.indexOf("filter=app_46755028429")<0){var c=gm.getValue("mfStatus","");if(c=="OpenMonster"){caap.CheckMonster();return true}else if(c=="MonsterFound"){caap.VisitUrl("http://apps.facebook.com/castle_age"+
gm.getValue("navLink"));gm.setValue("mfStatus","");return true}else if(c=="TestMonster"&&this.WhileSinceDidIt("checkedFeed",7200)||!this.WhileSinceDidIt("checkedFeed",60*gm.getValue("MonsterFinderFeedMin",5)))caap.selectMonst();else{global.is_chrome?caap.VisitUrl("http://apps.facebook.com/?filter=app_46755028429&show_hidden=true&ignore_self=true&sk=lf",0):caap.VisitUrl("http://www.facebook.com/?filter=app_46755028429&show_hidden=true&ignore_self=true&sk=lf",0);gm.setValue("mfStatus","MFOFB");return false}}},
MonsterFinderOnFB:function(){if(gm.getValue("mfStatus","")!="MFOFB")return false;gm.setValue("mfStatus","Running");gm.setValue("delayPer",1E4);gm.setValue("iterations",2);gm.setValue("iterationsRun",0);log("Set mostRecentFeed");this.JustDidIt("checkedFeed");gm.setValue("monstersExhausted",false);this.bottomScroll()},CheckMonster:function(){if(gm.getValue("mfStatus")!="OpenMonster")return false;log("Checking Monster: "+gm.getValue("navLink"));this.mf_attackButton=this.CheckForImage("attack_monster_button.jpg");
if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("seamonster_power.gif");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("attack_monster_button2.jpg");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("seamonster_power.gif");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("attack_monster_button.jpg");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("event_attack1.gif");if(!this.mf_attackButton){this.mf_attackButton=
this.CheckForImage("event_attack2.gif");if(!this.mf_attackButton)this.mf_attackButton=this.CheckForImage("raid_attack_button.gif")}}}}}}if(this.mf_attackButton){var c=this.CheckResults_viewFight();log("Found Attack Button.  Dam: "+c);if(c){log("Already attacked this monster, find new one");gm.setValue("urlixc",gm.getValue("urlixc","~")+"~"+gm.getValue("navLink").replace("http://apps.facebook.com/castle_age",""));gm.setValue("mfStatus","TestMonster");gm.setValue("waitMonsterLoad",0);return true}else{log("No Damage to monster, Attacking");
caap.Click(this.mf_attackButton);window.setTimeout(function(){log("Hand off to Monsters section");gm.setValue("urlixc",gm.getValue("urlixc","~")+"~"+gm.getValue("navLink").replace("http://apps.facebook.com/castle_age",""));gm.setValue("mfStatus","MonsterFound");gm.setValue("navLink","");caap.NavigateTo("battle_monster");log("Navigate to battle_monster");window.setTimeout(function(){gm.setValue("resetselectMonster",true);gm.setValue("LastAction","Idle");log("resetselectMonster");return true},4E3)},
4E3);return false}}else{log("No Attack Button");if(gm.getValue("waitMonsterLoad",0)<2){log("No Attack Button, Pass"+gm.getValue("waitMonsterLoad"));gm.setValue("waitMonsterLoad",gm.getValue("waitMonsterLoad",0)+1);gm.setValue("LastAction","Idle")}else{log("No Attack Button, Find New Monster");gm.setValue("urlixc",gm.getValue("urlixc","~")+gm.getValue("navLink").replace("http://apps.facebook.com/castle_age",""));gm.setValue("mfStatus","TestMonster");gm.setValue("waitMonsterLoad",0)}return true}},mfMain:function(){log("Do Stuff "+
new Date);gm.getValue("urlix","")===""&&this.clearLinks();this.handleCTA();log("Scroll Up");nHtml.ScrollToTop();log("Select Monster");this.selectMonst()},redirectLinks:function(){for(var c=0;c<document.getElementsByTagName("a").length;c+=1)document.getElementsByTagName("a")[c].target="child_frame"},bottomScroll:function(){nHtml.ScrollToBottom();nHtml.setTimeout(function(){caap.olderPosts()},gm.getValue("delayPer",6E4))},olderPosts:function(){var c=gm.getValue("iterationsRun",0);if(c>0){var d=nHtml.FindByAttrContains(document,
"a","class","PagerMoreLink");if(d){log("Showing more ...");caap.Click(d);log("Link clicked.")}else log("PagerMoreLink not found!")}gm.setValue("iterationsRun",c+=1);log("Get More Iterations "+gm.getValue("iterationsRun")+" of "+gm.getValue("iterations")+" "+new Date);gm.getValue("iterationsRun")<gm.getValue("iterations")?nHtml.setTimeout(function(){caap.bottomScroll()},gm.getValue("delayPer",6E4)):nHtml.setTimeout(function(){caap.mfMain()},gm.getValue("delayPer",12E4))},selectMonst:function(){if(gm.getValue("monstersExhausted",
false)===true)return false;log("Select Monst Function");var c=gm.getValue("MonsterFinderOrder");log("Monst Priority: "+c);c=c.split("~");log("MonstArray: "+c[0]);for(var d=0;d<c.length;d+=1){gm.getValue(c[d],"~")=="~"&&gm.setValue(c[d],"~");log("monstArray[x]: "+c[d]);var e=c[d],f=gm.getValue(c[d],"~").replace(/~~/g,"~").split("~"),g=0;log("Inside MonstArray For Loop "+c[d]+" - Array["+(f.length-1)+"] "+gm.getValue(c[d]).replace("~","~\n"));for(var h=0;h<f.length;h+=1)if(f[h]){var k=f[h].replace("http://apps.facebook.com/castle_age",
"");if(gm.getValue("urlixc","~").indexOf(k)==-1){log("Navigating to Monst: "+c[d]+"  Link: "+k);k="http://apps.facebook.com/castle_age"+k;gm.setValue("navLink",k);gm.setValue("clickUrl",k);this.VisitUrl(k);gm.setValue("mfStatus","OpenMonster");gm.setValue("LastAction","Monsters");this.waitMilliSecs=1E4;return true}else{g+=1;log("Trimming already checked URL, Monst Type: "+e);gm.setValue(e,gm.getValue(e).replace("~"+k,"").replace(/~~/g,"~"),"~")}}log("Links Already Visited: "+c[d]+" #:"+g)}log("All Monsters Tested");
gm.setValue("monstersExhausted",true);gm.setValue("mfStatus","");c=gm.getValue("urlix","~");if(nHtml.CountInstances(c)>100){log("Idle- Resetting Monster Searcher Values, #-"+c);caap.clearLinks(true);gm.setValue("LastAction","")}gm.setValue("clickUrl","http://apps.facebook.com/castle_age/index.php?bm=1");this.VisitUrl("http://apps.facebook.com/castle_age/index.php?bm=1");return false},clearLinks:function(c){log("Clear Links");if(c===true){gm.setValue("navLink","");gm.setValue("mfStatus","");gm.setValue("waitMonsterLoad",
0);gm.setValue("urlixc","~")}gm.setValue("urlix","~");gm.setValue("doaid","~");gm.setValue("legio","~");gm.setValue("hydra","~");gm.setValue("earth","~");gm.setValue("ice","~");gm.setValue("kull","~");gm.setValue("gilda","~");gm.setValue("colos","~");gm.setValue("sylva","~");gm.setValue("mephi","~");gm.setValue("keira","~");gm.setValue("lotus","~");gm.setValue("skaar","~");gm.setValue("serps","~");gm.setValue("eserp","~");gm.setValue("sserp","~");gm.setValue("aserp","~");gm.setValue("rserp","~");
gm.setValue("drags","~");gm.setValue("edrag","~");gm.setValue("fdrag","~");gm.setValue("gdrag","~");gm.setValue("rdrag","~");gm.setValue("deas","~");gm.setValue("a1dea","~");gm.setValue("a2dea","~");gm.setValue("b1dea","~");gm.setValue("b2dea","~");this.JustDidIt("clearedMonsterFinderLinks")},handleCTA:function(){var c=nHtml.getX("//div[@class='GenericStory_Body']",document,nHtml.xpath.unordered);log("Number of entries- "+c.snapshotLength);for(var d=0;d<c.snapshotLength;d+=1){var e=nHtml.getX("./div[2]/div/div/a/@href",
c.snapshotItem(d),nHtml.xpath.string).replace("http://apps.facebook.com/castle_age",""),f=nHtml.Gup("user",e),g=nHtml.Gup("mpool",e),h=nHtml.Gup("action",e),k=nHtml.getX("./div[2]/div/div/a/div/img/@src",c.snapshotItem(d),nHtml.xpath.string);nHtml.getX("./form/span/span/a/abbr/@title",c.snapshotItem(d),nHtml.xpath.string);var l="",m=gm.getValue("urlixc","~");if(k)if(!(m.indexOf(e)>=0))if(k.indexOf("cta_hydra_")>=0||k.indexOf("twitter_hydra_objective")>=0){l=gm.getValue("hydra","~");l.indexOf(e)==
-1&&gm.setValue("hydra",gm.getValue("hydra","")+"~"+e)}else if(k.indexOf("cta_castle_")>=0){l=gm.getValue("legio","~");l.indexOf(e)==-1&&gm.setValue("legio",gm.getValue("legio","")+"~"+e)}else if(k.indexOf("cta_earth_")>=0){l=gm.getValue("earth","~");l.indexOf(e)==-1&&gm.setValue("earth",gm.getValue("earth","")+"~"+e)}else if(k.indexOf("cta_water_")>=0){l=gm.getValue("ice","~");l.indexOf(e)==-1&&gm.setValue("ice",gm.getValue("ice","")+"~"+e)}else if(k.indexOf("raid_deathrune_")>=0){l=gm.getValue("deas",
"~");l.indexOf(e)==-1&&gm.setValue("deas",gm.getValue("deas","")+"~"+e);if(k.indexOf("raid_deathrune_a1.gif")>=0){l=gm.getValue("a1dea","~");l.indexOf(e)==-1&&gm.setValue("a1dea",gm.getValue("a1dea","")+"~"+e)}else if(k.indexOf("raid_deathrune_a2.gif")>=0){l=gm.getValue("a2dea","~");l.indexOf(e)==-1&&gm.setValue("a2dea",gm.getValue("a2dea","")+"~"+e)}else if(k.indexOf("raid_deathrune_b1.gif")>=0){l=gm.getValue("b1dea","~");l.indexOf(e)==-1&&gm.setValue("b1dea",gm.getValue("b1dea","")+"~"+e)}else if(k.indexOf("raid_deathrune_b2.gif")>=
0){l=gm.getValue("b2dea","~");l.indexOf(e)==-1&&gm.setValue("b2dea",gm.getValue("b2dea","")+"~"+e)}}else if(k.indexOf("_dragon.gif")>=0){l=gm.getValue("drags","~");l.indexOf(e)==-1&&gm.setValue("drags",gm.getValue("drags","")+"~"+e);if(k.indexOf("cta_red_dragon.gif")>=0){l=gm.getValue("rdrag","~");l.indexOf(e)==-1&&gm.setValue("rdrag",gm.getValue("rdrag","")+"~"+e)}else if(k.indexOf("cta_yellow_dragon.gif")>=0){l=gm.getValue("gdrag","~");l.indexOf(e)==-1&&gm.setValue("gdrag",gm.getValue("gdrag","")+
"~"+e)}else if(k.indexOf("cta_blue_dragon.gif")>=0){l=gm.getValue("fdrag","~");l.indexOf(e)==-1&&gm.setValue("fdrag",gm.getValue("fdrag","")+"~"+e)}else if(k.indexOf("cta_green_dragon.gif")>=0){l=gm.getValue("edrag","~");l.indexOf(e)==-1&&gm.setValue("edrag",gm.getValue("edrag","")+"~"+e)}}else if(k.indexOf("twitter_seamonster_")>=0&&k.indexOf("_1.jpg")>=0){l=gm.getValue("serps","~");l.indexOf(e)==-1&&gm.setValue("serps",gm.getValue("serps","")+"~"+e);if(k.indexOf("twitter_seamonster_purple_1")>=
0){l=gm.getValue("aserp","~");l.indexOf(e)==-1&&gm.setValue("aserp",gm.getValue("aserp","")+"~"+e)}else if(k.indexOf("twitter_seamonster_red_1")>=0){l=gm.getValue("rserp","~");l.indexOf(e)==-1&&gm.setValue("rserp",gm.getValue("rserp","")+"~"+e)}else if(k.indexOf("twitter_seamonster_blue_1")>=0){l=gm.getValue("sserp","~");l.indexOf(e)==-1&&gm.setValue("sserp",gm.getValue("sserp","")+"~"+e)}else if(k.indexOf("twitter_seamonster_green_1")>=0){l=gm.getValue("eserp","~");l.indexOf(e)==-1&&gm.setValue("eserp",
gm.getValue("eserp","")+"~"+e)}}else if(k.indexOf("cta_death")>=0&&k.indexOf("cta_death_dead.gif")==-1){l=gm.getValue("skaar","~");l.indexOf(e)==-1&&gm.setValue("skaar",gm.getValue("skaar","")+"~"+e)}else if(k.indexOf("cta_lotus.gif")>=0){l=gm.getValue("lotus","~");l.indexOf(e)==-1&&gm.setValue("lotus",gm.getValue("lotus","")+"~"+e)}else if(k.indexOf("cta_keira.gif")>=0){l=gm.getValue("keira","~");l.indexOf(e)==-1&&gm.setValue("keira",gm.getValue("keira","")+"~"+e)}else if(k.indexOf("cta_mephi.gif")>=
0){l=gm.getValue("mephi","~");l.indexOf(e)==-1&&gm.setValue("mephi",gm.getValue("mephi","")+"~"+e)}else if(k.indexOf("cta_sylvanas.gif")>=0){l=gm.getValue("sylva","~");l.indexOf(e)==-1&&gm.setValue("sylva",gm.getValue("sylva","")+"~"+e)}else if(k.indexOf("cta_stone.gif")>=0){l=gm.getValue("colos","~");l.indexOf(e)==-1&&gm.setValue("colos",gm.getValue("colos","")+"~"+e)}else if(k.indexOf("cta_orc_king.gif")>=0){l=gm.getValue("gilda","~");l.indexOf(e)==-1&&gm.setValue("gilda",gm.getValue("gilda","")+
"~"+e)}else if(k.indexOf("cta_orc_captain.gif")>=0){l=gm.getValue("kull","~");l.indexOf(e)==-1&&gm.setValue("kull",gm.getValue("kull","")+"~"+e)}k=gm.getValue("urlix","~");l=gm.getValue("doaid","~");if(f&&h)if(h=="doObjective")if(m.indexOf(e)==-1&&l.indexOf(e)==-1){l+="~"+e;gm.setValue("doaid",l)}if(f&&g)if(m.indexOf(e)==-1&&k.indexOf(e)==-1){k+="~"+e;gm.setValue("urlix",k)}}log("Completed Url Handling");this.JustDidIt("checkedFeed")},AutoPotions:function(){try{if(!gm.getValue("AutoPotions",true)||
!this.WhileSinceDidIt("AutoPotionTimer",21600)||!this.WhileSinceDidIt("AutoPotionTimerDelay",600))return false;if(!nHtml.FindByAttr(document.body,"div","class","statsTTitle")){log("Going to keep for potions");if(this.NavigateTo("keep"))return true}log("Checking energy potions");var c=$("img[title='Energy Potion']").parent().next().text().replace(new RegExp("[^0-9\\.]","g"),"");c||(c=0);log("Energy Potions: "+c);if(c>=gm.getNumber("energyPotionsSpendOver",39)){gm.setValue("Consume_Energy",true);log("Energy potions ready to consume")}log("Checking stamina potions");
var d=$("img[title='Stamina Potion']").parent().next().text().replace(new RegExp("[^0-9\\.]","g"),"");d||(d=0);log("Stamina Potions: "+d);if(d>=gm.getNumber("staminaPotionsSpendOver",39)){gm.setValue("Consume_Stamina",true);log("Stamina potions ready to consume")}log("Checking experience to next level");if((gm.getValue("Consume_Energy",false)||gm.getValue("Consume_Stamina",false))&&this.stats.exp.dif<=gm.getNumber("potionsExperience",20)){log("Not spending potions, experience to next level condition. Delaying 10 minutes");
this.JustDidIt("AutoPotionTimerDelay");return true}if(this.stats.energy.num<this.stats.energy.max-10&&c>gm.getNumber("energyPotionsKeepUnder",35)&&gm.getValue("Consume_Energy",false)){log("Spending energy potions");var e=nHtml.FindByAttr(document.body,"form","id","app46755028429_consume_1");if(e){var f=nHtml.FindByAttrContains(e,"input","src","potion_consume.gif");if(f){log("Consume energy potion");caap.Click(f);return true}else log("Could not find consume energy button")}else log("Could not find energy consume form");
return false}else{gm.setValue("Consume_Energy",false);log("Energy potion conditions not met")}if(this.stats.stamina.num<this.stats.stamina.max-10&&d>gm.getNumber("staminaPotionsKeepUnder",35)&&gm.getValue("Consume_Stamina",false)){log("Spending stamina potions");var g=nHtml.FindByAttr(document.body,"form","id","app46755028429_consume_2");if(g){var h=nHtml.FindByAttrContains(g,"input","src","potion_consume.gif");if(h){log("Consume stamina potion");caap.Click(h);return true}else log("Could not find consume stamina button")}else log("Could not find stamina consume form");
return false}else{gm.setValue("Consume_Stamina",false);log("Stamina potion conditions not met")}this.JustDidIt("AutoPotionTimer");return true}catch(k){log("ERROR in AutoPotion: "+k);return false}},ImmediateBanking:function(){if(!gm.getValue("BankImmed"))return false;return Bank.work(true)},RetrieveFromBank:function(c){try{if(c<=0)return false;var d=this.CheckForImage("btn_retrieve.gif");if(!d)return this.NavigateTo("keep");var e=gm.getNumber("minInStore",0);if(!(e||e<=gm.getNumber("inStore",0)-c))return false;
var f=nHtml.FindByAttrXPath(d.form,"input","@type='' or @type='text'");if(f)f.value=c;else{log("Cannot find box to put in number for bank retrieve.");return false}log("Retrieving "+c+" from bank");gm.setValue("storeRetrieve","");this.Click(d);return true}catch(g){log("ERROR in RetrieveFromBank: "+g);return false}},PassiveGeneral:function(){if(this.SelectGeneral("IdleGeneral"))return true;gm.setValue("MaxIdleEnergy",this.stats.energy.max);gm.setValue("MaxIdleStamina",this.stats.stamina.max);return false},
AutoIncome:function(){if(this.stats.payminute<1&&this.stats.paytime.match(/\d/)&&gm.getValue("IncomeGeneral")!="Use Current"){this.SelectGeneral("IncomeGeneral");return true}return false},CheckResults_army:function(){for(var c=$('div[style="padding: 0pt 0pt 10px 0px; overflow: hidden; float: left; width: 240px; height: 50px;"]').find('a[text="Ignore"]'),d=0;d<c.length;d+=1){var e="<br /><a title='This link can be used to collect the gift when it has been lost on Facebook. !!If you accept a gift in this manner then it will leave an orphan request on Facebook!!' href='"+
c[d].href.replace("ignore","acpt")+"'>Lost Accept</a>";$(e).insertAfter($('div[style="padding: 0pt 0pt 10px 0px; overflow: hidden; float: left; width: 240px; height: 50px;"]').find("a[href="+c[d].href+"]"))}},CheckResults_gift_accept:function(){if($("#app46755028429_app_body").text().match(/You have sent \d+ gifts?/)){log("Confirmed gifts sent out.");gm.setValue("RandomGiftPic","");gm.setValue("FBSendList","")}},CheckResults_index:function(){},AutoGift:function(){try{if(!gm.getValue("AutoGift"))return false;
var c={},d=nHtml.FindByAttrContains(document.body,"div","id","_gift1");if(d){gm.setList("GiftList",[]);var e=document.evaluate(".//div[contains(@id,'_gift')]",d.parentNode,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(d=0;d<e.snapshotLength;d+=1){var f=e.snapshotItem(d),g=$.trim(nHtml.GetText(f)).replace(/!/i,"");if(gm.getValue("GiftList").indexOf(g)>=0)g+=" #2";gm.listPush("GiftList",g);c[g]=this.CheckForImage("mystery",f).src.match(/[\w_\.]+$/i).toString()}if(gm.getValue("GiftChoice")==
"Get Gift List"){gm.setValue("GiftChoice","Same Gift As Received");this.SelectDropOption("GiftChoice","Same Gift As Received")}}if(gm.getValue("GiftChoice",false)=="Get Gift List"||!gm.getList("GiftList"))if(this.NavigateTo("army,gift","giftpage_title.jpg"))return true;e=[];if(gm.getValue("HaveGift",false)){if(this.NavigateTo("army","invite_on.gif"))return true;var h=nHtml.FindByAttrContains(document.body,"a","href","reqs.php#confirm_"),k=nHtml.FindByAttrContains(document.body,"a","href","act=ignore");
if(k&&h){e=this.userRe.exec(k.href);if(!e){log("Unable to find giver ID");return false}var l=nHtml.FindByAttrContains(h.parentNode.parentNode,"a","href","profile.php");l||(l=nHtml.FindByAttrContains(h.parentNode.parentNode,"div","style","overflow: hidden; text-align: center; width: 170px;"));c="Unknown";if(l)c=$.trim(nHtml.GetText(l));gm.setValue("GiftEntry",e[2]+global.vs+c);log("Giver ID = "+e[2]+" Name  = "+c);this.JustDidIt("ClickedFacebookURL");if(global.is_chrome)h.href="http://apps.facebook.com/reqs.php#confirm_46755028429_0";
gm.setValue("clickUrl",h.href);this.VisitUrl(h.href);return true}gm.setValue("HaveGift",false);return this.NavigateTo("gift")}h=null;if(gm.getValue("FBSendList","")){if(h=nHtml.FindByAttrContains(document.body,"input","name","sendit")){log("Sending gifts to Facebook");caap.Click(h);return true}gm.listAddBefore("ReceivedList",gm.getList("FBSendList"));gm.setList("FBSendList",[]);if(h=nHtml.FindByAttrContains(document.body,"input","name","ok")){log("Over max gifts per day");this.JustDidIt("WaitForNextGiftSend");
caap.Click(h);return true}log("No Facebook pop up to send gifts");return false}if(gm.getValue("CASendList","")){var m=nHtml.FindByAttrContains(document.body,"form","id","req_form_");if(m)if(h=nHtml.FindByAttrContains(m,"input","name","send")){log("Clicked CA send gift button");gm.listAddBefore("FBSendList",gm.getList("CASendList"));gm.setList("CASendList",[]);caap.Click(h);return true}log("No CA button to send gifts");gm.listAddBefore("ReceivedList",gm.getList("CASendList"));gm.setList("CASendList",
[]);return false}if(!this.WhileSinceDidIt("WaitForNextGiftSend",10800))return false;if(this.WhileSinceDidIt("WaitForNotFoundIDs",10800)&&gm.getList("NotFoundIDs")){gm.listAddBefore("ReceivedList",gm.getList("NotFoundIDs"));gm.setList("NotFoundIDs",[])}gm.getValue("DisableGiftReturn",false)&&gm.setList("ReceivedList",[]);var p=gm.getList("ReceivedList");if(!p.length)return false;if(this.NavigateTo("army,gift","giftpage_title.jpg"))return true;if(c.length===0){log("No list of pictures for gift choices");
return false}l=h="";var n=gm.getValue("GiftChoice"),q=gm.getList("GiftList");switch(n){case "Random Gift":if(l=gm.getValue("RandomGiftPic"))break;var o=Math.floor(Math.random()*q.length);m=0;for(var r in c)if(c.hasOwnProperty(r)){m+=1;if(m==o){l=c[r];gm.setValue("RandomGiftPic",l);break}}if(!l){log("No gift type match. GiverList: "+p);return false}break;case "Same Gift As Received":h=p[0].split(global.vs)[2];log("Looking for same gift as "+h);if(q.indexOf(h)<0){log("No gift type match. Using first gift as default.");
h=gm.getList("GiftList")[0]}l=c[h];break;default:l=c[gm.getValue("GiftChoice")];break}var t=this.CheckForImage(l);if(t)log("GiftPic is "+l);else{log("Unable to find "+l);return false}if(nHtml.FindByAttrContains(t.parentNode.parentNode.parentNode.parentNode,"div","style","giftpage_select")){if(this.NavigateTo("gift_invite_castle_off.gif","gift_invite_castle_on.gif"))return true}else{this.NavigateTo("gift_more_gifts.gif");return this.NavigateTo(l)}var s=nHtml.FindByAttrContains(document.body,"div",
"class","unselected_list"),v=nHtml.FindByAttrContains(document.body,"div","class","selected_list");gm.setList("ReceivedList",[]);for(var u in p)if(p.hasOwnProperty(u))if(u>10)gm.listPush("ReceivedList",p[u]);else{var x=p[u].split(global.vs),w=x[0],B=x[2];if(n=="Same Gift As Received"&&B!=h&&q.indexOf(B)>=0)gm.listPush("ReceivedList",p[u]);else{var y=nHtml.FindByAttrContains(s,"input","value",w);if(y){log("Clicking giver ID "+w);this.Click(y);if(nHtml.FindByAttrContains(v,"input","value",w)){gm.listPush("CASendList",
p[u]);log("Moved ID "+w)}else{log("NOT moved ID "+w);gm.listPush("NotFoundIDs",p[u]);this.JustDidIt("WaitForNotFoundIDs")}}else{log("Unable to find giver ID "+w);gm.listPush("NotFoundIDs",p[u]);this.JustDidIt("WaitForNotFoundIDs")}}}return true}catch(A){log("ERROR in AutoGift: "+A);return false}},AcceptGiftOnFB:function(){try{if(global.is_chrome){if(window.location.href.indexOf("apps.facebook.com/reqs.php")<0&&window.location.href.indexOf("apps.facebook.com/home.php")<0)return false}else if(window.location.href.indexOf("www.facebook.com/reqs.php")<
0&&window.location.href.indexOf("www.facebook.com/home.php")<0)return false;var c=gm.getValue("GiftEntry","");if(!c)return false;log("On FB page with gift ready to go");if(window.location.href.indexOf("facebook.com/reqs.php")>=0)for(var d=document.evaluate(".//input[contains(@name,'/castle/tracker.php')]",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),e=0;e<d.snapshotLength;e+=1){var f=d.snapshotItem(e),g=f.name.match(/uid%3D\d+/i);if(g){g=String(g).substr(6);if(g==this.NumberOnly(c)){var h=
$.trim(f.value.replace(/^Accept /i,""));if(gm.getList("GiftList").indexOf(h)<0){log("Unknown gift type.");h="Unknown Gift"}gm.getValue("ReceivedList"," ").indexOf(c)<0&&gm.listPush("ReceivedList",c+global.vs+h);log("This giver: "+g+" gave "+h+" Givers: "+gm.getList("ReceivedList"));caap.Click(f);gm.setValue("GiftEntry","");return true}}}if(!this.WhileSinceDidIt("ClickedFacebookURL",10))return false;log("Error: unable to find gift");gm.getValue("ReceivedList"," ").indexOf(c)<0&&gm.listPush("ReceivedList",
c+"\tUnknown Gift");caap.VisitUrl("http://apps.facebook.com/castle_age/army.php?act=acpt&uid="+this.NumberOnly(c));gm.setValue("GiftEntry","");return true}catch(k){log("ERROR in AcceptGiftOnFB: "+k);return false}},ImmediateAutoStat:function(){if(!gm.getValue("StatImmed")||!gm.getValue("AutoStat"))return false;return caap.AutoStat()},IncreaseStat:function(c,d,e){try{var f=c.toLowerCase();c="";switch(f){case "energy":c=nHtml.FindByAttrContains(e,"a","href","energy_max");break;case "stamina":c=nHtml.FindByAttrContains(e,
"a","href","stamina_max");break;case "attack":c=nHtml.FindByAttrContains(e,"a","href","attack");break;case "defense":c=nHtml.FindByAttrContains(e,"a","href","defense");break;case "health":c=nHtml.FindByAttrContains(e,"a","href","health_max");break;default:log("Unable to identify attribute "+f);return"Fail"}if(!c){log("Unable to locate upgrade button for "+f);return"Fail"}var g=this.stats.level,h=parseInt(c.parentNode.parentNode.childNodes[3].firstChild.data.replace(new RegExp("[^0-9]","g"),""),10);
parseInt(nHtml.FindByAttrContains(e,"a","href","energy_max").parentNode.parentNode.childNodes[3].firstChild.data.replace(new RegExp("[^0-9]","g"),""),10);parseInt(nHtml.FindByAttrContains(e,"a","href","stamina_max").parentNode.parentNode.childNodes[3].firstChild.data.replace(new RegExp("[^0-9]","g"),""),10);if(g>=10){parseInt(nHtml.FindByAttrContains(e,"a","href","attack").parentNode.parentNode.childNodes[3].firstChild.data.replace(new RegExp("[^0-9]","g"),""),10);parseInt(nHtml.FindByAttrContains(e,
"a","href","defense").parentNode.parentNode.childNodes[3].firstChild.data.replace(new RegExp("[^0-9]","g"),""),10);parseInt(nHtml.FindByAttrContains(e,"a","href","health_max").parentNode.parentNode.childNodes[3].firstChild.data.replace(new RegExp("[^0-9]","g"),""),10)}var k=nHtml.FindByAttrContains(document.body,"div","id","app46755028429_AjaxLoadIcon");if(!k||k.style.display!=="none"){log("Unable to find AjaxLoadIcon?");return"Fail"}if(f=="stamina"&&this.statsPoints<2){gm.setValue("SkillPointsNeed",
2);return"Fail"}gm.setValue("SkillPointsNeed",1);e=d;g=" "+d;if(gm.getValue("AutoStatAdv",false)){e=eval(d);g=" ("+d+")="+e}if(e>h){log("Status Before:  "+f+"="+h+" Adjusting To:"+g);this.Click(c);return"Click"}return"Next"}catch(l){log("ERROR in IncreaseStat: "+l);return"Fail"}},statsMatch:true,autoStatRuleLog:true,AutoStat:function(){try{if(!gm.getValue("AutoStat"))return false;if(!this.statsMatch){if(this.autoStatRuleLog){log("User should change their stats rules");this.autoStatRuleLog=false}return false}var c=
document.getElementById("app46755028429_main_bntp");if(!c)return false;var d=nHtml.FindByAttrContains(c,"a","href","keep.php");if(!d)return false;this.statsPoints=d.firstChild.firstChild.data.replace(new RegExp("[^0-9]","g"),"");if(!this.statsPoints||this.statsPoints<gm.getValue("SkillPointsNeed",1))return false;var e=nHtml.FindByAttrContains(document.body,"div","class","keep_attribute_section");if(!e){this.NavigateTo("keep");return true}d=0;c=4;if(gm.getValue("AutoStatAdv",false)){d=5;c=9}for(d=
d;d<=c;d+=1)if(gm.getValue("Attribute"+d,"")!==""){if(this.stats.level<10)if(gm.getValue("Attribute"+d,"")==="Attack"||gm.getValue("Attribute"+d,"")==="Defense")continue;switch(this.IncreaseStat(gm.getValue("Attribute"+d,""),gm.getValue("AttrValue"+d,0),e)){case "Next":continue;case "Click":return true;default:return false}}log("No rules match to increase stats");return this.statsMatch=false}catch(f){log("ERROR in AutoStat: "+f);return false}},AutoCollectMA:function(){try{if(!gm.getValue("AutoCollectMA",
true)||!this.WhileSinceDidIt("AutoCollectMATimer",86700))return false;log("Collecting Master and Apprentice reward");caap.SetDivContent("idle_mess","Collect MA Reward");var c=nHtml.FindByAttrContains(document.body,"img","src","ma_view_progress_main"),d=nHtml.FindByAttrContains(document.body,"img","src","ma_main_learn_more");if(!c&&!d){log("Going to home");if(this.NavigateTo("index"))return true}if(c){this.Click(c);caap.SetDivContent("idle_mess","Collected MA Reward");log("Collected Master and Apprentice reward")}if(!c&&
d){caap.SetDivContent("idle_mess","No MA Rewards");log("No Master and Apprentice rewards")}window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);this.JustDidIt("AutoCollectMATimer");log("Collect Master and Apprentice reward completed");return true}catch(e){log("ERROR in AutoCollectMA: "+e);return false}},friendListType:{facebook:{name:"facebook",url:"http://apps.facebook.com/castle_age/army.php?app_friends=false&giftSelection=1"},gifta:{name:"gifta",url:"http://apps.facebook.com/castle_age/gift.php?app_friends=a&giftSelection=1"},
giftb:{name:"giftb",url:"http://apps.facebook.com/castle_age/gift.php?app_friends=b&giftSelection=1"},giftc:{name:"giftc",url:"http://apps.facebook.com/castle_age/gift.php?app_friends=c&giftSelection=1"}},GetFriendList:function(c,d){try{log("Entered GetFriendList and request is for: "+c.name);if(d){gm.deleteValue(c.name+"Requested");gm.deleteValue(c.name+"Responded")}if(gm.getValue(c.name+"Requested",false))log("Already requested GetFriendList for: "+c.name);else{log("Getting Friend List: "+c.name);
gm.setValue(c.name+"Requested",true);$.ajax({url:c.url,error:function(f,g){gm.deleteValue(c.name+"Requested");log("GetFriendList("+c.name+"): "+g)},success:function(f,g){try{log("GetFriendList.ajax splitting data");f=f.split('<div class="unselected_list">');if(f.length<2)throw"Could not locate 'unselected_list'";f=f[1].split('</div><div class="selected_list">');if(f.length<2)throw"Could not locate 'selected_list'";log("GetFriendList.ajax data split ok");var h=[];$("<div></div>").html(f[0]).find("input").each(function(){h.push($(this).val())});
log("GetFriendList.ajax saving friend list of "+h.length+" ids");h.length?gm.setList(c.name+"Responded",h):gm.setValue(c.name+"Responded",true);log("GetFriendList("+c.name+"): "+g)}catch(k){gm.deleteValue(c.name+"Requested");log("ERROR in GetFriendList.ajax: "+k)}}})}return true}catch(e){log("ERROR in GetFriendList("+c.name+"): "+e);return false}},addFriendSpamCheck:0,AddFriend:function(c){try{var d=function(f,g){if(caap.addFriendSpamCheck>0)caap.addFriendSpamCheck-=1;log("AddFriend("+c+"): "+g)};
$.ajax({url:"http://apps.facebook.com/castle_age/party.php?twt=jneg&jneg=true&user="+c+"&lka="+c+"&etw=9&ref=nf",error:d,success:d});return true}catch(e){log("ERROR in AddFriend("+c+"): "+e);return false}},AutoFillArmy:function(c,d){try{if(!gm.getValue("FillArmy",false))return false;var e=gm.getValue("ArmyCount",0);if(e===0){this.SetDivContent("idle_mess","Filling Army");log("Filling army")}if(gm.getValue(c.name+"Responded",false)===true||gm.getValue(d.name+"Responded",false)===true){this.SetDivContent("idle_mess",
"<b>Fill Army Completed</b>");log("Fill Army Completed: no friends found");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);gm.setValue("FillArmy",false);gm.deleteValue("ArmyCount");gm.deleteValue("FillArmyList");gm.deleteValue(c.name+"Responded");gm.deleteValue(d.name+"Responded");gm.deleteValue(c.name+"Requested");gm.deleteValue(d.name+"Requested");return true}var f=gm.getList("FillArmyList");if(!f.length){this.GetFriendList(c);this.GetFriendList(d)}var g=gm.getList(c.name+
"Responded"),h=gm.getList(d.name+"Responded");if(g.length&&h.length||f.length){if(!f.length){var k=h.filter(function(m){return g.indexOf(m)>=0});gm.setList("FillArmyList",k);f=gm.getList("FillArmyList");gm.deleteValue(c.name+"Responded");gm.deleteValue(d.name+"Responded");gm.deleteValue(c.name+"Requested");gm.deleteValue(d.name+"Requested")}h=5;if(f.length<5)h=f.length;else if(f.length-e<5)h=f.length-e;h-=this.addFriendSpamCheck;for(k=0;k<h;k+=1){this.AddFriend(f[e]);e+=1;this.addFriendSpamCheck+=
1}this.SetDivContent("idle_mess","Filling Army, Please wait..."+e+"/"+f.length);log("Filling Army, Please wait..."+e+"/"+f.length);gm.setValue("ArmyCount",e);if(e>=f.length){this.SetDivContent("idle_mess","<b>Fill Army Completed</b>");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);log("Fill Army Completed");gm.setValue("FillArmy",false);gm.deleteValue("ArmyCount");gm.deleteValue("FillArmyList")}}return true}catch(l){log("ERROR in AutoFillArmy: "+l);this.SetDivContent("idle_mess",
"<b>Fill Army Failed</b>");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);gm.setValue("FillArmy",false);gm.deleteValue("ArmyCount");gm.deleteValue("FillArmyList");gm.deleteValue(c.name+"Responded");gm.deleteValue(d.name+"Responded");gm.deleteValue(c.name+"Requested");gm.deleteValue(d.name+"Requested");return false}},AjaxGiftCheck:function(){try{if(!this.WhileSinceDidIt("AjaxGiftCheckTimer",300+Math.floor(Math.random()*3*60)))return false;log("Performing AjaxGiftCheck");$.ajax({url:"http://apps.facebook.com/castle_age/index.php",
error:function(d,e){log("AjaxGiftCheck.ajax: "+e)},success:function(d){try{log("AjaxGiftCheck.ajax: Checking data.");if($(d).find("a[href*='reqs.php#confirm_']").length){log("AjaxGiftCheck.ajax: We have a gift waiting!");gm.setValue("HaveGift",true)}else log("AjaxGiftCheck.ajax: No gifts waiting.");log("AjaxGiftCheck.ajax: Done.")}catch(e){log("ERROR in AjaxGiftCheck.ajax: "+e)}}});this.JustDidIt("AjaxGiftCheckTimer");log("Completed AjaxGiftCheck");return true}catch(c){log("ERROR in AjaxGiftCheck: "+
c);return false}},Idle:function(){this.WhileSinceDidIt("clearedMonsterFinderLinks",259200)&&this.clearLinks(true);this.AjaxGiftCheck();this.AutoFillArmy(this.friendListType.giftc,this.friendListType.facebook);this.AutoCollectMA();this.ReconPlayers();this.UpdateDashboard();gm.setValue("ReleaseControl",true);return true},ReconPlayers:function(){try{if(!gm.getValue("DoPlayerRecon",false))return false;if(this.stats.stamina.num<=0)return false;if(!this.CheckTimer("PlayerReconTimer"))return false;this.SetDivContent("idle_mess",
"Player Recon: Starting");if(!document.getElementById("iframeRecon")){nHtml.OpenInIFrame("http://apps.facebook.com/castle_age/battle.php#iframeRecon","iframeRecon");log("Opening the recon iframe");this.SetTimer("PlayerReconTimer",30);return true}var c=document.getElementById("iframeRecon").contentDocument;if(!c){log("Recon HTML page not ready. waithing For 30 more secionds.");this.SetTimer("PlayerReconTimer",30);return true}this.SetDivContent("idle_mess","Player Recon: In Progress");var d=c.evaluate("//input[contains(@src,'battle_01.gif')]",
c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(d.snapshotLength<=0){c.location.reload(true);log("Recon can not find battle page");caap.SetDivContent("idle_mess","");return false}for(var e=gm.getNumber("ReconPlayerRank",99),f=gm.getNumber("ReconPlayerLevel",999),g=gm.getNumber("ReconPlayerARBase",999),h=0,k=0;k<d.snapshotLength;k+=1){for(var l=d.snapshotItem(k);l.tagName.toLowerCase()!="tr";)l=l.parentNode;var m=l,p=this.NumberOnly(this.CheckForImage("symbol_",m,c).src.match(/\d+\.jpg/i).toString()),
n=$.trim(nHtml.GetText(m)),q=/(.+), Level ([0-9]+)\s*([A-Za-z ]+)\s*([0-9]+)/i.exec(n);if(q){var o=$.trim(q[1]),r=parseInt(q[2],10),t=$.trim(q[3]),s=this.rankTable[t.toLowerCase()],v=parseInt(q[4],10),u=nHtml.FindByAttrXPath(m,"input","@name='target_id'",c).value,x=(new Date).getTime();if(!(r-this.stats.level>f))if(!(this.stats.rank-s>e)){var w=this.stats.level/r;m=g*w;if(m<=0)log("Recon unable to calculate army ratio: "+g+"/"+w);else if(!(v>this.stats.army*m)){h+=1;var B=gm.getListObjVal("targetsOl",
u,"invadewinsNum",-1),y=gm.getListObjVal("targetsOl",u,"invadelossesNum",-1),A=gm.getListObjVal("targetsOl",u,"duelwinsNum",-1),z=gm.getListObjVal("targetsOl",u,"duellossesNum",-1),D=gm.getListObjVal("targetsOl",u,"defendwinsNum",-1),C=gm.getListObjVal("targetsOl",u,"defendlossesNum",-1),G=gm.getListObjVal("targetsOl",u,"goldNum",-1),E=gm.getListObjVal("targetsOl",u,"attackTime",0),F=gm.getListObjVal("targetsOl",u,"selectTime",0),L=gm.getListObjVal("targetsOl",u,"statswinsNum",-1),H=gm.getListObjVal("targetsOl",
u,"statswinsNum",-1),I=gm.getValue("LimitTargets",100);gm.setListObjVal("targetsOl",u,"nameStr",o,I);gm.setListObjVal("targetsOl",u,"rankStr",t);gm.setListObjVal("targetsOl",u,"rankNum",s);gm.setListObjVal("targetsOl",u,"levelNum",r);gm.setListObjVal("targetsOl",u,"armyNum",v);gm.setListObjVal("targetsOl",u,"deityNum",p);gm.setListObjVal("targetsOl",u,"invadewinsNum",B);gm.setListObjVal("targetsOl",u,"invadelossesNum",y);gm.setListObjVal("targetsOl",u,"duelwinsNum",A);gm.setListObjVal("targetsOl",
u,"duellossesNum",z);gm.setListObjVal("targetsOl",u,"defendwinsNum",D);gm.setListObjVal("targetsOl",u,"defendlossesNum",C);gm.setListObjVal("targetsOl",u,"statswinsNum",L);gm.setListObjVal("targetsOl",u,"statslossesNum",H);gm.setListObjVal("targetsOl",u,"goldNum",G);gm.setListObjVal("targetsOl",u,"aliveTime",x);gm.setListObjVal("targetsOl",u,"attackTime",E);gm.setListObjVal("targetsOl",u,"selectTime",F)}}}else log("Recon can not parse target text string"+n)}c.location.reload(true);var J=gm.getValue("PlayerReconRetry",
60);this.SetTimer("PlayerReconTimer",J);h>0?this.SetDivContent("idle_mess","Player Recon: Found:"+h+" Total:"+gm.getList("targetsOl").length):this.SetDivContent("idle_mess","Player Recon: No Targets Found");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},J*1E3);return false}catch(K){log("ERROR in Recon :"+K);return false}},currentPage:"",currentTab:"",waitMilliSecs:5E3,actionDescTable:{Page:"Reviewing Pages",AutoIncome:"Awaiting Income",AutoStat:"Upgrade Skill Points",MaxEnergyQuest:"At Max Energy Quest",
PassiveGeneral:"Setting Idle General",Idle:"Idle Tasks",ImmediateBanking:"Immediate Banking",Battle:"Battling Players",MonsterReview:"Review Monsters/Raids",ImmediateAutoStat:"Immediate Auto Stats",Elite:"Fill Elite Guard",AutoPotions:"Auto Potions",Alchemy:"Auto Alchemy",Blessing:"Auto Bless",AutoGift:"Auto Gifting",MonsterFinder:"Monster Finder",DemiPoints:"Demi Points First",Monsters:"Fighting Monsters",Heal:"Auto Healing",Bank:"Auto Banking",Land:"Buy/Sell Land"},CheckLastAction:function(c){var d=
gm.getValue("LastAction","none");this.actionDescTable[c]?this.SetDivContent("activity_mess","Activity: "+this.actionDescTable[c]):this.SetDivContent("activity_mess","Activity: "+c);if(d!=c){log("Changed from doing "+d+" to "+c);gm.setValue("LastAction",c)}},masterActionList:{0:"Elite",2:"Heal",3:"ImmediateBanking",4:"ImmediateAutoStat",5:"MaxEnergyQuest",6:"DemiPoints",7:"MonsterReview",8:"Monsters",9:"Battle",10:"MonsterFinder",11:"Quest",12:"PassiveGeneral",13:"Land",14:"Bank",15:"Blessing",16:"AutoStat",
17:"AutoGift",18:"AutoPotions",19:"Alchemy",20:"Idle"},actionsList:[],MakeActionsList:function(){try{if(this.actionsList.length===0){log("Loading a fresh Action List");var c="",d=[],e=0,f=gm.getValue("actionOrder","");if(f!==""){log("Trying user defined Action Order");d=f.split(",");for(c in this.masterActionList)if(this.masterActionList.hasOwnProperty(c))e+=1;else{log("Error Getting Master Action List length!");log("Skipping 'action' from masterActionList: "+c)}}else{log("Building the default Action Order");
for(c in this.masterActionList)if(this.masterActionList.hasOwnProperty(c))e=d.push(c);else{log("Error Building Default Action Order!");log("Skipping 'action' from masterActionList: "+c)}}var g=d.length;if(g===0)throw"Action Order Array is empty! "+f===""?"(Default)":"(User)";g<e&&log("Warning! Action Order Array has fewer orders than default!");g>e&&log("Warning! Action Order Array has more orders than default!");for(c=0;c!==g;c+=1){e="";e=f!==""?this.masterActionList[parseInt(d[c],16)]:this.masterActionList[d[c]];
if(e.length>0&&typeof e==="string")this.actionsList.push(e);else{log("Error! Skipping actionItem");log("Action Item("+c+"): "+e)}}f!==""&&log("Get Action List: "+this.actionsList)}this.actionsList[0]!="Page"&&this.actionsList.unshift("Page");return true}catch(h){log("ERROR in MakeActionsList: "+h);this.actionsList=["Page","Elite","Heal","ImmediateBanking","ImmediateAutoStat","MaxEnergyQuest","DemiPoints","MonsterReview","Monsters","Battle","MonsterFinder","Quest","PassiveGeneral","Land","Bank","Blessing",
"AutoStat","AutoGift","AutoPotions","Alchemy","Idle"];return false}},MainLoop:function(){this.waitMilliSecs=5E3;if(location.href.indexOf("/common/error.html")>=0){log("detected error page, waiting to go back to previous page.");window.setTimeout(function(){window.history.go(-1)},3E4)}else if(document.getElementById("try_again_button")){log("detected Try Again message, waiting to reload");window.setTimeout(function(){window.history.go(0)},3E4)}else{if(gm.getValue("fbFilter",false)&&(window.location.href.indexOf("apps.facebook.com/reqs.php")>=
0||window.location.href.indexOf("apps.facebook.com/home.php")>=0||window.location.href.indexOf("filter=app_46755028429")>=0))typeof GM_addStyle!="undefined"&&GM_addStyle('#contentArea div[id^="div_story_"]:not([class*="46755028429"]) {\ndisplay:none !important;\n}');var c=false;if(global.is_chrome){if(window.location.href.indexOf("apps.facebook.com/reqs.php")>=0||window.location.href.indexOf("apps.facebook.com/home.php")>=0||window.location.href.indexOf("filter=app_46755028429")>=0)c=true}else if(window.location.href.indexOf("www.facebook.com/reqs.php")>=
0||window.location.href.indexOf("www.facebook.com/home.php")>=0||window.location.href.indexOf("filter=app_46755028429")>=0)c=true;if(c){if(gm.getValue("mfStatus","")=="OpenMonster"){log("Opening Monster "+gm.getValue("navLink"));this.CheckMonster()}else if(gm.getValue("mfStatus","")=="CheckMonster"){log("Scanning URL for new monster");this.selectMonst()}this.MonsterFinderOnFB();this.AcceptGiftOnFB()}else{if(c=nHtml.FindByAttrContains(document.body,"a","class","undo_link")){this.Click(c);log("Undoing notification")}if(c=
gm.getValue("Disabled",false))global.is_chrome&&CE_message("disabled",null,c);else if(this.GetStats()){gm.setValue("NoWindowLoad",0);if(gm.getValue("caapPause","none")!="none"){this.caapDivObject.css({background:gm.getValue("StyleBackgroundDark","#fee"),opacity:gm.getValue("StyleOpacityDark","1")});this.caapTopObject.css({background:gm.getValue("StyleBackgroundDark","#fee"),opacity:gm.getValue("StyleOpacityDark","1")})}else{if(this.WhileSinceDidIt("clickedOnSomething",25)&&this.waitingForDomLoad){log("Clicked on something, but nothing new loaded.  Reloading page.");
this.ReloadCastleAge()}Queue.burn.stamina=this.CheckStamina("Battle");Queue.burn.energy=this.CheckEnergy(1,gm.getValue("WhenQuest","Never"));if(this.AutoIncome())this.CheckLastAction("AutoIncome");else{this.MakeActionsList();c=this.actionsList.slice();gm.getValue("ReleaseControl",false)?gm.setValue("ReleaseControl",false):c.unshift(gm.getValue("LastAction","Idle"));for(var d in c){worker=WorkerByName(c[d]);if(typeof this[c[d]]=="function")result=this[c[d]]();else if(worker){worker._unflush();(result=
worker._work(true))&&log("Doing worker "+worker.name)}else log("ERROR - No function for "+c[d]);if(result){this.CheckLastAction(c[d]);break}}for(i in Workers)Workers[i]._flush()}}}else{d=gm.getValue("NoWindowLoad",0);if(d===0){this.JustDidIt("NoWindowLoadTimer");gm.setValue("NoWindowLoad",1)}else if(this.WhileSinceDidIt("NoWindowLoadTimer",Math.min(Math.pow(2,d-1)*15,3600))){this.JustDidIt("NoWindowLoadTimer");gm.setValue("NoWindowLoad",d+1);this.ReloadCastleAge()}log("Page no-load count: "+d)}}this.WaitMainLoop()}},
WaitMainLoop:function(){this.waitForPageChange=true;nHtml.setTimeout(function(){caap.waitForPageChange=false;caap.MainLoop()},caap.waitMilliSecs*(1+Math.random()*0.2))},ReloadCastleAge:function(){if(window.location.href.indexOf("castle_age")>=0&&!gm.getValue("Disabled")&&gm.getValue("caapPause")=="none"){global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause","none"));window.location.href="http://apps.facebook.com/castle_age/index.php?bm=1"}},ReloadOccasionally:function(){var c=gm.getNumber("ReloadFrequency",
8);if(!c||c<8)c=8;nHtml.setTimeout(function(){if(caap.WhileSinceDidIt("clickedOnSomething",300)){log("Reloading if not paused after inactivity");if((window.location.href.indexOf("castle_age")>=0||window.location.href.indexOf("reqs.php#confirm_46755028429_0")>=0)&&!gm.getValue("Disabled")&&gm.getValue("caapPause")=="none"){global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause","none"));window.location.href="http://apps.facebook.com/castle_age/index.php?bm=1"}}caap.ReloadOccasionally()},
6E4*c+c*60*1E3*Math.random())}};if(typeof GM_log!=="function"){alert("Your browser does not appear to support Greasemonkey scripts!");throw"Error: Your browser does not appear to support Greasemonkey scripts!";}log("Starting");
if(global.is_chrome){try{var lastVersion=localStorage.getItem(global.gameName+"__LastVersion",0),shouldTryConvert=false;if(lastVersion)if(lastVersion.substr(0,1)=="s")shouldTryConvert=true;if(caapVersion<="140.21.9"||shouldTryConvert)ConvertGMtoJSON()}catch(e$$51){log("Error converting DB: "+e$$51)}try{CM_Listener()}catch(e$$52){log("Error loading CM_Listener"+e$$52)}}
if(gm.getValue("SetTitle")){var DocumentTitle="";if(gm.getValue("SetTitleAction",false))DocumentTitle+="Starting - ";if(gm.getValue("SetTitleName",false))DocumentTitle+=gm.getValue("PlayerName","CAAP")+" - ";document.title=DocumentTitle+global.documentTitle}
if(!global.is_chrome)try{if(gm.getValue("SUC_remote_version",0)>caapVersion)global.newVersionAvailable=true;var updateCheck=function(c){if(c||parseInt(gm.getValue("SUC_last_update","0"),10)+864E5<=(new Date).getTime())try{GM_xmlhttpRequest({method:"GET",url:"http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/Castle-Age-Autoplayer.user.js",headers:{"Cache-Control":"no-cache"},onload:function(e){var f=e.responseText;e=/@version\s*(.*?)\s*$/m.exec(f)[1];f=/@name\s*(.*?)\s*$/m.exec(f)[1];gm.setValue("SUC_last_update",
(new Date).getTime()+"");gm.setValue("SUC_target_script_name",f);gm.setValue("SUC_remote_version",e);log("remote version "+e);if(e>caapVersion){global.newVersionAvailable=true;c&&confirm('There is an update available for the Greasemonkey script "'+f+'."\nWould you like to go to the install page now?')&&GM_openInTab("http://senses.ws/caap/index.php?topic=771.msg3582#msg3582")}else c&&alert('No update is available for "'+f+'."')}})}catch(d){c&&alert("An error occurred while checking for updates:\n"+
d)}};GM_registerMenuCommand(gm.getValue("SUC_target_script_name","???")+" - Manual Update Check",function(){updateCheck(true)});updateCheck(false)}catch(err$$101){log("ERROR in GitHub updater: "+err$$101)}
if(gm.getValue("LastVersion",0)!=caapVersion)try{parseInt(gm.getValue("LastVersion",0),10)<121&&gm.setValue("WhenBattle",gm.getValue("WhenFight","Stamina Available"));if(parseInt(gm.getValue("LastVersion",0),10)<126)for(var storageKeys=GM_listValues(),key=0;key<storageKeys.length;key+=1)GM_getValue(storageKeys[key])&&GM_setValue(storageKeys[key],GM_getValue(storageKeys[key]).toString().replace("~",global.os).replace("`",global.vs));if(parseInt(gm.getValue("LastVersion",0),10)<130&&gm.getValue("MonsterGeneral")){gm.setValue("AttackGeneral",
gm.getValue("MonsterGeneral"));gm.deleteValue("MonsterGeneral")}if(parseInt(gm.getValue("LastVersion",0),10)<133){var clearList=["FreshMeatMaxLevel","FreshMeatARMax","FreshMeatARMin"];clearList.forEach(function(c){gm.setValue(c,"")})}if((gm.getValue("LastVersion",0)<"140.15.3"||gm.getValue("LastVersion",0)<"140.21.0")&&gm.getValue("actionOrder","")!=="")alert("You are using a user defined Action List!\nThe Master Action List has changed!\nYou must update your Action List!");if(gm.getValue("LastVersion",
0)<"140.16.2")for(var a=1;a<=5;a+=1){var attribute=gm.getValue("Attribute"+a,"");if(attribute!==""){gm.setValue("Attribute"+a,attribute.ucFirst());log("Converted Attribute"+a+": "+attribute+"   to: "+attribute.ucFirst())}}if(gm.getValue("LastVersion",0)<"140.23.0"){var convertToArray=function(c){var d=gm.getValue(c,""),e=[];if(d.length){d=d.replace(/\n/gi,",");e=d.split(",");e=e.filter(function(f){return f!==""});e.length||(e=[])}gm.setList(c,e)};convertToArray("EliteArmyList");convertToArray("BattleTargets")}if(gm.getValue("LastVersion",
0)<"140.23.6"){gm.deleteValue("AutoEliteGetList");gm.deleteValue("AutoEliteReqNext");gm.deleteValue("AutoEliteEnd");gm.deleteValue("MyEliteTodo")}gm.setValue("LastVersion",caapVersion)}catch(err$$102){log("ERROR in Environment updater: "+err$$102)}
$(function(){log("Full page load completed");if(gm.getValue("caapPause","none")!=="none"&&gm.getValue("caapPause","none")!=="block"){log("Refresh page because unable to load gm.values due to unsafewindow error");window.location.href=window.location.href}gm.setValue("clickUrl",window.location.href);global.AddCSS();if(window.location.href.indexOf("facebook.com/castle_age/")>=0){gm.setValue("caapPause","none");gm.setValue("ReleaseControl",true);global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause",
"none"));nHtml.setTimeout(function(){userID=$("head").html().regex(/user:([0-9]+),/i);if(!userID||typeof userID!=="number"||userID===0){log("ERROR: No Facebook UserID!!!");window.location.href=window.location.href}try{imagepath=$("#app"+APPID+"_globalContainer img:eq(0)").attr("src").pathpart()}catch(c){log("ERROR: Bad Page Load!!!");Page.reload();return}do_css();caap.MakeActionsList();caap.init();Page.identify();for(i in Workers)Workers[i]._setup();for(i in Workers)Workers[i]._init();for(i in Workers){Workers[i]._update();
Workers[i]._flush()}log("Workers: "+Length(Workers));Page.parse_all()},200)}caap.waitMilliSecs=8E3;caap.WaitMainLoop()});caap.ReloadOccasionally();
